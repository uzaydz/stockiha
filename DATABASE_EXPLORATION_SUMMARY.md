# ملخص استكشاف بنية قاعدة البيانات المحلية

## نظرة سريعة

تم استكشاف شامل لنظام التخزين المحلي في تطبيق Bazaar Console Connect:

### الملفات الرئيسية المُكتشفة:
1. **`/src/database/localDb.ts`** (1,286 سطر)
   - قاعدة البيانات الأساسية باستخدام Dexie.js
   - 18 إصدار من تطور البيانات
   - 28 جدول رئيسي
   - 150+ فهرس متقدم

2. **`/src/lib/db/inventoryDB.ts`** (345 سطر)
   - واجهة إدارة المخزون
   - دوال المزامنة والبحث

3. **`/src/lib/utils/complete-logout-cleaner.ts`** (925 سطر)
   - تنظيف شامل عند تسجيل الخروج
   - تنظيف 10 مستويات مختلفة من مصادر البيانات

4. **`/src/context/auth/utils/authStorage.ts`** (523 سطر)
   - إدارة بيانات المصادقة والجلسات
   - دعم الأوفلاين الآمن

5. **`/electron/secureStorage.cjs`** (376 سطر)
   - تخزين آمن في بيئة Electron
   - تشفير البيانات الحساسة

---

## البنية الشاملة

### 1. طبقات التخزين

```
┌─────────────────────────────────────────┐
│      IndexedDB (bazaarDB_v2)            │
│   - 28 جدول رئيسي                      │
│   - 150+ فهرس                          │
│   - سعة: 50-250 MB                     │
│   - البيانات الرئيسية                  │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│   localStorage / sessionStorage         │
│   - بيانات الجلسة والمصادقة             │
│   - الإعدادات والتفضيلات               │
│   - سعة: 5-10 MB                       │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│   electron-store (Electron فقط)        │
│   - إعدادات مشفرة                       │
│   - بيانات النوافذ                     │
│   - سعة: غير محدودة (القرص الصلب)      │
└─────────────────────────────────────────┘
```

### 2. الجداول الرئيسية (28 جدول)

#### A) المنتجات والمخزون
- `products` (18 فهرس) - المنتجات مع بحث متقدم عربي
- `inventory` - كميات المخزون
- `transactions` - سجل عمليات المخزون

#### B) المبيعات
- `posOrders` (11 فهرس) - طلبات البيع
- `posOrderItems` - عناصر الطلب
- `posSettings` - إعدادات نقاط البيع
- `workSessions` - جلسات العمل

#### C) العملاء
- `customers` (9 فهارس) - بيانات العملاء
- `addresses` - عناوين العملاء
- `customerDebts` - ديون العملاء
- `customerDebtPayments` - مدفوعات الديون

#### D) الفواتير والإرجاعات
- `invoices` (8 فهارس) - الفواتير
- `invoiceItems` - عناصر الفاتورة
- `productReturns` (7 فهارس) - إرجاعات المنتجات
- `returnItems` - عناصر الإرجاع

#### E) الخسائر والمصروفات
- `lossDeclarations` (6 فهارس) - إعلانات الخسائر
- `lossItems` - عناصر الخسارة
- `expenses` (6 فهارس) - المصروفات
- `recurringExpenses` - المصروفات المتكررة
- `expenseCategories` - فئات المصروفات

#### F) خدمات الإصلاح
- `repairOrders` (8 فهارس) - طلبات الإصلاح
- `repairStatusHistory` - سجل الحالات
- `repairImages` - صور الإصلاح
- `repairImageFiles` - ملفات الصور
- `repairLocations` - مواقع الإصلاح

#### G) مجموعات الطلبات
- `orderGroups` - مجموعات الطلبات
- `orderGroupRules` - قواعد المجموعات
- `orderAssignments` - تعيينات الطلبات
- `orderGroupMembers` - أعضاء المجموعات

#### H) أخرى
- `staffPins` - بيانات اعتماد الموظفين (مجزأة)
- `syncQueue` - قائمة انتظار المزامنة
- `organizationSubscriptions` - الاشتراكات
- `subscriptionPlans` - خطط الاشتراك

---

## حدود التخزين

| النوع | الحد الأقصى | الملاحظات |
|-------|-----------|---------|
| IndexedDB | 50-250 MB | متغير حسب المتصفح |
| localStorage | 5-10 MB | قابل للتجاوز بإذن |
| sessionStorage | ذاكرة | يتم مسحه عند الإغلاق |
| electron-store | قرص صلب | لا حدود عملية |
| قيمة واحدة | 10 MB (محقق) | في secureStorage.cjs |

---

## آليات التنظيف (5 مستويات)

### المستوى 1: تنظيف عند تسجيل الخروج
```
CompleteLogoutCleaner.performCompleteCleanup()
├── تنظيف React Query Cache
├── تنظيف localStorage (60+ مفتاح)
├── حذف IndexedDB (7 قواعد بيانات)
├── تنظيف Service Worker Cache
├── حذف Cookies
├── مسح Application State (40+ متغير)
├── مسح Event Listeners المخصصة
├── تنظيف React Context states
└── إعادة تحميل الصفحة
```
**المدة:** 2 ثانية

### المستوى 2: تنظيف سريع
```
CompleteLogoutCleaner.quickCleanup()
├── حذف 5 مفاتيح حساسة فقط
└── مسح cookies الحساسة
```
**المدة:** فوري

### المستوى 3: تنظيف بيانات المصادقة
```
clearAuthStorage()
├── حذف AUTH_STATE
├── حذف AUTH_USER و AUTH_SESSION
├── حذف SESSION_CACHE
└── حذف OFFLINE_SNAPSHOT_KEY
```

### المستوى 4: تنظيف مع الاحتفاظ بالأوفلاين
```
clearAuthStorageKeepOfflineCredentials()
├── حذف بيانات الجلسة
├── الاحتفاظ ببيانات المستخدم الأوفلاين
└── الاحتفاظ بـ secure sessions
```

### المستوى 5: تنظيف البيانات القديمة
```
cleanExpiredCache()
├── حذف الملفات الشخصية (> 24 ساعة)
├── حذف جلسات الكاش (> 30 دقيقة)
└── حذف كاش المستخدم (> 1 ساعة)
```

---

## الفهارس المتقدمة (مثال)

### فهارس البحث العربي

```javascript
// من localDb.ts الإصدار 8

// تطبيع الأحرف العربية
normalizeArabic(text) {
  - إزالة التشكيل والتمطيط
  - توحيد الهمزات والتاء المربوطة
  - توحيد الياء المقصورة
  - إزالة الأحرف الخاصة
  - الحفاظ على الأرقام والمسافات
}

// الفهارس المُنتجة
name_search: "محمود حمود" → "محمود حمود"
sku_search: "SKU-001أ" → "sku 001 ا"
barcode_digits: "1234ABC567" → "1234567"

// الفهارس المركبة
[organization_id+name_lower]      // البحث السريع بالاسم
[organization_id+sku_lower]        // البحث بالرمز
[organization_id+category_id+name_lower]  // البحث بالفئة
[organization_id+barcode_digits]   // البحث بالرمز الشريطي
```

---

## عمليات المزامنة

### نموذج المزامنة

```
1. فحص الاتصال (navigator.onLine)
   ↓
2. جلب البيانات غير المتزامنة
   ↓
3. تنفيذ متوازي (Pool Size = 2)
   ↓
4. محاولة المزامنة
   ├─ نجاح → synced = true
   └─ فشل → محاولة لاحقة + تسجيل الخطأ
   ↓
5. تحديث حالة المزامنة
```

### حالات المزامنة

```
pending_sync → syncing → synced ✓
                    ↓
                  error → retry (الحد الأقصى: 3 محاولات)
```

### الأولويات

```
Priority 1: عالي (بيانات حرجة)
Priority 2: متوسط (بيانات عادية)
Priority 3: منخفض (بيانات اختيارية)
```

---

## أمثلة الاستخدام

### البحث السريع
```typescript
// البحث في منتج بالاسم
await inventoryDB.products
  .where('[organization_id+name_lower]')
  .equals([orgId, 'منتج'])
  .toArray();
```

### تحديث الكمية (معاملة آمنة)
```typescript
await inventoryDB.transaction('rw', 
  [inventoryDB.inventory, inventoryDB.transactions], 
  async () => {
    // تحديث آمن
  }
);
```

### البحث بالفئة
```typescript
await inventoryDB.products
  .where('[organization_id+category_id+name_lower]')
  .between(
    [orgId, catId, ''],
    [orgId, catId, '\uffff']
  )
  .toArray();
```

---

## نقاط القوة

✓ **فهارس متقدمة:** 150+ فهرس لبحث سريع  
✓ **دعم الأوفلاين:** عمل كامل بدون اتصال  
✓ **معاملات آمنة:** ACID transactions  
✓ **بحث عربي:** توحيد الأحرف والبحث الذكي  
✓ **مزامنة تلقائية:** نظام متطور للتزامن  
✓ **تنظيف شامل:** تنظيف 10 مستويات مختلفة  

---

## نقاط الضعف

✗ **عدم التشفير:** معظم البيانات غير مشفرة  
✗ **بدون حد زمني واضح:** عدم وجود TTL عام  
✗ **تنظيف يدوي:** يعتمد على الأحداث (logout)  
✗ **بدون مراقبة حجم:** عدم وجود تنظيف تلقائي  
✗ **حدود غير واضحة:** حد التخزين قد يتجاوز المتوقع  

---

## التوصيات

### الأمان
1. تشفير جميع البيانات الحساسة قبل الحفظ
2. استخدام TLS دائماً عند المزامنة
3. التحقق من توقيع البيانات

### الأداء
1. استخدام الفهارس المركبة عند الاستعلام
2. تحديد `limit()` في الاستعلامات الكبيرة
3. تنظيف دوري للبيانات القديمة

### الموثوقية
1. إضافة نظام logging للمزامنة
2. تحديد حد أقصى لمحاولات المزامنة
3. إعادة بناء الفهارس تلقائياً عند الحاجة

### الخصوصية
1. حذف البيانات الشخصية عند الطلب
2. تحديد سياسة الاحتفاظ بالبيانات
3. إخطار المستخدم بالبيانات المخزنة

---

## الملفات الرئيسية

```
التخزين:
├── src/database/localDb.ts              (1,286 سطر)
├── src/lib/db/inventoryDB.ts            (345 سطر)
├── src/context/auth/utils/authStorage.ts (523 سطر)
└── electron/secureStorage.cjs            (376 سطر)

التنظيف:
├── src/lib/utils/complete-logout-cleaner.ts  (925 سطر)
└── src/lib/utils/gentle-logout-cleaner.ts

المزامنة:
├── src/api/syncService.ts
├── src/api/syncRepairs.ts
├── src/api/localCustomerDebtService.ts
├── src/api/localInvoiceService.ts
└── src/api/localProductReturnService.ts
```

---

## الإحصائيات

```
عدد الجداول:              28
عدد الفهارس الإجمالي:     150+
عدد الفهارس المركبة:      40+
عدد الإصدارات:           18
عدد المفاتيح المنظفة:     60+
عدد المتغيرات المحذوفة:   40+
عدد قواعد البيانات المحذوفة: 7
```

---

## الخاتمة

تم إنشاء نظام تخزين محلي شامل وقوي يدعم:
- التخزين الضخم (IndexedDB)
- البحث السريع جداً (150+ فهرس)
- العمل الأوفلاين الكامل
- المزامنة التلقائية
- التنظيف الشامل عند الحاجة

النظام جاهز للإنتاج مع توصيات بسيطة للتحسينات الأمنية والأداء.

---

**تم الاستكشاف:** 2025-11-04  
**الملفات المُفحوصة:** 10+  
**سطور الكود المُحللة:** 4,000+  
**الجداول المرصودة:** 28  
**الفهارس المرصودة:** 150+

