# ØªØ­Ù„ÙŠÙ„ Ø£Ù…Ø§Ù† Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†

## ğŸ”’ Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©

### Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1: ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Tenant)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Authentication Method: Supabase Auth         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Component                    â”‚ Status        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Password Transmission         â”‚ âœ… HTTPS     â”‚
â”‚ Password Hashing              â”‚ âœ… Bcrypt    â”‚
â”‚ Session Token Encryption      â”‚ âš ï¸  Partial  â”‚
â”‚ Local Storage Encryption      â”‚ âŒ None      â”‚
â”‚ Offline Session Storage       â”‚ âœ… AES-GCM   â”‚
â”‚ Token Expiration Validation   â”‚ âœ… Checked   â”‚
â”‚ Revocation Support            â”‚ âŒ No        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2: ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Staff PIN)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Authentication Method: 6-Digit PIN           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Component                    â”‚ Status        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PIN Hashing                   â”‚ âœ… SHA-256   â”‚
â”‚ Salt Randomization            â”‚ âœ… 16 bytes  â”‚
â”‚ Salt Storage                  â”‚ âœ… Separate  â”‚
â”‚ Brute Force Protection        â”‚ âŒ None      â”‚
â”‚ Rate Limiting                 â”‚ âŒ None      â”‚
â”‚ Account Lockout               â”‚ âŒ None      â”‚
â”‚ PIN Transmission              â”‚ âœ… Direct    â”‚
â”‚ Offline Verification          â”‚ âœ… IndexedDB â”‚
â”‚ Permission Validation         â”‚ âš ï¸  Local    â”‚
â”‚ Revocation Support            â”‚ âŒ No        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš¨ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ø­Ø±Ø¬Ø©

### 1. âŒ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© ÙÙŠ localStorage

**Ø§Ù„Ù…ÙˆÙ‚Ø¹**: Multiple files
**Ø§Ù„Ù…Ø®Ø§Ø·Ø±**:
- XSS attacks ÙŠÙ…ÙƒÙ† Ù‚Ø±Ø§Ø¡Ø© localStorage
- Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø´ÙØ±Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
- Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ø¨Ø± DevTools ÙˆØªØ­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø´ÙŠØ¡

**Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©**:
```javascript
// localStorage keys (Plain Text âŒ)
bazaar_offline_auth_snapshot_v1  // Email + User metadata
staff_session                     // Staff name + permissions
admin_mode                        // Boolean admin flag
secure_offline_session_meta_v1    // User ID + Expiration
```

**Ø§Ù„ØªÙˆØµÙŠØ©**:
```typescript
// Ø§Ø³ØªØ®Ø¯Ù… IndexedDB Ù…Ø¹ encryption Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† localStorage
// Ø£Ùˆ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø§Ø³ØªØ®Ø¯Ù… sessionStorage Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
// Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… service workers Ù…Ø¹ encryption

// âœ… Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­:
1. IndexedDB + encrypted fields
2. sessionStorage ÙÙ‚Ø· Ù„Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
3. service worker encryption layer
```

---

### 2. âŒ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Brute Force Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†

**Ø§Ù„Ù…ÙˆÙ‚Ø¹**: src/pages/StaffLogin.tsx
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©**:
- PIN 6 Ø£Ø±Ù‚Ø§Ù… = 1 Ù…Ù„ÙŠÙˆÙ† Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©
- Ø¨Ø¯ÙˆÙ† ØªØ£Ø®ÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
- ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ PIN ÙÙŠ Ø«ÙˆØ§Ù†

**Ø§Ù„Ù‡Ø¬ÙˆÙ… Ø§Ù„Ù…Ø­ØªÙ…Ù„**:
```python
import time
import requests

# Offline attack (super fast)
for i in range(1000000):
    pin = str(i).zfill(6)
    verify_pin_offline(pin)  # No delay!
    
# Online attack (slower but possible)
for i in range(1000000):
    result = api.verify_pin(pin)  # ~100ms per request
    if result.success:
        print(f"PIN found: {pin}")
        break
    time.sleep(0.1)  # No server-side rate limiting!
```

**Ø§Ù„ØªÙˆØµÙŠØ©**:
```typescript
// âœ… ØªØ·Ø¨ÙŠÙ‚ Ø­Ù…Ø§ÙŠØ© Ù…Ø­Ù„ÙŠØ©
1. ØªØªØ¨Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ§Ø´Ù„Ø©
2. ØªØ£Ø®ÙŠØ± ØªØµØ§Ø¹Ø¯ÙŠ (exponential backoff)
3. Ù‚ÙÙ„ Ù…Ø¤Ù‚Øª Ø¨Ø¹Ø¯ N Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø®Ø§Ø·Ø¦Ø©
4. ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù„Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ­Ø±Ø² Ø§Ù„Ø­Ø³Ø§Ø¨

// âœ… ØªØ·Ø¨ÙŠÙ‚ Ø­Ù…Ø§ÙŠØ© ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…
1. Rate limiting per IP/organization
2. Account lockout after 5 attempts
3. Temporary ban (15 minutes)
4. Logging suspicious activities
5. Captcha after 3 failures
```

---

### 3. âš ï¸ Ù…ÙØªØ§Ø­ Electron Ù…Ø­ÙÙˆØ¸ Ø¨Ø´ÙƒÙ„ Ø«Ø§Ø¨Øª

**Ø§Ù„Ù…ÙˆÙ‚Ø¹**: electron/secureStorage.cjs
**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©**:
```javascript
encryptionKey: 'stockiha-secure-encryption-key-2024'
```
- Ø§Ù„Ù…ÙØªØ§Ø­ Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯!
- Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ù„ÙØŒ ÙŠÙ…ÙƒÙ† ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„ÙƒÙ„ Ø¬Ù‡Ø§Ø²

**Ø§Ù„ØªÙˆØµÙŠØ©**:
```typescript
// âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
import { safeStorage } from 'electron';
import { randomBytes } from 'crypto';

// Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ù„ÙƒÙ„ ØªØ«Ø¨ÙŠØª
const deviceKey = safeStorage.encryptString(
  randomBytes(32).toString('hex')
);

// Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
store.set('device_encryption_key', deviceKey);

// Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­
const encryptionKey = safeStorage.decryptString(
  store.get('device_encryption_key')
);
```

---

### 4. âŒ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¢Ù„ÙŠØ© Ø¥Ø¨Ø·Ø§Ù„ (Revocation)

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©**:
- PIN Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…
- Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¨Ø·Ø§Ù„ PIN ÙÙˆØ±Ø§Ù‹
- Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙØµÙˆÙ„ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†

**Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„Ø®Ø·ÙŠØ±**:
```
Admin: ÙØµÙ„ Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
Server: PIN Ù…Ø­Ø¯Ø« (disabled)
Offline Device: Still has old cached PIN!
Result: Fired employee can still work offline âŒ
```

**Ø§Ù„ØªÙˆØµÙŠØ©**:
```typescript
// âœ… ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø¥Ø¨Ø·Ø§Ù„
interface CachedPIN {
  staffId: string;
  pin_hash: string;
  salt: string;
  permissions: object;
  cached_at: timestamp;
  revoked: boolean;  // â† Ø¬Ø¯ÙŠØ¯
  revoked_at?: timestamp;  // â† Ø¬Ø¯ÙŠØ¯
}

// Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª:
1. ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¨Ø·Ø§Ù„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
2. Ø­Ø¯Ø« Ø­Ø§Ù„Ø© revoked Ù…Ø­Ù„ÙŠØ§Ù‹
3. Ù…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø¨Ø·Ù„ÙŠÙ†
4. Ù…Ø³Ø­ PIN Ø§Ù„Ù…Ø¨Ø·Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨
```

---

### 5. âŒ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø®Ø§Ø¯Ù…

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©**:
```typescript
// Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·!
staff.permissions = {
  canEditProducts: true,
  canManageSettings: true,
  canViewReports: true
}

// ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹!
localStorage.setItem('staff_session', {
  ...staff,
  permissions: { ...allPermissionsTrue }
})
```

**Ø§Ù„ØªÙˆØµÙŠØ©**:
```typescript
// âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù†Ø¯ ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø­Ø³Ø§Ø³Ø©
async function canPerformAction(action: string) {
  // Try server first
  try {
    const response = await api.checkPermission(action);
    return response.allowed;
  } catch (error) {
    // Fallback to local (offline)
    return localStaff.permissions[action] ?? false;
  }
}

// Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ø¬Ø¯Ø§Ù‹:
// ï¿½ï¿½ï¿½ Ø§Ø­ØªÙØ¸ Ø¨Ù€ sensitive actions Ù„Ù€ online ÙÙ‚Ø·
```

---

## ğŸ›¡ï¸ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©

### Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© 1: Ø­Ø±Ø¬Ø© (Do Immediately)

#### 1.1 ØªØ·Ø¨ÙŠÙ‚ Rate Limiting Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
```typescript
// src/pages/StaffLogin.tsx
const [failedAttempts, setFailedAttempts] = useState(0);
const [lockoutUntil, setLockoutUntil] = useState<Date | null>(null);

const handleVerifyPin = async (pinCode: string) => {
  // Check lockout
  if (lockoutUntil && new Date() < lockoutUntil) {
    const secondsLeft = Math.ceil(
      (lockoutUntil.getTime() - Date.now()) / 1000
    );
    toast.error(`Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙˆÙ„. Ø­Ø§ÙˆÙ„ Ø¨Ø¹Ø¯ ${secondsLeft} Ø«Ø§Ù†ÙŠØ©`);
    return;
  }

  // Verify PIN
  const result = await verifyStaffPinOffline(pin);
  
  if (!result.success) {
    const newAttempts = failedAttempts + 1;
    setFailedAttempts(newAttempts);
    
    // Lock after 5 attempts
    if (newAttempts >= 5) {
      const lockout = new Date(Date.now() + 15 * 60 * 1000); // 15 mins
      setLockoutUntil(lockout);
      toast.error('ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù…Ø¯Ø© 15 Ø¯Ù‚ÙŠÙ‚Ø©');
    } else {
      toast.error(`ÙØ´Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ${newAttempts}/5`);
    }
  } else {
    setFailedAttempts(0);
    setLockoutUntil(null);
    // Success...
  }
};
```

#### 1.2 Ø¥Ø¶Ø§ÙØ© checksum Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
```typescript
// src/context/auth/utils/authStorage.ts
import { createHmac } from 'crypto';

interface OfflineAuthSnapshot {
  // ... existing fields
  checksum?: string;  // â† Ø¬Ø¯ÙŠØ¯
}

export function saveOfflineAuthSnapshot(session: Session, user: User) {
  const snapshot: OfflineAuthSnapshot = {
    user: { ... },
    sessionMeta: { ... }
  };

  // Create HMAC to detect tampering
  const hmac = createHmac('sha256', 'secret-key-change-me');
  hmac.update(JSON.stringify(snapshot));
  snapshot.checksum = hmac.digest('hex');

  localStorage.setItem(OFFLINE_SNAPSHOT_KEY, JSON.stringify(snapshot));
}

export function validateOfflineAuthSnapshot(
  snapshot: OfflineAuthSnapshot
): boolean {
  const { checksum, ...data } = snapshot;
  
  const hmac = createHmac('sha256', 'secret-key-change-me');
  hmac.update(JSON.stringify(data));
  const expectedChecksum = hmac.digest('hex');
  
  return checksum === expectedChecksum;
}
```

#### 1.3 Ø§Ø³ØªØ®Ø¯Ø§Ù… sessionStorage Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† localStorage
```typescript
// Store temporary auth data in sessionStorage (cleared on browser close)
const useSecureStorage = {
  setItem: (key: string, value: any) => {
    sessionStorage.setItem(key, JSON.stringify(value));
  },
  
  getItem: (key: string) => {
    const item = sessionStorage.getItem(key);
    return item ? JSON.parse(item) : null;
  },
  
  removeItem: (key: string) => {
    sessionStorage.removeItem(key);
  }
};
```

---

### Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© 2: Ø¹Ø§Ù„ÙŠØ© (This Week)

#### 2.1 ØªØ­Ø¯ÙŠØ« Ù…ÙØªØ§Ø­ Electron Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
```typescript
// electron/secureStorage.cjs
const { safeStorage } = require('electron');
const crypto = require('crypto');

function getOrCreateDeviceKey(app) {
  const keyPath = path.join(app.getPath('userData'), '.device-key');
  
  try {
    // Try to load existing key
    const encryptedKey = fs.readFileSync(keyPath, 'utf-8');
    return safeStorage.decryptString(encryptedKey);
  } catch (error) {
    // Create new key
    const newKey = crypto.randomBytes(32).toString('hex');
    const encryptedKey = safeStorage.encryptString(newKey);
    fs.writeFileSync(keyPath, encryptedKey, 'utf-8');
    return newKey;
  }
}

const deviceKey = getOrCreateDeviceKey(app);
const mainStore = new Store({
  name: 'config',
  cwd: app.getPath('userData'),
  schema,
  encryptionKey: deviceKey,  // âœ… Dynamic!
  clearInvalidConfig: true,
});
```

#### 2.2 ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Revocation
```typescript
// src/lib/offline/staffCredentials.ts
export interface LocalStaffPIN {
  id: string;
  organization_id: string;
  staff_name: string;
  pin_hash: string;
  salt: string;
  permissions?: any;
  updated_at: string;
  revoked: boolean;  // â† Ø¬Ø¯ÙŠØ¯
  revoked_at?: string;  // â† Ø¬Ø¯ÙŠØ¯
}

export async function checkStaffRevocation(
  organizationId: string
): Promise<string[]> {
  try {
    const response = await fetch(
      `/api/organizations/${organizationId}/revoked-staff`
    );
    const { revoked_ids } = await response.json();
    
    // Update local database
    for (const staffId of revoked_ids) {
      const record = await inventoryDB.staffPins.get(staffId);
      if (record) {
        await inventoryDB.staffPins.put({
          ...record,
          revoked: true,
          revoked_at: new Date().toISOString()
        });
      }
    }
    
    return revoked_ids;
  } catch (error) {
    console.error('Failed to check revocation:', error);
    return [];
  }
}
```

#### 2.3 ØªØ´ÙÙŠØ± IndexedDB Ø§Ù„Ø­Ø³Ø§Ø³Ø©
```typescript
// src/database/localDb.ts
import { encrypt, decrypt } from '@/lib/crypto';

export async function saveStaffPinEncrypted(pin: LocalStaffPIN) {
  const encrypted = {
    ...pin,
    pin_hash: await encrypt(pin.pin_hash),
    salt: await encrypt(pin.salt),
    permissions: await encrypt(JSON.stringify(pin.permissions))
  };
  
  await inventoryDB.staffPins.put(encrypted);
}

export async function getStaffPinDecrypted(staffId: string) {
  const record = await inventoryDB.staffPins.get(staffId);
  if (!record) return null;
  
  return {
    ...record,
    pin_hash: await decrypt(record.pin_hash),
    salt: await decrypt(record.salt),
    permissions: JSON.parse(await decrypt(record.permissions))
  };
}
```

---

### Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© 3: Ù…ØªÙˆØ³Ø·Ø© (This Month)

#### 3.1 Ø¥Ø¶Ø§ÙØ© Audit Logging
```typescript
// src/lib/offline/auditLog.ts
interface OfflineAuditLog {
  id: string;
  organization_id: string;
  staff_id: string;
  action: string;
  timestamp: string;
  success: boolean;
  details?: object;
}

export async function logOfflineAction(log: OfflineAuditLog) {
  await inventoryDB.auditLogs.put(log);
  
  // Try to sync when online
  if (navigator.onLine) {
    try {
      await api.syncAuditLogs(log);
    } catch (error) {
      // Keep locally until synced
    }
  }
}
```

#### 3.2 ØªØ·Ø¨ÙŠÙ‚ End-to-End Encryption
```typescript
// src/lib/crypto/e2ee.ts
import { generateKeyPair, encrypt, decrypt } from './sodium';

export async function setupE2EE() {
  const keyPair = await generateKeyPair();
  
  // Send public key to server
  await api.registerPublicKey(keyPair.publicKey);
  
  // Store private key securely (Electron only)
  if (window.electronAPI) {
    await window.electronAPI.secureSession.storePrivateKey(
      keyPair.privateKey
    );
  }
}

export async function encryptSensitiveData(data: any) {
  const publicKey = await getPublicKey();
  return await encrypt(JSON.stringify(data), publicKey);
}
```

#### 3.3 ØªØ·Ø¨ÙŠÙ‚ Zero-Knowledge Proof
```typescript
// src/lib/offline/zkp.ts
// Verify PIN without sending actual PIN over network
// Use zero-knowledge proof (Schnorr protocol)
```

---

## ğŸ“Š Ù…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Security Metrics Dashboard                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚ 1. Failed Login Attempts:                      â”‚
â”‚    â”œâ”€ Today: 12/50 (24%)                       â”‚
â”‚    â”œâ”€ This Week: 87/500 (17%)                  â”‚
â”‚    â””â”€ Alert: > 30% anomaly                     â”‚
â”‚                                                 â”‚
â”‚ 2. Lockouts Triggered:                         â”‚
â”‚    â”œâ”€ Today: 2                                 â”‚
â”‚    â”œâ”€ Reason: Excessive failed attempts        â”‚
â”‚    â””â”€ Duration: 15 minutes each                â”‚
â”‚                                                 â”‚
â”‚ 3. Revoked Staff:                              â”‚
â”‚    â”œâ”€ Total Revoked: 5                         â”‚
â”‚    â”œâ”€ Cached Revocations Synced: 5             â”‚
â”‚    â””â”€ Status: âœ… All up-to-date                â”‚
â”‚                                                 â”‚
â”‚ 4. Data Integrity:                             â”‚
â”‚    â”œâ”€ HMAC Validation Pass Rate: 100%          â”‚
â”‚    â”œâ”€ Tampering Detected: 0                    â”‚
â”‚    â””â”€ Status: âœ… Secure                        â”‚
â”‚                                                 â”‚
â”‚ 5. Encryption Status:                          â”‚
â”‚    â”œâ”€ Offline Sessions Encrypted: 85%          â”‚
â”‚    â”œâ”€ PIN Hashes with Salt: 100%               â”‚
â”‚    â””â”€ Electron Key Dynamic: â³ Pending          â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©

### Unit Tests:
```typescript
describe('Offline Authentication Security', () => {
  it('should reject tampered offline snapshot', () => {
    const snapshot = loadOfflineAuthSnapshot();
    snapshot.user.email = 'attacker@evil.com';
    
    const isValid = validateOfflineAuthSnapshot(snapshot);
    expect(isValid).toBe(false);
  });

  it('should lock after 5 failed PIN attempts', () => {
    for (let i = 0; i < 5; i++) {
      verifyStaffPinOffline('000000');
    }
    
    const isLocked = isStaffLocked();
    expect(isLocked).toBe(true);
  });

  it('should not accept revoked staff PIN', () => {
    const staff = await getStaffPinDecrypted('staff-1');
    staff.revoked = true;
    
    const result = verifyStaffPinOffline('123456');
    expect(result.success).toBe(false);
  });
});
```

### Integration Tests:
```typescript
describe('Offline-to-Online Sync', () => {
  it('should sync revoked staff on reconnect', async () => {
    // Simulate offline environment
    // Perform actions as revoked staff
    // Go online
    // Verify revocation synced
  });

  it('should resolve conflicts between local and server', async () => {
    // Local: PIN changed to 111111
    // Server: PIN changed to 222222
    // Expected: Server wins
  });
});
```

---

## âœ… Checklist Ø§Ù„ØªÙ†ÙÙŠØ°

### Phase 1 (Week 1-2):
- [ ] ØªØ·Ø¨ÙŠÙ‚ Rate Limiting Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†
- [ ] Ø¥Ø¶Ø§ÙØ© checksum Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
- [ ] ØªØ¨Ø¯ÙŠÙ„ Ù…Ù† localStorage Ø¥Ù„Ù‰ sessionStorage
- [ ] Ø¥Ø¶Ø§ÙØ© Unit Tests

### Phase 2 (Week 3-4):
- [ ] ØªØ­Ø¯ÙŠØ« Ù…ÙØªØ§Ø­ Electron Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
- [ ] ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Revocation
- [ ] ØªØ´ÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB Ø§Ù„Ø­Ø³Ø§Ø³Ø©
- [ ] ØªØ·Ø¨ÙŠÙ‚ Audit Logging

### Phase 3 (Week 5-6):
- [ ] End-to-End Encryption
- [ ] Zero-Knowledge Proof Ù„Ù„Ù€ PIN
- [ ] Security Dashboard
- [ ] Penetration Testing

---

## ğŸ“š Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯

1. **OWASP Authentication Cheat Sheet**
   https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html

2. **Web Storage Security**
   https://cheatsheetseries.owasp.org/cheatsheets/Secure_Local_Storage.html

3. **Rate Limiting Best Practices**
   https://tools.ietf.org/html/draft-polli-ratelimit-headers

4. **Zero-Knowledge Proof**
   https://blog.cryptographyengineering.com/2014/11/27/zero-knowledge-proofs-illustrated-primer/

5. **Electron Security**
   https://www.electronjs.org/docs/tutorial/security

