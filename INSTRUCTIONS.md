# تعليمات لإصلاح مشكلة إحصائيات لوحة التحكم للمسؤول

## المشكلة

المشكلة الحالية هي أن لوحة التحكم تعرض إحصائيات لجميع المسؤولين في المؤسسة بدلاً من عرض الإحصائيات الخاصة بالمسؤول المحدد فقط. هذا يجعل الإحصائيات غير دقيقة للمسؤول الذي يقوم بعرض لوحة التحكم.

## الحل

لحل هذه المشكلة، قمنا بالتعديلات التالية:

1. تحديث وظائف واجهة برمجة التطبيقات (API) في `src/lib/api/analytics.ts` لتمرير معرف المستخدم الحالي إلى وظائف قاعدة البيانات.
2. إنشاء وظائف قاعدة بيانات محدثة في `supabase/functions/analytics_functions_update.sql` لتصفية البيانات بناءً على معرف المستخدم.
3. تحديث صفحة لوحة التحكم `src/pages/Dashboard.tsx` لجلب الإحصائيات الحقيقية بدلاً من البيانات التجريبية.

## خطوات التنفيذ

### 1. تحديث وظائف قاعدة البيانات

قم بتنفيذ ملف SQL المحدث على قاعدة البيانات Supabase:

1. قم بتسجيل الدخول إلى لوحة تحكم Supabase الخاصة بمشروعك.
2. انتقل إلى قسم "SQL Editor".
3. قم بنسخ محتوى الملف `supabase/functions/analytics_functions_update.sql` ولصقه في محرر SQL.
4. اضغط على زر "Run" لتنفيذ الاستعلامات.

هذا سيقوم بتحديث وظائف قاعدة البيانات لتصفية البيانات بناءً على معرف المستخدم.

### 2. نشر التحديثات في الواجهة الأمامية

قم بنشر ملفات الواجهة الأمامية المحدثة:

1. تحديث ملف `src/lib/api/analytics.ts` بالنسخة المحدثة التي تقوم بتمرير معرف المستخدم.
2. تحديث ملف `src/pages/Dashboard.tsx` بالنسخة المحدثة التي تستخدم دالة `getDashboardStats` لجلب الإحصائيات الحقيقية.

### 3. التحقق من الحل

بعد تنفيذ الخطوات أعلاه، قم بالتحقق من أن لوحة التحكم تعرض الإحصائيات الصحيحة:

1. سجل الدخول كمسؤول غير رئيسي وتحقق من أن الإحصائيات تعرض فقط البيانات المرتبطة به.
2. سجل الدخول كمدير للمؤسسة أو مسؤول رئيسي وتأكد من أنه يمكنه رؤية إحصائيات جميع المسؤولين.

## كيف يعمل الحل؟

1. **التصفية على مستوى المستخدم**: يتم الآن تمرير معرف المستخدم الحالي (`userId`) عند استدعاء وظائف API.

2. **فحص صلاحيات المستخدم**: تم إنشاء وظيفة جديدة `is_organization_admin` تتحقق مما إذا كان المستخدم هو مدير للمؤسسة.

3. **تصفية البيانات بشكل ذكي**: تم تعديل شرط التصفية في جميع وظائف SQL ليصبح:
   ```sql
   AND (
       p_admin_id IS NULL 
       OR v_is_admin = TRUE 
       OR o.created_by = p_admin_id
   )
   ```
   
   حيث:
   - إذا كان `p_admin_id` هو `NULL` (الافتراضي)، تتم إعادة جميع السجلات
   - إذا كان المستخدم مديرًا للمؤسسة (`v_is_admin = TRUE`)، يمكنه رؤية جميع السجلات
   - وإلا، يمكن للمستخدم رؤية السجلات التي أنشأها فقط (`o.created_by = p_admin_id`)

4. **تكامل الواجهة الأمامية**: تم إضافة دالة `getDashboardStats` في صفحة Dashboard لتحويل بيانات التحليلات إلى تنسيق متوافق مع مكونات لوحة التحكم.

## ملاحظات إضافية

- التعديلات التي تم إجراؤها تؤثر فقط على طريقة استرجاع البيانات وعرضها، ولا تؤثر على هيكل قاعدة البيانات أو واجهة المستخدم.
- في حالة عدم توفر بيانات حقيقية، سيتم استخدام البيانات التجريبية كاحتياطي.
- تم تبسيط حساب بعض الإحصائيات (مثل يومي/أسبوعي/سنوي) باستخدام تقريب بناءً على القيم الشهرية. 