# خطة تحسين قاعدة البيانات والواجهة الأمامية لـ Bazaar Console Connect

## مقدمة

تهدف هذه الخطة إلى تحسين هيكل قاعدة البيانات الحالي وتوضيح تدفق البيانات بين لوحة التحكم (dashboard/store-editor) والمتجر العام، مما يؤدي إلى زيادة الكفاءة، تقليل التكرار، وتحسين قابلية الصيانة.

## 1. تحسينات قاعدة البيانات

### 1.1. جدول `organizations`

*   **الوضع الحالي:** يحتوي على حقل `settings` (jsonb) الذي يخزن معلومات مكررة (`theme`, `logo_url`, `primary_color`) ومعلومات فريدة (`trial_end_date`). يحتوي أيضاً على حقل `logo_url` نصي قد يكون مكرراً.
*   **التحسينات المقترحة:**
    1.  **إنشاء عمود مخصص:** أضف عمود `trial_end_date TIMESTAMP WITH TIME ZONE` إلى جدول `organizations`.
    2.  **ترحيل البيانات:** انقل قيم `trial_end_date` من حقل `settings` (jsonb) إلى العمود الجديد `organizations.trial_end_date`.
        *   مثال استعلام الترحيل: `UPDATE organizations SET trial_end_date = (settings->>'trial_end_date')::TIMESTAMP WITH TIME ZONE WHERE settings->>'trial_end_date' IS NOT NULL;`
    3.  **إزالة حقل `settings` (jsonb):** بعد ترحيل `trial_end_date` والتأكد من أن إعدادات المظهر تُدار بالكامل من `organization_settings`، قم بإزالة حقل `organizations.settings` (jsonb) بالكامل.
        *   `ALTER TABLE organizations DROP COLUMN settings;`
    4.  **توحيد `organizations.logo_url` (الحقل النصي):**
        *   قرر ما إذا كان `organizations.logo_url` يمثل الشعار الرئيسي للمؤسسة (يُحتفظ به) أو إذا كان مكرراً مع `organization_settings.logo_url`.
        *   إذا كان `organization_settings.logo_url` هو المصدر المعتمد لشعار واجهة المتجر، يمكن إزالة `organizations.logo_url` أو جعله `NULL` إذا لم يكن له استخدام آخر واضح.

### 1.2. جدول `organization_settings`

*   **الوضع الحالي:** يخزن إعدادات مظهر المتجر (الألوان، النمط، اسم الموقع، الشعار، إلخ).
*   **التحسينات المقترحة:**
    1.  **تأكيد المسؤولية:** تأكد من أن هذا الجدول هو المصدر الوحيد لإعدادات مظهر واجهة المتجر.
    2.  **توحيد `logo_url`:** يجب أن يحتوي على `logo_url` المستخدم لواجهة المتجر. تأكد من تحديث هذا الحقل إذا تم تغيير الشعار وتوحيده مع `organizations.logo_url` حسب القرار المتخذ.
    3.  **الفهرسة:** تأكد من وجود فهرس على `organization_id`.

### 1.3. جدول `store_settings`

*   **الوضع الحالي:** يستخدم نموذج `component_type` و `settings` (jsonb) لإدارة مكونات المتجر المتقدمة (SEO، بكسلات التتبع، إلخ).
*   **التحسينات المقترحة:**
    1.  **القيود (Constraints) على `component_type`:**
        *   إذا كانت هناك مجموعة معروفة ومحدودة من قيم `component_type`، فكر في إنشاء جدول `component_types (id SERIAL PRIMARY KEY, name TEXT UNIQUE)` وجعل `store_settings.component_type` مفتاحًا أجنبيًا يشير إليه، أو استخدم `ENUM` type في PostgreSQL.
        *   هذا يعزز سلامة البيانات ويوفر قائمة منسدلة محتملة في الواجهة الأمامية.
    2.  **الفهرسة:**
        *   تأكد من وجود فهرس على `organization_id`.
        *   أنشئ فهرسًا مركبًا على `(organization_id, component_type)`.
        *   ضع في اعتبارك فهرسًا على `(organization_id, component_type, is_active)` إذا كان يتم التصفية بناءً على المكونات النشطة بشكل شائع.

### 1.4. جدول `seo_cache`

*   **الوضع الحالي:** يخزن محتوى SEO المولد مسبقًا (مثل `robots.txt`, `sitemap.xml`).
*   **التحسينات المقترحة:**
    1.  **إدارة `seo_cache`:**
        *   تأكد من وجود آلية قوية (triggers في PostgreSQL، دوال مجدولة، أو منطق برمجي في `lib/api/settings.ts` بعد الحفظ) لتحديث/إلغاء صلاحية إدخالات `seo_cache` عند تعديل إعدادات SEO ذات الصلة في `store_settings`.
    2.  **القيود على `cache_type`:**
        *   مشابه لـ `component_type`، إذا كانت هناك مجموعة معروفة ومحدودة من قيم `cache_type` (مثل 'robots.txt', 'sitemap.xml', 'meta_tags_homepage')، فكر في استخدام `ENUM` type أو جدول بحث منفصل.
    3.  **الفهرسة:**
        *   أنشئ فهرسًا على `(organization_id, cache_type)`.
        *   ضع في اعتبارك فهرسًا على `expires_at` إذا كانت هناك عملية مجدولة لتنظيف الإدخالات منتهية الصلاحية.

### 1.5. جدول `landing_page_components`

*   **الوضع الحالي:** يخزن مكونات صفحات الهبوط وترتيبها وإعداداتها.
*   **التحسينات المقترحة:**
    1.  **القيود على `type` (نوع المكون):**
        *   مشابه لـ `store_settings.component_type`، ضع في اعتبارك استخدام `ENUM` أو جدول بحث لأنواع المكونات المتاحة (مثل 'HeroBanner', 'ProductGrid', 'Testimonials').
    2.  **الفهرسة:**
        *   تأكد من وجود فهرس على `landing_page_id`.
        *   أنشئ فهرسًا مركبًا على `(landing_page_id, is_active, position)` لتسريع جلب المكونات النشطة والمرتبة للصفحة.

## 2. تحسينات الواجهة الأمامية (`dashboard/store-editor` والمكونات ذات الصلة)

1.  **مصدر واحد للحقيقة للبيانات:**
    *   تأكد من أن الواجهة الأمامية تقرأ وتكتب إعدادات المظهر (الألوان، النمط، الشعار) من وإلى جدول `organization_settings` فقط (بعد التوحيد والترحيل).
    *   قراءة `trial_end_date` من العمود المخصص الجديد في `organizations`.
2.  **التعامل مع `store_settings` و `landing_page_components`:**
    *   استمر في استخدام `store_settings` لإدارة المكونات الإضافية (SEO، تتبع، إلخ) وأنواع بيانات TypeScript قوية لكل `component_type`.
    *   عند حفظ التغييرات في `store_settings` (خاصة إعدادات SEO)، تأكد من أن الواجهة الخلفية أو آلية قاعدة البيانات تقوم بتحديث `seo_cache`.
    *   بالنسبة لمحرر صفحات الهبوط، تأكد من أن الواجهة الأمامية تتعامل بشكل صحيح مع `landing_page_components` لجلب وعرض المكونات وترتيبها وإعداداتها.
3.  **تنظيم الكود:**
    *   استمر في استخدام الـ Hooks المخصصة (مثل `useOrganizationSettings`) لتغليف منطق جلب البيانات وإدارة الحالة.
    *   تأكد من أن `lib/api/settings.ts` (أو ملفات API مشابهة) تحتوي على منطق تفاعلات قاعدة البيانات بشكل نظيف ومنظم.
    *   حافظ على تحديث ملفات الأنواع (`types/settings.ts`, `types/store-editor.ts` إلخ) لتعكس أي تغييرات في هياكل البيانات.

## 3. خطوات التنفيذ المقترحة (لتغييرات قاعدة البيانات)

1.  **النسخ الاحتياطي الكامل لقاعدة البيانات.**
2.  **تطبيق تغييرات المخطط تدريجياً:**
    *   أضف الأعمدة الجديدة المقترحة (مثل `organizations.trial_end_date`).
    *   أنشئ الجداول المساعدة المقترحة (مثل `component_types` إذا تم اختيار هذا النهج).
3.  **كتابة وتشغيل سكربتات ترحيل البيانات:**
    *   لترحيل `trial_end_date`.
    *   لتوحيد `logo_url`.
    *   لإزالة المفاتيح المكررة من حقول JSONB قبل إزالة الحقول نفسها.
4.  **تطبيق بقية تغييرات المخطط:**
    *   إزالة الأعمدة والحقول المكررة (مثل `organizations.settings`).
    *   إضافة المفاتيح الأجنبية والقيود الجديدة.
    *   إنشاء الفهارس المقترحة.
5.  **تحديث كود التطبيق (الواجهة الخلفية والأمامية):**
    *   تعديل الاستعلامات والدوال في `lib/api/settings.ts` وغيرها لتعكس مخطط قاعدة البيانات الجديد.
    *   تحديث مكونات الواجهة الأمامية والـ Hooks.
6.  **الاختبار الشامل:**
    *   اختبار جميع وظائف محرر الإعدادات والمتجر العام.
    *   التحقق من صحة البيانات بعد الترحيل.

## 4. ملاحظات إضافية

*   التواصل المستمر بين فريق الواجهة الأمامية وفريق الواجهة الخلفية (إذا كانا منفصلين) ضروري أثناء تنفيذ هذه التغييرات.
*   مراجعة أداء الاستعلامات بعد إنشاء الفهارس الجديدة للتأكد من فعاليتها.

---

هذه الخطة هي نقطة انطلاق. قد تحتاج إلى تعديلها بناءً على تفاصيل إضافية تظهر أثناء التنفيذ.
