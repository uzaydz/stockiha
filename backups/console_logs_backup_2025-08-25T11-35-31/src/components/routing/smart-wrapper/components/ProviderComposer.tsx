/**
 * ğŸ­ Provider Composer
 * Ù…Ø¤Ù„Ù Ø§Ù„Ù…Ø²ÙˆØ¯ÙŠÙ† Ø§Ù„Ù…Ø­Ø³Ù† Ù„Ù„Ø£Ø¯Ø§Ø¡
 * Ù…ÙƒÙˆÙ† Ù…Ù†ÙØµÙ„ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ³Ù‡ÙˆÙ„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©
 */

import React, { memo, useMemo, useRef, useEffect } from 'react';
import { ProviderComposition } from '../ConditionalProviders';
import { SmartErrorBoundary, AuthErrorBoundary, DataErrorBoundary } from '../ErrorBoundaries';
import type { PageType, ProviderConfig } from '../types';

interface ProviderComposerProps {
  config: ProviderConfig;
  pageType: PageType;
  pathname: string;
  children: React.ReactNode;
}

export const ProviderComposer = memo<ProviderComposerProps>(({ 
  config, 
  pageType, 
  pathname, 
  children 
}) => {
  
  // ğŸ”¥ Ø§Ø³ØªØ®Ø¯Ø§Ù… useRef Ù„Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªÙƒØ±Ø±
  const renderCount = useRef(0);
  const isInitialized = useRef(false);
  const lastConfig = useRef<ProviderConfig | null>(null);
  const lastPageType = useRef<PageType | null>(null);
  const lastPathname = useRef<string | null>(null);
  
  renderCount.current++;
  
  // ğŸ”¥ Memoized provider composition Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
  const providerContent = useMemo(() => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©
    if (
      lastConfig.current === config &&
      lastPageType.current === pageType &&
      lastPathname.current === pathname
    ) {
      return (
        <ProviderComposition
          config={config}
          pageType={pageType}
          pathname={pathname}
        >
          {children}
        </ProviderComposition>
      );
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©
    lastConfig.current = config;
    lastPageType.current = pageType;
    lastPathname.current = pathname;

    return (
      <ProviderComposition
        config={config}
        pageType={pageType}
        pathname={pathname}
      >
        {children}
      </ProviderComposition>
    );
  }, [config, pageType, pathname, children]);

  // ğŸ›¡ï¸ Error boundary wrapped content Ù…Ø¹ memoization Ù…Ø­Ø³Ù†
  const errorBoundaryContent = useMemo(() => {
    return (
      <SmartErrorBoundary
        pageType={pageType}
        pathname={pathname}
        enableRecovery={true}
      >
        <AuthErrorBoundary pageType={pageType}>
          <DataErrorBoundary pageType={pageType}>
            {providerContent}
          </DataErrorBoundary>
        </AuthErrorBoundary>
      </SmartErrorBoundary>
    );
  }, [pageType, pathname, providerContent]);

  // ğŸ”¥ Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…ØªÙƒØ±Ø±
  useEffect(() => {
    if (isInitialized.current) {
      return;
    }
    isInitialized.current = true;
  }, []);

  // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØºÙ„Ù Ø¨Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
  return errorBoundaryContent;
});

ProviderComposer.displayName = 'ProviderComposer';
