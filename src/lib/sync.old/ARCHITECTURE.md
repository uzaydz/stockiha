# ğŸ—ï¸ Sync Architecture - Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØªØ¨Ø¹ Ù†Ù…Ø· **Local-First, Offline-First** Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ²Ø§Ù…Ù† (Concurrency).

## ğŸ”— Ø§Ù„Ù…ØµØ§Ø¯Ø± ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹

- [SQLite WAL Mode](https://sqlite.org/wal.html)
- [SQLite Concurrent Writes](https://tenthousandmeters.com/blog/sqlite-concurrent-writes-and-database-is-locked-errors/)
- [BEGIN IMMEDIATE Transactions](https://sqlite.org/lang_transaction.html)
- [Tauri SQL Plugin](https://v2.tauri.app/plugin/sql/)
- [Offline-First Architecture](https://developer.android.com/topic/architecture/data-layer/offline-first)
- [async-mutex Pattern](https://www.npmjs.com/package/async-mutex)

---

## ğŸ›ï¸ Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ØªØ·Ø¨ÙŠÙ‚ React / Tauri                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    UI Components                          â”‚  â”‚
â”‚  â”‚   (POSAdvanced, Categories, Products, etc.)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Context Providers                            â”‚  â”‚
â”‚  â”‚   (AuthContext, POSDataContext, CustomersContext)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                API Services Layer                         â”‚  â”‚
â”‚  â”‚   localPosOrderService, localProductService, etc.         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            âš¡ DatabaseCoordinator (NEW!)                  â”‚  â”‚
â”‚  â”‚   - Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª          â”‚  â”‚
â”‚  â”‚   - ÙŠÙØµÙ„ Ø¹Ù…Ù„ÙŠØ§Øª POS Ø¹Ù† Ø¹Ù…Ù„ÙŠØ§Øª Sync                      â”‚  â”‚
â”‚  â”‚   - ÙŠØ¹Ø·ÙŠ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©                       â”‚  â”‚
â”‚  â”‚   - ÙŠÙˆÙ‚Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              DeltaWriteService                            â”‚  â”‚
â”‚  â”‚   - ÙˆØ§Ø¬Ù‡Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø©                                  â”‚  â”‚
â”‚  â”‚   - Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ù€ Outbox                              â”‚  â”‚
â”‚  â”‚   - ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Delta operations)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SQLiteWriteQueue                             â”‚  â”‚
â”‚  â”‚   - Single Writer Pattern                                 â”‚  â”‚
â”‚  â”‚   - BEGIN IMMEDIATE Ù„ØªØ¬Ù†Ø¨ deadlocks                       â”‚  â”‚
â”‚  â”‚   - Priority Queue (critical > high > normal > low)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              SQLite Database (Tauri)                      â”‚  â”‚
â”‚  â”‚   - WAL Mode (concurrent reads + single writer)           â”‚  â”‚
â”‚  â”‚   - busy_timeout = 60000ms                                â”‚  â”‚
â”‚  â”‚   - cache_size = 64MB                                     â”‚  â”‚
â”‚  â”‚   - mmap_size = 256MB                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚         â”‚                                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ PushEngine  â”‚                  â”‚ PullEngine  â”‚               â”‚
â”‚  â”‚ (Upload)    â”‚                  â”‚ (Download)  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                                â”‚                      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                         â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                   â”‚  Supabase   â”‚
                   â”‚  Cloud DB   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ DatabaseCoordinator (Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ)

### Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª

1. **Mutex Ù…Ø±ÙƒØ²ÙŠ** - ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ¹Ø§Ø±Ø¶Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
2. **ÙØµÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª** - ÙŠÙØ±Ù‚ Ø¨ÙŠÙ† Ø¹Ù…Ù„ÙŠØ§Øª POS Ùˆ Sync
3. **Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©** - ÙŠØ¹Ø·ÙŠ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø© (POS)
4. **Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©** - ÙŠÙˆÙ‚Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©

### ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

```typescript
import { databaseCoordinator } from '@/lib/sync/core/DatabaseCoordinator';

// âœ… Ø¹Ù…Ù„ÙŠØ§Øª POS (Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚ØµÙˆÙ‰)
const result = await databaseCoordinator.executePOS(
  async () => createOrder(orderData),
  'Create POS Order'
);

// âœ… Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ø¯ÙŠØ©)
const result = await databaseCoordinator.executeSyncPush(
  async () => pushToServer(data),
  'Push orders batch'
);

// âœ… Ø¹Ù…Ù„ÙŠØ§Øª Realtime (Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©)
const result = await databaseCoordinator.executeRealtime(
  async () => handleRealtimeUpdate(data),
  'Realtime product update'
);
```

### Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª

| Ø§Ù„Ù†ÙˆØ¹ | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© | Ø§Ù„ÙˆØµÙ |
|-------|----------|-------|
| POS | `critical` | Ø¥Ù†Ø´Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª |
| Realtime | `high` | ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± |
| Sync Push | `normal` | Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª |
| Sync Pull | `low` | Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª |

---

## ğŸ“ SQLiteWriteQueue (Single Writer Pattern)

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙŠ ÙŠØ­Ù„Ù‡Ø§

```
âŒ Ø¨Ø¯ÙˆÙ† Queue:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order    â”‚  â”‚ Realtime â”‚  â”‚ SyncPull â”‚
â”‚ Create   â”‚  â”‚ Update   â”‚  â”‚ Write    â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚            â”‚             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  SQLite DB  â”‚
           â”‚ (LOCKED!)   â”‚  â† ğŸ’¥ "database is locked"
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Ù…Ø¹ Queue:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Order    â”‚  â”‚ Realtime â”‚  â”‚ SyncPull â”‚
â”‚ Create   â”‚  â”‚ Update   â”‚  â”‚ Write    â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚            â”‚             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SQLiteWrite    â”‚
        â”‚ Queue (FIFO)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  SQLite DB  â”‚
           â”‚ (ONE Writer)â”‚  â† âœ… Ù„Ø§ Ù…Ø´Ø§ÙƒÙ„!
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ø§Ù„Ù…ÙŠØ²Ø§Øª

1. **BEGIN IMMEDIATE** - ÙŠØ­Ø¬Ø² Ø§Ù„Ù‚ÙÙ„ ÙÙˆØ±Ø§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Transaction
2. **Priority Queue** - Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø© ØªÙÙ†ÙØ° Ø£ÙˆÙ„Ø§Ù‹
3. **inTransaction flag** - ÙŠÙ…Ù†Ø¹ deadlock Ø¯Ø§Ø®Ù„ Transactions
4. **Automatic retry** - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù‚ÙÙ„

---

## ğŸ”„ ØªØ¯ÙÙ‚ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ÙŠØ© POS

```
1. User clicks "Complete Order"
   â”‚
   â–¼
2. POSAdvanced.handleSubmitOrder()
   â”‚
   â–¼
3. usePOSOrder.submitOrder()
   â”‚
   â–¼
4. âš¡ databaseCoordinator.executePOS()
   â”‚  â”œâ”€ ÙŠÙˆÙ‚Ù Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
   â”‚  â””â”€ ÙŠØ­ØªØ¬Ø² Ø§Ù„Ù‚ÙÙ„ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
   â”‚
   â–¼
5. localPosOrderService.createLocalPOSOrder()
   â”‚
   â–¼
6. deltaWriteService.createOrderWithItems()
   â”‚
   â–¼
7. sqliteWriteQueue.transaction()
   â”‚  â””â”€ BEGIN IMMEDIATE
   â”‚
   â–¼
8. INSERT INTO orders (...)
   â”‚
   â–¼
9. INSERT INTO order_items (...)
   â”‚
   â–¼
10. UPDATE products SET stock = stock - quantity
    â”‚
    â–¼
11. INSERT INTO sync_outbox (orders INSERT)
    â”‚
    â–¼
12. INSERT INTO sync_outbox (order_items INSERT)
    â”‚
    â–¼
13. COMMIT
    â”‚
    â–¼
14. âš¡ Release lock + Resume sync
    â”‚
    â–¼
15. âœ… Return result to UI
```

---

## ğŸ“Š Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SQLite Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†Ø©

```sql
-- WAL Mode - ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
PRAGMA journal_mode = WAL;

-- Synchronous = NORMAL - ØªÙˆØ§Ø²Ù† Ø¨ÙŠÙ† Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡
PRAGMA synchronous = NORMAL;

-- Busy Timeout = 60 Ø«Ø§Ù†ÙŠØ© - Ø£Ù‡Ù… Ø¥Ø¹Ø¯Ø§Ø¯!
PRAGMA busy_timeout = 60000;

-- Cache Size = 64MB - ÙƒØ§Ø´ Ø£ÙƒØ¨Ø± = Ø£Ø¯Ø§Ø¡ Ø£ÙØ¶Ù„
PRAGMA cache_size = -64000;

-- Temp Store = Memory - Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
PRAGMA temp_store = MEMORY;

-- MMap Size = 256MB - memory-mapped I/O
PRAGMA mmap_size = 268435456;

-- WAL Auto Checkpoint = 1000 ØµÙØ­Ø©
PRAGMA wal_autocheckpoint = 1000;

-- Locking Mode = Normal - ÙŠØ³Ù…Ø­ Ø¨Ø¹Ø¯Ø© connections
PRAGMA locking_mode = NORMAL;
```

---

## ğŸ› ï¸ Ø§Ø³ØªÙƒØ´Ø§Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡

### "database is locked"

**Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨:**
1. Ø¹Ù…Ù„ÙŠØ§Øª Ù…ØªØ²Ø§Ù…Ù†Ø© ØªØªØµØ§Ø±Ø¹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨Ø©
2. Transaction Ø·ÙˆÙŠÙ„Ø© ØªØ­Ø¬Ø² Ø§Ù„Ù‚ÙÙ„
3. busy_timeout Ù…Ù†Ø®ÙØ¶ Ø¬Ø¯Ø§Ù‹

**Ø§Ù„Ø­Ù„ÙˆÙ„:**
1. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… `DatabaseCoordinator` Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
2. Ø§Ø¬Ø¹Ù„ Transactions Ù‚ØµÙŠØ±Ø© Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†
3. ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SQLite (Ø®Ø§ØµØ© busy_timeout)

### Ø¨Ø·Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª

**Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨:**
1. Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø§Øª Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„Ø©
2. Pull Sync ÙƒØ¨ÙŠØ± ÙŠØ­Ø¬Ø² Ø§Ù„Ù‚ÙÙ„
3. Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… batching

**Ø§Ù„Ø­Ù„ÙˆÙ„:**
1. Ø§Ø³ØªØ®Ø¯Ù… batch inserts (50-100 Ø³Ø¬Ù„ per batch)
2. Ù‚Ø³Ù‘Ù… Pull Sync Ø¥Ù„Ù‰ Ø¯ÙØ¹Ø§Øª Ø£ØµØºØ±
3. Ø§Ø³ØªØ®Ø¯Ù… `databaseCoordinator.executePOS()` Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø±Ø¬Ø©

### Ø§Ù„ØªØ´Ø®ÙŠØµ

```typescript
// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø³Ù‚
const diagnosis = databaseCoordinator.diagnose();
console.log(diagnosis);

// Ù…Ø«Ø§Ù„ Ø§Ù„Ù†Ø§ØªØ¬:
{
  lockState: {
    isLocked: false,
    heldBy: null,
    waitingCount: 0
  },
  stats: {
    totalOperations: 150,
    posOperations: 45,
    syncOperations: 105,
    averageWaitTime: 12,
    maxWaitTime: 500,
    lockContentions: 3
  },
  syncPaused: false,
  recommendations: []
}
```

---

## ğŸ“ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª

```
src/lib/sync/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ DatabaseCoordinator.ts  âš¡ NEW - Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ
â”‚   â”œâ”€â”€ SQLiteWriteQueue.ts     - Single Writer Pattern
â”‚   â”œâ”€â”€ SyncManager.ts          - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â”‚   â”œâ”€â”€ PushEngine.ts           - Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
â”‚   â””â”€â”€ PullEngine.ts           - Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
â”œâ”€â”€ queue/
â”‚   â””â”€â”€ OutboxManager.ts        - Ø¥Ø¯Ø§Ø±Ø© ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØµØ§Ø¯Ø±
â”œâ”€â”€ config.ts                   - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
â””â”€â”€ ARCHITECTURE.md             - Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù
```

---

## âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„ØªÙ†ÙÙŠØ°

- [x] ØªÙØ¹ÙŠÙ„ WAL mode
- [x] Ø¶Ø¨Ø· busy_timeout = 60000
- [x] Ø§Ø³ØªØ®Ø¯Ø§Ù… BEGIN IMMEDIATE
- [x] Ø¥Ù†Ø´Ø§Ø¡ DatabaseCoordinator
- [x] ØªØ­Ø¯ÙŠØ« localPosOrderService
- [ ] ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£Ø®Ø±Ù‰
- [ ] Ø¥Ø¶Ø§ÙØ© ØªØ´Ø®ÙŠØµØ§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
- [ ] Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø¡ ØªØ­Øª Ø§Ù„Ø­Ù…Ù„

---

## ğŸ“ˆ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹

| Ø§Ù„Ø¹Ù…Ù„ÙŠØ© | Ù‚Ø¨Ù„ | Ø¨Ø¹Ø¯ |
|---------|-----|-----|
| Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ÙŠØ© (Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯) | 5-15 Ø«Ø§Ù†ÙŠØ© | < 500ms |
| Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ÙŠØ© (10 Ø¹Ù†Ø§ØµØ±) | 20-90 Ø«Ø§Ù†ÙŠØ© | < 1 Ø«Ø§Ù†ÙŠØ© |
| Ù…Ø²Ø§Ù…Ù†Ø© 100 Ø·Ù„Ø¨ÙŠØ© | 5-10 Ø¯Ù‚Ø§Ø¦Ù‚ | < 30 Ø«Ø§Ù†ÙŠØ© |
| Database locked errors | Ù…ØªÙƒØ±Ø±Ø© | Ù†Ø§Ø¯Ø±Ø© Ø¬Ø¯Ø§Ù‹ |
