<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”’ Ø§Ø®ØªØ¨Ø§Ø± Sync Lock Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .info-box {
            background: #f0f4ff;
            border-right: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .info-box p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .tab-info {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .tab-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #ff6b6b;
            font-size: 14px;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-acquire {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-release {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-check {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-cleanup {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .log-container {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            line-height: 1.4;
        }

        .log-info {
            color: #4fc3f7;
        }

        .log-success {
            color: #81c784;
            background: rgba(129, 199, 132, 0.1);
        }

        .log-warning {
            color: #ffb74d;
            background: rgba(255, 183, 77, 0.1);
        }

        .log-error {
            color: #e57373;
            background: rgba(229, 115, 115, 0.1);
        }

        .log-lock {
            color: #ba68c8;
            background: rgba(186, 104, 200, 0.1);
        }

        .timestamp {
            color: #757575;
            font-size: 11px;
        }

        .lock-status {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .status-card {
            flex: 1;
            min-width: 200px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .status-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .status-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .heartbeat {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ Ø§Ø®ØªØ¨Ø§Ø± Sync Lock Manager</h1>
        <p class="subtitle">Ø§ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙŠ Ø¹Ø¯Ø© ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† Ø§Ù„Ù†ÙˆØ§ÙØ°</p>

        <div class="tab-info">
            <strong>ğŸ·ï¸ Ù…Ø¹Ø±Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨:</strong><br>
            <span class="tab-id" id="tabId">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>

        <div class="info-box">
            <h3>ğŸ“‹ ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h3>
            <p><strong>1.</strong> Ø§ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø±</p>
            <p><strong>2.</strong> ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ØŒ Ø§Ø¶ØºØ· "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„"</p>
            <p><strong>3.</strong> ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠØŒ Ø§Ø¶ØºØ· "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„" Ø£ÙŠØ¶Ø§Ù‹</p>
            <p><strong>4.</strong> ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙØ´Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙˆÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© "Ø§Ù„Ù‚ÙÙ„ Ù…Ø­Ø¬ÙˆØ² Ø¨ÙˆØ§Ø³Ø·Ø© ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±"</p>
            <p><strong>5.</strong> ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ØŒ Ø§Ø¶ØºØ· "Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù‚ÙÙ„"</p>
            <p><strong>6.</strong> Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ† Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„</p>
        </div>

        <div class="buttons">
            <button class="btn-acquire" onclick="acquireLock()">
                ğŸ”’ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„
            </button>
            <button class="btn-release" onclick="releaseLock()">
                ğŸ”“ Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù‚ÙÙ„
            </button>
            <button class="btn-check" onclick="checkLockStatus()">
                ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
            </button>
            <button class="btn-cleanup" onclick="cleanupLocks()">
                ğŸ§¹ ØªÙ†Ø¸ÙŠÙ ÙƒÙ„ Ø§Ù„Ø£Ù‚ÙØ§Ù„
            </button>
        </div>

        <div class="lock-status">
            <div class="status-card">
                <h4>Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„</h4>
                <div class="value" id="lockStatus">-</div>
            </div>
            <div class="status-card">
                <h4>Ù…Ø¹Ø±Ù Ø§Ù„Ù‚ÙÙ„</h4>
                <div class="value" id="currentLockId" style="font-size: 12px;">-</div>
            </div>
            <div class="status-card">
                <h4>Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø§Ù„Ùƒ</h4>
                <div class="value" id="lockOwner" style="font-size: 12px;">-</div>
            </div>
        </div>

        <h3 style="margin: 30px 0 15px; color: #667eea;">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:</h3>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script type="module">
        // Ù…Ø­Ø§ÙƒØ§Ø© SyncLockManager Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const TAB_ID = `tab_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        let currentLockId = null;
        let heartbeatInterval = null;

        // Ø¹Ø±Ø¶ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        document.getElementById('tabId').textContent = TAB_ID;

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø³Ø¬Ù„
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;

            const timestamp = new Date().toLocaleTimeString('ar-SA');
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;

            container.insertBefore(entry, container.firstChild);

            // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 50 entry
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function updateUI() {
            const lockData = getLockData();
            const statusEl = document.getElementById('lockStatus');
            const lockIdEl = document.getElementById('currentLockId');
            const ownerEl = document.getElementById('lockOwner');

            if (lockData) {
                const isOurs = lockData.tabId === TAB_ID;
                statusEl.textContent = isOurs ? 'ğŸŸ¢ Ù…Ø­Ø¬ÙˆØ² (Ø£Ù†Øª)' : 'ğŸ”´ Ù…Ø­Ø¬ÙˆØ²';
                statusEl.className = isOurs ? 'value heartbeat' : 'value';
                lockIdEl.textContent = lockData.lockId.substring(0, 20) + '...';
                ownerEl.textContent = lockData.tabId === TAB_ID ? 'Ø£Ù†Øª' : lockData.tabId.substring(0, 15) + '...';
            } else {
                statusEl.textContent = 'âšª Ù…ØªØ§Ø­';
                statusEl.className = 'value';
                lockIdEl.textContent = '-';
                ownerEl.textContent = '-';
            }
        }

        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚ÙÙ„
        function getLockData() {
            try {
                const data = localStorage.getItem('sync_lock_products');
                if (!data) return null;

                const lockData = JSON.parse(data);
                const now = Date.now();
                const elapsed = now - lockData.lastHeartbeat;

                // Ø¥Ø°Ø§ Ù…Ø¶Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ© Ø¨Ø¯ÙˆÙ† heartbeatØŒ Ø§Ù„Ù‚ÙÙ„ Ù…Ù†ØªÙ‡ÙŠ
                if (elapsed > 30000) {
                    log('â±ï¸ Ø§Ù„Ù‚ÙÙ„ Ù…Ù†ØªÙ‡ÙŠ (Ù„Ø§ heartbeat Ù…Ù†Ø° ${Math.floor(elapsed / 1000)} Ø«Ø§Ù†ÙŠØ©)', 'warning');
                    return null;
                }

                return lockData;
            } catch (error) {
                return null;
            }
        }

        // Ø¨Ø¯Ø¡ heartbeat
        function startHeartbeat(lockId) {
            stopHeartbeat();

            heartbeatInterval = setInterval(() => {
                const lockData = getLockData();

                if (lockData && lockData.lockId === lockId && lockData.tabId === TAB_ID) {
                    lockData.lastHeartbeat = Date.now();
                    localStorage.setItem('sync_lock_products', JSON.stringify(lockData));
                    log('ğŸ’“ Heartbeat', 'info');
                    updateUI();
                } else {
                    stopHeartbeat();
                    log('âš ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Heartbeat (Ø§Ù„Ù‚ÙÙ„ Ù„Ù… ÙŠØ¹Ø¯ Ù…Ù„ÙƒÙ†Ø§)', 'warning');
                }
            }, 5000);
        }

        // Ø¥ÙŠÙ‚Ø§Ù heartbeat
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„
        window.acquireLock = async function() {
            log('ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„...', 'info');

            const existingLock = getLockData();

            if (existingLock) {
                if (existingLock.tabId === TAB_ID) {
                    log('âš ï¸ Ù„Ø¯ÙŠÙƒ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø§Ù„ÙØ¹Ù„!', 'warning');
                } else {
                    const remaining = Math.ceil((30000 - (Date.now() - existingLock.lastHeartbeat)) / 1000);
                    log(`âŒ Ø§Ù„Ù‚ÙÙ„ Ù…Ø­Ø¬ÙˆØ² Ø¨ÙˆØ§Ø³Ø·Ø© ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø± (${remaining}Ø« Ù…ØªØ¨Ù‚ÙŠØ©)`, 'error');
                }
                updateUI();
                return;
            }

            const lockId = `lock_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const now = Date.now();

            const lockData = {
                lockId,
                tabId: TAB_ID,
                startTime: now,
                lastHeartbeat: now,
                timeout: 30000,
                status: 'active'
            };

            localStorage.setItem('sync_lock_products', JSON.stringify(lockData));

            // Ø§Ù†ØªØ¸Ø± 100ms Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† race condition
            await new Promise(resolve => setTimeout(resolve, 100));

            const verifyLock = getLockData();
            if (verifyLock && verifyLock.lockId === lockId && verifyLock.tabId === TAB_ID) {
                currentLockId = lockId;
                startHeartbeat(lockId);
                log('âœ… ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                log(`ğŸ”‘ Ù…Ø¹Ø±Ù Ø§Ù„Ù‚ÙÙ„: ${lockId}`, 'lock');
            } else {
                log('âŒ ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„ (race condition)', 'error');
            }

            updateUI();
        };

        // Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù‚ÙÙ„
        window.releaseLock = function() {
            if (!currentLockId) {
                log('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚ÙÙ„ Ù„Ø¥Ø·Ù„Ø§Ù‚Ù‡', 'warning');
                return;
            }

            const lockData = getLockData();

            if (!lockData || lockData.lockId !== currentLockId || lockData.tabId !== TAB_ID) {
                log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù‚ÙÙ„: Ø§Ù„Ù‚ÙÙ„ Ù„Ø§ ÙŠÙ†ØªÙ…ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ¨ÙˆÙŠØ¨', 'warning');
                return;
            }

            stopHeartbeat();
            localStorage.removeItem('sync_lock_products');
            log(`ğŸ”“ ØªÙ… Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ù‚ÙÙ„: ${currentLockId}`, 'success');
            currentLockId = null;
            updateUI();
        };

        // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
        window.checkLockStatus = function() {
            const lockData = getLockData();

            if (lockData) {
                const isOurs = lockData.tabId === TAB_ID;
                const elapsed = Math.floor((Date.now() - lockData.startTime) / 1000);
                const sinceHeartbeat = Math.floor((Date.now() - lockData.lastHeartbeat) / 1000);

                log(`ğŸ” Ø§Ù„Ù‚ÙÙ„ Ù…Ø­Ø¬ÙˆØ² ${isOurs ? '(Ø£Ù†Øª)' : '(ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±)'}`, 'info');
                log(`â±ï¸ Ù…Ø¶Ù‰ ${elapsed}Ø« Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©ØŒ ${sinceHeartbeat}Ø« Ù…Ù†Ø° Ø¢Ø®Ø± heartbeat`, 'info');
                log(`ğŸ·ï¸ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø§Ù„Ùƒ: ${lockData.tabId}`, 'info');
            } else {
                log('âœ… Ø§Ù„Ù‚ÙÙ„ Ù…ØªØ§Ø­ (ØºÙŠØ± Ù…Ø­Ø¬ÙˆØ²)', 'success');
            }

            updateUI();
        };

        // ØªÙ†Ø¸ÙŠÙ ÙƒÙ„ Ø§Ù„Ø£Ù‚ÙØ§Ù„
        window.cleanupLocks = function() {
            stopHeartbeat();
            localStorage.removeItem('sync_lock_products');
            currentLockId = null;
            log('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ ÙƒÙ„ Ø§Ù„Ø£Ù‚ÙØ§Ù„', 'success');
            updateUI();
        };

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù† ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø£Ø®Ø±Ù‰
        window.addEventListener('storage', (event) => {
            if (event.key === 'sync_lock_products') {
                if (!event.newValue) {
                    log('ğŸ“¢ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø± Ø£Ø·Ù„Ù‚ Ø§Ù„Ù‚ÙÙ„', 'info');
                    if (currentLockId) {
                        currentLockId = null;
                        stopHeartbeat();
                    }
                } else {
                    const lockData = JSON.parse(event.newValue);
                    if (lockData.tabId !== TAB_ID) {
                        log('ğŸ“¢ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø± Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙÙ„', 'info');
                    }
                }
                updateUI();
            }
        });

        // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.addEventListener('beforeunload', () => {
            if (currentLockId) {
                releaseLock();
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
        setInterval(updateUI, 1000);

        // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ
        updateUI();
        log('ğŸš€ ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø£Ù‚ÙØ§Ù„', 'success');
        log(`ğŸ·ï¸ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨: ${TAB_ID}`, 'info');
    </script>
</body>
</html>
