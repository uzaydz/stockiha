# ุฎุทุฉ ุฅุตูุงุญ ูุธุงู ุงููุฒุงููุฉ ุงูุดุงููุฉ

## ุงููุดุงูู ุงูุฑุฆูุณูุฉ

### 1. ุงุณุชุฏุนุงุกุงุช Supabase ุงูููุฑุฑุฉ (ุงูุชูููุฉ ุงูุนุงููุฉ)
- **ุงูุญุงูู**: 20-30 ุงุณุชุฏุนุงุก ุนูุฏ ูู ุชุญููู ุตูุญุฉ
- **ุงููุทููุจ**: 1-3 ุงุณุชุฏุนุงุกุงุช ููุท

### 2. ุนุฏู ุงุณุชุฎุฏุงู SQLite ุฃููุงู (Local-First)
- **ุงูุญุงูู**: ูุฌูุจ ูู ุงูุณูุฑูุฑ ุซู ูุญูุธ ูู SQLite
- **ุงููุทููุจ**: ููุฑุฃ ูู SQLite ุฃููุงูุ ูุฌูุจ ูู ุงูุณูุฑูุฑ ููุท ุนูุฏ ุงูุญุงุฌุฉ

### 3. ูุญุฑูุงุช ูุฒุงููุฉ ูุชุนุงุฑุถุฉ
- **ุงูุญุงูู**: DeltaSyncEngine + TauriSyncService + AppInitializationService
- **ุงููุทููุจ**: ูุตุฏุฑ ูุงุญุฏ ูููุฒุงููุฉ

### 4. ููุฏุงู ุงูููุชุฌุงุช (6 ุจุฏูุงู ูู 35)
- **ุงูุณุจุจ**: ูุง ุชุชู ุงูููุงุฑูุฉ ูุน ุงูุณูุฑูุฑ ุนูุฏ ูุฌูุฏ ุจูุงูุงุช ูุญููุฉ

---

## ุงูุญู ุงูููุชุฑุญ: Single Source of Truth

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    App Startup                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  1. ูุฑุงุกุฉ ูู SQLite ุฃููุงู (Local-First)                      โ
โ     - ุฅุฐุง ููุฌุฏุช ุจูุงูุงุช โ ุงุณุชุฎุฏููุง ููุฑุงู                      โ
โ     - ุนุฑุถ UI ุจุฏูู ุงูุชุธุงุฑ ุงูุณูุฑูุฑ                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  2. ูุญุต ุงูุญุงุฌุฉ ููุชุญุฏูุซ (ูู ุงูุฎูููุฉ)                          โ
โ     - ุขุฎุฑ ูุฒุงููุฉ > 5 ุฏูุงุฆูุ                                  โ
โ     - ุงูุงุชุตุงู ูุชููุฑุ                                         โ
โ     - ูุฑู ูุจูุฑ ูู ุนุฏุฏ ุงูุณุฌูุงุชุ                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
              โโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ
              โ                               โ
              โผ                               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูุง ุญุงุฌุฉ ููุชุญุฏูุซ        โ     โ  ุชุญุฏูุซ ูุทููุจ            โ
โ  ุงุณุชุฎุฏู ุงูุจูุงูุงุช ุงููุญููุฉ โ     โ  ุฌูุจ ุชุฏุฑูุฌู (Delta)     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                              โ
                                              โผ
                              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ  ุชุญุฏูุซ SQLite + UI      โ
                              โ  (ุจุฏูู ุชูุฑุงุฑ)           โ
                              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Phase 1: ุฅุตูุงุญ ุงููุฑุงุกุฉ ุงููุญููุฉ ุฃููุงู (Local-First)

### ุงููููุงุช ุงููุทููุจ ุชุนุฏูููุง:

#### 1.1 `src/api/appInitializationService.ts`
**ุงููุดููุฉ**: ูุฐูุจ ููุณูุฑูุฑ ูุจุงุดุฑุฉ ุญุชู ูู ูุงูุช ุงูุจูุงูุงุช ููุฌูุฏุฉ ูุญููุงู

**ุงูุฅุตูุงุญ**:
```typescript
// ูุจู
const isOnline = navigator.onLine;
if (!isOnline) {
  // ุงุณุชุฎุฏู ุงููุญูู
}
// ุฐูุจ ููุณูุฑูุฑ ูุจุงุดุฑุฉ

// ุจุนุฏ
// 1. ุงูุฑุฃ ูู SQLite ุฃููุงู
const localData = await sqliteDB.getAppInitCacheById(key);
if (localData.success && localData.data) {
  // ุงุณุชุฎุฏู ุงููุญูู ููุฑุงู
  // ููู ุฌูุจ ุงูุชุญุฏูุซุงุช ูู ุงูุฎูููุฉ
  setTimeout(() => refreshFromServer(), 100);
  return localData.data;
}
// 2. ุฅุฐุง ูู ููุฌุฏ ูุญููุ ุงุฐูุจ ููุณูุฑูุฑ
```

#### 1.2 `src/hooks/useLocalPOSProducts.ts`
**ุงูุญุงูุฉ**: โ ุฌูุฏ - ููุฑุฃ ูู SQLite ุฃููุงู

#### 1.3 `src/context/shop/customers/CustomersContext.tsx`
**ุงููุดููุฉ**: ูุฏ ูุฌูุจ ูู ุงูุณูุฑูุฑ ุจุฏูู ูุญุต ุงููุญูู

---

## Phase 2: ุชูุญูุฏ ูุตุฏุฑ ุงููุฒุงููุฉ

### ุฅูุบุงุก ุงููุฒุงููุฉ ุงูููุฑุฑุฉ:

#### 2.1 `DeltaSyncEngine.fallbackInitialSync()`
**ุงููุดููุฉ**: ูุฌูุจ 10+ ุฌุฏุงูู ุจุดูู ูููุตู

**ุงูุฅุตูุงุญ**: ุงุณุชุฎุฏุงู RPC ูุงุญุฏ ุจุฏูุงู ูู ุงุณุชุฏุนุงุกุงุช ูุชุนุฏุฏุฉ
```typescript
// ูุจู (10+ ุงุณุชุฏุนุงุกุงุช)
for (const table of SYNCED_TABLES) {
  const { data } = await supabase.from(table).select('*');
}

// ุจุนุฏ (ุงุณุชุฏุนุงุก ูุงุญุฏ)
const { data } = await supabase.rpc('get_all_sync_data', {
  p_organization_id: organizationId,
  p_last_sync: lastSyncTime
});
```

#### 2.2 ุฅุฒุงูุฉ ุงูุงุณุชุฏุนุงุกุงุช ุงูุฅุถุงููุฉ ูู `appInitializationService.ts`
- โ `syncSuppliers` โ ูููู ูู DeltaSyncEngine
- โ `syncRepairs` โ ูููู ูู DeltaSyncEngine
- โ `syncDebts` โ ูููู ูู DeltaSyncEngine

---

## Phase 3: ุฅุตูุงุญ ูุดููุฉ ุงูููุชุฌุงุช ุงูููููุฏุฉ

### 3.1 `src/api/productSyncUtils.ts`
**ุงููุดููุฉ**: ูุชุญูู ูู "ูุงุฑุบ" ููุท

**ุงูุฅุตูุงุญ**:
```typescript
// ูุจู
if (!isEmpty) {
  return { needed: false }; // ูุชุฌุงูู ุงููุฑู!
}

// ุจุนุฏ
const localCount = await getLocalProductsCount(organizationId);
const serverCount = await getServerProductsCount(organizationId);
const diff = serverCount - localCount;

// ุฅุฐุง ูุฑู > 5 ุฃู > 20% โ ุฃุนุฏ ุงููุฒุงููุฉ
if (diff > 5 || (serverCount > 0 && diff / serverCount > 0.2)) {
  return await syncProductsFromServer(organizationId);
}
```

### 3.2 ุฅูุดุงุก ุฏุงูุฉ RPC ุฌุฏูุฏุฉ ูู Supabase
```sql
CREATE OR REPLACE FUNCTION get_entity_counts(p_organization_id UUID)
RETURNS JSON AS $$
SELECT json_build_object(
  'products', (SELECT COUNT(*) FROM products WHERE organization_id = p_organization_id AND is_active = true),
  'customers', (SELECT COUNT(*) FROM customers WHERE organization_id = p_organization_id),
  'orders', (SELECT COUNT(*) FROM orders WHERE organization_id = p_organization_id)
);
$$ LANGUAGE sql;
```

---

## Phase 4: ุชุญุณูู ุงูู Cache

### 4.1 ุงุณุชุฎุฏุงู React Query ุจุดูู ุฃูุถู
```typescript
// ูุจู
useQuery({
  queryKey: ['data'],
  staleTime: 5 * 60 * 1000, // 5 ุฏูุงุฆู
});

// ุจุนุฏ
useQuery({
  queryKey: ['data'],
  staleTime: Infinity, // ูุง ููุนุชุจุฑ ูุฏููุงู ุฃุจุฏุงู
  gcTime: 24 * 60 * 60 * 1000, // ูุจูู 24 ุณุงุนุฉ
  initialData: () => getFromSQLite(), // ูุจุฏุฃ ุจุงููุญูู
  refetchOnMount: false,
  refetchOnWindowFocus: false,
});
```

### 4.2 ุญูุธ ููุช ุขุฎุฑ ูุฒุงููุฉ
```typescript
// ูู SQLite
await sqliteDB.execute(`
  INSERT OR REPLACE INTO sync_metadata (entity_type, last_sync, record_count)
  VALUES ('products', ?, ?)
`, [new Date().toISOString(), count]);
```

---

## Phase 5: ุชูููู ุงุณุชุฏุนุงุกุงุช Supabase

### ุฌุฏูู ุงูููุงุฑูุฉ:

| ุงูุนูููุฉ | ูุจู | ุจุนุฏ |
|---------|-----|-----|
| ุชุญููู ุงูุตูุญุฉ ุงูุฃููู | 25-30 ุงุณุชุฏุนุงุก | 1-2 ุงุณุชุฏุนุงุก |
| ุชุญุฏูุซ ุงูุตูุญุฉ | 20-25 ุงุณุชุฏุนุงุก | 0 ุงุณุชุฏุนุงุก (ูู cache) |
| ุจุนุฏ 5 ุฏูุงุฆู | ููุณ ุงูุนุฏุฏ | 1 ุงุณุชุฏุนุงุก (delta only) |

### ุงูุงุณุชุฏุนุงุกุงุช ุงููุทููุจ ุฅุจูุงุคูุง:
1. `get_app_initialization_data` - ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุงูุจุฏุก
2. `get_delta_changes` - ููุชุญุฏูุซุงุช ุงูุชุฏุฑูุฌูุฉ ููุท

### ุงูุงุณุชุฏุนุงุกุงุช ุงููุทููุจ ุฅุฒุงูุชูุง:
- โ `get_user_with_permissions_unified` (ููุฑุฑ)
- โ `fallbackInitialSync` (10+ ุงุณุชุฏุนุงุกุงุช)
- โ `syncSuppliers`, `syncRepairs`, `syncDebts` (ูููุตูุฉ)

---

## ุงูุฃููููุงุช

| ุงูุฃููููุฉ | ุงููููุฉ | ุงูุชุฃุซูุฑ |
|----------|--------|---------|
| ๐ด 1 | Local-First ูู AppInitializationService | ูููู 80% ูู ุงูุงุณุชุฏุนุงุกุงุช |
| ๐ด 2 | ุฅุตูุงุญ productSyncUtils | ูุญู ูุดููุฉ 6 vs 35 |
| ๐ก 3 | ุชูุญูุฏ DeltaSyncEngine | ูููุน ุงูุชูุฑุงุฑ |
| ๐ก 4 | ุชุญุณูู React Query cache | ูุญุณู ุงูุฃุฏุงุก |
| ๐ข 5 | ุฅูุดุงุก RPC ููุญุฏ | ูููู ุงูุงุณุชุฏุนุงุกุงุช ุฃูุซุฑ |

---

## ุงููุชูุฌุฉ ุงููุชููุนุฉ

### ูุจู ุงูุฅุตูุงุญ:
- 25-30 ุงุณุชุฏุนุงุก Supabase ููู ุชุญููู ุตูุญุฉ
- 8-18 ุซุงููุฉ ููุช ุงูุชุญููู
- ููุฏุงู ุงูุจูุงูุงุช ุนูุฏ ุงูุชุญุฏูุซ
- 6 ููุชุฌุงุช ุจุฏูุงู ูู 35

### ุจุนุฏ ุงูุฅุตูุงุญ:
- 1-2 ุงุณุชุฏุนุงุก Supabase ุนูุฏ ุงูุจุฏุก ููุท
- < 1 ุซุงููุฉ ููุช ุงูุชุญููู (ูู SQLite)
- ูุง ููุฏุงู ููุจูุงูุงุช
- ุฌููุน ุงูููุชุฌุงุช ูุชุงุญุฉ

### ุชูููุฑ ุงูุชูููุฉ:
- **ูุจู**: 100,000+ ุงุณุชุฏุนุงุก/ููู
- **ุจุนุฏ**: 5,000-10,000 ุงุณุชุฏุนุงุก/ููู
- **ุงูุชูููุฑ**: 90-95%
