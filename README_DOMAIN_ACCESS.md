# تعديل قواعد الدخول من النطاقات

## المشكلة

في النظام الحالي، لا يمكن للمستخدمين الذين ينتمون لمؤسسة الدخول من النطاق العام (مثل ktobi.online)، وهذا يسبب مشكلة لبعض المستخدمين الذين يرغبون في الدخول من هذه النطاقات العامة.

## الحل المقترح

تم تطوير حل يستوفي المتطلبات التالية:

1. **السماح للجميع بالدخول من النطاق العام** - جميع المستخدمين، سواء كانوا تابعين لمؤسسة أم لا، يمكنهم الدخول من النطاقات العامة (ktobi.online, stockiha.com, bazaar.com, bazaar.dev).

2. **تقييد الدخول من النطاقات الخاصة** - النطاقات الخاصة (سواء الفرعية مثل company.ktobi.online أو الأساسية مثل company.com) تظل متاحة فقط للمستخدمين التابعين للمؤسسة المالكة للنطاق.

## ملفات الحل

يتكون الحل من ملف SQL واحد يحتوي على الدوال التالية:

1. `get_public_domains()` - دالة تُرجع قائمة بالنطاقات العامة.
2. `is_public_domain(p_domain)` - دالة للتحقق مما إذا كان النطاق عاماً.
3. تحديث دالة `check_user_requires_2fa` - لتطبيق القواعد الجديدة.
4. تحديث دالة `verify_domain_access` - للتوافق مع القواعد الجديدة.

## خطوات التنفيذ

1. قم بنسخ محتوى ملف `domain_access_fix.sql` إلى SQL Editor في Supabase.

2. قم بتنفيذ SQL query.

3. اختبر الدخول من النطاق العام والنطاقات الخاصة للتأكد من أن القواعد الجديدة تعمل كما هو متوقع.

## طريقة عمل الحل

1. **النطاق العام** (ktobi.online, stockiha.com, bazaar.com, bazaar.dev):
   - يتم السماح لجميع المستخدمين بالدخول.

2. **النطاق الخاص** (نطاق تابع لمؤسسة محددة):
   - يتم التحقق من أن المستخدم ينتمي للمؤسسة المالكة للنطاق.
   - إذا كان المستخدم من مؤسسة أخرى، يتم رفض الدخول.
   - إذا كان المستخدم من نفس المؤسسة، يتم السماح بالدخول.

## مثال توضيحي

| المستخدم | النطاق | النتيجة | السبب |
|---------|-------|--------|------|
| من المؤسسة A | ktobi.online (نطاق عام) | ✅ مسموح | النطاق العام متاح للجميع |
| من المؤسسة A | companyA.ktobi.online (نطاق خاص للمؤسسة A) | ✅ مسموح | المستخدم ينتمي للمؤسسة المالكة للنطاق |
| من المؤسسة A | companyB.ktobi.online (نطاق خاص للمؤسسة B) | ❌ ممنوع | المستخدم لا ينتمي للمؤسسة المالكة للنطاق |
| مدير عام (بدون مؤسسة) | ktobi.online (نطاق عام) | ✅ مسموح | النطاق العام متاح للجميع |
| مدير عام (بدون مؤسسة) | companyA.ktobi.online (نطاق خاص للمؤسسة A) | ❌ ممنوع | المستخدم لا ينتمي للمؤسسة المالكة للنطاق |

## ملاحظات فنية

- يتم استخدام دالة `is_public_domain` للتحقق مما إذا كان النطاق عاماً أم خاصاً.
- تم تبسيط الكود وتحسين المنطق للتعامل مع جميع حالات الدخول.
- يتم تسجيل محاولات الدخول غير المصرح بها في جدول سجلات الأمان.

## تخصيص إضافي

يمكنك تعديل قائمة النطاقات العامة عن طريق تحديث دالة `get_public_domains()` إذا كان لديك نطاقات عامة إضافية. 