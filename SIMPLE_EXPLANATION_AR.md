# ุดุฑุญ ุจุณูุท ุฌุฏุงู ูููุดุงูู ูุงูุญููู ๐

## ๐ ููุฏูุฉ: ูุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ

ุชุฎูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฎุฒูุฉ ูุจูุฑุฉ ุชุญุชูู ุนูู ุฌููุน ุจูุงูุงุชู (ุงูููุชุฌุงุชุ ุงูุทูุจุงุชุ ุงูุนููุงุกุ ุฅูุฎ).

**ุงููุดููุฉ ุงูุฃุณุงุณูุฉ**: ุนูุฏูุง ุชุฑูุฏ ูุชุญ ุงูุฎุฒูุฉุ ูุฌุจ ุฃู ูููู ููุงู ุดุฎุต ูุงุญุฏ ููุท ููุชุญูุง ูู ูู ูุฑุฉ. ุฅุฐุง ุญุงูู ุดุฎุตุงู ูุชุญูุง ูู ููุณ ุงูููุชุ ุณูุญุฏุซ ุชุนุงุฑุถ!

---

## ๐ด ุงููุดููุฉ ุงูุฃููู: "Database is Locked" (ูุงุนุฏุฉ ุงูุจูุงูุงุช ููููุฉ)

### ูุง ูู ุงููุดููุฉุ

ุนูุฏูุง ุชููู ุจุฅูุดุงุก ุทูุจูุฉ ูู ููุทุฉ ุงูุจูุนุ ูุญุฏุซ ุงูุฎุทุฃ ุงูุชุงูู:
```
error: "database is locked" (code: 5)
```

**ุจุจุณุงุทุฉ**: ุงููุธุงู ูุญุงูู ูุชุญ ุงูุฎุฒูุฉุ ููููุง ููููุฉ ูู ูุจู ุนูููุฉ ุฃุฎุฑู!

### ููุงุฐุง ุชุญุฏุซ ูุฐู ุงููุดููุฉุ

ุฏุนูู ุฃุดุฑุญ ุจุทุฑููุฉ ุจุณูุทุฉ:

#### 1. **ูุดููุฉ ุงูุงุชุตุงูุงุช ุงููุชุนุฏุฏุฉ** ๐

**ุงูุชุดุจูู**: ุชุฎูู ุฃู ูุฏูู ุฎุฒูุฉ ูุงุญุฏุฉุ ููู ูุฏูู 5 ููุงุชูุญ ูุฎุชููุฉ!

**ูุง ูุญุฏุซ ูู ุงูููุฏ**:
- ูู ูุฑุฉ ูุฑูุฏ ุงููุธุงู ุงููุตูู ููุงุนุฏุฉ ุงูุจูุงูุงุชุ ูุฏ ูููุดุฆ "ููุชุงุญ ุฌุฏูุฏ" (connection ุฌุฏูุฏ)
- ุญุชู ูู ูุงู ููุงู "ููุชุงุญ" ููุฌูุฏ ุจุงููุนู!
- ุงููุชูุฌุฉ: ุนุฏุฉ ููุงุชูุญ ุชุญุงูู ูุชุญ ุงูุฎุฒูุฉ ูู ููุณ ุงูููุช = ุชุนุงุฑุถ!

**ูุซุงู ูู ุงูููุฏ**:
```typescript
// โ ุงููุดููุฉ: ูู ูุฑุฉ ูุณุชุฏุนู ensureDb()ุ ูุฏ ูููุดุฆ connection ุฌุฏูุฏ
const db1 = await Database.load('stockiha_org1.db');  // ููุชุงุญ 1
const db2 = await Database.load('stockiha_org1.db');  // ููุชุงุญ 2 (ูุดููุฉ!)
// ุงูุขู ูุฏููุง ููุชุงุญุงู ูุญุงููุงู ูุชุญ ููุณ ุงูุฎุฒูุฉ!
```

#### 2. **ูุดููุฉ Queries ูุชุนุฏุฏุฉ ูู ููุณ ุงูููุช** โฑ๏ธ

**ุงูุชุดุจูู**: ุชุฎูู ุฃูู ุชุฑูุฏ ูุชุงุจุฉ ุดูุก ูู ุฏูุชุฑุ ููู 10 ุฃุดุฎุงุต ุขุฎุฑูู ูุฑูุฏูู ุงููุฑุงุกุฉ ูู ููุณ ุงูุฏูุชุฑ ูู ููุณ ุงูููุช!

**ูุง ูุญุฏุซ ูู ุงูููุฏ**:
- ุนูุฏ ุฅูุดุงุก ุทูุจูุฉ POSุ ุงููุธุงู ูุญุชุงุฌ ููุชุงุจุฉ ุงูุจูุงูุงุช (INSERT)
- ููู ูู ููุณ ุงูููุชุ ููุงู 10+ queries ุฃุฎุฑู ุชุนูู (ูุฑุงุกุฉ ุงูุจูุงูุงุช)
- ุงููุชูุฌุฉ: ุงููุชุงุจุฉ ุชูุชุธุฑ ุญุชู ุชูุชูู ุฌููุน ุงููุฑุงุกุงุช = ุชุฃุฎูุฑ!

**ูุซุงู ูู ุงูููุฌุงุช**:
```
[Log] query-24: SELECT 1          โ query 1
[Log] query-25: SELECT 1          โ query 2
[Log] query-26: SELECT 1          โ query 3
[Log] exec-8: INSERT orders        โ ูุญุงููุฉ ุงููุชุงุจุฉ (ุชูุดู!)
[Log] query-27: SELECT COUNT(*)   โ query 4
... (10+ queries ุฃุฎุฑู)
```

#### 3. **ูุดููุฉ Retry Logic ุบูุฑ ูุงูู** ๐

**ุงูุชุดุจูู**: ุชุฎูู ุฃูู ุชุญุงูู ูุชุญ ุจุงุจุ ูููู ููููู. ุชุญุงูู ูุฑุฉ ูุงุญุฏุฉ ูุชุณุชุณูู!

**ูุง ูุญุฏุซ ูู ุงูููุฏ**:
- ุนูุฏ ุญุฏูุซ "database is locked"ุ ุงููุธุงู ูุญุงูู ูุฑุฉ ูุงุญุฏุฉ ููุท
- ุฅุฐุง ูุดูุ ูุญุงูู ูุฑุฉ ุฃุฎุฑู ุจุนุฏ 300ms (ุฃูู ูู ุซุงููุฉ!)
- ููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฏ ุชุญุชุงุฌ ููุช ุฃุทูู (5+ ุซูุงูู)
- ุงููุชูุฌุฉ: ูุดู ุณุฑูุน ุฌุฏุงู!

---

## โ ุงูุญููู ุงููุทุจูุฉ

### ุงูุญู 1: Connection Pooling (ุชุฌูุน ุงูุงุชุตุงูุงุช) ๐

**ุงูููุฑุฉ**: ุจุฏูุงู ูู ุฅูุดุงุก ููุชุงุญ ุฌุฏูุฏ ูู ูุฑุฉุ ูุณุชุฎุฏู ููุชุงุญ ูุงุญุฏ ููุท!

**ููู ูุนูู**:
1. ุฃูู ูุฑุฉ ูุฑูุฏ ุงููุตูู ููุงุนุฏุฉ ุงูุจูุงูุงุช โ ููุดุฆ ููุชุงุญ ูุงุญุฏ
2. ูุญูุธ ุงูููุชุงุญ ูู "ุตูุฏูู" (Connection Pool)
3. ุงููุฑุฉ ุงููุงุฏูุฉ โ ูุณุชุฎุฏู ููุณ ุงูููุชุงุญ ูู ุงูุตูุฏูู
4. ูุง ููุดุฆ ููุชุงุญ ุฌุฏูุฏ ุฅูุง ุฅุฐุง ูุงู ุงูููุชุงุญ ุงููุฏูู ูุง ูุนูู

**ุงูููุฏ**:
```typescript
// โ ุงูุญู: Connection Pool
const connectionPool = new Map(); // ุตูุฏูู ูุญูุธ ุงูููุงุชูุญ

async function ensureDb(organizationId) {
  // 1. ูุญุต ุงูุตูุฏูู ุฃููุงู
  if (connectionPool.has(organizationId)) {
    const existingKey = connectionPool.get(organizationId);
    // 2. ุงูุชุญูู ูู ุฃู ุงูููุชุงุญ ูุง ูุฒุงู ูุนูู
    try {
      await existingKey.select('SELECT 1'); // ุงุฎุชุจุงุฑ ุจุณูุท
      return existingKey; // โ ุงุณุชุฎุฏู ุงูููุชุงุญ ุงูููุฌูุฏ
    } catch {
      // ุงูููุชุงุญ ูุง ูุนููุ ุงุญุฐูู ูู ุงูุตูุฏูู
      connectionPool.delete(organizationId);
    }
  }
  
  // 3. ููุท ุฅุฐุง ูู ููู ููุฌูุฏุงูุ ุฃูุดุฆ ููุชุงุญ ุฌุฏูุฏ
  const newKey = await Database.load(dbPath);
  connectionPool.set(organizationId, newKey); // ุงุญูุธู ูู ุงูุตูุฏูู
  return newKey;
}
```

**ุงููุชูุฌุฉ**: ุงูุขู ูุฏููุง ููุชุงุญ ูุงุญุฏ ููุท ููู ูุงุนุฏุฉ ุจูุงูุงุช! ๐

---

### ุงูุญู 2: ุชุญุณูู Retry Logic (ุชุญุณูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ) ๐

**ุงูููุฑุฉ**: ุจุฏูุงู ูู ุงููุญุงููุฉ ูุฑุฉ ูุงุญุฏุฉ ูุงูุงุณุชุณูุงูุ ูุญุงูู ุนุฏุฉ ูุฑุงุช ุจุงูุชุธุงุฑ ุฃุทูู!

**ููู ูุนูู**:
1. ุงููุญุงููุฉ ุงูุฃููู: ูุดู โ ุงูุชุธุฑ 500ms
2. ุงููุญุงููุฉ ุงูุซุงููุฉ: ูุดู โ ุงูุชุธุฑ 1000ms (ุซุงููุฉ ูุงุญุฏุฉ)
3. ุงููุญุงููุฉ ุงูุซุงูุซุฉ: ูุดู โ ุงูุชุธุฑ 2000ms (ุซุงููุชุงู)
4. ... ูููุฐุง ุญุชู 8 ูุญุงููุงุช

**ุงูููุฏ**:
```typescript
// โ ุงูุญู: Retry Logic ูุญุณูู
const MAX_RETRIES = 8; // 8 ูุญุงููุงุช ุจุฏูุงู ูู 3
const RETRY_DELAY_MS = 500; // 500ms ุจุฏูุงู ูู 300ms
const MAX_RETRY_DELAY_MS = 8000; // 8 ุซูุงูู ูุญุฏ ุฃูุตู

function getRetryDelay(attempt) {
  // exponential backoff: 500ms, 1000ms, 2000ms, 4000ms...
  const delay = RETRY_DELAY_MS * Math.pow(2, attempt - 1);
  return Math.min(delay, MAX_RETRY_DELAY_MS);
}

// ุนูุฏ ุญุฏูุซ ุฎุทุฃ "database is locked"
for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
  try {
    await db.execute(sql); // ูุญุงููุฉ ุงูุชูููุฐ
    return success; // โ ูุฌุญ!
  } catch (error) {
    if (error.includes('database is locked') && attempt < MAX_RETRIES) {
      const delay = getRetryDelay(attempt);
      await sleep(delay); // ุงูุชุธุฑ ูุจู ุงููุญุงููุฉ ุงูุชุงููุฉ
      continue; // ุญุงูู ูุฑุฉ ุฃุฎุฑู
    }
    throw error; // ูุดู ุจุนุฏ ูู ุงููุญุงููุงุช
  }
}
```

**ุงููุชูุฌุฉ**: ุงูุขู ุงููุธุงู ููุชุธุฑ ููุช ุฃุทูู ูุจู ุงูุงุณุชุณูุงู! โฐ

---

### ุงูุญู 3: Retry Logic ุฏุงุฎู Transaction (ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุฏุงุฎู ุงููุนุงููุฉ) ๐

**ุงูููุฑุฉ**: ุญุชู ุฏุงุฎู ุงููุนุงููุฉ ุงููุงุญุฏุฉุ ูุฏ ุชุญุฏุซ ูุดููุฉ "database is locked"!

**ูุง ูู Transaction (ุงููุนุงููุฉ)**ุ
- Transaction = ูุฌููุนุฉ ูู ุงูุนูููุงุช ูุฌุจ ุชูููุฐูุง ูุนุงู ุฃู ูุง ุดูุก
- ูุซุงู: ุฅูุดุงุก ุทูุจูุฉ = ุฅูุดุงุก ุงูุทูุจ + ุฅูุดุงุก ุงูุนูุงุตุฑ + ุชุญุฏูุซ ุงููุฎุฒูู
- ุฅุฐุง ูุดูุช ุฃู ุนูููุฉุ ููุบู ูู ุดูุก (ROLLBACK)

**ุงููุดููุฉ**:
- ุญุชู ุฏุงุฎู transactionุ ูุฏ ุชุญุฏุซ "database is locked"
- ุงูููุฏ ุงููุฏูู ูุงู ูุญุงูู ูุฑุฉ ูุงุญุฏุฉ ููุท ุฏุงุฎู transaction

**ุงูุญู**:
```typescript
// โ ุงูุญู: Retry Logic ุฏุงุฎู Transaction
if (this.inTransaction) {
  const MAX_TRANSACTION_RETRIES = 5;
  const TRANSACTION_RETRY_DELAY = 200; // 200ms
  
  for (let retry = 1; retry <= MAX_TRANSACTION_RETRIES; retry++) {
    try {
      const result = await sqliteDB.execute(sql, params);
      return result; // โ ูุฌุญ!
    } catch (error) {
      if (error.includes('database is locked') && retry < MAX_TRANSACTION_RETRIES) {
        const delay = TRANSACTION_RETRY_DELAY * retry; // 200ms, 400ms, 600ms...
        await sleep(delay);
        continue; // ุญุงูู ูุฑุฉ ุฃุฎุฑู
      }
      throw error;
    }
  }
}
```

**ุงููุชูุฌุฉ**: ุงูุขู ุญุชู ุฏุงุฎู transactionุ ูุญุงูู ุนุฏุฉ ูุฑุงุช! ๐

---

### ุงูุญู 4: ุชุฃุฎูุฑ Queries ุบูุฑ ุถุฑูุฑูุฉ ุฃุซูุงุก POS Operation โธ๏ธ

**ุงูููุฑุฉ**: ุฃุซูุงุก ุฅูุดุงุก ุทูุจูุฉ POS (ุนูููุฉ ุญุฑุฌุฉ)ุ ูุคุฎุฑ Queries ุบูุฑ ุถุฑูุฑูุฉ!

**ูุง ูู Queries**ุ
- Query = ุงุณุชุนูุงู (ูุฑุงุกุฉ ุจูุงูุงุช)
- ูุซุงู: "ุฃุนุทูู ูุงุฆูุฉ ุฌููุน ุงูููุชุฌุงุช"

**ุงููุดููุฉ**:
- ุฃุซูุงุก ุฅูุดุงุก ุทูุจูุฉ POSุ ููุงู 10+ queries ุชุนูู ูู ููุณ ุงูููุช
- ูุฐู Queries ุชููุน ุงููุชุงุจุฉ (INSERT) ูู ุงูุนูู
- ุงููุชูุฌุฉ: ุชุฃุฎูุฑ ูู ุฅูุดุงุก ุงูุทูุจูุฉ

**ุงูุญู**:
```typescript
// โ ุงูุญู: ุชุฃุฎูุฑ Queries ุบูุฑ ุถุฑูุฑูุฉ ุฃุซูุงุก POS Operation
if (isPOSActive) {
  // Queries ุจุณูุทุฉ ูููู ุชูููุฐูุง ูุจุงุดุฑุฉ
  const isSimpleQuery = sql.includes('SELECT 1') || 
                       sql.includes('PRAGMA') ||
                       sql.includes('COUNT(*)');
  
  // Queries ูุนูุฏุฉ - ุชุฃุฎูุฑูุง ููููุงู
  if (!isSimpleQuery && activeOperations.length > 2) {
    const writeOps = activeOperations.filter(o => o.type === 'execute');
    if (writeOps.length > 0) {
      const waitTime = Math.min(100, writeOps.length * 20); // 20-100ms
      await sleep(waitTime); // ุงูุชุธุฑ ููููุงู
    }
  }
}
```

**ุงููุชูุฌุฉ**: ุงูุขู Queries ุบูุฑ ุถุฑูุฑูุฉ ุชูุชุธุฑ ุญุชู ุชูุชูู ุงููุชุงุจุฉ! โณ

---

## ๐ด ุงููุดููุฉ ุงูุซุงููุฉ: ุงููุฒุงููุฉ ูุชูููุฉ (0/616)

### ูุง ูู ุงููุดููุฉุ

- ูุฏูู 616 ุทูุจูุฉ ุจุญุงูุฉ `pending_sync` (ูู ุงูุชุธุงุฑ ุงููุฒุงููุฉ)
- ููู ุงููุฒุงููุฉ ุชุธูุฑ 0/616 (ูุง ุดูุก ุชู ูุฒุงููุชู)
- ุงููุฒุงููุฉ ูุง ุชุนูู!

### ููุงุฐุง ุชุญุฏุซ ูุฐู ุงููุดููุฉุ

**ุงูุชุดุจูู**: ุชุฎูู ุฃู ูุฏูู ุตูุฏูู ุจุฑูุฏ ูููุก ุจุงูุฑุณุงุฆู (616 ุฑุณุงูุฉ)ุ ููู ุณุงุนู ุงูุจุฑูุฏ ูุชููู!

**ูุง ูุญุฏุซ ูู ุงูููุฏ**:

1. **ุงููุฒุงููุฉ ูุชูููุฉ ุฃุซูุงุก POS Operation**:
   - ุนูุฏ ุฅูุดุงุก ุทูุจูุฉ POSุ ุงููุธุงู ูููู ุงููุฒุงููุฉ ูุคูุชุงู
   - ูุฐุง ููุทูู: ูุง ูุฑูุฏ ุงููุฒุงููุฉ ุชุชุฏุงุฎู ูุน ุฅูุดุงุก ุงูุทูุจูุฉ
   - ููู ุงููุดููุฉ: ุงููุฒุงููุฉ ูุง ุชุณุชุฃูู ููุฑุงู ุจุนุฏ ุงูุชูุงุก POS operation!

2. **Interval ุทููู ููุชุญูู**:
   - ุงููุธุงู ูุชุญูู ูู ุงููุฒุงููุฉ ูู 2000ms (ุซุงููุชุงู)
   - ุฅุฐุง ุงูุชูุช POS operationุ ูุฏ ููุชุธุฑ ุซุงููุชูู ูุจู ุฃู ูุจุฏุฃ ุงููุฒุงููุฉ
   - ูุน 616 ุทูุจูุฉุ ูุฐุง ูุนูู ููุช ุทููู ุฌุฏุงู!

**ูุซุงู ูู ุงูููุฏ**:
```typescript
// โ ุงููุดููุฉ: ุงูุชุธุงุฑ ุทููู ูุจู ุงูุชุญูู ูู ุงููุฒุงููุฉ
if (databaseCoordinator.isSyncPaused()) {
  setTimeout(() => {
    this.scheduleNextBatch();
  }, 2000); // ุงูุชุธุฑ ุซุงููุชูู!
  return;
}
```

---

## โ ุงูุญููู ุงููุทุจูุฉ

### ุงูุญู 1: ุงุณุชุฆูุงู ุงููุฒุงููุฉ ููุฑุงู ุจุนุฏ POS Operation ๐

**ุงูููุฑุฉ**: ุจุนุฏ ุงูุชูุงุก POS operation ูุจุงุดุฑุฉุ ูุจุฏุฃ ุงููุฒุงููุฉ ููุฑุงู!

**ููู ูุนูู**:
1. ุนูุฏ ุงูุชูุงุก POS operationุ ูุทูู ุญุฏุซ `sync-resumed-after-pos`
2. SyncManager ูุณุชูุน ููุฐุง ุงูุญุฏุซ
3. ูุจุฏุฃ ุงููุฒุงููุฉ ููุฑุงู (ุจุนุฏ 500ms ููุชุฃูุฏ ูู ุงูุชูุงุก POS operation)

**ุงูููุฏ**:
```typescript
// โ ูู DatabaseCoordinator.executePOS()
finally {
  this.resumeSync(); // ุงุณุชุฆูุงู ุงููุฒุงููุฉ
  
  // ุฅุทูุงู ุญุฏุซ ูุจุฏุก ุงููุฒุงููุฉ ููุฑุงู
  setTimeout(() => {
    if (!this.isSyncPaused()) {
      window.dispatchEvent(new CustomEvent('sync-resumed-after-pos', {
        detail: { operationId, description }
      }));
    }
  }, 100); // ุชุฃุฎูุฑ ุจุณูุท (100ms)
}

// โ ูู SyncManager.start()
window.addEventListener('sync-resumed-after-pos', () => {
  setTimeout(() => {
    if (!databaseCoordinator.isSyncPaused() && !this.isSyncing) {
      this.syncAll(); // ุจุฏุก ุงููุฒุงููุฉ ููุฑุงู!
    }
  }, 500);
});
```

**ุงููุชูุฌุฉ**: ุงูุขู ุงููุฒุงููุฉ ุชุจุฏุฃ ููุฑุงู ุจุนุฏ ุฅูุดุงุก ุงูุทูุจูุฉ! โก

---

### ุงูุญู 2: ุชูููู Interval ููุชุญูู ูู ุงููุฒุงููุฉ โฑ๏ธ

**ุงูููุฑุฉ**: ุจุฏูุงู ูู ุงูุงูุชุธุงุฑ ุซุงููุชููุ ูุชุญูู ูู 500ms (ูุตู ุซุงููุฉ)!

**ุงูููุฏ**:
```typescript
// โ ูุจู: ุงูุชุธุงุฑ ุทููู
if (databaseCoordinator.isSyncPaused()) {
  setTimeout(() => {
    this.scheduleNextBatch();
  }, 2000); // ุซุงููุชุงู
}

// โ ุจุนุฏ: ุงูุชุธุงุฑ ุฃูุตุฑ
if (databaseCoordinator.isSyncPaused()) {
  setTimeout(() => {
    this.scheduleNextBatch();
  }, 500); // ูุตู ุซุงููุฉ ููุท!
}
```

**ุงููุชูุฌุฉ**: ุงูุขู ุงููุธุงู ูุชุญูู ูู ุงููุฒุงููุฉ 4 ูุฑุงุช ุฃุณุฑุน! ๐

---

## ๐ ููุฎุต ุงููุดุงูู ูุงูุญููู

### ุงููุดููุฉ 1: "Database is Locked"

| ุงููุดููุฉ | ุงูุณุจุจ | ุงูุญู |
|---------|-------|------|
| ูุงุนุฏุฉ ุงูุจูุงูุงุช ููููุฉ | ุงุชุตุงูุงุช ูุชุนุฏุฏุฉ | Connection Pooling |
| ูุดู ุณุฑูุน | Retry Logic ุบูุฑ ูุงูู | ุชุญุณูู Retry Logic (8 ูุญุงููุงุชุ delays ุฃุทูู) |
| ูุดู ุฏุงุฎู Transaction | ูุง retry ุฏุงุฎู transaction | ุฅุถุงูุฉ Retry Logic ุฏุงุฎู Transaction |
| Queries ูุชุนุฏุฏุฉ | Queries ุชุนูู ุฃุซูุงุก ุงููุชุงุจุฉ | ุชุฃุฎูุฑ Queries ุบูุฑ ุถุฑูุฑูุฉ |

### ุงููุดููุฉ 2: ุงููุฒุงููุฉ ูุชูููุฉ (0/616)

| ุงููุดููุฉ | ุงูุณุจุจ | ุงูุญู |
|---------|-------|------|
| ุงููุฒุงููุฉ ูุง ุชุจุฏุฃ | ูุง ุชุณุชุฃูู ุจุนุฏ POS operation | ุฅุทูุงู ุญุฏุซ ูุจุฏุก ุงููุฒุงููุฉ ููุฑุงู |
| ุงูุชุธุงุฑ ุทููู | Interval ุทููู (2000ms) | ุชูููู Interval ุฅูู 500ms |

---

## ๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ูุจู ุงูุญููู:
- โ "database is locked" ูุญุฏุซ ูู ูู ูุฑุฉ
- โ ุชุฃุฎูุฑ ~6 ุซูุงูู ูุฅูุดุงุก ุทูุจูุฉ
- โ 2-3 ูุญุงููุงุช retry
- โ ุงููุฒุงููุฉ ูุชูููุฉ (0/616)

### ุจุนุฏ ุงูุญููู:
- โ "database is locked" ูุงุฏุฑ ุฌุฏุงู ุฃู ูุง ูุญุฏุซ
- โ ุชุฃุฎูุฑ < 2 ุซุงููุฉ ูุฅูุดุงุก ุทูุจูุฉ
- โ 0-1 ูุญุงููุฉ retry ููุท
- โ ุงููุฒุงููุฉ ุชุจุฏุฃ ููุฑุงู ุจุนุฏ ุฅูุดุงุก ุงูุทูุจูุฉ

---

## ๐ง ููู ุชุนูู ุงูุญููู ูุนุงูุ

### ุณููุงุฑูู: ุฅูุดุงุก ุทูุจูุฉ POS

1. **ุงููุณุชุฎุฏู ูููุฑ "ุฅูุดุงุก ุทูุจูุฉ"** ๐
   - ุงููุธุงู ูุจุฏุฃ POS operation
   - ูููู ุงููุฒุงููุฉ ูุคูุชุงู

2. **ุฅูุดุงุก Transaction** ๐
   - `BEGIN IMMEDIATE` โ ูุฌุญ โ
   - ูุณุชุฎุฏู connection ูุงุญุฏ ูู Connection Pool

3. **INSERT ุงูุทูุจ** ๐
   - ุฅุฐุง ุญุฏุซ "database is locked":
     - Retry Logic ุฏุงุฎู Transaction ูุญุงูู ูุฑุฉ ุฃุฎุฑู
     - ููุชุธุฑ 200msุ 400msุ 600ms...
   - ูู ุงูููุงูุฉ: ูุฌุญ โ

4. **INSERT sync_outbox** ๐ค
   - ููุณ ุงูุดูุก: Retry Logic ุฏุงุฎู Transaction
   - ูุฌุญ โ

5. **COMMIT** โ
   - ุงูุชูุช Transaction ุจูุฌุงุญ

6. **ุงุณุชุฆูุงู ุงููุฒุงููุฉ** ๐
   - ุฅุทูุงู ุญุฏุซ `sync-resumed-after-pos`
   - SyncManager ูุจุฏุฃ ุงููุฒุงููุฉ ููุฑุงู (ุจุนุฏ 500ms)
   - ูุนุงูุฌุฉ ุงูู 616 ุทูุจูุฉ ุงููุนููุฉ

---

## ๐ก ูุตุงุฆุญ ูููุณุชูุจู

1. **ุฑุงูุจ Connection Pool**: ุชุฃูุฏ ูู ุฃู ูุฏูู connection ูุงุญุฏ ููุท ููู organization
2. **ุฑุงูุจ Retries**: ุฅุฐุง ูุงู ุนุฏุฏ Retries ุนุงููุ ูุฏ ุชุญุชุงุฌ ูุชุญุณููุงุช ุฅุถุงููุฉ
3. **ุฑุงูุจ ุงููุฒุงููุฉ**: ุชุฃูุฏ ูู ุฃู ุงููุฒุงููุฉ ุชุจุฏุฃ ููุฑุงู ุจุนุฏ POS operations
4. **ุฑุงูุจ ุงูุฃุฏุงุก**: ุฅุฐุง ูุงู ููุช ุงูุชูููุฐ > 2 ุซุงููุฉุ ูุฏ ุชุญุชุงุฌ ูุชุญุณููุงุช

---

## ๐ ูุตุทูุญุงุช ูููุฉ

- **Connection**: ุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุซู ููุชุงุญ ููุฎุฒูุฉ)
- **Connection Pool**: ุตูุฏูู ูุญูุธ ุงูุงุชุตุงูุงุช (ูุซู ุตูุฏูู ุงูููุงุชูุญ)
- **Transaction**: ูุนุงููุฉ (ูุฌููุนุฉ ุนูููุงุช ูุฌุจ ุชูููุฐูุง ูุนุงู)
- **Query**: ุงุณุชุนูุงู (ูุฑุงุกุฉ ุจูุงูุงุช)
- **Retry**: ุฅุนุงุฏุฉ ูุญุงููุฉ (ูุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ุจุนุฏ ูุดู)
- **Sync**: ูุฒุงููุฉ (ุฅุฑุณุงู ุงูุจูุงูุงุช ุงููุญููุฉ ููุณูุฑูุฑ)

---

## ๐ ุฎูุงุตุฉ

**ุงููุดููุฉ ุงูุฃุณุงุณูุฉ**: ุงููุธุงู ูุงู ูููุดุฆ ุงุชุตุงูุงุช ูุชุนุฏุฏุฉ ููุญุงูู ูุชุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุนุฏุฉ ุฃูุงูู ูู ููุณ ุงูููุช.

**ุงูุญู**: ุงุณุชุฎุฏููุง ุงุชุตุงู ูุงุญุฏ ููุท (Connection Pooling) ูุฃุถููุง Retry Logic ุฃููู.

**ุงููุชูุฌุฉ**: ุงูุขู ุงููุธุงู ูุนูู ุจุดูู ุฃุณุฑุน ูุฃูุซุฑ ุงุณุชูุฑุงุฑุงู! ๐






























