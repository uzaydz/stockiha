# ğŸ—ï¸ Ø®Ø·Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„Ø© - MASTER REBUILD PLAN

> **ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù„ÙŠÙ„:** 2 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025
> **Ø§Ù„Ù‡Ø¯Ù:** Ù†Ø¸Ø§Ù… Ù…Ø«Ø§Ù„ÙŠ Ù…ÙˆØ­Ø¯ 100% Ù…Ø¹ Supabase

---

## ğŸ“‹ Ø§Ù„ÙÙ‡Ø±Ø³

1. [Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©](#1-Ù…Ù„Ø®Øµ-Ø§Ù„Ù…Ø´Ø§ÙƒÙ„-Ø§Ù„Ù…ÙƒØªØ´ÙØ©)
2. [Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­](#2-Ø§Ù„Ù‡ÙŠÙƒÙ„-Ø§Ù„Ø¬Ø¯ÙŠØ¯-Ø§Ù„Ù…Ù‚ØªØ±Ø­)
3. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªÙˆØ­ÙŠØ¯ Ø§Ù„ØªØ³Ù…ÙŠØ§Øª](#3-Ø§Ù„Ù…Ø±Ø­Ù„Ø©-1-ØªÙˆØ­ÙŠØ¯-Ø§Ù„ØªØ³Ù…ÙŠØ§Øª)
4. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ SQLite Schema](#4-Ø§Ù„Ù…Ø±Ø­Ù„Ø©-2-Ø¥Ø¹Ø§Ø¯Ø©-Ø¨Ù†Ø§Ø¡-sqlite-schema)
5. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©](#5-Ø§Ù„Ù…Ø±Ø­Ù„Ø©-3-Ø¥Ø¹Ø§Ø¯Ø©-Ø¨Ù†Ø§Ø¡-Ù†Ø¸Ø§Ù…-Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©)
6. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ TypeScript](#6-Ø§Ù„Ù…Ø±Ø­Ù„Ø©-4-ØªÙˆØ­ÙŠØ¯-Ø§Ù„Ø£Ù†ÙˆØ§Ø¹-typescript)
7. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¯Ù…Ø§Øª](#7-Ø§Ù„Ù…Ø±Ø­Ù„Ø©-5-ØªØ­Ø¯ÙŠØ«-Ø§Ù„Ø®Ø¯Ù…Ø§Øª)
8. [Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Migration ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª](#8-Ø§Ù„Ù…Ø±Ø­Ù„Ø©-6-migration-ÙˆØªØ±Ø­ÙŠÙ„-Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
9. [Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©](#9-Ù‚Ø§Ø¦Ù…Ø©-Ø§Ù„Ù…Ù„ÙØ§Øª-Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©)
10. [Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª](#10-Ø¬Ø¯ÙˆÙ„-Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª)

---

## 1. Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©

### 1.1 Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØµØ§Ø¯Ù…Ø©

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„Ø£Ø±Ù‚Ø§Ù… | Ø§Ù„ØªØ£Ø«ÙŠØ± |
|---------|---------|---------|
| **Ø£Ø¹Ù…Ø¯Ø© Ù…ÙƒØ±Ø±Ø© ÙÙŠ products** | 419 Ø¹Ù…ÙˆØ¯ (192 Ù…ÙƒØ±Ø±) | 45.8% Ù‡Ø¯Ø± |
| **Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©** | 10+ Ù…Ù„ÙØ§Øª | ØªØ¶Ø§Ø±Ø¨ ÙƒØ¨ÙŠØ± |
| **Ø¬Ø¯Ø§ÙˆÙ„ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ©** | 5 Ø¬Ø¯Ø§ÙˆÙ„ | ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© |
| **Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ©** | 50+ Ø¹Ù…ÙˆØ¯ | Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª |
| **Ø«ØºØ±Ø§Øª Ø£Ù…Ù†ÙŠØ©** | 4 SQL Injection | Ø®Ø·Ø± Ø­Ø±Ø¬ |
| **Race Conditions** | 3 Ù†Ù‚Ø§Ø· | ÙÙ‚Ø¯Ø§Ù† Ø¨ÙŠØ§Ù†Ø§Øª |

### 1.2 Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø­Ø±Ø¬Ø© (Critical)

```
ğŸ”´ 1. SQL Injection ÙÙŠ SyncManager.ts (Ø³Ø·Ø± 477, 519)
ğŸ”´ 2. null order_id ÙÙŠ order_items (PushEngine.ts Ø³Ø·Ø± 330)
ğŸ”´ 3. DELTA Race Condition (PushEngine.ts Ø³Ø·Ø± 549-602)
ğŸ”´ 4. Hardcoded payment_method = 'cash' (SyncManager.ts Ø³Ø·Ø± 162)
ğŸ”´ 5. Ø§Ø²Ø¯ÙˆØ§Ø¬ÙŠØ© 45% ÙÙŠ Ø£Ø¹Ù…Ø¯Ø© products
```

### 1.3 Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø§Ù„Ø£Ø³Ù…Ø§Ø¡

| Ø§Ù„Ù…Ø­Ù„ÙŠ (SQLite) | Ø§Ù„Ø³ÙŠØ±ÙØ± (Supabase) | Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ­Ø¯ |
|-----------------|-------------------|---------------|
| `pos_orders` | `orders` | `orders` |
| `pos_order_items` | `order_items` | `order_items` |
| `product_returns` | `returns` | `returns` |
| `loss_declarations` | `losses` | `losses` |
| `work_sessions` | `staff_work_sessions` | `staff_work_sessions` |

---

## 2. Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù‚ØªØ±Ø­

### 2.1 Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯

```
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ schema/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts              # ØªØµØ¯ÙŠØ± Ù…ÙˆØ­Ø¯
â”‚   â”‚   â”‚   â”œâ”€â”€ tables/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ products.sql.ts   # schema products
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ orders.sql.ts     # schema orders
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ customers.sql.ts  # schema customers
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”œâ”€â”€ indexes.sql.ts        # Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ‡Ø§Ø±Ø³
â”‚   â”‚   â”‚   â””â”€â”€ migrations/
â”‚   â”‚   â”‚       â”œâ”€â”€ v43_unify_schema.ts
â”‚   â”‚   â”‚       â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ operations/
â”‚   â”‚   â”‚   â”œâ”€â”€ read.ts               # Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
â”‚   â”‚   â”‚   â”œâ”€â”€ write.ts              # Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©
â”‚   â”‚   â”‚   â””â”€â”€ batch.ts              # Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª
â”‚   â”‚   â””â”€â”€ sqliteClient.ts           # Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯
â”‚   â”‚
â”‚   â”œâ”€â”€ sync/
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ SyncManager.ts        # Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù…ÙØ­Ø³Ù‘Ù†)
â”‚   â”‚   â”‚   â”œâ”€â”€ PullEngine.ts         # Ù…Ø­Ø±Ùƒ Ø§Ù„Ø³Ø­Ø¨ (Ù…ÙØ­Ø³Ù‘Ù†)
â”‚   â”‚   â”‚   â”œâ”€â”€ PushEngine.ts         # Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¯ÙØ¹ (Ù…ÙØ­Ø³Ù‘Ù†)
â”‚   â”‚   â”‚   â””â”€â”€ DeltaEngine.ts        # Ù…Ø­Ø±Ùƒ DELTA (Ø¬Ø¯ÙŠØ¯)
â”‚   â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â”‚   â”œâ”€â”€ OutboxManager.ts      # Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµØ§Ø¯Ø±
â”‚   â”‚   â”‚   â””â”€â”€ ConflictResolver.ts   # Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â”œâ”€â”€ tables.ts             # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
â”‚   â”‚   â”‚   â”œâ”€â”€ constants.ts          # Ø§Ù„Ø«ÙˆØ§Ø¨Øª
â”‚   â”‚   â”‚   â””â”€â”€ index.ts              # ØªØµØ¯ÙŠØ± Ù…ÙˆØ­Ø¯
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â”œâ”€â”€ validation.ts         # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
â”‚   â”‚       â””â”€â”€ network.ts            # ÙØ­Øµ Ø§Ù„Ø´Ø¨ÙƒØ©
â”‚   â”‚
â”‚   â””â”€â”€ types/
â”‚       â”œâ”€â”€ database/
â”‚       â”‚   â”œâ”€â”€ supabase.types.ts     # Ø£Ù†ÙˆØ§Ø¹ Supabase (Ù…ÙˆÙ„Ø¯Ø©)
â”‚       â”‚   â””â”€â”€ local.types.ts        # Ø£Ù†ÙˆØ§Ø¹ Ù…Ø­Ù„ÙŠØ©
â”‚       â”œâ”€â”€ entities/
â”‚       â”‚   â”œâ”€â”€ product.ts            # Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬
â”‚       â”‚   â”œâ”€â”€ order.ts              # Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
â”‚       â”‚   â”œâ”€â”€ customer.ts           # Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„
â”‚       â”‚   â””â”€â”€ ...
â”‚       â””â”€â”€ index.ts                  # ØªØµØ¯ÙŠØ± Ù…ÙˆØ­Ø¯
â”‚
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â”‚   â”œâ”€â”€ remote.ts             # ProductRemoteService
â”‚   â”‚   â”‚   â”œâ”€â”€ local.ts              # ProductLocalService
â”‚   â”‚   â”‚   â””â”€â”€ sync.ts               # ProductSyncService
â”‚   â”‚   â”œâ”€â”€ orders/
â”‚   â”‚   â”‚   â”œâ”€â”€ remote.ts             # OrderRemoteService
â”‚   â”‚   â”‚   â”œâ”€â”€ local.ts              # OrderLocalService
â”‚   â”‚   â”‚   â””â”€â”€ sync.ts               # OrderSyncService
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ transformers.ts           # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
â”‚       â””â”€â”€ validators.ts             # Ø§Ù„ØªØ­Ù‚Ù‚
â”‚
â””â”€â”€ hooks/
    â””â”€â”€ data/
        â”œâ”€â”€ useProducts.ts
        â”œâ”€â”€ useOrders.ts
        â””â”€â”€ ...
```

### 2.2 Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯

```typescript
/**
 * âœ… Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
 *
 * 1. snake_case ÙÙ‚Ø· - Ù„Ø§ camelCase ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
 * 2. Ø£Ø³Ù…Ø§Ø¡ Ù…ØªØ·Ø§Ø¨Ù‚Ø© 100% Ù…Ø¹ Supabase
 * 3. Ù„Ø§ TABLE_MAP - Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø©
 * 4. Ù„Ø§ COLUMN_MAP - Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…ÙˆØ­Ø¯Ø©
 * 5. Validation ÙÙŠ Ø·Ø¨Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
 * 6. Parameterized queries ÙÙ‚Ø· - Ù„Ø§ template literals
 */
```

---

## 3. Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªÙˆØ­ÙŠØ¯ Ø§Ù„ØªØ³Ù…ÙŠØ§Øª

### 3.1 Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©

```typescript
// âŒ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø®Ø§Ø·Ø¦Ø©)
await addColumnIfNotExists('products', 'compare_at_price', 'REAL');
await addColumnIfNotExists('products', 'compareAtPrice', 'REAL');

// âœ… Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØµØ­ÙŠØ­Ø©)
await addColumnIfNotExists('products', 'compare_at_price', 'REAL');
// Ù„Ø§ ØªØ¶Ù camelCase Ø£Ø¨Ø¯Ø§Ù‹!
```

### 3.2 Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©

#### 3.2.1 Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„

```typescript
// Ù…Ù„Ù: src/lib/sync/config/tables.ts

export const UNIFIED_TABLES = {
  // âŒ Ø§Ù„Ù‚Ø¯ÙŠÙ… â†’ âœ… Ø§Ù„Ø¬Ø¯ÙŠØ¯
  'pos_orders': 'orders',
  'pos_order_items': 'order_items',
  'product_returns': 'returns',
  'loss_declarations': 'losses',
  'work_sessions': 'staff_work_sessions',
} as const;

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
export const SYNCED_TABLES = [
  'products',
  'product_categories',
  'product_subcategories',
  'product_colors',
  'product_sizes',
  'product_images',
  'customers',
  'orders',              // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† pos_orders
  'order_items',         // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† pos_order_items
  'returns',             // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† product_returns
  'return_items',
  'losses',              // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† loss_declarations
  'loss_items',
  'suppliers',
  'supplier_purchases',
  'supplier_purchase_items',
  'supplier_payments',
  'invoices',
  'invoice_items',
  'expenses',
  'expense_categories',
  'staff_work_sessions', // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† work_sessions
  'pos_settings',
  'organization_settings',
] as const;
```

#### 3.2.2 Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (orders)

```typescript
// Ù…Ù„Ù: src/lib/types/entities/order.ts

/**
 * âœ… Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ­Ø¯ - Ù…ØªØ·Ø§Ø¨Ù‚ 100% Ù…Ø¹ Supabase
 *
 * Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ snake_case
 * Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ camelCase
 */
export interface Order {
  // Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  id: string;
  organization_id: string;
  customer_id: string | null;

  // Ø§Ù„Ù…Ø¨Ø§Ù„Øº (âœ… Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØµØ­ÙŠØ­Ø©)
  subtotal: number;
  tax: number;
  discount: number | null;
  total: number;                    // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† total_amount
  amount_paid: number | null;       // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† paid_amount
  remaining_amount: number | null;

  // Ø§Ù„Ø­Ø§Ù„Ø©
  status: 'pending' | 'processing' | 'completed' | 'cancelled';
  payment_method: 'cash' | 'card' | 'credit' | 'mixed';
  payment_status: 'pending' | 'paid' | 'partial' | 'refunded';

  // Ø§Ù„Ù…ÙˆØ¸Ù
  employee_id: string | null;       // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† staff_id
  created_by_staff_id: string | null;
  created_by_staff_name: string | null;

  // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„
  global_order_number: number;      // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† order_number
  slug: string | null;

  // Ø§Ù„Ø´Ø­Ù†
  is_online: boolean;
  shipping_address_id: string | null;
  shipping_method: string | null;
  shipping_cost: number | null;

  // Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  notes: string | null;
  customer_notes: string | null;
  admin_notes: string | null;
  metadata: Record<string, any> | null;

  // Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  created_at: string;
  updated_at: string;
  completed_at: string | null;

  // âŒ Ø£Ø¹Ù…Ø¯Ø© ÙŠØ¬Ø¨ Ø­Ø°ÙÙ‡Ø§ (Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·)
  // synced - Ù„Ø§ ÙŠÙØ±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
  // sync_status - Ù„Ø§ ÙŠÙØ±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
  // pending_operation - Ù„Ø§ ÙŠÙØ±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
  // local_order_number - Ù„Ø§ ÙŠÙØ±Ø³Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
}
```

#### 3.2.3 Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (order_items)

```typescript
// Ù…Ù„Ù: src/lib/types/entities/orderItem.ts

export interface OrderItem {
  // Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  id: string;
  order_id: string;                 // âœ… Ù…Ø·Ù„ÙˆØ¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹
  product_id: string;
  organization_id: string;          // âœ… Ù…Ø·Ù„ÙˆØ¨

  // Ø§Ù„Ù…Ù†ØªØ¬
  name: string;                     // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† product_name
  quantity: number;
  unit_price: number;
  total_price: number;              // âœ… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† subtotal

  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
  color_id: string | null;
  size_id: string | null;
  color_name: string | null;
  size_name: string | null;
  variant_display_name: string | null;

  // Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹
  sale_type: 'retail' | 'wholesale' | 'partial_wholesale';
  selling_unit_type: 'piece' | 'weight' | 'meter' | 'box';

  // Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
  weight_sold: number | null;
  weight_unit: string | null;
  price_per_weight_unit: number | null;
  meters_sold: number | null;
  price_per_meter: number | null;
  boxes_sold: number | null;
  units_per_box: number | null;
  box_price: number | null;

  // Ø§Ù„ØªØªØ¨Ø¹
  batch_id: string | null;
  batch_number: string | null;
  serial_numbers: string[] | null;
  expiry_date: string | null;

  // Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  created_at: string;

  // âŒ Ø£Ø¹Ù…Ø¯Ø© ÙŠØ¬Ø¨ Ø­Ø°ÙÙ‡Ø§
  // barcode - Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·
  // cost - Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·
  // discount - Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· (Ø§Ø³ØªØ®Ø¯Ù… discount Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ order)
  // image_url - Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·
  // synced - Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·
}
```

#### 3.2.4 Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (products)

```typescript
// Ù…Ù„Ù: src/lib/types/entities/product.ts

export interface Product {
  // Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  id: string;
  organization_id: string;
  category_id: string | null;
  subcategory_id: string | null;
  supplier_id: string | null;

  // Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  name: string;
  description: string;
  sku: string;
  barcode: string | null;
  slug: string | null;

  // Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  price: number;
  compare_at_price: number | null;
  purchase_price: number | null;

  // ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø¬Ù…Ù„Ø©
  wholesale_price: number | null;
  partial_wholesale_price: number | null;
  min_wholesale_quantity: number | null;
  min_partial_wholesale_quantity: number | null;
  allow_retail: boolean;
  allow_wholesale: boolean;
  allow_partial_wholesale: boolean;

  // Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
  stock_quantity: number;
  min_stock_level: number | null;
  reorder_level: number | null;
  reorder_quantity: number | null;

  // Ø§Ù„Ø­Ø§Ù„Ø©
  is_active: boolean;
  is_featured: boolean;
  is_digital: boolean;
  is_new: boolean | null;

  // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
  has_variants: boolean;
  use_sizes: boolean;
  use_variant_prices: boolean;

  // Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„ÙˆØ²Ù†
  sell_by_weight: boolean;
  weight_unit: string | null;
  price_per_weight_unit: number | null;
  purchase_price_per_weight_unit: number | null;
  min_weight_per_sale: number | null;
  max_weight_per_sale: number | null;
  average_item_weight: number | null;
  available_weight: number;
  total_weight_purchased: number;

  // Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
  sell_by_box: boolean;
  units_per_box: number | null;
  box_price: number | null;
  box_purchase_price: number | null;
  box_barcode: string | null;
  allow_single_unit_sale: boolean;
  available_boxes: number;
  total_boxes_purchased: number;

  // Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ù…ØªØ±
  sell_by_meter: boolean;
  meter_unit: string | null;
  price_per_meter: number | null;
  purchase_price_per_meter: number | null;
  min_meters_per_sale: number | null;
  roll_length_meters: number | null;
  available_length: number;
  total_meters_purchased: number;

  // Ø§Ù„ØªØªØ¨Ø¹
  track_expiry: boolean;
  default_expiry_days: number | null;
  expiry_alert_days: number;
  track_serial_numbers: boolean;
  require_serial_on_sale: boolean;
  track_batches: boolean;
  use_fifo: boolean;

  // Ø§Ù„Ø¶Ù…Ø§Ù†
  has_warranty: boolean;
  warranty_duration_months: number | null;
  warranty_type: string | null;

  // Ø§Ù„ØµÙˆØ±
  images: string[] | null;
  thumbnail_image: string | null;

  // Ø§Ù„Ù†Ø´Ø±
  publication_status: 'draft' | 'scheduled' | 'published' | 'archived';
  publish_at: string | null;
  published_at: string | null;

  // Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
  tax_rate: number | null;
  tax_included: boolean;

  // Ø§Ù„Ø®ØµØ§Ø¦Øµ
  features: string[] | null;
  specifications: Record<string, any> | null;
  dimensions: Record<string, any> | null;

  // Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  created_at: string;
  updated_at: string;
  last_inventory_update: string | null;

  // âŒ Ø£Ø¹Ù…Ø¯Ø© ÙŠØ¬Ø¨ Ø­Ø°ÙÙ‡Ø§ (Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·)
  // synced, sync_status, pending_operation
  // name_lower, name_normalized, sku_lower, barcode_lower
  // thumbnail_base64, images_base64
  // local_updated_at
  // stock_version
  // actual_stock_quantity (Ù…Ø­Ø³ÙˆØ¨)
}
```

---

## 4. Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ SQLite Schema

### 4.1 Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯: `src/lib/db/schema/tables/orders.sql.ts`

```typescript
/**
 * Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ù…ØªØ·Ø§Ø¨Ù‚ 100% Ù…Ø¹ Supabase
 */
export const ORDERS_TABLE = `
CREATE TABLE IF NOT EXISTS orders (
  -- Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  id TEXT PRIMARY KEY,
  organization_id TEXT NOT NULL,
  customer_id TEXT,

  -- Ø§Ù„Ù…Ø¨Ø§Ù„Øº
  subtotal REAL NOT NULL DEFAULT 0,
  tax REAL NOT NULL DEFAULT 0,
  discount REAL,
  total REAL NOT NULL DEFAULT 0,
  amount_paid REAL,
  remaining_amount REAL,
  consider_remaining_as_partial INTEGER DEFAULT 1,

  -- Ø§Ù„Ø­Ø§Ù„Ø©
  status TEXT NOT NULL DEFAULT 'pending',
  payment_method TEXT NOT NULL DEFAULT 'cash',
  payment_status TEXT NOT NULL DEFAULT 'pending',

  -- Ø§Ù„Ù…ÙˆØ¸Ù
  employee_id TEXT,
  created_by_staff_id TEXT,
  created_by_staff_name TEXT,

  -- Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„
  global_order_number INTEGER,
  slug TEXT,
  customer_order_number INTEGER,

  -- Ø§Ù„Ø´Ø­Ù†
  is_online INTEGER NOT NULL DEFAULT 0,
  shipping_address_id TEXT,
  shipping_method TEXT,
  shipping_cost REAL,

  -- Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
  notes TEXT,
  customer_notes TEXT,
  admin_notes TEXT,
  metadata TEXT,

  -- Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨
  pos_order_type TEXT DEFAULT 'pos',
  call_confirmation_status_id INTEGER,

  -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  completed_at TEXT,

  -- âš¡ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·)
  _synced INTEGER DEFAULT 0,
  _sync_status TEXT,
  _pending_operation TEXT,
  _local_updated_at TEXT
);
`;

export const ORDERS_INDEXES = `
CREATE INDEX IF NOT EXISTS idx_orders_org_status ON orders(organization_id, status);
CREATE INDEX IF NOT EXISTS idx_orders_org_created ON orders(organization_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_orders_customer ON orders(customer_id);
CREATE INDEX IF NOT EXISTS idx_orders_employee ON orders(employee_id);
CREATE INDEX IF NOT EXISTS idx_orders_global_number ON orders(global_order_number);
`;
```

### 4.2 Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯: `src/lib/db/schema/tables/products.sql.ts`

```typescript
/**
 * Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ù…ØªØ·Ø§Ø¨Ù‚ 100% Ù…Ø¹ Supabase
 *
 * Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø£Ø¹Ù…Ø¯Ø© camelCase
 */
export const PRODUCTS_TABLE = `
CREATE TABLE IF NOT EXISTS products (
  -- Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  id TEXT PRIMARY KEY,
  organization_id TEXT NOT NULL,
  category_id TEXT,
  subcategory_id TEXT,
  supplier_id TEXT,

  -- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
  name TEXT NOT NULL,
  description TEXT,
  sku TEXT NOT NULL,
  barcode TEXT,
  slug TEXT,
  brand TEXT,
  category TEXT,
  subcategory TEXT,

  -- Ø§Ù„ØªØ³Ø¹ÙŠØ±
  price REAL NOT NULL DEFAULT 0,
  compare_at_price REAL,
  purchase_price REAL,

  -- ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø¬Ù…Ù„Ø©
  wholesale_price REAL,
  partial_wholesale_price REAL,
  min_wholesale_quantity INTEGER,
  min_partial_wholesale_quantity INTEGER,
  allow_retail INTEGER DEFAULT 1,
  allow_wholesale INTEGER DEFAULT 0,
  allow_partial_wholesale INTEGER DEFAULT 0,

  -- Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©
  is_sold_by_unit INTEGER DEFAULT 1,
  unit_type TEXT,
  unit_purchase_price REAL,
  unit_sale_price REAL,

  -- Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
  stock_quantity INTEGER NOT NULL DEFAULT 0,
  min_stock_level INTEGER DEFAULT 5,
  reorder_level INTEGER DEFAULT 10,
  reorder_quantity INTEGER DEFAULT 20,

  -- Ø§Ù„Ø­Ø§Ù„Ø©
  is_active INTEGER DEFAULT 1,
  is_featured INTEGER DEFAULT 0,
  is_digital INTEGER DEFAULT 0,
  is_new INTEGER DEFAULT 0,
  show_price_on_landing INTEGER DEFAULT 1,

  -- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
  has_variants INTEGER DEFAULT 0,
  use_sizes INTEGER DEFAULT 0,
  use_variant_prices INTEGER DEFAULT 0,

  -- Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„ÙˆØ²Ù†
  sell_by_weight INTEGER DEFAULT 0,
  weight_unit TEXT DEFAULT 'kg',
  price_per_weight_unit REAL,
  purchase_price_per_weight_unit REAL,
  min_weight_per_sale REAL,
  max_weight_per_sale REAL,
  average_item_weight REAL,
  available_weight REAL DEFAULT 0,
  total_weight_purchased REAL DEFAULT 0,

  -- Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
  sell_by_box INTEGER DEFAULT 0,
  units_per_box INTEGER DEFAULT 1,
  box_price REAL,
  box_purchase_price REAL,
  box_barcode TEXT,
  allow_single_unit_sale INTEGER DEFAULT 1,
  available_boxes INTEGER DEFAULT 0,
  total_boxes_purchased INTEGER DEFAULT 0,

  -- Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ø§Ù„Ù…ØªØ±
  sell_by_meter INTEGER DEFAULT 0,
  meter_unit TEXT DEFAULT 'm',
  price_per_meter REAL,
  purchase_price_per_meter REAL,
  min_meters_per_sale REAL DEFAULT 0.1,
  roll_length_meters REAL,
  available_length REAL DEFAULT 0,
  total_meters_purchased REAL DEFAULT 0,

  -- Ø§Ù„ØªØªØ¨Ø¹
  track_expiry INTEGER DEFAULT 0,
  default_expiry_days INTEGER,
  expiry_alert_days INTEGER DEFAULT 30,
  track_serial_numbers INTEGER DEFAULT 0,
  require_serial_on_sale INTEGER DEFAULT 0,
  track_batches INTEGER DEFAULT 0,
  use_fifo INTEGER DEFAULT 1,

  -- Ø§Ù„Ø¶Ù…Ø§Ù†
  has_warranty INTEGER DEFAULT 0,
  warranty_duration_months INTEGER,
  warranty_type TEXT,

  -- Ø§Ù„ØµÙˆØ±
  images TEXT,
  thumbnail_image TEXT,

  -- Ø§Ù„Ù†Ø´Ø±
  publication_status TEXT DEFAULT 'published',
  publish_at TEXT,
  published_at TEXT,

  -- Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨
  tax_rate REAL,
  tax_included INTEGER DEFAULT 1,
  commission_rate REAL,

  -- Ø§Ù„Ø®ØµØ§Ø¦Øµ
  features TEXT,
  specifications TEXT,
  dimensions TEXT,
  weight_kg REAL,

  -- Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù…ØªØ®ØµØµØ©
  -- Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©
  requires_prescription INTEGER DEFAULT 0,
  active_ingredient TEXT,
  dosage_form TEXT,
  concentration TEXT,

  -- Ø§Ù„Ù…Ø·Ø§Ø¹Ù…
  preparation_time_minutes INTEGER,
  calories INTEGER,
  allergens TEXT,
  is_vegetarian INTEGER DEFAULT 0,
  is_vegan INTEGER DEFAULT 0,
  is_gluten_free INTEGER DEFAULT 0,
  spice_level INTEGER,

  -- Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±
  oem_number TEXT,
  compatible_models TEXT,
  vehicle_make TEXT,
  vehicle_model TEXT,
  year_from INTEGER,
  year_to INTEGER,

  -- Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¨Ù†Ø§Ø¡
  material_type TEXT,
  coverage_area_sqm REAL,

  -- Ø§Ù„ØªØµÙ†ÙŠØ¹
  manufacturer TEXT,
  country_of_origin TEXT,
  customs_code TEXT,

  -- Ø§Ù„Ø´Ø­Ù†
  has_fast_shipping INTEGER DEFAULT 0,
  has_money_back INTEGER DEFAULT 0,
  has_quality_guarantee INTEGER DEFAULT 0,
  fast_shipping_text TEXT,
  money_back_text TEXT,
  quality_guarantee_text TEXT,

  -- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
  special_offers_config TEXT,
  advanced_description TEXT,
  purchase_page_config TEXT,

  -- Ø§Ù„ØªØªØ¨Ø¹
  created_by_user_id TEXT,
  updated_by_user_id TEXT,
  form_template_id TEXT,
  shipping_provider_id INTEGER,
  shipping_clone_id INTEGER,
  use_shipping_clone INTEGER DEFAULT 0,
  shipping_method_type TEXT DEFAULT 'default',
  name_for_shipping TEXT,

  -- Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now')),
  last_inventory_update TEXT,

  -- âš¡ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø· - ØªØ¨Ø¯Ø£ Ø¨Ù€ _)
  _synced INTEGER DEFAULT 0,
  _sync_status TEXT,
  _pending_operation TEXT,
  _local_updated_at TEXT,
  _name_lower TEXT,
  _sku_lower TEXT,
  _barcode_lower TEXT
);
`;

export const PRODUCTS_INDEXES = `
CREATE INDEX IF NOT EXISTS idx_products_org ON products(organization_id);
CREATE INDEX IF NOT EXISTS idx_products_org_active ON products(organization_id, is_active);
CREATE INDEX IF NOT EXISTS idx_products_sku ON products(sku);
CREATE INDEX IF NOT EXISTS idx_products_barcode ON products(barcode);
CREATE INDEX IF NOT EXISTS idx_products_category ON products(category_id);
CREATE INDEX IF NOT EXISTS idx_products_name_lower ON products(_name_lower);
CREATE INDEX IF NOT EXISTS idx_products_sku_lower ON products(_sku_lower);
CREATE INDEX IF NOT EXISTS idx_products_barcode_lower ON products(_barcode_lower);
`;
```

### 4.3 Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©

```typescript
/**
 * âš¡ Ù‚Ø§Ø¹Ø¯Ø© Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:
 *
 * Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø· ØªØ¨Ø¯Ø£ Ø¨Ù€ _ (underscore)
 * Ù‡Ø°Ø§ ÙŠØ¬Ø¹Ù„Ù‡Ø§ ÙˆØ§Ø¶Ø­Ø© ÙˆÙŠØ³Ù‡Ù„ ÙÙ„ØªØ±ØªÙ‡Ø§
 */

// Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© Ù„ÙƒÙ„ Ø¬Ø¯ÙˆÙ„
const LOCAL_COLUMNS = [
  '_synced',           // Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (0 = ØºÙŠØ± Ù…ØªØ²Ø§Ù…Ù†ØŒ 1 = Ù…ØªØ²Ø§Ù…Ù†)
  '_sync_status',      // pending, syncing, synced, failed
  '_pending_operation', // INSERT, UPDATE, DELETE
  '_local_updated_at', // Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
  '_error',            // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¥Ù† ÙˆØ¬Ø¯Øª
];

// Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ù„Ù„ÙÙ‡Ø±Ø³Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©)
const LOCAL_SEARCH_COLUMNS = [
  '_name_lower',       // Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
  '_sku_lower',        // Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
  '_barcode_lower',    // Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
];
```

---

## 5. Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©

### 5.1 Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ø³Ø·

```typescript
// Ù…Ù„Ù: src/lib/sync/config/index.ts

/**
 * âš¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
 *
 * Ù„Ø§ ÙŠÙˆØ¬Ø¯ TABLE_MAP Ù„Ø£Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø©
 * Ù„Ø§ ÙŠÙˆØ¬Ø¯ COLUMN_MAP Ù„Ø£Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø©
 */

export const SYNC_CONFIG = {
  // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø© (Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)
  SYNCED_TABLES: [
    // Ø§Ù„Ù…Ø³ØªÙ‚Ù„Ø© (ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙˆØ§Ø²ÙŠ)
    'products',
    'product_categories',
    'product_subcategories',
    'customers',
    'suppliers',
    'expense_categories',

    // Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© (ÙŠØ¬Ø¨ Ø§Ù„ØªØ³Ù„Ø³Ù„)
    'orders',
    'order_items',
    'invoices',
    'invoice_items',
    'returns',
    'return_items',
    'losses',
    'loss_items',
    'supplier_purchases',
    'supplier_purchase_items',
    'supplier_payments',

    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    'product_colors',
    'product_sizes',
    'product_images',

    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    'pos_settings',
    'organization_settings',
    'staff_work_sessions',
  ],

  // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø· (Ù„Ø§ ØªÙØ²Ø§Ù…Ù†)
  LOCAL_ONLY_TABLES: [
    'sync_outbox',
    'sync_state',
    'cached_images',
    'cached_notifications',
    'app_license_state',
    'staff_pins',
    'user_credentials',
  ],

  // Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ØªØ¨Ø¯Ø£ Ø¨Ù€ _)
  // ÙŠØªÙ… ÙÙ„ØªØ±ØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø©
  LOCAL_COLUMN_PREFIX: '_',

  // Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
  BATCH_SIZE: 50,
  BATCH_INTERVAL_MS: 3000,
  IDLE_INTERVAL_MS: 30000,
  MAX_RETRY_ATTEMPTS: 5,
  RETRY_DELAY_BASE_MS: 1000,
};

/**
 * ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
 */
export function filterLocalColumns(data: Record<string, any>): Record<string, any> {
  const filtered: Record<string, any> = {};

  for (const [key, value] of Object.entries(data)) {
    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ _
    if (!key.startsWith('_')) {
      filtered[key] = value;
    }
  }

  return filtered;
}

/**
 * Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù€ getServerTableName Ù„Ø£Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø©
 * Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù€ getServerColumnName Ù„Ø£Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø©
 */
```

### 5.2 PushEngine Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†

```typescript
// Ù…Ù„Ù: src/lib/sync/core/PushEngine.ts

import { supabase } from '@/lib/supabase';
import { SYNC_CONFIG, filterLocalColumns } from '../config';
import { outboxManager } from '../queue/OutboxManager';

export class PushEngine {
  private organizationId: string | null = null;
  private isRunning = false;

  async start(organizationId: string) {
    this.organizationId = organizationId;
    this.isRunning = true;
    this.scheduleNextBatch();
  }

  stop() {
    this.isRunning = false;
  }

  /**
   * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
   */
  async processBatch(): Promise<BatchResult> {
    const pending = await outboxManager.getPending(SYNC_CONFIG.BATCH_SIZE);
    if (pending.length === 0) return { success: true, count: 0 };

    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª (Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ±)
    const sorted = this.sortByDependency(pending);

    const results: BatchResult = { success: true, count: 0, errors: [] };

    for (const op of sorted) {
      try {
        await this.processOperation(op);
        await outboxManager.markSent(op.id);
        results.count++;
      } catch (error) {
        results.errors.push({ id: op.id, error: String(error) });
        await outboxManager.markFailed(op.id, String(error));
      }
    }

    return results;
  }

  /**
   * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
   */
  private async processOperation(op: OutboxEntry): Promise<void> {
    const payload = JSON.parse(op.payload);

    // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    const cleanPayload = filterLocalColumns(payload);

    // âœ… Ø¥Ø¶Ø§ÙØ© organization_id Ø¥Ø°Ø§ Ù„Ø²Ù…
    if (this.organizationId && !cleanPayload.organization_id) {
      cleanPayload.organization_id = this.organizationId;
    }

    // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    this.validatePayload(op.table_name, cleanPayload);

    switch (op.operation) {
      case 'INSERT':
      case 'UPDATE':
        const { error: upsertError } = await supabase
          .from(op.table_name)
          .upsert(cleanPayload);
        if (upsertError) throw upsertError;
        break;

      case 'DELETE':
        const { error: deleteError } = await supabase
          .from(op.table_name)
          .delete()
          .eq('id', op.record_id);
        if (deleteError) throw deleteError;
        break;

      case 'DELTA':
        await this.handleDelta(op.table_name, op.record_id, payload);
        break;
    }
  }

  /**
   * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
   */
  private validatePayload(table: string, payload: Record<string, any>): void {
    // orders: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† total Ùˆ subtotal Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
    if (table === 'orders') {
      if (payload.total === undefined) {
        payload.total = payload.subtotal || 0;
      }
      if (payload.subtotal === undefined) {
        payload.subtotal = payload.total || 0;
      }
      if (!payload.status) {
        payload.status = 'pending';
      }
      if (!payload.payment_method) {
        throw new Error('payment_method is required for orders');
      }
      if (!payload.payment_status) {
        payload.payment_status = 'pending';
      }
    }

    // order_items: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† order_id Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (table === 'order_items') {
      if (!payload.order_id) {
        throw new Error('order_id is required for order_items');
      }
      if (!payload.product_id) {
        throw new Error('product_id is required for order_items');
      }
      if (!payload.name) {
        payload.name = 'Ù…Ù†ØªØ¬';
      }
      if (payload.total_price === undefined) {
        payload.total_price = (payload.quantity || 1) * (payload.unit_price || 0);
      }
    }
  }

  /**
   * Ù…Ø¹Ø§Ù„Ø¬Ø© DELTA Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… RPC
   */
  private async handleDelta(
    table: string,
    recordId: string,
    delta: Record<string, number>
  ): Promise<void> {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… RPC Ù„ØªØ¬Ù†Ø¨ Race Condition
    const { error } = await supabase.rpc('apply_delta', {
      p_table: table,
      p_record_id: recordId,
      p_delta: delta
    });

    if (error) {
      // Fallback Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† RPC Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
      if (error.code === '42883') {
        await this.handleDeltaFallback(table, recordId, delta);
      } else {
        throw error;
      }
    }
  }

  /**
   * Fallback Ù„Ù„Ù€ DELTA (ØºÙŠØ± Ù…Ø«Ø§Ù„ÙŠ - Ø¹Ø±Ø¶Ø© Ù„Ù€ Race Condition)
   */
  private async handleDeltaFallback(
    table: string,
    recordId: string,
    delta: Record<string, number>
  ): Promise<void> {
    // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const fields = Object.keys(delta);
    const { data, error: fetchError } = await supabase
      .from(table)
      .select(fields.join(','))
      .eq('id', recordId)
      .single();

    if (fetchError) throw fetchError;
    if (!data) return; // Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ø°ÙˆÙ

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const updates: Record<string, number> = {};
    for (const [field, deltaValue] of Object.entries(delta)) {
      const current = (data as any)[field] || 0;
      updates[field] = Math.max(0, current + deltaValue);
    }

    // ØªØ­Ø¯ÙŠØ«
    const { error: updateError } = await supabase
      .from(table)
      .update({ ...updates, updated_at: new Date().toISOString() })
      .eq('id', recordId);

    if (updateError) throw updateError;
  }

  /**
   * ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
   */
  private sortByDependency(ops: OutboxEntry[]): OutboxEntry[] {
    const priority: Record<string, number> = {
      'orders': 1,
      'invoices': 2,
      'returns': 3,
      'losses': 4,
      'supplier_purchases': 5,
      'order_items': 10,
      'invoice_items': 11,
      'return_items': 12,
      'loss_items': 13,
      'supplier_purchase_items': 14,
    };

    return [...ops].sort((a, b) => {
      const pa = priority[a.table_name] || 50;
      const pb = priority[b.table_name] || 50;
      if (pa !== pb) return pa - pb;
      return a.local_seq - b.local_seq;
    });
  }
}
```

### 5.3 PullEngine Ø§Ù„Ù…ÙØ­Ø³Ù‘Ù†

```typescript
// Ù…Ù„Ù: src/lib/sync/core/PullEngine.ts

import { supabase } from '@/lib/supabase';
import { SYNC_CONFIG } from '../config';
import { tauriBatchUpsert, tauriExecute } from '@/lib/db/sqliteClient';
import { outboxManager } from '../queue/OutboxManager';

export class PullEngine {
  private organizationId: string;
  private pendingIds: Map<string, Set<string>> = new Map();

  constructor(organizationId: string) {
    this.organizationId = organizationId;
  }

  /**
   * ØªÙ‡ÙŠØ¦Ø© Ø¬Ø¯ÙˆÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
   */
  async init(): Promise<void> {
    await tauriExecute(this.organizationId, `
      CREATE TABLE IF NOT EXISTS sync_state (
        table_name TEXT PRIMARY KEY,
        last_synced_at TEXT,
        last_sync_status TEXT,
        error_message TEXT
      )
    `);
  }

  /**
   * ØªØ­Ø¯ÙŠØ« cache Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
   */
  async refreshPendingCache(): Promise<void> {
    const pending = await outboxManager.getPendingOperations();
    this.pendingIds.clear();

    for (const op of pending) {
      if (!this.pendingIds.has(op.table_name)) {
        this.pendingIds.set(op.table_name, new Set());
      }
      this.pendingIds.get(op.table_name)!.add(op.record_id);
    }
  }

  /**
   * Ø¬Ù„Ø¨ Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
   */
  async pullTable(tableName: string): Promise<PullResult> {
    const startTime = Date.now();
    const result: PullResult = { processed: 0, skipped: 0, errors: 0 };

    try {
      const syncState = await this.getSyncState(tableName);
      const lastSynced = syncState?.last_synced_at || '1970-01-01T00:00:00Z';

      console.log(`[PullEngine] â¬‡ï¸ Pulling ${tableName} since ${lastSynced}`);

      // Ø¬Ù„Ø¨ IDs Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
      const pendingIds = this.pendingIds.get(tableName) || new Set();

      let page = 0;
      let hasMore = true;
      let maxTimestamp = lastSynced;

      while (hasMore) {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Supabase
        let query = supabase
          .from(tableName)
          .select('*')
          .gt('updated_at', lastSynced)
          .order('updated_at', { ascending: true })
          .range(page * 1000, (page + 1) * 1000 - 1);

        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ organization_id Ø¥Ø°Ø§ Ù„Ø²Ù…
        if (this.tableHasOrgId(tableName)) {
          query = query.eq('organization_id', this.organizationId);
        }

        const { data, error } = await query;

        if (error) {
          console.error(`[PullEngine] âŒ Error: ${error.message}`);
          result.errors++;
          break;
        }

        if (!data || data.length === 0) {
          hasMore = false;
          break;
        }

        // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        const toUpsert: any[] = [];
        const toDelete: string[] = [];

        for (const record of data) {
          // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
          if (pendingIds.has(record.id)) {
            result.skipped++;
            continue;
          }

          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ø§Ø¹Ù…
          if (record.deleted_at) {
            toDelete.push(record.id);
          } else {
            // Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
            toUpsert.push({
              ...record,
              _synced: 1,
              _sync_status: 'synced',
            });
          }

          // ØªØ­Ø¯ÙŠØ« Ø£Ù‚ØµÙ‰ timestamp
          if (record.updated_at > maxTimestamp) {
            maxTimestamp = record.updated_at;
          }
        }

        // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        if (toDelete.length > 0) {
          await tauriExecute(
            this.organizationId,
            `DELETE FROM ${tableName} WHERE id IN (${toDelete.map(() => '?').join(',')})`,
            toDelete
          );
          result.processed += toDelete.length;
        }

        // Ø¥Ø¯Ø±Ø§Ø¬/ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        if (toUpsert.length > 0) {
          await tauriBatchUpsert(this.organizationId, tableName, toUpsert, 'id');
          result.processed += toUpsert.length;
        }

        if (data.length < 1000) {
          hasMore = false;
        } else {
          page++;
        }
      }

      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      if (result.errors === 0) {
        await this.updateSyncState(tableName, maxTimestamp, 'success');
      }

      const duration = Date.now() - startTime;
      console.log(`[PullEngine] âœ… ${tableName}: ${result.processed} processed, ${result.skipped} skipped (${duration}ms)`);

    } catch (error) {
      console.error(`[PullEngine] âŒ Critical error: ${error}`);
      result.errors++;
    }

    return result;
  }

  /**
   * Ù‡Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ organization_id
   */
  private tableHasOrgId(tableName: string): boolean {
    const noOrgIdTables = [
      'product_colors',
      'product_sizes',
      'product_images',
      'invoice_items',
      'return_items',
      'loss_items',
      'supplier_purchase_items',
    ];
    return !noOrgIdTables.includes(tableName);
  }

  // ... getSyncState, updateSyncState
}
```

---

## 6. Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ TypeScript

### 6.1 Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ù†ÙˆØ§Ø¹

```typescript
// Ù…Ù„Ù: src/lib/types/index.ts

// ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ù…Ù† Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯

// Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª
export * from './entities/product';
export * from './entities/order';
export * from './entities/orderItem';
export * from './entities/customer';
export * from './entities/supplier';
export * from './entities/invoice';
export * from './entities/expense';

// Ø£Ù†ÙˆØ§Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
export type { Database } from './database/supabase.types';

// Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
export * from './sync/outbox';
export * from './sync/state';

// Ø£Ù†ÙˆØ§Ø¹ Ù…Ø³Ø§Ø¹Ø¯Ø©
export * from './common';
```

### 6.2 Ø£Ù†ÙˆØ§Ø¹ Ù…Ø´ØªØ±ÙƒØ©

```typescript
// Ù…Ù„Ù: src/lib/types/common.ts

/**
 * Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©
 */
export interface AuditColumns {
  created_at: string;
  updated_at: string;
}

/**
 * Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ØªØ¨Ø¯Ø£ Ø¨Ù€ _)
 */
export interface LocalSyncColumns {
  _synced?: 0 | 1;
  _sync_status?: 'pending' | 'syncing' | 'synced' | 'failed';
  _pending_operation?: 'INSERT' | 'UPDATE' | 'DELETE' | null;
  _local_updated_at?: string;
  _error?: string;
}

/**
 * Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹
 */
export type SaleType = 'retail' | 'wholesale' | 'partial_wholesale';

/**
 * Ù†ÙˆØ¹ ÙˆØ­Ø¯Ø© Ø§Ù„Ø¨ÙŠØ¹
 */
export type SellingUnitType = 'piece' | 'weight' | 'meter' | 'box';

/**
 * Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
 */
export type OrderStatus = 'pending' | 'processing' | 'completed' | 'cancelled';

/**
 * Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
 */
export type PaymentMethod = 'cash' | 'card' | 'credit' | 'mixed' | 'bank_transfer';

/**
 * Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
 */
export type PaymentStatus = 'pending' | 'paid' | 'partial' | 'refunded';
```

### 6.3 Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„

```typescript
// Ù…Ù„Ù: src/lib/utils/transformers.ts

/**
 * âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:
 *
 * Ø¨Ø¹Ø¯ ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ØŒ Ù„Ù† Ù†Ø­ØªØ§Ø¬ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„!
 * Ù†Ø­ØªÙØ¸ Ø¨Ù‡Ø§ ÙÙ‚Ø· Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
 */

/**
 * ØªØ­ÙˆÙŠÙ„ snake_case Ø¥Ù„Ù‰ camelCase
 * @deprecated Ø§Ø³ØªØ®Ø¯Ù… snake_case ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù†
 */
export function toCamelCase<T extends Record<string, any>>(obj: T): T {
  const result: any = {};
  for (const [key, value] of Object.entries(obj)) {
    const camelKey = key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
    result[camelKey] = value;
  }
  return result;
}

/**
 * ØªØ­ÙˆÙŠÙ„ camelCase Ø¥Ù„Ù‰ snake_case
 * @deprecated Ø§Ø³ØªØ®Ø¯Ù… snake_case ÙÙŠ ÙƒÙ„ Ù…ÙƒØ§Ù†
 */
export function toSnakeCase<T extends Record<string, any>>(obj: T): T {
  const result: any = {};
  for (const [key, value] of Object.entries(obj)) {
    const snakeKey = key.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);
    result[snakeKey] = value;
  }
  return result;
}

/**
 * ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ù€ _)
 */
export function filterLocalColumns<T extends Record<string, any>>(obj: T): Partial<T> {
  const result: any = {};
  for (const [key, value] of Object.entries(obj)) {
    if (!key.startsWith('_')) {
      result[key] = value;
    }
  }
  return result;
}
```

---

## 7. Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¯Ù…Ø§Øª

### 7.1 OrderService Ø§Ù„Ø¬Ø¯ÙŠØ¯

```typescript
// Ù…Ù„Ù: src/api/services/orders/OrderService.ts

import { supabase } from '@/lib/supabase';
import { Order, OrderItem, OrderStatus, PaymentStatus } from '@/lib/types';
import { filterLocalColumns } from '@/lib/utils/transformers';

export class OrderService {

  /**
   * Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
   */
  async createOrder(
    organizationId: string,
    orderData: Omit<Order, 'id' | 'created_at' | 'updated_at'>,
    items: Omit<OrderItem, 'id' | 'order_id' | 'created_at'>[]
  ): Promise<{ order: Order; items: OrderItem[] }> {

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    if (!orderData.payment_method) {
      throw new Error('payment_method is required');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .insert({
        ...filterLocalColumns(orderData),
        organization_id: organizationId,
        status: orderData.status || 'pending',
        payment_status: orderData.payment_status || 'pending',
        is_online: orderData.is_online ?? false,
        subtotal: orderData.subtotal || 0,
        tax: orderData.tax || 0,
        total: orderData.total || orderData.subtotal || 0,
      })
      .select()
      .single();

    if (orderError) throw orderError;

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const itemsWithOrderId = items.map(item => ({
      ...filterLocalColumns(item),
      order_id: order.id,
      organization_id: organizationId,
      name: item.name || 'Ù…Ù†ØªØ¬',
      quantity: item.quantity || 1,
      unit_price: item.unit_price || 0,
      total_price: item.total_price || (item.quantity || 1) * (item.unit_price || 0),
    }));

    const { data: insertedItems, error: itemsError } = await supabase
      .from('order_items')
      .insert(itemsWithOrderId)
      .select();

    if (itemsError) throw itemsError;

    return { order, items: insertedItems };
  }

  /**
   * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
   */
  async updateOrderStatus(
    orderId: string,
    status: OrderStatus,
    paymentStatus?: PaymentStatus
  ): Promise<Order> {
    const updates: Partial<Order> = {
      status,
      updated_at: new Date().toISOString(),
    };

    if (paymentStatus) {
      updates.payment_status = paymentStatus;
    }

    if (status === 'completed') {
      updates.completed_at = new Date().toISOString();
    }

    const { data, error } = await supabase
      .from('orders')
      .update(updates)
      .eq('id', orderId)
      .select()
      .single();

    if (error) throw error;
    return data;
  }

  /**
   * Ø¬Ù„Ø¨ Ø·Ù„Ø¨ Ù…Ø¹ Ø¹Ù†Ø§ØµØ±Ù‡
   */
  async getOrderWithItems(orderId: string): Promise<Order & { items: OrderItem[] }> {
    const { data: order, error: orderError } = await supabase
      .from('orders')
      .select('*')
      .eq('id', orderId)
      .single();

    if (orderError) throw orderError;

    const { data: items, error: itemsError } = await supabase
      .from('order_items')
      .select('*')
      .eq('order_id', orderId);

    if (itemsError) throw itemsError;

    return { ...order, items: items || [] };
  }
}

export const orderService = new OrderService();
```

### 7.2 LocalOrderService Ø§Ù„Ø¬Ø¯ÙŠØ¯

```typescript
// Ù…Ù„Ù: src/api/services/orders/LocalOrderService.ts

import { Order, OrderItem, LocalSyncColumns } from '@/lib/types';
import { tauriExecute, tauriUpsert, tauriBatchUpsert, tauriQuery } from '@/lib/db/sqliteClient';
import { outboxManager } from '@/lib/sync/queue/OutboxManager';
import { generateUUID } from '@/lib/utils/uuid';

type LocalOrder = Order & LocalSyncColumns;
type LocalOrderItem = OrderItem & LocalSyncColumns;

export class LocalOrderService {
  private organizationId: string;

  constructor(organizationId: string) {
    this.organizationId = organizationId;
  }

  /**
   * Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ù…Ø­Ù„ÙŠ
   */
  async createOrder(
    orderData: Omit<Order, 'id' | 'created_at' | 'updated_at' | 'organization_id'>,
    items: Omit<OrderItem, 'id' | 'order_id' | 'created_at' | 'organization_id'>[]
  ): Promise<{ order: LocalOrder; items: LocalOrderItem[] }> {

    const orderId = generateUUID();
    const now = new Date().toISOString();

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø·Ù„Ø¨
    const order: LocalOrder = {
      id: orderId,
      organization_id: this.organizationId,
      ...orderData,
      status: orderData.status || 'pending',
      payment_status: orderData.payment_status || 'pending',
      is_online: orderData.is_online ?? false,
      subtotal: orderData.subtotal || 0,
      tax: orderData.tax || 0,
      total: orderData.total || orderData.subtotal || 0,
      created_at: now,
      updated_at: now,
      // Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      _synced: 0,
      _sync_status: 'pending',
      _pending_operation: 'INSERT',
      _local_updated_at: now,
    };

    // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨
    await tauriUpsert(this.organizationId, 'orders', order, 'id');

    // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ outbox
    await outboxManager.add({
      tableName: 'orders',
      operation: 'INSERT',
      recordId: orderId,
      payload: order,
    });

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const orderItems: LocalOrderItem[] = items.map(item => ({
      id: generateUUID(),
      order_id: orderId,
      organization_id: this.organizationId,
      product_id: item.product_id,
      name: item.name || 'Ù…Ù†ØªØ¬',
      quantity: item.quantity || 1,
      unit_price: item.unit_price || 0,
      total_price: item.total_price || (item.quantity || 1) * (item.unit_price || 0),
      color_id: item.color_id || null,
      size_id: item.size_id || null,
      color_name: item.color_name || null,
      size_name: item.size_name || null,
      sale_type: item.sale_type || 'retail',
      selling_unit_type: item.selling_unit_type || 'piece',
      created_at: now,
      // Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      _synced: 0,
      _sync_status: 'pending',
      _pending_operation: 'INSERT',
    }));

    // Ø­ÙØ¸ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    await tauriBatchUpsert(this.organizationId, 'order_items', orderItems, 'id');

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ù€ outbox
    for (const item of orderItems) {
      await outboxManager.add({
        tableName: 'order_items',
        operation: 'INSERT',
        recordId: item.id,
        payload: item,
      });
    }

    return { order, items: orderItems };
  }

  /**
   * Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
   */
  async getOrders(options?: {
    status?: string;
    limit?: number;
    offset?: number;
  }): Promise<LocalOrder[]> {
    let query = `
      SELECT * FROM orders
      WHERE organization_id = ?
    `;
    const params: any[] = [this.organizationId];

    if (options?.status) {
      query += ` AND status = ?`;
      params.push(options.status);
    }

    query += ` ORDER BY created_at DESC`;

    if (options?.limit) {
      query += ` LIMIT ?`;
      params.push(options.limit);
    }

    if (options?.offset) {
      query += ` OFFSET ?`;
      params.push(options.offset);
    }

    const result = await tauriQuery<LocalOrder>(this.organizationId, query, params);
    return result.data || [];
  }
}
```

---

## 8. Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Migration ÙˆØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

### 8.1 Ø®Ø·Ø© Ø§Ù„ØªØ±Ø­ÙŠÙ„

```typescript
// Ù…Ù„Ù: src/lib/db/schema/migrations/v43_unify_schema.ts

/**
 * Migration v43: ØªÙˆØ­ÙŠØ¯ Schema Ù…Ø¹ Supabase
 *
 * Ù‡Ø°Ø§ Ø§Ù„Ù€ migration ÙŠÙ‚ÙˆÙ… Ø¨Ù€:
 * 1. Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (pos_orders â†’ orders)
 * 2. Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (total_amount â†’ total)
 * 3. Ø­Ø°Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© (camelCase)
 * 4. Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© _ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
 */

export async function migrate_v43(organizationId: string): Promise<void> {
  console.log('[Migration v43] Starting schema unification...');

  // 1. Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
  await renameTable(organizationId, 'pos_orders', 'orders');
  await renameTable(organizationId, 'pos_order_items', 'order_items');
  await renameTable(organizationId, 'product_returns', 'returns');
  await renameTable(organizationId, 'loss_declarations', 'losses');
  await renameTable(organizationId, 'work_sessions', 'staff_work_sessions');

  // 2. Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ orders
  await renameColumn(organizationId, 'orders', 'total_amount', 'total');
  await renameColumn(organizationId, 'orders', 'paid_amount', 'amount_paid');
  await renameColumn(organizationId, 'orders', 'staff_id', 'employee_id');
  await renameColumn(organizationId, 'orders', 'order_number', 'global_order_number');

  // 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ order_items
  await renameColumn(organizationId, 'order_items', 'product_name', 'name');
  await renameColumn(organizationId, 'order_items', 'subtotal', 'total_price');

  // 4. Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© _ Ù„Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  await renameColumn(organizationId, 'products', 'synced', '_synced');
  await renameColumn(organizationId, 'products', 'sync_status', '_sync_status');
  await renameColumn(organizationId, 'products', 'pending_operation', '_pending_operation');
  await renameColumn(organizationId, 'products', 'local_updated_at', '_local_updated_at');
  await renameColumn(organizationId, 'products', 'name_lower', '_name_lower');
  await renameColumn(organizationId, 'products', 'sku_lower', '_sku_lower');
  await renameColumn(organizationId, 'products', 'barcode_lower', '_barcode_lower');

  // Ù†ÙØ³ Ø§Ù„Ø´ÙŠØ¡ Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„...

  // 5. Ø­Ø°Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© (camelCase)
  await dropDuplicateColumns(organizationId);

  // 6. ØªØ­Ø¯ÙŠØ« Ø¥ØµØ¯Ø§Ø± Schema
  await updateSchemaVersion(organizationId, 43);

  console.log('[Migration v43] âœ… Schema unification complete!');
}

/**
 * Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø¬Ø¯ÙˆÙ„
 */
async function renameTable(
  organizationId: string,
  oldName: string,
  newName: string
): Promise<void> {
  try {
    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const exists = await tableExists(organizationId, oldName);
    if (!exists) {
      console.log(`[Migration] Table ${oldName} not found, skipping...`);
      return;
    }

    // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    const newExists = await tableExists(organizationId, newName);
    if (newExists) {
      console.log(`[Migration] Table ${newName} already exists, migrating data...`);
      // Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø¬Ø¯ÙŠØ¯
      await exec(organizationId, `
        INSERT INTO ${newName} SELECT * FROM ${oldName}
        WHERE id NOT IN (SELECT id FROM ${newName})
      `);
      await exec(organizationId, `DROP TABLE ${oldName}`);
      return;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©
    await exec(organizationId, `ALTER TABLE ${oldName} RENAME TO ${newName}`);
    console.log(`[Migration] Renamed ${oldName} â†’ ${newName}`);
  } catch (error) {
    console.error(`[Migration] Error renaming ${oldName}:`, error);
  }
}

/**
 * Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø¹Ù…ÙˆØ¯
 */
async function renameColumn(
  organizationId: string,
  tableName: string,
  oldColumn: string,
  newColumn: string
): Promise<void> {
  try {
    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
    const hasOld = await columnExists(organizationId, tableName, oldColumn);
    if (!hasOld) {
      console.log(`[Migration] Column ${tableName}.${oldColumn} not found, skipping...`);
      return;
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const hasNew = await columnExists(organizationId, tableName, newColumn);
    if (hasNew) {
      // Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø¬Ø¯ÙŠØ¯
      await exec(organizationId, `
        UPDATE ${tableName}
        SET ${newColumn} = ${oldColumn}
        WHERE ${newColumn} IS NULL AND ${oldColumn} IS NOT NULL
      `);
      console.log(`[Migration] Merged ${tableName}.${oldColumn} â†’ ${newColumn}`);
      return;
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©
    await exec(organizationId, `
      ALTER TABLE ${tableName}
      RENAME COLUMN ${oldColumn} TO ${newColumn}
    `);
    console.log(`[Migration] Renamed ${tableName}.${oldColumn} â†’ ${newColumn}`);
  } catch (error) {
    // SQLite Ù‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… RENAME COLUMN Ù…Ø¨Ø§Ø´Ø±Ø©
    console.log(`[Migration] Using alternative method for ${tableName}.${oldColumn}`);
    await renameColumnAlternative(organizationId, tableName, oldColumn, newColumn);
  }
}

/**
 * Ø­Ø°Ù Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØ±Ø±Ø© (camelCase)
 */
async function dropDuplicateColumns(organizationId: string): Promise<void> {
  const duplicates = [
    // products
    { table: 'products', column: 'compareAtPrice' },
    { table: 'products', column: 'purchasePrice' },
    { table: 'products', column: 'stockQuantity' },
    { table: 'products', column: 'wholesalePrice' },
    { table: 'products', column: 'sellByWeight' },
    { table: 'products', column: 'sellByBox' },
    { table: 'products', column: 'sellByMeter' },
    { table: 'products', column: 'hasVariants' },
    { table: 'products', column: 'useSizes' },
    { table: 'products', column: 'isActive' },
    { table: 'products', column: 'isFeatured' },
    { table: 'products', column: 'thumbnailImage' },
    // ... Ø§Ù„Ù…Ø²ÙŠØ¯

    // orders
    { table: 'orders', column: 'totalAmount' },
    { table: 'orders', column: 'paidAmount' },
    { table: 'orders', column: 'staffId' },
    { table: 'orders', column: 'paymentMethod' },
    { table: 'orders', column: 'paymentStatus' },
    // ... Ø§Ù„Ù…Ø²ÙŠØ¯
  ];

  for (const { table, column } of duplicates) {
    await dropColumn(organizationId, table, column);
  }
}
```

### 8.2 Ø³ÙƒØ±Ø¨Øª ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ±Ø­ÙŠÙ„

```typescript
// Ù…Ù„Ù: src/lib/db/runMigration.ts

import { migrate_v43 } from './schema/migrations/v43_unify_schema';
import { getSchemaVersion, setSchemaVersion } from './schema/version';

export async function runMigrations(organizationId: string): Promise<void> {
  const currentVersion = await getSchemaVersion(organizationId);

  console.log(`[Migrations] Current schema version: ${currentVersion}`);

  // ØªÙ†ÙÙŠØ° Ø§Ù„Ù€ migrations Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  if (currentVersion < 43) {
    console.log('[Migrations] Running v43 (Schema Unification)...');
    await migrate_v43(organizationId);
  }

  // migrations Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©...

  const newVersion = await getSchemaVersion(organizationId);
  console.log(`[Migrations] âœ… All migrations complete. Version: ${newVersion}`);
}
```

---

## 9. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©

### 9.1 Ù…Ù„ÙØ§Øª ÙŠØ¬Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨ØªÙ‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„

```
src/lib/db/tauriSchema.ts                    â†’ src/lib/db/schema/
src/lib/sync/config.ts                       â†’ src/lib/sync/config/
src/lib/sync/SyncManager.ts                  â†’ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø©
src/lib/sync/PullEngine.ts                   â†’ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø©
src/lib/sync/PushEngine.ts                   â†’ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø©
src/lib/sync/delta/DeltaSyncEngine.ts        â†’ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø©
src/lib/sync/delta/OutboxManager.ts          â†’ ØªØ­Ø¯ÙŠØ«
src/types/index.ts                           â†’ src/lib/types/
src/types/product.ts                         â†’ src/lib/types/entities/
```

### 9.2 Ù…Ù„ÙØ§Øª ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ«Ù‡Ø§

```
src/api/posOrdersService.ts                  â†’ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
src/api/localPosOrderService.ts              â†’ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
src/api/productSyncUtils.ts                  â†’ ØªØ­Ø¯ÙŠØ«
src/api/supplierService.ts                   â†’ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
src/api/localSupplierService.ts              â†’ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
src/services/DeltaWriteService.ts            â†’ ØªØ­Ø¯ÙŠØ«
src/services/LocalProductSearchService.ts    â†’ ØªØ­Ø¯ÙŠØ«
src/context/POSDataContext.tsx               â†’ ØªØ­Ø¯ÙŠØ«
src/context/WorkSessionContext.tsx           â†’ ØªØ­Ø¯ÙŠØ«
src/hooks/useLocalPOSProducts.ts             â†’ ØªØ­Ø¯ÙŠØ«
src/hooks/useOptimizedOrders.ts              â†’ ØªØ­Ø¯ÙŠØ«
src/components/pos-advanced/*.tsx            â†’ ØªØ­Ø¯ÙŠØ«
```

### 9.3 Ù…Ù„ÙØ§Øª ÙŠØ¬Ø¨ Ø­Ø°ÙÙ‡Ø§

```
src/lib/sync/delta/BatchSender.ts            â†’ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
src/lib/sync/delta/ConflictResolver.ts       â†’ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
src/lib/sync/delta/MergeStrategy.ts          â†’ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
src/lib/sync/delta/OperationQueue.ts         â†’ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
src/lib/sync/delta/RealtimeReceiver.ts       â†’ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
src/lib/sync/delta/StateHashValidator.ts     â†’ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…
```

---

## 10. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª

### 10.1 Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© 1: Ø­Ø±Ø¬Ø© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„)

| Ø§Ù„Ù…Ù‡Ù…Ø© | Ø§Ù„ÙˆØµÙ | Ø§Ù„Ù…Ù„ÙØ§Øª |
|--------|-------|---------|
| ğŸ”´ Ø¥ØµÙ„Ø§Ø­ SQL Injection | Ø§Ø³ØªØ®Ø¯Ø§Ù… parameterized queries | SyncManager.ts |
| ğŸ”´ Ø¥ØµÙ„Ø§Ø­ null order_id | Ø§Ù„ØªØ­Ù‚Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù€ outbox | PushEngine.ts, OutboxManager.ts |
| ğŸ”´ Ø¥ØµÙ„Ø§Ø­ DELTA Race | Ø§Ø³ØªØ®Ø¯Ø§Ù… RPC Ø£Ùˆ transaction | PushEngine.ts |
| ğŸ”´ Ø¥ØµÙ„Ø§Ø­ payment_method | Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… 'cash' Ø§ÙØªØ±Ø§Ø¶ÙŠ | SyncManager.ts |

### 10.2 Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© 2: Ø¹Ø§Ù„ÙŠØ© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ)

| Ø§Ù„Ù…Ù‡Ù…Ø© | Ø§Ù„ÙˆØµÙ | Ø§Ù„Ù…Ù„ÙØ§Øª |
|--------|-------|---------|
| ğŸŸ  Ø¥Ù†Ø´Ø§Ø¡ Schema Ø¬Ø¯ÙŠØ¯ | Ø¬Ø¯Ø§ÙˆÙ„ Ù…ÙˆØ­Ø¯Ø© | src/lib/db/schema/ |
| ğŸŸ  ÙƒØªØ§Ø¨Ø© Migration | v43 unify schema | migrations/ |
| ğŸŸ  ØªØ­Ø¯ÙŠØ« config.ts | Ø¥Ø²Ø§Ù„Ø© TABLE_MAP Ùˆ COLUMN_MAP | config/ |
| ğŸŸ  ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ | ØªÙˆØ­ÙŠØ¯ Ù…Ø¹ Supabase | src/lib/types/ |

### 10.3 Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© 3: Ù…ØªÙˆØ³Ø·Ø© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø«Ø§Ù„Ø«)

| Ø§Ù„Ù…Ù‡Ù…Ø© | Ø§Ù„ÙˆØµÙ | Ø§Ù„Ù…Ù„ÙØ§Øª |
|--------|-------|---------|
| ğŸŸ¡ ØªØ­Ø¯ÙŠØ« PullEngine | Ø¥Ø²Ø§Ù„Ø© mappings | PullEngine.ts |
| ğŸŸ¡ ØªØ­Ø¯ÙŠØ« PushEngine | Ø¥Ø²Ø§Ù„Ø© mappings | PushEngine.ts |
| ğŸŸ¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¯Ù…Ø§Øª | Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ù…Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø© | api/services/ |
| ğŸŸ¡ ØªØ­Ø¯ÙŠØ« Contexts | Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø³Ù…Ø§Ø¡ Ù…ÙˆØ­Ø¯Ø© | context/ |

### 10.4 Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© 4: Ù…Ù†Ø®ÙØ¶Ø© (Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ù„Ø§Ø­Ù‚Ø©)

| Ø§Ù„Ù…Ù‡Ù…Ø© | Ø§Ù„ÙˆØµÙ | Ø§Ù„Ù…Ù„ÙØ§Øª |
|--------|-------|---------|
| ğŸŸ¢ ØªØ­Ø¯ÙŠØ« Components | Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© | components/ |
| ğŸŸ¢ Ø¥Ø¶Ø§ÙØ© Tests | Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù„Ù€ migration | tests/ |
| ğŸŸ¢ ØªÙˆØ«ÙŠÙ‚ | README ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Øª | docs/ |
| ğŸŸ¢ ØªÙ†Ø¸ÙŠÙ | Ø­Ø°Ù Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© | - |

---

## âœ… Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©

| Ø§Ù„Ù…Ù‚ÙŠØ§Ø³ | Ù‚Ø¨Ù„ | Ø¨Ø¹Ø¯ | Ø§Ù„ØªØ­Ø³Ù† |
|---------|-----|-----|--------|
| **Ø£Ø¹Ù…Ø¯Ø© products** | 419 | 229 | -45% |
| **Ø­Ø¬Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª** | X MB | ~0.5X MB | -50% |
| **Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©** | X sec | ~0.6X sec | +40% |
| **Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©** | ÙƒØ«ÙŠØ±Ø© | 0 | -100% |
| **ØªØ¹Ù‚ÙŠØ¯ config.ts** | 387 Ø³Ø·Ø± | ~100 Ø³Ø·Ø± | -75% |
| **Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©** | 12 Ù…Ù„Ù | 6 Ù…Ù„ÙØ§Øª | -50% |
| **Mappings Ù…Ø·Ù„ÙˆØ¨Ø©** | 50+ | 0 | -100% |

---

**Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©**

> ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯Ù‡Ø§ ÙÙŠ: 2 Ø¯ÙŠØ³Ù…Ø¨Ø± 2025
> Ø§Ù„Ù‡Ø¯Ù: Ù†Ø¸Ø§Ù… Ù…Ø«Ø§Ù„ÙŠ Ù…ÙˆØ­Ø¯ 100%
> Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: 3-4 Ø£Ø³Ø§Ø¨ÙŠØ¹
