# ุฎุทุฉ ุงูุชุฌุงุฑ ุงูุฅููุชุฑููููู ุงููุจุชุฏุฆูู

## ูุธุฑุฉ ุนุงูุฉ
ุฎุทุฉ ุงุดุชุฑุงู ุฎุงุตุฉ ุจุงูุชุฌุงุฑ ุงูุฅููุชุฑููููู ุงููุจุชุฏุฆูู ุชุญุชูู ุนูู ุญุฏูุฏ ูุญุฏุฏุฉ ููุทูุจูุงุช ุงูุฅููุชุฑูููุฉ ูุน ูููุฐุฌ ุชุณุนูุฑ ูุฑู.

## ุงููููุฒุงุช ุงูุฑุฆูุณูุฉ

### ๐ฏ **ุงูุณุนุฑ ูุงูุญุฏูุฏ**
- **ุงูุณุนุฑ**: 1000 ุฏุฌ ุดูุฑูุงู
- **ุงูุญุฏ ุงูุฃูุตู**: 100 ุทูุจูุฉ ุฅููุชุฑูููุฉ ุดูุฑูุงู
- **ูุชุฑุฉ ุงูุชุฌุฑุจุฉ**: 5 ุฃูุงู ูุฌุงูุงู
- **ุฅุนุงุฏุฉ ุงูุชูุนูู**: ุชููุงุฆู ูู ุดูุฑ

### ๐ฐ **ูููุฐุฌ ุงูุชุณุนูุฑ ุงููุฑู**
- **100 ุทูุจูุฉ ุฅุถุงููุฉ**: 1000 ุฏุฌ
- **250 ุทูุจูุฉ ุฅุถุงููุฉ**: 2000 ุฏุฌ
- **ุชุฑููุฉ ูุฎุทุท ุฃุนูู**: ุฅููุงููุฉ ุงูุชุฑููุฉ ูู ุฃู ููุช

### ๐ซ **ูุง ูุง ุชุญุชููู ุงูุฎุทุฉ**
- โ ููุทุฉ ุจูุน (POS)
- โ ุฎุฏูุงุช ุงูุฅุดุชุฑุงูุงุช ุงูุฑูููุฉ
- โ ุฎุฏูุงุช ุงูุฃูุนุงุจ
- โ ุฎุฏูุงุช ุงูุชุตููุญ

### โ **ูุง ุชุญุชููู ุงูุฎุทุฉ**
- โ ูุชุฌุฑ ุฅููุชุฑููู ูุงูู
- โ ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช (ุญุชู 50 ููุชุฌ)
- โ ุฅุฏุงุฑุฉ ุงููุฎุฒูู
- โ ุชูุงุฑูุฑ ุงููุจูุนุงุช ุงูุฃุณุงุณูุฉ
- โ ูุณุชุฎุฏู ูุงุญุฏ ููุท
- โ ุฏุนู ููู ุนุจุฑ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู

## ุงูุจููุฉ ุงูุชูููุฉ

### ๐๏ธ **ูุงุนุฏุฉ ุงูุจูุงูุงุช**

#### ุฌุฏูู `subscription_plans` - ุชู ุชุญุฏูุซู
```sql
ALTER TABLE subscription_plans ADD COLUMN max_online_orders INTEGER;
```

#### ุฌุฏูู `organizations` - ุชู ุชุญุฏูุซู
```sql
ALTER TABLE organizations
ADD COLUMN online_orders_this_month INTEGER DEFAULT 0,
ADD COLUMN online_orders_limit INTEGER,
ADD COLUMN store_blocked BOOLEAN DEFAULT FALSE,
ADD COLUMN store_block_reason TEXT;
```

#### ุฌุฏูู `monthly_online_orders_usage` - ุฌุฏูุฏ
```sql
CREATE TABLE monthly_online_orders_usage (
    organization_id UUID REFERENCES organizations(id),
    year_month TEXT, -- YYYY-MM
    orders_count INTEGER DEFAULT 0,
    orders_limit INTEGER DEFAULT 0
);
```

### ๐ง **ุงููุธุงุฆู ุงููุณุงุนุฏุฉ**

#### `check_online_orders_limit(organization_id)`
- ุงูุชุญูู ูู ุงูุญุฏูุฏ ุงูุดูุฑูุฉ
- ุญุธุฑ ุงููุชุฌุฑ ุนูุฏ ุงูุชุฌุงูุฒ
- ุฅุฑุฌุงุน ูุนูููุงุช ููุตูุฉ

#### `calculate_monthly_online_orders(organization_id)`
- ุญุณุงุจ ุงูุทูุจูุงุช ุงูุดูุฑูุฉ
- ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงูุงุณุชุฎุฏุงู
- ุฅุฑุฌุงุน ุงูุนุฏุฏ ุงูุญุงูู

#### `reset_monthly_online_orders()`
- ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฏุงุฏ ุดูุฑูุงู
- ูู ุญุธุฑ ุงููุชุงุฌุฑ
- ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช

## ุงููุฑููุช ุงูุฏ

### ๐ฃ **Hooks ุงูุฌุฏูุฏุฉ**

#### `useOnlineOrdersLimit()`
```typescript
const { limitInfo, loading, error, checkLimit, refreshLimit } = useOnlineOrdersLimit();
```

### ๐งฉ **ุงูููููุงุช ุงูุฌุฏูุฏุฉ**

#### `OnlineOrdersLimitCard`
- ุนุฑุถ ุญุงูุฉ ุงูุญุฏูุฏ ุงูุดูุฑูุฉ
- ุฅุญุตุงุฆูุงุช ุงูุงุณุชุฎุฏุงู
- ุชุญุฐูุฑุงุช ูุฅุดุนุงุฑุงุช

#### `OrderLimitBlocker`
- ููุน ุฅูุดุงุก ุงูุทูุจูุงุช ุนูุฏ ุงูุญุธุฑ
- ุนุฑุถ ุตูุญุฉ ุญุธุฑ ุฌูููุฉ
- ุฎูุงุฑุงุช ุงูุชุฑููุฉ

## ุงูุชุทุจูู ุงูุนููู

### 1๏ธโฃ **ุชุซุจูุช ุงููุธุงู**
```bash
# ุชุดุบูู ููู SQL ูุฅุถุงูุฉ ุงูุญุฏูุฏ
psql -d your_database -f sql/add_online_orders_limits.sql

# ุชุดุบูู ุณูุฑูุจุช ุงูุฅุนุฏุงุฏ
psql -d your_database -f scripts/setup_ecommerce_starter_plan.sql
```

### 1๏ธโฃ **ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ ูู ุงูููุงุฑุณ**
```bash
# ุชุดุบูู ููู ุฅุตูุงุญ ุงููุดุงูู
psql -d your_database -f sql/fix_online_orders_limits_issues.sql
```

#### ๐ง **ุฃุณุจุงุจ ุงูุฎุทุฃ ูููููุฉ ุชุฌูุจู**
**ุงูุฎุทุฃ**: `functions in index expression must be marked IMMUTABLE`

**ุงูุณุจุจ**: PostgreSQL ูุง ูุณูุญ ุจุฅูุดุงุก ููุงุฑุณ ุชุญุชูู ุนูู ุฏูุงู ุบูุฑ ุซุงุจุชุฉ (non-IMMUTABLE)

**ุงูุญู**:
- โ `TO_CHAR(created_at, 'YYYY-MM')` - ุฏุงูุฉ ุบูุฑ ุซุงุจุชุฉ
- โ `DATE_TRUNC('month', created_at)` - ุฏุงูุฉ ุซุงุจุชุฉ
- โ ููุงุฑุณ ุจุณูุทุฉ ุนูู ุงูุฃุนูุฏุฉ ุงููุจุงุดุฑุฉ

**ุชุฌูุจ ุงูุฎุทุฃ ูุณุชูุจูุงู**:
```sql
-- โ ุฎุทุฃ
CREATE INDEX idx_bad ON table_name(function_name(column));

-- โ ุตุญูุญ
CREATE INDEX idx_good ON table_name(column);
-- ุฃู
CREATE INDEX idx_good_date ON table_name(DATE_TRUNC('month', column));
```

### 2๏ธโฃ **ุงุณุชุฎุฏุงู ุงูููููุงุช**

#### ูู ุตูุญุฉ ุงูุฅุดุชุฑุงูุงุช:
```tsx
import OnlineOrdersLimitCard from '@/components/subscription/OnlineOrdersLimitCard';

// ุนุฑุถ ุงูุญุฏูุฏ
<OnlineOrdersLimitCard />
```

#### ุนุฏุงุฏ ุงูุทูุจูุงุช ูู ุงููุงูุจุงุฑ:
```tsx
import OnlineOrdersCounter from '@/components/navbar/OnlineOrdersCounter';

// ุงูุนุฑุถ ุงููุฏูุฌ ูู ุงููุงูุจุงุฑ
<OnlineOrdersCounter variant="compact" />

// ุงูุนุฑุถ ุงููุงูู
<OnlineOrdersCounter variant="default" />
```

#### ุฅุดุนุงุฑุงุช ุญุฏูุฏ ุงูุทูุจูุงุช:
```tsx
import OrdersLimitNotifications from '@/components/navbar/OrdersLimitNotifications';

// ุฅุดุนุงุฑุงุช ุฐููุฉ ุชุธูุฑ ุชุญุช ุงููุงูุจุงุฑ
<OrdersLimitNotifications />
```

#### ูู ุตูุญุงุช ุงููุชุฌุฑ:
```tsx
import OrderLimitBlocker from '@/components/store/OrderLimitBlocker';

<OrderLimitBlocker>
  {/* ูุญุชูู ุงููุชุฌุฑ */}
</OrderLimitBlocker>
```

### 3๏ธโฃ **ุงุฎุชุจุงุฑ ุงููุธุงู**

#### ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ุงูุชุฌุฑูุจูุฉ:
```bash
# ุชุดุบูู ููู ุงูุงุฎุชุจุงุฑ
psql -d your_database -f test_ecommerce_starter_ui.sql
```

#### ุงูุงุฎุชุจุงุฑ ุงููุฏูู:
1. **ุชุณุฌูู ุงูุฏุฎูู** ุจุงููุคุณุณุฉ ุงูุชุฌุฑูุจูุฉ
2. **ูุญุต ุงููุงูุจุงุฑ** ูุฑุคูุฉ ุนุฏุงุฏ ุงูุทูุจูุงุช
3. **ูุฑุงูุจุฉ ุงูุฅุดุนุงุฑุงุช** ุชุญุช ุงููุงูุจุงุฑ
4. **ุชุฌุฑุจุฉ ุฅูุดุงุก ุทูุจูุงุช** ููุชุญูู ูู ุงูุนุฏุงุฏ
5. **ุงุฎุชุจุงุฑ ุญุธุฑ ุงููุชุฌุฑ** ุนูุฏ ุชุฌุงูุฒ ุงูุญุฏ

### 4๏ธโฃ **ุงููุฑุงูุจุฉ ูุงูุฅุฏุงุฑุฉ**

#### ูุฑุงูุจุฉ ุงููุชุงุฌุฑ ุงููุญุธูุฑุฉ:
```sql
-- ุนุฑุถ ุฌููุน ุงููุชุงุฌุฑ ุงููุญุธูุฑุฉ
SELECT * FROM blocked_stores_view_fixed WHERE is_blocked = TRUE;

-- ุฅุญุตุงุฆูุงุช ุงูุฎุทุฉ
SELECT * FROM get_ecommerce_starter_stats();
```

#### ุฅุฏุงุฑุฉ ุงูุญุฏูุฏ:
```sql
-- ุฅุถุงูุฉ ุทูุจูุงุช ุฅุถุงููุฉ
SELECT add_online_orders_credits('organization-id', 100, 1000);

-- ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฏุงุฏ ุดูุฑูุงู
SELECT reset_monthly_online_orders();
```

### 3๏ธโฃ **ูู ูุธุงู ูุนุงูุฌุฉ ุงูุทูุจูุงุช**
```sql
-- ุจุฏูุงู ูู process_online_order_new
SELECT process_online_order_with_limits(
  customer_name, phone, province, municipality,
  product_id, organization_id, address, city,
  delivery_company, delivery_option, payment_method,
  notes, product_color_id, product_size_id, size_name,
  quantity, unit_price, total_price, delivery_fee,
  form_data, metadata, stop_desk_id
);
```

## ุฅุฏุงุฑุฉ ุงููุธุงู

### ๐ **ุงููุฑุงูุจุฉ**
```sql
-- ุนุฑุถ ุงููุชุงุฌุฑ ุงููุญุธูุฑุฉ
SELECT * FROM blocked_stores_view;

-- ุนุฑุถ ุงุณุชุฎุฏุงู ุงูุทูุจูุงุช ุงูุดูุฑู
SELECT
    o.name,
    mou.orders_count,
    mou.orders_limit,
    sp.name as plan_name
FROM organizations o
LEFT JOIN monthly_online_orders_usage mou ON o.id = mou.organization_id
LEFT JOIN organization_subscriptions os ON o.id = os.organization_id
LEFT JOIN subscription_plans sp ON os.plan_id = sp.id
WHERE sp.code = 'ecommerce_starter';
```

### ๐ **ุฅุนุงุฏุฉ ุงูุชุนููู ุงูุดูุฑู**
```sql
-- ูููู ุชูููุฐูุง ุนุจุฑ cron job
SELECT reset_monthly_online_orders();
```

## ุงูุชุณููู ูุงููุจูุนุงุช

### ๐ฏ **ููุงุท ุงูููุฉ**
- **ุณุนุฑ ููุฎูุถ**: 1000 ุฏุฌ ุดูุฑูุงู
- **ูุฑููุฉ**: ุฅููุงููุฉ ุฅุถุงูุฉ ุทูุจูุงุช ุญุณุจ ุงูุญุงุฌุฉ
- **ุณูููุฉ ุงูุงุณุชุฎุฏุงู**: ูุซุงููุฉ ูููุจุชุฏุฆูู
- **ุชุฏุฑูุฌู**: ุฅููุงููุฉ ุงูุชุฑููุฉ ูุงุญูุงู

### ๐ **ุงุณุชุฑุงุชูุฌูุฉ ุงููุจูุนุงุช**
1. **ุงุณุชูุฏุงู ุงููุจุชุฏุฆูู**: ุงูุชุฌุงุฑ ุงูุฌุฏุฏ ูู ุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ
2. **ุนุฑูุถ ุฎุงุตุฉ**: ุฎุตููุงุช ููุฃุดูุฑ ุงูุฃููู
3. **ุจุฑุงูุฌ ุงูุฅุญุงูุฉ**: ููุงูุขุช ููุนููุงุก ุงูุฐูู ูุฌูุจูู ุนููุงุก ุฌุฏุฏ
4. **ุฏุนู ููู**: ูุณุงุนุฏุฉ ูู ุฅุนุฏุงุฏ ุงููุชุฌุฑ

### ๐ก **ุงูุชุฑููุงุช ุงูููุชุฑุญุฉ**
- **ุฎุทุฉ ูุชูุณุทุฉ**: 300 ุทูุจูุฉ - 2500 ุฏุฌ
- **ุฎุทุฉ ูุงููุฉ**: 500 ุทูุจูุฉ - 4000 ุฏุฌ
- **ุฎุทุฉ ุชุฌุงุฑ**: 1000 ุทูุจูุฉ - 7000 ุฏุฌ

## ุงูุฏุนู ุงูููู

### ๐ **ููุงุท ุงูุงุชุตุงู**
- **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู**: support@yourcompany.com
- **ุงููุงุชู**: ุฑูู ุงูุฏุนู ุงูููู
- **ุงูุฏุฑุฏุดุฉ**: ูุธุงู ุงูุฏุฑุฏุดุฉ ุงููุจุงุดุฑุฉ

### ๐ **ุงููุดุงูู ุงูุดุงุฆุนุฉ**
1. **ุญุธุฑ ุงููุชุฌุฑ**: ููููุฉ ุงูุชุนุงูู ูุน ุชุฌุงูุฒ ุงูุญุฏูุฏ
2. **ุฅุนุงุฏุฉ ุงูุชูุนูู**: ููููุฉ ุฅุถุงูุฉ ุงููุฒูุฏ ูู ุงูุทูุจูุงุช
3. **ุงูุชุฑููุฉ**: ููููุฉ ุงูุชุฑููุฉ ูุฎุทุท ุฃุนูู

## ุงููุฑุงูุจุฉ ูุงูุชุญูููุงุช

### ๐ **ุงูููุงููุณ ุงููููุฉ**
- **ูุนุฏู ุงูุชุญููู**: ูุณุจุฉ ุงููุชุงุฌุฑ ุงูุชู ุชุชุฌุงูุฒ 100 ุทูุจูุฉ
- **ูุนุฏู ุงูุชุฑููุฉ**: ูุณุจุฉ ุงููุชุงุฌุฑ ุงูุชู ุชุชุฑูู ูุฎุทุท ุฃุนูู
- **ูุนุฏู ุงูุฑุถุง**: ุชููููุงุช ุงูุนููุงุก ููุฎุทุฉ
- **ูุนุฏู ุงูุงุณุชุฎุฏุงู**: ูุชูุณุท ุงุณุชุฎุฏุงู ุงูุทูุจูุงุช ุงูุดูุฑูุฉ

### ๐ **ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ**
- **ุฒูุงุฏุฉ ุงูุญุฏูุฏ**: ุจูุงุกู ุนูู ุงูุงุณุชุฎุฏุงู ุงููุนูู
- **ุชุญุณูู ุงูุฃุณุนุงุฑ**: ุชุนุฏูู ุงูุฃุณุนุงุฑ ุญุณุจ ุงูุทูุจ
- **ุฅุถุงูุฉ ูููุฒุงุช**: ููุฒุงุช ุฅุถุงููุฉ ููุฎุทุฉ
- **ุชุญุณูู ุงููุงุฌูุฉ**: ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

## ุงูุฎูุงุตุฉ

ุฎุทุฉ ุงูุชุฌุงุฑ ุงูุฅููุชุฑููููู ุงููุจุชุฏุฆูู ูู ุญู ูุซุงูู ูููุจุชุฏุฆูู ูู ุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉุ ุญูุซ ุชููุฑ:
- **ุณุนุฑ ููุฎูุถ** ู**ูุฑููุฉ ูู ุงูุงุณุชุฎุฏุงู**
- **ุญุฏูุฏ ูุงุถุญุฉ** ู**ูุฑุงูุจุฉ ุฏูููุฉ**
- **ุณูููุฉ ุงูุชุฑููุฉ** ู**ุฏุนู ููู**
- **ูููุฐุฌ ุฃุนูุงู ูุณุชุฏุงู** ู**ูุงุจู ููุชูุณุน**

ุงููุธุงู ูุถูู **ุฑุถุง ุงูุนููุงุก** ูุน **ุงุณุชุฏุงูุฉ ุงูุฃุนูุงู** ูู ุฎูุงู ูููุฐุฌ ุชุณุนูุฑ ุฐูู ููุงุณุจ ุงุญุชูุงุฌุงุช ุงูุชุฌุงุฑ ุงููุจุชุฏุฆูู.
