# ุฅุตูุงุญ ูุดููุฉ ุญุงูุฉ ุงูุทูุจุงุช ุจุนุฏ ุงููุฒุงููุฉ โ

## ุงููุดููุฉ ๐ด

ูุงูุช ุงูุทูุจุงุช ุชุธูุฑ ุจุญุงูุฉ "ููุฏ ุงููุฒุงููุฉ" (pending_sync) ูู ูุงุฌูุฉ ุทูุจูุงุช ููุทุฉ ุงูุจูุน ุญุชู ุจุนุฏ ูุฌุงุญ ุงููุฒุงููุฉ ูุน ุงูุณูุฑูุฑ.

### ุงูุฃุนุฑุงุถ:
```
๐ ุงูุทูุจูุฉ: b0ef4817-37ed-464d-91d4-a480dae8834b
โ ุชู ุฅูุดุงุก ุงูุทูุจูุฉ ุจูุฌุงุญ
โ ุชูุช ุงููุฒุงููุฉ ุจูุฌุงุญ ูุน ุงูุณูุฑูุฑ
โ ุชู ุชุญุฏูุซ sync_outbox ุจูุฌุงุญ
โ ููู ุงูุญุงูุฉ ูู ุงููุงุฌูุฉ ูุง ุชุฒุงู "ููุฏ ุงููุฒุงููุฉ"
```

## ุงูุณุจุจ ุงูุฌุฐุฑู ๐

ูู ุงูููู `src/lib/sync/queue/OutboxManager.ts` (ุงูุณุทุฑ 500-532)ุ ูุงู ุงุณุชุนูุงู UPDATE ุงูุฐู ูุญุฏุซ ุญุงูุฉ ุงูุทูุจูุฉ ูุญุชูู ุนูู ุดุฑุท WHERE ูุนูุฏ ุฌุฏุงู:

### ุงูููุฏ ุงููุฏูู (ุงููุนุทู):
```sql
UPDATE orders
SET synced = 1,
    _synced = 1,
    sync_status = 'synced',
    _sync_status = 'synced',
    status = CASE
        WHEN status = 'pending_sync' THEN 'synced'
        ELSE status
    END,
    pending_operation = NULL,
    _pending_operation = NULL
WHERE id IN (${recordPlaceholders})
AND (sync_status = 'pending' OR sync_status = 'syncing'
     OR _sync_status = 'pending' OR _sync_status = 'syncing'
     OR status = 'pending_sync')  -- โ๏ธ ุดุฑุท ุฒุงุฆุฏ ูุณุจุจ ุงููุดููุฉ
```

### ุงููุดููุฉ ูู ุงูุดุฑุท:
- ุฅุฐุง ุชู ุชุญุฏูุซ `sync_status` ูู ููุงู ุขุฎุฑ ูู ุงูููุฏ ูุจู ุชูููุฐ ูุฐุง ุงูุงุณุชุนูุงู
- ูุฅู ุดุฑุท `WHERE` ูู ูุฌุฏ ุฃู ุณุฌูุงุช ุชุทุงุจูู
- ูุจุงูุชุงูู ูู ูุชู ุชุญุฏูุซ ุญูู `status` ูู `pending_sync` ุฅูู `synced`
- ูุฐุง ูุฎูู **race condition** ุจูู ุนุฏุฉ ุฃุฌุฒุงุก ูู ุงูููุฏ

## ุงูุญู โ

ุชู ุชุจุณูุท ุงูุงุณุชุนูุงู ูุฅุฒุงูุฉ ุงูุดุฑุท ุงูุฒุงุฆุฏ ุนูู `sync_status`:

### ุงูููุฏ ุงูุฌุฏูุฏ (ุงููุตูุญ):
```sql
UPDATE orders
SET synced = 1,
    _synced = 1,
    sync_status = 'synced',
    _sync_status = 'synced',
    status = CASE
        WHEN status = 'pending_sync' THEN 'synced'
        WHEN status = 'syncing' THEN 'synced'
        ELSE status
    END,
    pending_operation = NULL,
    _pending_operation = NULL,
    updated_at = datetime('now')
WHERE id IN (${recordPlaceholders})  -- โ ุดุฑุท ุจุณูุท ููุท ุนูู ุงูู IDs
```

### ุงูุชุญุณููุงุช:
1. โ **ุฅุฒุงูุฉ ุงูุดุฑุท ุงูุฒุงุฆุฏ**: ูู ูุนุฏ ูุชุญูู ูู `sync_status` ูู WHERE
2. โ **ุฏุนู ุญุงูุชูู**: ูุญุฏุซ ูู `pending_sync` ุฃู `syncing` ุฅูู `synced`
3. โ **ุชุญุฏูุซ ุงูููุช**: ูุถูู `updated_at = datetime('now')` ูุชุชุจุน ุงูุชุญุฏูุซ
4. โ **ุชุญุฏูุซ ููุง ุงูุนููุฏูู**: ูุญุฏุซ `synced` ู `_synced` ู `sync_status` ู `_sync_status`

## ุงูููุทู ๐ง

ุงูุณุฌูุงุช ุงูููุฌูุฏุฉ ูู `sync_outbox` ูู **ุจุญูู ุงูุชุนุฑูู** ุณุฌูุงุช ุชุญุชุงุฌ ูููุฒุงููุฉ. ูุฐูู:
- ูุง ุญุงุฌุฉ ููุชุญูู ูู `sync_status` ูู ุดุฑุท WHERE
- ูููู ุงูุจุญุซ ุจุงูู IDs ุงููุทุงุจูุฉ
- ูุฐุง ูุถูู ุชุญุฏูุซ ุงูุญุงูุฉ ุจูุฌุงุญ ุจุบุถ ุงููุธุฑ ุนู ุงูุญุงูุฉ ุงููุณูุทุฉ

## ุงููููุงุช ุงููุนุฏูุฉ ๐

### 1. `/src/lib/sync/queue/OutboxManager.ts` (ุงูุณุทุฑ 500-532)
ุงูุชุนุฏูู ุงูุฑุฆูุณู ูุฅุตูุงุญ ุงุณุชุนูุงู UPDATE

## ููููุฉ ุงูุงุฎุชุจุงุฑ ๐งช

1. **ุฅูุดุงุก ุทูุจูุฉ ุฌุฏูุฏุฉ**:
   - ูู ุจูุชุญ ููุทุฉ ุงูุจูุน
   - ุฃูุดุฆ ุทูุจูุฉ ุฌุฏูุฏุฉ
   - ุงูุทูุจูุฉ ูุฌุจ ุฃู ุชุจุฏุฃ ุจุญุงูุฉ `status: 'pending_sync'`

2. **ุงูุชุธุฑ ุงููุฒุงููุฉ**:
   - ุงูุชุธุฑ ุญุชู ุชุชู ูุฒุงููุฉ ุงูุทูุจูุฉ ุชููุงุฆูุงู
   - ุฑุงูุจ ุณุฌูุงุช Console:
     ```
     [OutboxManager] โ Updated sync_status and status to 'synced' for X orders
     ```

3. **ุชุญูู ูู ุงููุงุฌูุฉ**:
   - ุงูุชุญ ุตูุญุฉ "ุทูุจูุงุช ููุทุฉ ุงูุจูุน"
   - ูุฌุจ ุฃู ุชุธูุฑ ุงูุทูุจูุฉ ุจุญุงูุฉ "ููุฒุงููู" (badge ุฃุฎุถุฑ)
   - ูููุณ "ููุฏ ุงููุฒุงููุฉ" (badge ุฃุฒุฑู)

## ููุงุญุธุงุช ุฅุถุงููุฉ ๐

### ุญุงูุงุช ุงูุทูุจูุงุช:
- `pending_sync`: ุงูุทูุจูุฉ ุชู ุฅูุดุงุคูุง ูุญููุงู ููู ุชุชู ูุฒุงููุชูุง ุจุนุฏ
- `syncing`: ุงูุทูุจูุฉ ููุฏ ุงููุฒุงููุฉ ุญุงููุงู
- `synced`: ุงูุทูุจูุฉ ุชูุช ูุฒุงููุชูุง ุจูุฌุงุญ
- `completed`: ุงูุทูุจูุฉ ููุชููุฉ (ุญุงูุฉ ููุทู ุงูุฃุนูุงู)
- `failed`: ูุดูุช ุงููุฒุงููุฉ

### ุงููุฑู ุจูู `status` ู `sync_status`:
- `status`: ุญุงูุฉ ููุทู ุงูุฃุนูุงู (completed, cancelled, etc.)
- `sync_status`: ุญุงูุฉ ุงููุฒุงููุฉ (pending, syncing, synced, failed)

### ุนูููุฉ ุงูุญูุธ ูู ุงูุณูุฑูุฑ:
ูู `localPosOrderService.ts` (ุงูุณุทุฑ 487-491)ุ ุนูุฏ ุญูุธ ุงูุทูุจูุงุช ูู ุงูุณูุฑูุฑ:
```typescript
status: order.status ?? 'completed', // โก ุงูุญูุงุธ ุนูู ุงูุญุงูุฉ ุงูุฃุตููุฉ
synced: 1,
_synced: 1,
sync_status: 'synced',
_sync_status: 'synced',
```

ูุฐุง ูุถูู ุฃู ุงูุทูุจูุงุช ุงููุญููุฉ ูู ุงูุณูุฑูุฑ ุชูุนุชุจุฑ ูุฒุงููุฉ ุชููุงุฆูุงู.

## ุงูุชุฃุซูุฑ ุงููุชููุน ๐ฏ

ุจุนุฏ ูุฐุง ุงูุฅุตูุงุญ:
- โ ุฌููุน ุงูุทูุจูุงุช ุงูุชู ุชุชู ูุฒุงููุชูุง ุจูุฌุงุญ ุณุชุธูุฑ ุจุญุงูุฉ "ููุฒุงููู"
- โ ูู ุชุนูุฏ ุชูุฌุฏ ุทูุจูุงุช "ุนุงููุฉ" ูู ุญุงูุฉ "ููุฏ ุงููุฒุงููุฉ"
- โ ุงููุงุฌูุฉ ุณุชุนูุณ ุงูุญุงูุฉ ุงููุนููุฉ ููุทูุจูุงุช ุจุฏูุฉ
- โ ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุจูุถูุญ ุงูุญุงูุงุช

## ุงูุฎูุงุตุฉ ๐

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจูุฌุงุญ ูู ุฎูุงู **ุซูุงุซ ุฎุทูุงุช**:

### 1๏ธโฃ ุชุจุณูุท ุงุณุชุนูุงู UPDATE (OutboxManager.ts - ุงูุณุทูุฑ 532-547)
- ุฅุฒุงูุฉ ุงูุดุฑุท ุงูุฒุงุฆุฏ ุนูู `sync_status` ูู WHERE
- ูุฐุง ุฃุฒุงู race condition ุจูู ุฃุฌุฒุงุก ุงูููุฏ

### 2๏ธโฃ ุฅุตูุงุญ ุฎุทุฃ `_synced` column (OutboxManager.ts - ุงูุณุทูุฑ 496-526)
- ุฅุถุงูุฉ whitelist ููุฌุฏุงูู ุงูุชู ูุฏููุง ุนููุฏ `_synced`
- ูุนุงูุฌุฉ ุงูุฌุฏุงูู ุงูุฃุฎุฑู ุจุดูู ูููุตู

### 3๏ธโฃ ุฅุถุงูุฉ Event System ูุชุญุฏูุซ ุงููุงุฌูุฉ (ุงูุญู ุงูููุงุฆู) โ
**OutboxManager.ts (ุงูุณุทูุฑ 551-557)**:
```typescript
// ุฅุทูุงู ุญุฏุซ ุจุนุฏ ุชุญุฏูุซ ุงูุทูุจูุงุช ุจูุฌุงุญ
dispatchAppEvent('pos-orders-synced', {
    orderIds: recordIds,
    count: recordIds.length
});
```

**POSOrdersDataContext.tsx (ุงูุณุทูุฑ 1860-1870)**:
```typescript
// ุงูุงุณุชูุงุน ููุญุฏุซ ูุชุญุฏูุซ ุงูู cache
useEffect(() => {
    const unsubscribe = addAppEventListener('pos-orders-synced', (detail) => {
        console.log(`๐ ุชูุช ูุฒุงููุฉ ${detail.count} ุทูุจูุฉ - ุชุญุฏูุซ ุงููุงุฆูุฉ...`);
        refetchOrders();
    });
    return unsubscribe;
}, [refetchOrders]);
```

### ููุงุฐุง ุงูุฎุทูุฉ 3๏ธโฃ ูุงูุช ุถุฑูุฑูุฉุ
- ุงูุฎุทูุชุงู 1๏ธโฃ ู 2๏ธโฃ ูุงูุชุง ุจุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ โ
- ููู React Query ูุงู ูุง ูุฒุงู ูุนุฑุถ ุจูุงูุงุช ูุฏููุฉ ูู ุงูู cache โ
- ุงูุญู: ุฅุทูุงู ุญุฏุซ ูุฎุจุฑ ุงููุงุฌูุฉ ุจุชุญุฏูุซ ุงูุจูุงูุงุช โ

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ**: 2025-12-03
**ุงููููุงุช ุงููุนุฏูุฉ**:
- `src/lib/sync/queue/OutboxManager.ts` (ุงูุณุทูุฑ 29ุ 551-557)
- `src/context/POSOrdersDataContext.tsx` (ุงูุณุทูุฑ 1860-1870)
