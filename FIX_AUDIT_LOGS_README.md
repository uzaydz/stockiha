# ๐ง ุฅุตูุงุญ ูุดููุฉ audit_logs - organization_id

## ๐ **ููุฎุต ุงููุดููุฉ**

ุนูุฏ ูุญุงููุฉ ุชุญุฏูุซ ููุชุฌุ ูุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:
```
column "organization_id" of relation "audit_logs" does not exist
```

## ๐ **ุงูุชุญููู ุงูุชูุตููู**

### **ุงูุณุจุจ ุงูุฌุฐุฑู:**
- ุฌุฏูู `audit_logs` ุชู ุฅูุดุงุคู ูู migration `20251102_super_admin_performance_security.sql`
- ุงูุจููุฉ ุงููุนููุฉ ููุฌุฏูู **ูุง ุชุญุชูู** ุนูู ุนููุฏ `organization_id`
- ููู ุฏุงูุชูู ูุฏููุชูู (`refresh_stats_with_logging` ู `trigger_refresh_stats`) ุชุญุงููุงู ุงูุฅุฏุฑุงุฌ ูู ูุฐุง ุงูุฌุฏูู ุจุงุณุชุฎุฏุงู ุฃุนูุฏุฉ ุบูุฑ ููุฌูุฏุฉ

### **ุงูุจููุฉ ุงูุญุงููุฉ ูุฌุฏูู audit_logs:**
```sql
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY,
  user_id UUID,              -- โ
  user_email TEXT,           -- โ
  action TEXT,               -- โ
  resource_type TEXT,        -- โ
  resource_id UUID,          -- โ
  ip_address INET,           -- โ
  user_agent TEXT,           -- โ
  changes JSONB,             -- โ
  metadata JSONB,            -- โ
  severity TEXT,             -- โ
  status TEXT,               -- โ
  error_message TEXT,        -- โ
  created_at TIMESTAMPTZ     -- โ
)
```

**โ ุงูุฃุนูุฏุฉ ุงูููููุฏุฉ ุงูุชู ุชุญุงูู ุงูุฏูุงู ุงููุฏููุฉ ุงุณุชุฎุฏุงููุง:**
- `organization_id`
- `details`
- `created_by`

### **ุงูุฏูุงู ุงููุชุฃุซุฑุฉ:**
1. **`refresh_stats_with_logging()`**
   - ุชูุณุชุฏุนู ูุชุญุฏูุซ materialized view ููุฅุญุตุงุฆูุงุช
   - ุชุญุงูู ุงูุฅุฏุฑุงุฌ ูุน ุฃุนูุฏุฉ ุบูุฑ ููุฌูุฏุฉ

2. **`trigger_refresh_stats()`**
   - Trigger ุนูู ุฌุฏูู `products` (INSERT/UPDATE/DELETE)
   - ุชุณุชุฏุนู ุงูุฏุงูุฉ ุฃุนูุงู
   - **ูุฐุง ูู ุณุจุจ ุธููุฑ ุงูุฎุทุฃ ุนูุฏ ุชุญุฏูุซ ุงูููุชุฌุงุช**

## โ **ุงูุญู ุงูููุทุจู**

ุชู ุฅูุดุงุก ููู `fix_audit_logs_product_update.sql` ุงูุฐู ูููู ุจู:

### 1. ุชุญุฏูุซ `refresh_stats_with_logging()`:
- ุงุณุชุฎุฏุงู ุงูุจููุฉ ุงูุตุญูุญุฉ ูุฌุฏูู `audit_logs`
- ุชุญููู ุงูุจูุงูุงุช ุงููุฏููุฉ ุฅูู ุงูุจููุฉ ุงูุฌุฏูุฏุฉ:
  - `organization_id` โ ุญุฐู (ููุณ ุถุฑูุฑู)
  - `details` โ `metadata` (JSONB)
  - `created_by` โ `user_id` (NULL ูููุธุงู)
  - ุฅุถุงูุฉ `resource_type`, `severity`, `status`

### 2. ุชุญุฏูุซ `trigger_refresh_stats()`:
- ููุณ ุงูุชุญุฏูุซุงุช ูุชุชูุงูู ูุน ุงูุจููุฉ ุงูุฌุฏูุฏุฉ
- ุงูุญูุงุธ ุนูู ููุณ ุงูููุทู ูุงูุณููู

## ๐ **ููููุฉ ุชุทุจูู ุงูุฅุตูุงุญ**

### **ุงูุฎูุงุฑ 1: ุนุจุฑ Supabase Dashboard**
1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู **SQL Editor**
3. ุงูุชุญ ููู `fix_audit_logs_product_update.sql`
4. ุงูุณุฎ ุงููุญุชูู ูุงูุตูู ูู ุงููุญุฑุฑ
5. ุงุถุบุท **Run**

### **ุงูุฎูุงุฑ 2: ุนุจุฑ CLI**
```bash
# ุฅุฐุง ููุช ุชุณุชุฎุฏู Supabase CLI
supabase db execute -f fix_audit_logs_product_update.sql

# ุฃู ุนุจุฑ psql
psql -h YOUR_HOST -U postgres -d YOUR_DB -f fix_audit_logs_product_update.sql
```

### **ุงูุฎูุงุฑ 3: ุนุจุฑ Migration**
```bash
# ููู ุงูููู ุฅูู ูุฌูุฏ migrations
cp fix_audit_logs_product_update.sql supabase/migrations/$(date +%Y%m%d%H%M%S)_fix_audit_logs.sql

# ุชุทุจูู Migration
supabase db push
```

## โ๏ธ **ุงูุชุญูู ูู ูุฌุงุญ ุงูุฅุตูุงุญ**

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญุ ูู ุจุงุฎุชุจุงุฑ ุชุญุฏูุซ ููุชุฌ:

```sql
-- ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ
UPDATE products 
SET name = name || ' ' 
WHERE id = (SELECT id FROM products LIMIT 1);

-- ุงูุชุญูู ูู ุงูุณุฌูุงุช
SELECT * FROM audit_logs 
WHERE action = 'refresh_stats' 
ORDER BY created_at DESC 
LIMIT 5;
```

ูุฌุจ ุฃู ูุชู ุงูุชุญุฏูุซ ุจูุฌุงุญ ุจุฏูู ุฃุฎุทุงุก.

## ๐ **ุงูุชุญูู ูู ุงููุดุงูู ุงููุดุงุจูุฉ**

ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูุดุงูู ูุดุงุจูุฉ ูู ุฏูุงู ุฃุฎุฑู:

```sql
-- ุงูุจุญุซ ุนู ุฏูุงู ุชุญุงูู ุงุณุชุฎุฏุงู audit_logs ุจุดูู ุฎุงุทุฆ
SELECT 
    p.proname as function_name,
    pg_get_functiondef(p.oid) as definition
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
AND pg_get_functiondef(p.oid) LIKE '%audit_logs%'
AND (
    pg_get_functiondef(p.oid) LIKE '%organization_id%'
    OR pg_get_functiondef(p.oid) LIKE '%details%'
    OR pg_get_functiondef(p.oid) LIKE '%created_by%'
);
```

## ๐ **ุงูุชูุงูู ูุน ุฌุฏูู settings_audit_log**

ูุงุญุธ ุฃู ููุงู ุฌุฏูู ุขุฎุฑ ููุชุฏููู: `settings_audit_log`

ูุฐุง ุงูุฌุฏูู **ูุญุชูู** ุนูู `organization_id` ูููุณุชุฎุฏู ูุชุชุจุน ุชุบููุฑุงุช ุงูุฅุนุฏุงุฏุงุช.

**ุงููุฑู ุจูู ุงูุฌุฏูููู:**

| ุงูููุฒุฉ | audit_logs | settings_audit_log |
|-------|-----------|-------------------|
| **ุงูุบุฑุถ** | ุชุชุจุน ุฅุฌุฑุงุกุงุช Super Admin | ุชุชุจุน ุชุบููุฑุงุช ุงูุฅุนุฏุงุฏุงุช |
| **organization_id** | โ ุบูุฑ ููุฌูุฏ | โ ููุฌูุฏ |
| **ุงูุจููุฉ** | ุญุฏูุซุฉ ูููุญุณููุฉ | ูุฏููุฉ ูุชุญุชุงุฌ ุชุญุฏูุซ |
| **ุงูุงุณุชุฎุฏุงู** | ููุฅุฌุฑุงุกุงุช ุงูุฅุฏุงุฑูุฉ | ููุฅุนุฏุงุฏุงุช ููุท |

## ๐ **ููุงุญุธุงุช ุฅุถุงููุฉ**

1. **ูุง ุชุญุฐู ุฌุฏูู `settings_audit_log`** - ูุงุฒุงู ูุณุชุฎุฏู ูู ุฃูุงูู ุฃุฎุฑู
2. **ุงูุฏูุงู ุงูููุญุฏุซุฉ ูุชูุงููุฉ ูุน ุงูุจููุฉ ุงูุฌุฏูุฏุฉ ููุท**
3. **ูู ุชุคุซุฑ ุนูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูู `audit_logs`**
4. **ุงูุฅุตูุงุญ ุขูู ููุงุจู ููุชุฑุงุฌุน**

## ๐ **ุงูุชุฑุงุฌุน ุนู ุงูุชุบููุฑุงุช (ุฅุฐุง ูุฒู ุงูุฃูุฑ)**

ุฅุฐุง ุญุฏุซุช ูุดุงููุ ููููู ุงูุชุฑุงุฌุน ุจุงุณุชุฎุฏุงู:

```sql
-- ุงุณุชุนุงุฏุฉ ุงููุณุฎ ุงููุฏููุฉ ูู ุงูุฏูุงู
-- ููู ูุงุญุธ ุฃู ูุฐุง ุณููุนูุฏ ุงููุดููุฉ ุงูุฃุตููุฉ
```

**ูุง ูููุตุญ ุจุงูุชุฑุงุฌุน** - ุงูุญู ุงูุตุญูุญ ูู ุฅุตูุงุญ ุงูุจููุฉ ุจุดูู ุฏุงุฆู.

## ๐ **ูู ุญุงู ุงุณุชูุฑุงุฑ ุงููุดููุฉ**

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:

1. ุชุญูู ูู ุชุทุจูู ุงูู SQL ุจูุฌุงุญ (ูุง ุชูุฌุฏ ุฃุฎุทุงุก)
2. ุชุญูู ูู ุฃู ุงูุฏูุงู ุชู ุชุญุฏูุซูุง:
   ```sql
   SELECT proname, prosrc 
   FROM pg_proc 
   WHERE proname IN ('refresh_stats_with_logging', 'trigger_refresh_stats');
   ```
3. ุชุญูู ูู logs ุงูุฎุงุฏู ููุญุตูู ุนูู ูุฒูุฏ ูู ุงูุชูุงุตูู
4. ุฑุงุฌุน ุงูููู `EditProductDialog.tsx` ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ูุดุงูู ูู ุงูููุฏ ุงูุฃูุงูู

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2025-11-03  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุทุจูู
