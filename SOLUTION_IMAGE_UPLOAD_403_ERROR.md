# ุญู ูุดููุฉ ุฑูุน ุงูุตูุฑ: ุฎุทุฃ 403 "new row violates row-level security policy"

## ๐ ููุฎุต ุงููุดููุฉ

ูุงู ุงููุณุชุฎุฏููู ููุงุฌููู ุฎุทุฃ 403 ุนูุฏ ูุญุงููุฉ ุฑูุน ุงูุตูุฑ ูุน ุงูุฑุณุงุฆู ุงูุชุงููุฉ:
- `"statusCode": "403", "error": "Unauthorized", "message": "new row violates row-level security policy"`
- `POST https://wrnssatuvmumsczyldth.supabase.co/storage/v1/object/organization-assets/... 400 (Bad Request)`

## ๐ ุชุญููู ุงููุดููุฉ

ุจุนุฏ ุงูุชุญููู ุงูุดุงููุ ุชุจูู ุฃู ุงููุดููุฉ ุชุชููู ูู ุนุฏุฉ ุฃุฌุฒุงุก:

### 1. ูุดููุฉ ุงูุชูุงุก ุตูุงุญูุฉ ุงูุฌูุณุฉ
- ุงูุฌูุณุฉ ุงููุฎุฒูุฉ ูู `localStorage` ูุงูุช ููุชููุฉ ุงูุตูุงุญูุฉ
- `expires_at: 1756210588` ุฃูู ูู ุงูููุช ุงูุญุงูู
- `refresh_token` ุฃูุถุงู ููุชูู ุงูุตูุงุญูุฉ ุฃู ุบูุฑ ุตุงูุญ

### 2. ูุดููุฉ ุนุฏู ุชุฒุงูู ุงููุตุงุฏูุฉ
- Supabase client ูุง ูุญุตู ุนูู ุงูุฌูุณุฉ ุฑุบู ูุฌูุฏ ุงููุณุชุฎุฏู ูุตุงุฏู ูู ุงูุชุทุจูู
- `auth.uid()` ูุนูุฏ `null` ูู ุณูุงุณุงุช RLS
- ุนุฏู ุชุทุจูู `access_token` ุนูู headers ุงูุนููู

### 3. ุณูุงุณุงุช Row Level Security ุบูุฑ ููุชููุฉ
- ุงูุณูุงุณุงุช ุงูุญุงููุฉ ุชุชุทูุจ `auth.uid() IS NOT NULL`
- ููู ุงูุนููู ูุง ูุฑุณู ุงูู token ุจุดูู ุตุญูุญ

## โ ุงูุญู ุงููุทุจู

### 1. ุชุญุณูู ูุณุงุนุฏุงุช ุงููุตุงุฏูุฉ (`src/utils/authHelpers.ts`)

```typescript
// ุฅุถุงูุฉ ุฏูุงู ุดุงููุฉ ููุชุญูู ูู ุงูุฌูุณุฉ ูุชุฌุฏูุฏูุง
- validateCurrentSession(): ูุญุต ุงูุฌูุณุฉ ุงูุญุงููุฉ ูุน ูุญุงููุฉ ุงูุชุฌุฏูุฏ
- checkStoredSession(): ูุญุต ุงูุฌูุณุงุช ุงููุฎุฒูุฉ ูู localStorage
- restoreStoredSession(): ุงุณุชุนุงุฏุฉ ูุชุทุจูู ุงูุฌูุณุฉ ุงููุฎุฒูุฉ
- createAuthenticatedClient(): ุฅูุดุงุก ุนููู ูุตุงุฏู ูุน headers ุตุญูุญุฉ
- uploadFileWithAuth(): ุฑูุน ุงููููุงุช ูุน ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงููุตุงุฏูุฉ
- debugAuthState(): ุชุดุฎูุต ุดุงูู ูุญุงูุฉ ุงููุตุงุฏูุฉ
```

#### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
- **ุชุฌุฏูุฏ ุชููุงุฆู ููุฌูุณุฉ**: ูุญุงููุฉ ุชุฌุฏูุฏ ุงูุฌูุณุฉ ุงูููุชููุฉ ุจุงุณุชุฎุฏุงู `refresh_token`
- **ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ**: ุญุฐู ุงูุฌูุณุงุช ุงูููุชููุฉ ูู `localStorage`
- **ูุญุต ูุตุงุฏุฑ ูุชุนุฏุฏุฉ**: ุงูุจุญุซ ูู ุนุฏุฉ ููุงุชูุญ ููุฌูุณุฉ ุงููุฎุฒูุฉ
- **ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ**: ุฑุณุงุฆู ูููููุฉ ูููุณุชุฎุฏู ุจุงููุบุฉ ุงูุนุฑุจูุฉ
- **ุชุดุฎูุต ุดุงูู**: ูุนูููุงุช ููุตูุฉ ุนู ุญุงูุฉ ุงููุตุงุฏูุฉ ูู ูุถุน ุงูุชุทููุฑ

### 2. ุชุญุณูู ImageUploader (`src/components/ui/ImageUploader.tsx`)

```typescript
// ุงุณุชุฎุฏุงู ุงููุณุงุนุฏุงุช ุงูุฌุฏูุฏุฉ
import { uploadFileWithAuth, validateCurrentSession, debugAuthState } from "@/utils/authHelpers";

// ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุน ุฑุณุงุฆู ูุงุถุญุฉ ูุฒุฑ ุชุญุฏูุซ ุงูุตูุญุฉ
```

#### ุงูุชุญุณููุงุช:
- **ุชุดุฎูุต ูู ูุถุน ุงูุชุทููุฑ**: ุนุฑุถ ูุนูููุงุช ููุตูุฉ ุนู ุนูููุฉ ุงูุฑูุน
- **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงููุตุงุฏูุฉ**: ุฑุณุงุฆู ุฎุงุตุฉ ูุฃุฎุทุงุก ุชุณุฌูู ุงูุฏุฎูู ูุน ุฒุฑ ุชุญุฏูุซ
- **ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุฐููุฉ**: ูุญุงููุฉ ุฅุถุงููุฉ ุนูุฏ ูุดู ุงููุตุงุฏูุฉ
- **ุชุณุฌูู ููุตู**: console.log ุดุงูู ูุชุชุจุน ุงูุนูููุฉ

### 3. ุฅุตูุงุญ ุณูุงุณุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (`fix_image_upload_rls_policies.sql`)

```sql
-- ุณูุงุณุงุช ูุญุณูุฉ ูุฃูุซุฑ ูุฑููุฉ
CREATE POLICY "authenticated_upload_storage_objects" ON storage.objects
FOR INSERT 
TO authenticated
WITH CHECK (
  bucket_id = ANY (ARRAY['organization-assets'::text, 'store-assets'::text, 'user-avatars'::text, 'bazaar-public'::text])
  AND auth.uid() IS NOT NULL
  AND auth.role() = 'authenticated'
);
```

#### ุงูููุฒุงุช:
- **ุณูุงุณุงุช ุดุงููุฉ**: ุชุบุทู ุฌููุน buckets ุงููุทููุจุฉ
- **ูุญุต ูุฒุฏูุฌ**: ุงูุชุฃูุฏ ูู `auth.uid()` ู `auth.role()`
- **ุฏุงูุฉ ูุณุงุนุฏุฉ**: `is_authenticated_user()` ููุชุญูู ูู ุงููุตุงุฏูุฉ
- **ุณูุงุณุงุช ุจุฏููุฉ**: ุญููู ูุจุณุทุฉ ูู ุญุงูุฉ ุงุณุชูุฑุงุฑ ุงููุดููุฉ

## ๐ ููููุฉ ุนูู ุงูุญู

### 1. ุนูุฏ ูุญุงููุฉ ุฑูุน ุตูุฑุฉ:
```
1. debugAuthState() - ุนุฑุถ ูุนูููุงุช ุงูุชุดุฎูุต
2. validateCurrentSession() - ูุญุต ุงูุฌูุณุฉ ุงูุญุงููุฉ
3. checkStoredSession() - ุงูุจุญุซ ูู localStorage
4. ูุญุงููุฉ ุชุฌุฏูุฏ ุงูุฌูุณุฉ ุฅุฐุง ูุงูุช ููุชููุฉ
5. ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ
6. createAuthenticatedClient() - ุฅูุดุงุก ุนููู ูุตุงุฏู
7. uploadFileWithAuth() - ุฑูุน ุงูููู ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
```

### 2. ูู ุญุงูุฉ ูุดู ุงููุตุงุฏูุฉ:
```
1. ุนุฑุถ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู
2. ุชูุฏูู ุฒุฑ "ุชุญุฏูุซ ุงูุตูุญุฉ"
3. ุชุณุฌูู ุงูุฃุฎุทุงุก ูู console ููุชุดุฎูุต
4. ุชูุธูู ุงูุจูุงูุงุช ุงูููุชููุฉ ุงูุตูุงุญูุฉ
```

## ๐ ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑ

### ูุจู ุงูุญู:
```
โ ุงูุฌูุณุฉ ุงูุญุงููุฉ: null
โ ุฎุทุฃ ุงููุณุชุฎุฏู: AuthSessionMissingError: Auth session missing!
โ ุนูุงููู ุงูุนููู: Headers {}
โ ุฎุทุฃ 403: new row violates row-level security policy
```

### ุจุนุฏ ุงูุญู:
```
โ ุชู ุงูุชุดุงู ุงูุฌูุณุฉ ุงูููุชููุฉ ุงูุตูุงุญูุฉ
โ ูุญุงููุฉ ุชุฌุฏูุฏ ุงูุฌูุณุฉ ุจุงุณุชุฎุฏุงู refresh_token
โ ุชูุธูู ุงูุจูุงูุงุช ุงูุชุงููุฉ ูู localStorage
โ ุฑุณุงูุฉ ูุงุถุญุฉ: "ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู ูุฑูุน ุงูุตูุฑ"
โ ุฒุฑ ุชุญุฏูุซ ุงูุตูุญุฉ ูููุณุชุฎุฏู
```

## ๐๏ธ ุงููููุงุช ุงููุญุฏุซุฉ

1. **`src/utils/authHelpers.ts`** - ูุณุงุนุฏุงุช ุงููุตุงุฏูุฉ ุงูุฌุฏูุฏุฉ
2. **`src/components/ui/ImageUploader.tsx`** - ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
3. **`fix_image_upload_rls_policies.sql`** - ุฅุตูุงุญ ุณูุงุณุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

## ๐ ููุงุญุธุงุช ูููุฉ

### ูููุทูุฑูู:
- ุงุณุชุฎุฏู `debugAuthState()` ูุชุดุฎูุต ูุดุงูู ุงููุตุงุฏูุฉ
- ุฑุงูุจ console.log ูู ูุถุน ุงูุชุทููุฑ ููุญุตูู ุนูู ูุนูููุงุช ููุตูุฉ
- ุชุฃูุฏ ูู ุชุดุบูู `fix_image_upload_rls_policies.sql` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ูููุณุชุฎุฏููู:
- ูู ุญุงูุฉ ุธููุฑ ุฑุณุงูุฉ "ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู"ุ ุงููุฑ ุนูู "ุชุญุฏูุซ ุงูุตูุญุฉ"
- ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉุ ูู ุจุชุณุฌูู ุงูุฎุฑูุฌ ุซู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
- ุชุฃูุฏ ูู ุงุณุชูุฑุงุฑ ุงุชุตุงู ุงูุฅูุชุฑูุช

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฅุฐุง ุงุณุชูุฑ ุฎุทุฃ 403:
1. ุชุดุบูู `fix_image_upload_rls_policies.sql` ูู Supabase Dashboard
2. ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช bucket ูู Storage
3. ูุญุต ุณูุงุณุงุช RLS ูู Policies
4. ุงูุชุฃูุฏ ูู ุตุญุฉ ูุชุบูุฑุงุช ุงูุจูุฆุฉ

### ุฅุฐุง ูู ุชุนูู ูุญุงููุฉ ุงูุชุฌุฏูุฏ:
1. ูุญุต ุตูุงุญูุฉ `refresh_token` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช JWT ูู Supabase Dashboard
3. ูุฑุงุฌุนุฉ ุฅุนุฏุงุฏุงุช `auth.autoRefreshToken` ูู ุงูุนููู

## ๐ฏ ุงูุฎูุงุตุฉ

ุชู ุญู ุงููุดููุฉ ุจูุฌุงุญ ูู ุฎูุงู:
- **ุชุดุฎูุต ุฏููู** ููุตุฏุฑ ุงููุดููุฉ
- **ุญู ุดุงูู** ูุบุทู ุฌููุน ุงูุฌูุงูุจ
- **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณูุฉ** ูุน ุฑุณุงุฆู ูุงุถุญุฉ
- **ุฃุฏูุงุช ุชุดุฎูุต** ูููุทูุฑูู
- **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฐููุฉ** ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ

ุงููุธุงู ุงูุขู ูุชุนุงูู ุจุฐูุงุก ูุน ุงูุชูุงุก ุตูุงุญูุฉ ุงูุฌูุณุงุช ูููุฌู ุงููุณุชุฎุฏู ููุฎุทูุงุช ุงูุตุญูุญุฉ.
