# ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÙŠØ© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Offline

## ğŸ“ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TAURI APPLICATION                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Online     â”‚  â”‚   Offline    â”‚  â”‚   Syncing    â”‚     â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚     â”‚
â”‚  â”‚ Supabase RPC â”‚  â”‚  SQLite DB   â”‚  â”‚ Delta Sync   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚ staffService â”‚                          â”‚
â”‚                    â”‚  (Unified)   â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                           â”‚                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                 â”‚                 â”‚              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚   Staff    â”‚   â”‚ Permissionsâ”‚   â”‚    Sync    â”‚       â”‚
â”‚   â”‚ Management â”‚   â”‚   Dialog   â”‚   â”‚   Button   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ØªØ¯ÙÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Flow)

### 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯

#### Ø£) Online Mode:
```
User Input â†’ StaffManagement.tsx
    â†“
staffService.save()
    â†“
Supabase RPC (save_pos_staff_session)
    â†“
localStaffService.upsert() [Cache]
    â†“
SQLite (staff_members)
    â†“
UI Update
```

#### Ø¨) Offline Mode:
```
User Input â†’ StaffManagement.tsx
    â†“
staffService.save() [Detect Offline]
    â†“
localStaffService.upsertWithPending()
    â†“
SQLite (staff_members, synced=0)
    â†“
outboxManager.add()
    â†“
SQLite (sync_outbox)
    â†“
UI Update + Pending Badge
    â†“
[When Online]
    â†“
batchSender.sendBatch()
    â†“
Supabase RPC
    â†“
Update synced=1
```

---

### 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

#### Ø£) Online Mode:
```
User Input â†’ StaffPermissionsDialog.tsx
    â†“
staffService.save({ permissions })
    â†“
Supabase RPC
    â†“
localPermissionsService.saveStaffPermissions()
    â†“
SQLite UPDATE permissions
    â†“
UI Update
```

#### Ø¨) Offline Mode:
```
User Input â†’ StaffPermissionsDialog.tsx
    â†“
localPermissionsService.saveStaffPermissions()
    â†“
SQLite UPDATE (permissions, synced=0)
    â†“
outboxManager.add({ operation: 'UPDATE' })
    â†“
UI Update + Pending Badge
    â†“
[When Online] â†’ Delta Sync
```

---

### 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† PIN (Login)

#### Ø£) Online Mode:
```
User Input PIN â†’ StaffLoginForm
    â†“
staffService.verifyPin()
    â†“
Supabase RPC (verify_staff_login)
    â†“
Save to staff_pins [For Offline]
    â†“
Return Staff + Token
    â†“
Login Success
```

#### Ø¨) Offline Mode:
```
User Input PIN â†’ StaffLoginForm
    â†“
staffService.verifyPin() [Detect Offline]
    â†“
localStaffService.verifyPin()
    â†“
SQLite Query (staff_pins)
    â†“
Hash Comparison
    â†“
Login Success/Failure
```

---

### 4. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©

```
[Network Status Change: Online]
    â†“
deltaSyncEngine.fullSync()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚                  â”‚
â–¼                 â–¼                  â–¼
Download          Upload            Resolve
Staff from        Local             Conflicts
Server            Changes
    â”‚                 â”‚                  â”‚
    â†“                 â†“                  â†“
syncStaffFromServer  syncStaffToServer  conflictResolver
    â”‚                 â”‚                  â”‚
    â†“                 â†“                  â†“
UPDATE SQLite    UPDATE Supabase    last-write-wins
(synced=1)       (from outbox)
    â”‚                 â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
              Update UI + Toast
```

---

## ğŸ—„ï¸ Ù‡ÙŠÙƒÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

### SQLite Tables

```sql
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     staff_members                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚ TEXT PRIMARY KEY                         â”‚
â”‚ org_id       â”‚ TEXT NOT NULL                            â”‚
â”‚ user_id      â”‚ TEXT (Link to users table)               â”‚
â”‚ name         â”‚ TEXT NOT NULL                            â”‚
â”‚ email        â”‚ TEXT                                     â”‚
â”‚ phone        â”‚ TEXT                                     â”‚
â”‚ role         â”‚ TEXT DEFAULT 'staff'                     â”‚
â”‚ permissions  â”‚ TEXT (JSON)  â† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª               â”‚
â”‚ pin_hash     â”‚ TEXT                                     â”‚
â”‚ salt         â”‚ TEXT                                     â”‚
â”‚ is_active    â”‚ INTEGER DEFAULT 1                        â”‚
â”‚ last_login   â”‚ TEXT                                     â”‚
â”‚ created_at   â”‚ TEXT                                     â”‚
â”‚ updated_at   â”‚ TEXT                                     â”‚
â”‚ synced       â”‚ INTEGER DEFAULT 0  â† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©      â”‚
â”‚ sync_status  â”‚ TEXT                                     â”‚
â”‚ pending_op   â”‚ TEXT                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      staff_pins                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚ TEXT PRIMARY KEY                         â”‚
â”‚ staff_id     â”‚ TEXT NOT NULL UNIQUE                     â”‚
â”‚ org_id       â”‚ TEXT NOT NULL                            â”‚
â”‚ pin_hash     â”‚ TEXT NOT NULL                            â”‚
â”‚ salt         â”‚ TEXT NOT NULL                            â”‚
â”‚ staff_name   â”‚ TEXT                                     â”‚
â”‚ permissions  â”‚ TEXT (JSON)  â† Ù„Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹           â”‚
â”‚ created_at   â”‚ TEXT                                     â”‚
â”‚ updated_at   â”‚ TEXT                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    user_permissions                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id           â”‚ TEXT PRIMARY KEY                         â”‚
â”‚ auth_user_id â”‚ TEXT NOT NULL                            â”‚
â”‚ user_id      â”‚ TEXT                                     â”‚
â”‚ email        â”‚ TEXT                                     â”‚
â”‚ name         â”‚ TEXT                                     â”‚
â”‚ role         â”‚ TEXT                                     â”‚
â”‚ org_id       â”‚ TEXT                                     â”‚
â”‚ is_active    â”‚ INTEGER                                  â”‚
â”‚ is_org_admin â”‚ INTEGER                                  â”‚
â”‚ is_super     â”‚ INTEGER                                  â”‚
â”‚ permissions  â”‚ TEXT (JSON)  â† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…        â”‚
â”‚ created_at   â”‚ TEXT                                     â”‚
â”‚ updated_at   â”‚ TEXT                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

### Permissions Structure (JSON)

```json
{
  "viewInventory": true,
  "manageProducts": true,
  "editProducts": true,
  "deleteProducts": false,
  "accessPOS": true,
  "manageOrders": true,
  "viewReports": true,
  "manageCustomers": true,
  "manageEmployees": false,
  "manageSettings": false,
  "canGiveDiscounts": true,
  "maxDiscountPercent": 20,
  "canDeleteOrders": false,
  "canVoidTransactions": false,
  "canAccessCashDrawer": true,
  "canRefund": true,
  "maxRefundAmount": 5000
}
```

### Permission Levels

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Owner/Admin                      â”‚
â”‚         (Full Access - All Permissions)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Manager      â”‚  â”‚   Supervisor    â”‚
â”‚ (Most Perms)    â”‚  â”‚ (Moderate Perms)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚      Staff      â”‚
         â”‚ (Basic Perms)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Delta Sync Flow

### Full Sync Process

```
1. Initialize Delta Sync Engine
   â†“
2. Check Connection Status
   â†“
3. Download Phase
   â”œâ”€â†’ Fetch staff_members from Supabase
   â”œâ”€â†’ Compare with local data (by updated_at)
   â”œâ”€â†’ INSERT new staff
   â”œâ”€â†’ UPDATE changed staff
   â””â”€â†’ Mark synced=1
   â†“
4. Upload Phase
   â”œâ”€â†’ Get pending operations from outbox
   â”œâ”€â†’ Filter staff operations
   â”œâ”€â†’ Send batch to Supabase
   â””â”€â†’ Remove from outbox on success
   â†“
5. Conflict Resolution
   â”œâ”€â†’ Detect conflicts (same record updated both sides)
   â”œâ”€â†’ Apply strategy: last-write-wins
   â””â”€â†’ Update both local and remote
   â†“
6. Update UI
   â”œâ”€â†’ Refresh staff list
   â”œâ”€â†’ Update sync badges
   â””â”€â†’ Show toast notification
```

### Incremental Sync (Real-time)

```
[Supabase Realtime Event]
    â†“
realtimeReceiver.subscribe('staff_members')
    â†“
Receive INSERT/UPDATE/DELETE
    â†“
operationQueue.enqueue()
    â†“
Apply to Local SQLite
    â†“
Invalidate React Query Cache
    â†“
UI Auto-Updates
```

---

## ğŸ“± UI Components Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          StaffManagement.tsx                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Header + Search + Filters                â”‚  â”‚
â”‚  â”‚  [+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù] [ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©]               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Offline Indicator (if offline)           â”‚  â”‚
â”‚  â”‚  âš ï¸ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ - 5 ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          StaffTable.tsx                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ Name â”‚ Email â”‚ Role â”‚ Active â”‚ Syncâ”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚
â”‚  â”‚  â”‚ Ø£Ø­Ù…Ø¯ â”‚ a@.. â”‚ staff â”‚  âœ…   â”‚  â³ â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Ù…Ø­Ù…Ø¯ â”‚ m@.. â”‚ managerâ”‚ âœ…   â”‚  âœ… â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  Dialogs:                                        â”‚
â”‚  â”œâ”€â†’ AddStaffDialog.tsx                         â”‚
â”‚  â”œâ”€â†’ UpdatePinDialog.tsx                        â”‚
â”‚  â””â”€â†’ StaffPermissionsDialog.tsx  â† NEW          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ® User Interactions

### 1. Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯

```
User â†’ Click [+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù]
  â†“
AddStaffDialog Opens
  â†“
Fill Form:
  - Name
  - Email
  - Phone
  - PIN
  - Permissions Checkboxes
  â†“
Click [Ø­ÙØ¸]
  â†“
[Online] â†’ Save to Supabase â†’ Cache in SQLite
[Offline] â†’ Save to SQLite (synced=0) â†’ Add to Outbox
  â†“
Show Toast: "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù"
  â†“
Close Dialog â†’ Refresh List
```

### 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª

```
User â†’ Click [ğŸ” ØµÙ„Ø§Ø­ÙŠØ§Øª] on Staff Row
  â†“
StaffPermissionsDialog Opens
  â†“
Show Permissions List with Switches:
  â˜‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
  â˜‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  â˜ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
  â˜‘ï¸ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
  â†“
Toggle Switches
  â†“
Click [Ø­ÙØ¸]
  â†“
[Online] â†’ Update Supabase â†’ Update SQLite
[Offline] â†’ Update SQLite (synced=0) â†’ Add to Outbox
  â†“
Show Toast: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª"
  â†“
[Offline] Show Badge: "Ù…Ø¹Ù„Ù‚"
```

### 3. Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©

```
User â†’ Click [ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©] in Titlebar
  â†“
Show Progress Dialog
  â†“
Run fullSync()
  â”œâ”€â†’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: 150 âœ…
  â”œâ”€â†’ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: 75 âœ…
  â”œâ”€â†’ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: 30 âœ…
  â”œâ”€â†’ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†: 8 âœ…  â† NEW
  â””â”€â†’ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª: 5 âœ…
  â†“
Show Toast: "ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­"
  â†“
Update All UI + Remove Pending Badges
```

---

## ğŸ”§ Services Layer

### staffService.ts (Unified)

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         staffService.ts                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  getAll()                                â”‚
â”‚    â”œâ”€â†’ Try Supabase RPC                 â”‚
â”‚    â”œâ”€â†’ [Success] Cache in SQLite        â”‚
â”‚    â””â”€â†’ [Fail] Fallback to SQLite        â”‚
â”‚                                          â”‚
â”‚  save()                                  â”‚
â”‚    â”œâ”€â†’ Try Supabase RPC                 â”‚
â”‚    â”œâ”€â†’ [Success] Update SQLite          â”‚
â”‚    â””â”€â†’ [Fail] Save to SQLite + Outbox   â”‚
â”‚                                          â”‚
â”‚  delete()                                â”‚
â”‚    â”œâ”€â†’ Try Supabase RPC                 â”‚
â”‚    â”œâ”€â†’ [Success] Delete from SQLite     â”‚
â”‚    â””â”€â†’ [Fail] Mark deleted + Outbox     â”‚
â”‚                                          â”‚
â”‚  updatePin()                             â”‚
â”‚    â”œâ”€â†’ Try Supabase RPC                 â”‚
â”‚    â”œâ”€â†’ [Success] Update staff_pins      â”‚
â”‚    â””â”€â†’ [Fail] Update local + Outbox     â”‚
â”‚                                          â”‚
â”‚  verifyPin()                             â”‚
â”‚    â”œâ”€â†’ Try Supabase RPC                 â”‚
â”‚    â””â”€â†’ [Fail] Verify from staff_pins    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### localStaffService.ts (New)

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      localStaffService.ts               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  getAll(orgId)                          â”‚
â”‚    â””â”€â†’ SELECT * FROM staff_members      â”‚
â”‚                                          â”‚
â”‚  getById(staffId, orgId)                â”‚
â”‚    â””â”€â†’ SELECT * WHERE id = ?           â”‚
â”‚                                          â”‚
â”‚  upsert(staff, orgId)                   â”‚
â”‚    â””â”€â†’ INSERT OR REPLACE                â”‚
â”‚                                          â”‚
â”‚  delete(staffId, orgId)                 â”‚
â”‚    â””â”€â†’ DELETE FROM staff_members        â”‚
â”‚                                          â”‚
â”‚  verifyPin(pin, orgId)                  â”‚
â”‚    â””â”€â†’ SELECT + Hash Comparison         â”‚
â”‚                                          â”‚
â”‚  getUnsynced(orgId)                     â”‚
â”‚    â””â”€â†’ SELECT WHERE synced = 0          â”‚
â”‚                                          â”‚
â”‚  updateSyncStatus(staffId, synced)      â”‚
â”‚    â””â”€â†’ UPDATE SET synced = ?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### localPermissionsService.ts (New)

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    localPermissionsService.ts           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  saveStaffPermissions()                 â”‚
â”‚    â””â”€â†’ UPDATE permissions JSON          â”‚
â”‚                                          â”‚
â”‚  getStaffPermissions()                  â”‚
â”‚    â””â”€â†’ SELECT permissions + JSON.parse  â”‚
â”‚                                          â”‚
â”‚  updatePermission(key, value)           â”‚
â”‚    â””â”€â†’ Merge + UPDATE                   â”‚
â”‚                                          â”‚
â”‚  hasPermission(staffId, permKey)        â”‚
â”‚    â””â”€â†’ Check specific permission        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª Test Scenarios

### Scenario 1: Create Staff Offline â†’ Sync Online

```
1. Disconnect Network
2. Add New Staff "Ø¹Ù„ÙŠ" with PIN "1234"
3. âœ… Staff appears in list with "Ù…Ø¹Ù„Ù‚" badge
4. âœ… Can login with PIN offline
5. Reconnect Network
6. âœ… Auto-sync uploads staff to Supabase
7. âœ… Badge removed
8. âœ… Staff visible on other devices
```

### Scenario 2: Update Permissions Offline

```
1. Disconnect Network
2. Edit Staff "Ø£Ø­Ù…Ø¯"
3. Enable "manageEmployees" permission
4. âœ… Permission saved locally
5. âœ… Staff shows "Ù…Ø¹Ù„Ù‚" badge
6. Reconnect Network
7. âœ… Auto-sync uploads permission change
8. âœ… Badge removed
```

### Scenario 3: Concurrent Updates (Conflict)

```
1. Device A: Update Staff name "Ù…Ø­Ù…Ø¯" â†’ "Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯" (offline)
2. Device B: Update Staff phone "Ù…Ø­Ù…Ø¯" â†’ "0500000000" (online)
3. Device A: Reconnect â†’ Sync
4. âœ… Conflict detected
5. âœ… Resolver applies last-write-wins
6. âœ… Result: Both changes merged or latest wins
```

---

## ğŸ“ˆ Performance Metrics

### Target Metrics:

| Ø¹Ù…Ù„ÙŠØ© | Ø§Ù„Ù‡Ø¯Ù | Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª |
|------|-------|-----------|
| Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† | < 100ms | Ù…Ù† SQLite |
| Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù offline | < 50ms | ÙƒØªØ§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© |
| Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† PIN | < 100ms | hash comparison |
| Ù…Ø²Ø§Ù…Ù†Ø© 100 Ù…ÙˆØ¸Ù | < 3s | Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù… |
| Upload pending changes | < 2s | batch upload |

---

## ğŸ¯ Success Criteria

âœ… ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯ offline
âœ… ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù offline
âœ… ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª offline
âœ… ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† PIN offline
âœ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
âœ… Ø¹Ø±Ø¶ ÙˆØ§Ø¶Ø­ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ data loss
âœ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø³Ø±ÙŠØ¹ (< 100ms Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
âœ… ÙˆØ§Ø¬Ù‡Ø© Ø³Ù„Ø³Ø© Ø¨ÙŠÙ† online/offline

---

**ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:** 2025-01-24
**Ø§Ù„Ù†Ø³Ø®Ø©:** 1.0
**Ø§Ù„Ø­Ø§Ù„Ø©:** ğŸ“ ØªØµÙ…ÙŠÙ… Ù…ÙƒØªÙ…Ù„
