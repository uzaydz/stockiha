# ๐ฏ ูุธุงู ุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุงุดุชุฑุงู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุงูู ูุฅุฏุงุฑุฉ ุทูุจุงุช ุงูุงุดุชุฑุงู ูุณูุญ ููุนููุงุก ุจุฅุฑุณุงู ุทูุจุงุช ุงูุงุดุชุฑุงู ูุน ูุนูููุงุช ุงูุฏูุนุ ููุณูุญ ููุณูุจุฑ ุฃุฏููู ุจูุฑุงุฌุนุชูุง ููุจูููุง ุฃู ุฑูุถูุง.

---

## ๐๏ธ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฌุฏูู ุงูุฑุฆูุณู: `subscription_requests`

```sql
CREATE TABLE subscription_requests (
  id UUID PRIMARY KEY,
  organization_id UUID,
  plan_id UUID,
  billing_cycle TEXT,  -- 'monthly' | 'yearly'
  amount DECIMAL(10, 2),
  currency TEXT DEFAULT 'DZD',

  -- ูุนูููุงุช ุงูุฏูุน
  payment_method TEXT,
  payment_proof_url TEXT,
  payment_reference TEXT,
  payment_notes TEXT,

  -- ูุนูููุงุช ุงูุชูุงุตู
  contact_name TEXT,
  contact_email TEXT,
  contact_phone TEXT,

  -- ุงูุญุงูุฉ
  status TEXT DEFAULT 'pending',  -- 'pending' | 'approved' | 'rejected' | 'processing'

  -- ููุงุญุธุงุช
  customer_notes TEXT,
  admin_notes TEXT,
  rejection_reason TEXT,

  -- ุงููุฑุงุฌุนุฉ
  reviewed_by UUID,
  reviewed_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ
);
```

### ุงูุฏูุงู ุงููุชุงุญุฉ

#### 1. `create_subscription_request` - ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ
```typescript
await supabase.rpc('create_subscription_request', {
  p_organization_id: 'xxx',
  p_plan_id: 'xxx',
  p_billing_cycle: 'monthly',
  p_amount: 5000,
  p_currency: 'DZD',
  p_payment_method: 'ุชุญููู ุจููู',
  p_payment_reference: '123456',
  p_contact_name: 'ุฃุญูุฏ ูุญูุฏ',
  p_contact_email: 'ahmad@example.com',
  p_customer_notes: 'ููุงุญุธุงุช ุงูุนููู'
});
```

#### 2. `admin_get_subscription_requests` - ุฌูุจ ุงูุทูุจุงุช (Super Admin)
```typescript
await supabase.rpc('admin_get_subscription_requests', {
  p_status: 'pending',  // ุฃู null ููุฌููุน
  p_limit: 50,
  p_offset: 0
});
```

#### 3. `admin_approve_subscription_request` - ูุจูู ุงูุทูุจ ูุชูุนูู ุงูุงุดุชุฑุงู
```typescript
await supabase.rpc('admin_approve_subscription_request', {
  p_request_id: 'xxx',
  p_admin_notes: 'ุชู ุงูุชุญูู ูู ุงูุฏูุน'
});
```

#### 4. `admin_reject_subscription_request` - ุฑูุถ ุงูุทูุจ
```typescript
await supabase.rpc('admin_reject_subscription_request', {
  p_request_id: 'xxx',
  p_rejection_reason: 'ูุนูููุงุช ุงูุฏูุน ุบูุฑ ุตุญูุญุฉ',
  p_admin_notes: 'ูุฑุฌู ุฅุนุงุฏุฉ ุงููุญุงููุฉ'
});
```

---

## ๐จ ุตูุญุฉ Super Admin: ุทูุจุงุช ุงูุงุดุชุฑุงู

### ุงููููุน
```
/super-admin/subscription-requests
```

### ุงูููุฒุงุช

โ **ุนุฑุถ ุฌููุน ุงูุทูุจุงุช** - ูุน ุฅููุงููุฉ ุงูุชุตููุฉ ุญุณุจ ุงูุญุงูุฉ
โ **ุงูุจุญุซ** - ุงูุจุญุซ ุนู ูุคุณุณุฉ ุฃู ุจุงูุฉ
โ **ุฅุญุตุงุฆูุงุช ุณุฑูุนุฉ** - ุฅุฌูุงูู ุงูุทูุจุงุชุ ุงููุนููุฉุ ุงูููุจููุฉุ ุงููุฑููุถุฉ
โ **ุนุฑุถ ุงูุชูุงุตูู ุงููุงููุฉ** - ุฌููุน ูุนูููุงุช ุงูุทูุจ ูุงูุฏูุน
โ **ูุจูู ุงูุทูุจ** - ุชูุนูู ุงูุงุดุชุฑุงู ุชููุงุฆูุงู
โ **ุฑูุถ ุงูุทูุจ** - ูุน ุฅููุงููุฉ ุฅุถุงูุฉ ุณุจุจ ุงูุฑูุถ
โ **ููุงุญุธุงุช ุงูุฅุฏุงุฑุฉ** - ุฅุถุงูุฉ ููุงุญุธุงุช ููู ุทูุจ
โ **ุณุฌู ุงููุฑุงุฌุนุฉ** - ูุนุฑูุฉ ูู ุฑุงุฌุน ุงูุทูุจ ููุชู

---

## ๐ง ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชุทุจูู Migration ูู Supabase

ุงูุชุญ **Supabase Dashboard** โ **SQL Editor** ูููุฐ:

```
supabase/migrations/current/20251102_create_subscription_requests_table.sql
```

### 2. ุฅุถุงูุฉ Route ููุตูุญุฉ

ูู ููู routes ุงูุฎุงุต ุจู Super Adminุ ุฃุถู:

```typescript
import SubscriptionRequests from '@/pages/super-admin/SubscriptionRequests';

// ูู routes
<Route path="/super-admin/subscription-requests" element={<SubscriptionRequests />} />
```

### 3. ุฅุถุงูุฉ ุฑุงุจุท ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ

ูู `SuperAdminLayout.tsx` ุฃู ููู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ:

```typescript
{
  title: 'ุทูุจุงุช ุงูุงุดุชุฑุงู',
  href: '/super-admin/subscription-requests',
  icon: FileText,
  badge: pendingRequestsCount > 0 ? pendingRequestsCount : undefined
}
```

### 4. ุชุนุฏูู SubscriptionDialog (ุงุฎุชูุงุฑู)

ุฅุฐุง ุฃุฑุฏุช ุฅุฑุณุงู ุงูุทูุจ ุชููุงุฆูุงู ุนูุฏ ุงุฎุชูุงุฑ ุงูุจุงูุฉุ ุฃุถู ูุฐุง ุงูููุฏ:

```typescript
import { createSubscriptionRequest } from '@/lib/subscription-requests-service';

const handleSubmitRequest = async () => {
  const result = await createSubscriptionRequest({
    organizationId: organization.id,
    planId: selectedPlan.id,
    billingCycle: billingCycle,
    amount: finalAmount,
    currency: 'DZD',
    paymentMethod: paymentFormData.method,
    paymentReference: paymentFormData.reference,
    contactName: user.name,
    contactEmail: user.email,
    customerNotes: notes
  });

  if (result.success) {
    toast.success('ุชู ุฅุฑุณุงู ุทูุจ ุงูุงุดุชุฑุงู ุจูุฌุงุญ! ุณูุชู ูุฑุงุฌุนุชู ูุฑูุจุงู.');
  } else {
    toast.error(result.error || 'ูุดู ูู ุฅุฑุณุงู ุงูุทูุจ');
  }
};
```

---

## ๐ ุณูุฑ ุงูุนูู (Workflow)

```
1. ุงูุนููู ูุฎุชุงุฑ ุจุงูุฉ โ ูููุฃ ูุนูููุงุช ุงูุฏูุน
                          โ
2. ูุฑุณู ุงูุทูุจ โ ููุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุญุงูุฉ 'pending'
                          โ
3. Super Admin ูุณุชูุจู ุฅุดุนุงุฑ โ ูุฑุงุฌุน ุงูุทูุจ ูู ุงูุตูุญุฉ ุงููุฎุตุตุฉ
                          โ
4. ูุชุญูู ูู ูุนูููุงุช ุงูุฏูุน โ ูุฑุงุฌุน ุฅุซุจุงุช ุงูุฏูุน
                          โ
5. ูุฑุงุฑ: ูุจูู ุฃู ุฑูุถ
   โ
   โโโ ูุจูู: ูุชู ุชูุนูู ุงูุงุดุชุฑุงู ุชููุงุฆูุงู + ุฅุดุนุงุฑ ููุนููู
   โ
   โโโ ุฑูุถ: ูุถูู ุณุจุจ ุงูุฑูุถ + ุฅุดุนุงุฑ ููุนููู
```

---

## ๐จ ูุนุงููุฉ ุงููุงุฌูุฉ

### ุตูุญุฉ ูุงุฆูุฉ ุงูุทูุจุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุทูุจุงุช ุงูุงุดุชุฑุงู                              [ุชุญุฏูุซ]      โ
โ  ุฅุฏุงุฑุฉ ููุฑุงุฌุนุฉ ุทูุจุงุช ุงูุงุดุชุฑุงู ูู ุงูุนููุงุก                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ   โ
โ  โ ุฅุฌูุงูู   โ  โ ููุฏ      โ  โ ููุจููุฉ  โ  โ ูุฑููุถุฉ   โ   โ
โ  โ   45     โ  โ   12     โ  โ   28     โ  โ    5     โ   โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  [ุจุญุซ...]                      [ุชุตููุฉ: ุฌููุน ุงูุญุงูุงุช โผ]    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุงููุคุณุณุฉ     โ ุงูุจุงูุฉ    โ ุงููุจูุบ      โ ุงูุญุงูุฉ โ ุงูุฅุฌุฑุงุกุงุชโ
โ  ุณุทููููุง    โ ูุชููุฒ    โ 50,000 DZD โ ูุนูู   โ [๐๏ธ][โ][โ]โ
โ  ูุชุฌุฑ ๏ฟฝ๏ฟฝุญูุฏ  โ ุฃุณุงุณู    โ 25,000 DZD โ ููุจูู  โ [๐๏ธ]      โ
โ  ...                                                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ูุงูุฐุฉ ุงูุชูุงุตูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุชูุงุตูู ุงูุทูุจ                          [โ]  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ ูุนูููุงุช ุงููุคุณุณุฉ                         โ
โ  ุงูุงุณู: ุณุทููููุง                              โ
โ  ุงูุจุฑูุฏ: info@stockiha.com                   โ
โ                                               โ
โ  ๐ ูุนูููุงุช ุงูุจุงูุฉ                           โ
โ  ุงูุจุงูุฉ: ุจุงูุฉ ูุชููุฒุฉ                         โ
โ  ุฏูุฑุฉ ุงูููุชุฑุฉ: ุณููู                          โ
โ  ุงููุจูุบ: 50,000.00 DZD                       โ
โ                                               โ
โ  ๐ค ูุนูููุงุช ุงูุชูุงุตู                          โ
โ  ุงูุงุณู: ุฃุญูุฏ ูุญูุฏ                            โ
โ  ุงูุจุฑูุฏ: ahmad@stockiha.com                  โ
โ  ุงููุงุชู: +213 555 123 456                    โ
โ                                               โ
โ  ๐ณ ูุนูููุงุช ุงูุฏูุน                            โ
โ  ุทุฑููุฉ ุงูุฏูุน: ุชุญููู ุจููู                    โ
โ  ุฑูู ุงููุฑุฌุน: TRX-2025-001                    โ
โ  [ุนุฑุถ ุฅุซุจุงุช ุงูุฏูุน]                           โ
โ                                               โ
โ  ๐ ููุงุญุธุงุช ุงูุนููู                           โ
โ  "ูุฑุฌู ุชูุนูู ุงูุญุณุงุจ ูู ุฃูุฑุจ ููุช..."         โ
โ                                               โ
โ  โ ุงูุญุงูุฉ: ููุฏ ุงููุฑุงุฌุนุฉ                    โ
โ  ุชู ุงูุฅูุดุงุก: 2 ููููุจุฑ 2025ุ 14:30           โ
โ                                               โ
โ              [ูุจูู ูุชูุนูู] [ุฑูุถ]             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## โ ุงูุงุฎุชุจุงุฑุงุช

### ุงุฎุชุจุงุฑ 1: ุฅูุดุงุก ุทูุจ ุงุดุชุฑุงู

```typescript
// ูู ุฌุงูุจ ุงูุนููู
const result = await createSubscriptionRequest({
  organizationId: 'org-123',
  planId: 'plan-premium',
  billingCycle: 'yearly',
  amount: 50000,
  paymentMethod: 'ุชุญููู ุจููู',
  paymentReference: 'TRX-001',
  contactName: 'ุฃุญูุฏ ูุญูุฏ',
  contactEmail: 'ahmad@example.com'
});

// ุงููุชูุฌุฉ ุงููุชููุนุฉ
// โ success: true
// โ request_id: 'xxx'
// โ message: 'ุชู ุฅุฑุณุงู ุทูุจ ุงูุงุดุชุฑุงู ุจูุฌุงุญ'
```

### ุงุฎุชุจุงุฑ 2: ุนุฑุถ ุงูุทูุจุงุช (Super Admin)

```bash
1. ุงูุชุญ /super-admin/subscription-requests
2. ุชุญูู ูู ุธููุฑ ุฌููุน ุงูุทูุจุงุช
3. ุฌุฑุจ ุงูุชุตููุฉ ุญุณุจ ุงูุญุงูุฉ
4. ุฌุฑุจ ุงูุจุญุซ ุนู ูุคุณุณุฉ

ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ ุชุธูุฑ ุฌููุน ุงูุทูุจุงุช ุจุดูู ุตุญูุญ
โ ุงูุชุตููุฉ ุชุนูู
โ ุงูุจุญุซ ูุนูู
โ ุงูุฅุญุตุงุฆูุงุช ุตุญูุญุฉ
```

### ุงุฎุชุจุงุฑ 3: ูุจูู ุทูุจ

```bash
1. ุงุฎุชุฑ ุทูุจ ูุนูู
2. ุงุถุบุท ุนูู ุฒุฑ "ุนุฑุถ"
3. ุฑุงุฌุน ุฌููุน ุงูุชูุงุตูู
4. ุงุถุบุท "ูุจูู ูุชูุนูู"
5. ุฃุถู ููุงุญุธุงุช (ุงุฎุชูุงุฑู)
6. ุงุถุบุท ุชุฃููุฏ

ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ ูุชู ูุจูู ุงูุทูุจ
โ ูุชู ุชูุนูู ุงุดุชุฑุงู ุงููุคุณุณุฉ ุชููุงุฆูุงู
โ ุชุธูุฑ ุฑุณุงูุฉ ูุฌุงุญ
โ ุชุชุญุฏุซ ุญุงูุฉ ุงูุทูุจ ุฅูู 'approved'
```

### ุงุฎุชุจุงุฑ 4: ุฑูุถ ุทูุจ

```bash
1. ุงุฎุชุฑ ุทูุจ ูุนูู
2. ุงุถุบุท ุนูู ุฒุฑ ุงูุฑูุถ [โ]
3. ุฃุฏุฎู ุณุจุจ ุงูุฑูุถ
4. ุฃุถู ููุงุญุธุงุช (ุงุฎุชูุงุฑู)
5. ุงุถุบุท ุชุฃููุฏ

ุงููุชูุฌุฉ ุงููุชููุนุฉ:
โ ูุชู ุฑูุถ ุงูุทูุจ
โ ููุญูุธ ุณุจุจ ุงูุฑูุถ
โ ุชุธูุฑ ุฑุณุงูุฉ ูุฌุงุญ
โ ุชุชุญุฏุซ ุญุงูุฉ ุงูุทูุจ ุฅูู 'rejected'
```

---

## ๐ ุงูุฃูุงู ูุงูุตูุงุญูุงุช

### Row Level Security (RLS)

โ **ุงูุนููุงุก:**
- ูููููู ุฅูุดุงุก ุทูุจุงุช ููุคุณุณุงุชูู ููุท
- ูููููู ุนุฑุถ ุทูุจุงุช ูุคุณุณุงุชูู ููุท
- ูุง ูููููู ุชุนุฏูู ุงูุทูุจุงุช ุจุนุฏ ุงูุฅูุดุงุก

โ **Super Admin:**
- ูููููู ุนุฑุถ ุฌููุน ุงูุทูุจุงุช
- ูููููู ูุจูู ุฃู ุฑูุถ ุงูุทูุจุงุช
- ูููููู ุฅุถุงูุฉ ููุงุญุธุงุช

โ **ุงููุณุชุฎุฏููู ุงูุนุงุฏููู:**
- ูุง ูููููู ุงููุตูู ููุทูุจุงุช

---

## ๐ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ (ุงุฎุชูุงุฑู)

1. **ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ:**
   - ุฅุดุนุงุฑ ููุณูุจุฑ ุฃุฏููู ุนูุฏ ุทูุจ ุฌุฏูุฏ
   - ุฅุดุนุงุฑ ููุนููู ุนูุฏ ูุจูู/ุฑูุถ ุงูุทูุจ

2. **ุฑูุน ูููุงุช:**
   - ุฑูุน ุฅุซุจุงุช ุงูุฏูุน ูุจุงุดุฑุฉ
   - ุฑูุน ูุณุชูุฏุงุช ุฅุถุงููุฉ

3. **ุชุชุจุน ุงูุญุงูุฉ:**
   - ุญุงูุงุช ุฅุถุงููุฉ (processing, pending_payment)
   - ุณุฌู ุชุงุฑูุฎ ุงูุชุบููุฑุงุช

4. **ุชูุงูู ุงูุฏูุน:**
   - ุชูุงูู ูุน ุจูุงุจุงุช ุงูุฏูุน ุงูุฅููุชุฑููู
   - ุงูุชุญูู ุงูุชููุงุฆู ูู ุงูุฏูุน

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู console log
2. ุฑุงุฌุน Supabase logs
3. ุชุฃูุฏ ูู ุชุทุจูู ุฌููุน migrations
4. ุชุฃูุฏ ูู ุตูุงุญูุงุช RLS

---

**ุชู ุงูุฅูุดุงุก:** 2025-11-02
**ุงูุฅุตุฏุงุฑ:** 1.0.0
**ุงูุญุงูุฉ:** ุฌุงูุฒ ููุฅูุชุงุฌ โ
