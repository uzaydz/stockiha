# خطة تحسين وتحديث نظام الطباعة في تطبيق Electron
## تحليل الوضع الحالي
بعد فحص الكود الحالي في `electron/main.cjs` و `src/services/`, تبين أن النظام يستخدم:
1. **لإيصالات الكاشير (POS):** مكتبة `electron-pos-printer` (تستخدم WebContents للرسم ثم الطباعة).
2. **للفواتير والتقارير (A4):** إنشاء `BrowserWindow` جديد ومخفي لكل عملية طباعة (`ipcMain.handle('print:html')`).
3. **للباركود:** تجميع مصفوفة بيانات وإرسالها لـ `electron-pos-printer`.

### المشاكل المكتشفة والفرص للتحسين:
1. **أداء الطباعة (Performance):**
   - **المشكلة:** يتم إنشاء نافذة جديدة (`new BrowserWindow`) لكل عملية طباعة A4/HTML ثم تدميرها. هذه العملية تستهلك الذاكرة وتسبب تأخيراً (Latency) يتراوح بين 1-3 ثوانٍ قبل بدء الطباعة.
   - **الحل:** استخدام تقنية **"Singleton Hidden Window"**. نافذة واحدة مخفية يتم إنشاؤها عند بدء التطبيق وتظل مفتوحة لخدمة طلبات الطباعة المتتالية.

2. **الاعتمادية (Reliability):**
   - **المشكلة:** في حال فشل الطباعة الصامتة (`silent printing`)، لا توجد آلية قوية لإعادة المحاولة أو عرض حوار الطباعة كبديل تلقائي.
   - **الحل:** تحسين معالجة الأخطاء (Error Handling) لتوفير Fallback تلقائي.

3. **الطباعة المباشرة (Raw Printing):**
   - **الفرصة:** مكتبة `electron-pos-printer` جيدة للتنسيق، لكنها أبطأ من إرسال أوامر ESC/POS المباشرة (Raw Bytes) للطابعة.
   - **التحسين:** إضافة خيار لإرسال أوامر خام (Raw ESC/POS) للطابعات التي تدعم ذلك للحصول على سرعة قصوى (أقل من 200ms).

---

## أحدث الطرق والتقنيات في Electron (2024/2025)
بناءً على أحدث الممارسات:
1. **Shared Render Process:** بدلاً من فتح نوافذ متعددة، يتم استخدام نافذة خلفية واحدة (`Background Worker`) لمعالجة المهام الثقيلة والطباعة.
2. **WebHID API:** للمعالجة المباشرة مع أجهزة USB دون الحاجة لتعريفات معقدة (للمستقبل).
3. **Optimized `webContents.print`:** استخدام خيارات الطباعة الحديثة في Electron لضمان توافق الهوامش والسرعة.

---

## الخطة التنفيذية المقترحة

### 1. إنشاء مدير الطباعة الموحد (Unified Print Manager)
سنقوم بفصل منطق الطباعة من `main.cjs` إلى ملف جديد `electron/printManager.cjs` لترتيب الكود وتحسين الأداء.

**المحاور الرئيسية للتطوير:**
*   **Singleton Window:** نافذة واحدة مخفية تخدم كل التطبيق.
*   **Queue System:** طابور (Queue) لطلبات الطباعة لمنع تداخل العمليات إذا ضغط المستخدم بسرعة.
*   **Memory Management:** تنظيف محتوى النافذة المخفية بعد كل طباعة لمنع تسرب الذاكرة.

### 2. تحسين كود الـ Backend (Main Process)
سيتم تعديل المعالجات (`ipcMain handlers`) لتستخدم المدير الجديد.

```javascript
// مثال للتصور الجديد (Sudo Code)
const printManager = new PrintManager();
await printManager.printHTML(htmlContent, options);
```

### 3. دعم الطباعة الخام (اختياري - للمستقبل)
إضافة بنية تحتية لدعم `node-escpos` إذا تطلب الأمر سرعة فائقة في المستقبل، لكن سنركز حالياً على تحسين الطريقة الحالية لضمان توافق التصميم.

---

## خطوات التنفيذ (بعد الموافقة)

1. **إنشاء ملف `electron/printManager.cjs`:**
   - يحتوي على كلاس `PrintManager`.
   - يدير النافذة المخفية (`workerWindow`).
   - يعالج طلبات الطباعة (HTML, PDF, POS).

2. **تحديث `electron/main.cjs`:**
   - استيراد `PrintManager`.
   - استبدال الـ Handlers الحالية بالكود الجديد المحسن.
   - ضمان عدم كسر الوظائف الحالية.

3. **اختبار الأداء:**
   - التأكد من أن الطباعة أسرع واستجابة التطبيق أفضل.

---

### هل توافق على البدء في تنفيذ "مدير الطباعة الموحد" (PrintManager) بهذه التحسينات؟
سيجعل هذا النظام الطباعة أسرع وأكثر استقراراً، ويقلل من استهلاك الرام بشكل ملحوظ.
