# حل مشكلة أخطاء HTTP 406 (Not Acceptable)

## المشكلة
كان التطبيق يواجه أخطاء HTTP 406 عند تحميل الموارد من Supabase، مما يؤدي إلى فشل في تحميل البيانات وظهور رسائل خطأ في وحدة التحكم.

## الأسباب المحتملة
1. **رؤوس HTTP غير متوافقة**: الخادم لا يقبل تنسيق الرؤوس المرسلة
2. **مشاكل CORS**: إعدادات CORS غير صحيحة
3. **رؤوس Accept غير مدعومة**: الخادم لا يدعم تنسيق المحتوى المطلوب
4. **مشاكل في المصادقة**: رؤوس المصادقة غير صحيحة أو مفقودة

## الحلول المطبقة

### 1. تحسين ملف `fetchWithAuth.ts`
- إضافة رؤوس HTTP محسنة ومتوافقة
- معالجة خاصة لأخطاء 406 مع إعادة المحاولة
- إضافة رؤوس CORS مناسبة
- تحسين معالجة الأخطاء

```typescript
// إضافة رؤوس محسنة
headers.set('Accept', 'application/json, text/plain, */*');
headers.set('Accept-Language', 'ar,en;q=0.9');
headers.set('Accept-Encoding', 'gzip, deflate, br');
headers.set('Cache-Control', 'no-cache');
headers.set('Pragma', 'no-cache');
```

### 2. تحسين إعدادات Supabase
- تحسين دالة `fetch` المخصصة في إعدادات Supabase
- إضافة معالجة خاصة لأخطاء 406
- تحسين رؤوس الطلبات

```typescript
// معالجة خاصة لأخطاء 406 في Supabase
if (response.status === 406) {
  // محاولة إعادة الطلب مع رؤوس مبسطة
  const retryHeaders = new Headers();
  retryHeaders.set('Accept', '*/*');
  retryHeaders.set('Content-Type', 'application/json');
  // ...
}
```

### 3. إنشاء معالج أخطاء موحد
- ملف `errorHandlers.ts` لمعالجة جميع أنواع الأخطاء
- دوال مساعدة لإعادة المحاولة
- معالجة خاصة لأخطاء Supabase

### 4. مكونات واجهة المستخدم للأخطاء
- مكون `ErrorHandler.tsx` لعرض الأخطاء بشكل جميل
- مكون `Error406Handler` خاص بأخطاء 406
- مكون `SessionMonitor` لمراقبة حالة الجلسة

### 5. معالج شامل لأخطاء 406
- ملف `http406Handler.ts` لاعتراض جميع طلبات HTTP
- إعادة المحاولة التلقائية للطلبات الفاشلة
- إظهار رسائل مناسبة للمستخدم

## كيفية عمل الحل

### 1. الاعتراض والمعالجة
```typescript
// اعتراض جميع طلبات fetch
window.fetch = async (input, init) => {
  const response = await originalFetch(input, init);
  
  if (response.status === 406) {
    // إعادة المحاولة مع رؤوس مبسطة
    return retryWith406Fix(input, init);
  }
  
  return response;
};
```

### 2. إعادة المحاولة التدريجية
1. **المحاولة الأولى**: رؤوس مبسطة
2. **المحاولة الثانية**: رؤوس أساسية فقط
3. **المحاولة الثالثة**: الحد الأدنى من الرؤوس

### 3. واجهة المستخدم
- رسائل تنبيه واضحة ومفيدة
- أزرار إعادة المحاولة
- مؤشرات التحميل

## الملفات المعدلة

1. **`src/lib/api/fetchWithAuth.ts`** - تحسين معالجة الطلبات
2. **`src/lib/supabase.ts`** - تحسين إعدادات Supabase
3. **`src/lib/errorHandlers.ts`** - معالجات الأخطاء الموحدة
4. **`src/components/ErrorHandler.tsx`** - مكونات واجهة الأخطاء
5. **`src/components/SessionMonitor.tsx`** - مراقب حالة الجلسة
6. **`src/lib/http406Handler.ts`** - معالج شامل لأخطاء 406
7. **`src/main.tsx`** - تهيئة المعالجات
8. **`src/App.tsx`** - إضافة مراقب الجلسة

## الفوائد

### 1. تحسين تجربة المستخدم
- رسائل خطأ واضحة ومفيدة
- إعادة المحاولة التلقائية
- واجهة مستخدم متجاوبة

### 2. استقرار التطبيق
- معالجة شاملة للأخطاء
- منع تعطل التطبيق
- تتبع وإحصائيات الأخطاء

### 3. سهولة الصيانة
- كود منظم ومعلق
- معالجات موحدة
- توثيق شامل

## الاختبار

### 1. اختبار الأخطاء
```javascript
// في وحدة التحكم
console.log(get406Stats()); // عرض إحصائيات الأخطاء
retryFailed406Requests(); // إعادة محاولة الطلبات الفاشلة
```

### 2. محاكاة الأخطاء
```javascript
// محاكاة خطأ 406
fetch('/api/test', {
  headers: { 'Accept': 'unsupported/format' }
});
```

## التحديثات المستقبلية

1. **تحسين الذكاء الاصطناعي**: إضافة تعلم آلي لتحديد أفضل رؤوس للطلبات
2. **تحليلات متقدمة**: تتبع أكثر تفصيلاً للأخطاء
3. **إعدادات قابلة للتخصيص**: السماح للمستخدمين بتخصيص سلوك المعالجة

## الخلاصة

تم حل مشكلة أخطاء HTTP 406 بنجاح من خلال:
- تحسين رؤوس HTTP
- إضافة معالجة شاملة للأخطاء
- تحسين واجهة المستخدم
- إضافة مراقبة وتتبع للأخطاء

هذا الحل يضمن استقرار التطبيق وتحسين تجربة المستخدم عند مواجهة أي مشاكل في الشبكة أو الخادم. 