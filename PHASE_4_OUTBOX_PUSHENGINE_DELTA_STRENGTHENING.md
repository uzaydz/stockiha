# ุงููุฑุญูุฉ 4: ุชูููุฉ Outbox / PushEngine / Delta

## โ ุงููุฏู
ูู ูุง ูุฎุฑุฌ ููุณูุฑูุฑ ููุธูู ููุงุจู ููุชุดุฎูุตุ ุจุฏูู ููุฏ ุจูุงูุงุช ุฃู retrys ูุง ููุงุฆูุฉ.

---

## 4.1 โ ูุฑุงุฌุนุฉ OutboxManager

### ุงูุชุญุณููุงุช ุงููููุฐุฉ:

#### 1. ุชุญุณูู ุชุตููู ุงูุฃุฎุทุงุก (`classifyError`)
- โ **Network/Timeout errors**: ุชู ููููุง ุฅูู ุฃููููุฉ ุนุงููุฉ โ retry (pending)
  - ุชู ุฅุถุงูุฉ ุฃููุงุท ุฅุถุงููุฉ: `connection timeout`, `socket hang up`, `econnaborted`, `etimedout`, `enotfound`, `dns`, `no internet`
  
- โ **Schema errors (fixed)**: ุชู ุชูููุฒูุง ุจูุถูุญ โ DLQ/UNFIXABLE (ูุน log ูุงุถุญ)
  - ุฃููุงุท ูุญุฏุฏุฉ: `pgrst204`, `could not find the`, `column does not exist`, `relation does not exist`, `no such column`, `no such table`
  - ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ: `Schema error (UNFIXABLE): Column/table missing in Supabase schema`

#### 2. ุชุญุณูู `markFailed`
- โ **Log ูุงุถุญ ููุฃุฎุทุงุก**: ุนูุฏ ููู Schema errors ุฅูู DLQ
  - ุชุณุฌูู ูุงูู: Table, Record ID, Operation, Error, Reason
  - ุชูููุฒ ูุงุถุญ ุจูู Schema errors (ูุงุจูุฉ ููุงุณุชุนุงุฏุฉ) ูุงูุฃุฎุทุงุก ุงูุฏุงุฆูุฉ

#### 3. ุงูุณูุงุณุฉ ุงููุทุจูุฉ:
- โ **ุฃุฎุทุงุก network/timeout** โ ูุนุงุฏ ุงููุญุงููุฉ (pending)
- โ **ุฃุฎุทุงุก schema ุงูุซุงุจุชุฉ** (ุนููุฏ ูุงูุต/ุฌุฏูู ุบูุฑ ููุฌูุฏ) โ ุชูุชูู ุฅูู DLQ/UNFIXABLE (ูุน log ูุงุถุญ)

---

## 4.2 โ ูุฑุงุฌุนุฉ PushEngine

### ุงูุชุญุณููุงุช ุงููููุฐุฉ:

#### 1. ุชุฑุชูุจ ุงูุนูููุงุช (ููุฌูุฏ ูุณุจูุงู)
- โ **Parent tables ุฃููุงู**: orders, invoices, returns, losses, supplier_purchases
- โ **Child tables ุซุงููุงู**: order_items, invoice_items, return_items, loss_items, supplier_purchase_items

#### 2. ูุธุงู Hooks ูู `config.ts`

##### Hook ูุฌุฏูู `orders`:
- โ **ุฅุตูุงุญ ุฃุณูุงุก ุงูุญููู ุงููุงููุฉ**:
  - `paid_amount` โ `amount_paid` (Supabase ูุณุชุฎุฏู amount_paid)
  - `total_amount` โ `total`
  - `tax_amount` โ `tax`
  - `discount_amount` โ `discount`
  - `shipping_amount` โ `shipping_cost`
  - `staff_id` โ `employee_id`

- โ **ุฅุฒุงูุฉ ุงูุญููู ุงููุญููุฉ**: 
  - `synced`, `sync_status`, `pending_operation`, `local_updated_at`
  - `order_number`, `local_order_number`, `customer_name`, `customer_phone`, `customer_email`
  - `wilaya`, `commune`, `tracking_number`, `shipping_company`
  - ูุบูุฑูุง ูู ุงูุญููู ุงููุญููุฉ

##### Hook ูุฌุฏูู `order_items`:
- โ **ุฅุตูุงุญ ุฃุณูุงุก ุงูุญููู**:
  - `subtotal` โ `total_price` (Supabase ูุณุชุฎุฏู total_price)
  
- โ **ุฅุฒุงูุฉ ุงูุญููู ุงููุญููุฉ**:
  - `synced`, `sync_status`, `pending_operation`, `local_updated_at`
  - `subtotal`, `discount` (ูุญููุฉ ููุท)

#### 3. ุงูุชุฃูุฏ ูู ุงูุชุบุทูุฉ:
- โ ุฌููุน ุงูุญููู ุงูุญููููุฉ ูุบุทุงุฉ (ูุซูุงู `amount_paid` vs `paid_amount`)
- โ ุงูุญููู ุงููุญููุฉ ุชูุฒุงู ูุจู ุงูุฅุฑุณุงู
- โ ุงูุญููู ุงูููููุฏุฉ ุชูุตูุญ ุชููุงุฆูุงู

---

## 4.3 โ Delta Operations

### ุงูุชุญุณููุงุช ุงููููุฐุฉ:

#### 1. ูู `DeltaWriteService.stockDelta`:

##### ุงูุชุญูู ูู ุงูุฃุนูุฏุฉ:
- โ **ุงูุชุญูู ูู ูุฌูุฏ organizationId** ูุจู ุงูุชูููุฐ
- โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุฃุนูุฏุฉ**: ุฅุฐุง ูุงู ุงูุนููุฏ ุบูุฑ ููุฌูุฏ ูุญููุงูุ ูุถูู DELTA ููู Outbox ุนูู ุฃู ุญุงู
  - ูุฏ ูููู ุงูุนููุฏ ููุฌูุฏุงู ูู Supabase ููู ุบูุฑ ููุฌูุฏ ูุญููุงู
  - ุงูุณูุฑูุฑ ูุฏ ูููู ูุงุฏุฑุงู ุนูู ูุนุงูุฌุฉ ุงูุชุญุฏูุซ

##### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
- โ **Log ูุงุถุญ ุนูุฏ ุงููุดู**:
  - Table, Field, Record ID, Delta, Error
  - ุชูููุฒ ุจูู ุฃุฎุทุงุก ุงูุฃุนูุฏุฉ ูุงูุฃุฎุทุงุก ุงูุฃุฎุฑู

- โ **ุฅุถุงูุฉ Outbox DELTA ุญุชู ุนูุฏ ูุดู ุงูุชุญุฏูุซ ุงููุญูู**:
  - ููุฃุฎุทุงุก ุจุณุจุจ ุนููุฏ ุบูุฑ ููุฌูุฏ: ูุถูู DELTA ููู Outbox ููุง ูุฑูู ุฎุทุฃ
  - ููุฃุฎุทุงุก ุงูุฃุฎุฑู: ูุญุงูู ุฅุถุงูุฉ DELTA ููู Outbox ุซู ูุฑูู ุงูุฎุทุฃ ุงูุฃุตูู

#### 2. ุงูุชุฃูุฏ ูู:
- โ `getLocalTableName` + `getLocalColumnName` ุชุนูุฏ ุฃุนูุฏุฉ ููุฌูุฏุฉ ูุนูุงู ูู Tauri schema
  - ุงูุฏูุงู ุชุนูุฏ ุงูุฃุณูุงุก ููุง ูู (ูุง ุชุญููู)
  - ุงูุชุญูู ูุชู ุนุจุฑ try-catch ุนูุฏ ุงูุชูููุฐ
  
- โ ุนูุฏ ูุดู ุนูููุฉ deltaุ ูุณุฌู error ูุงุถุญ ูููุถุงู Outbox DELTA ุจุดูู ุตุญูุญ
  - Log ูุงูู ููุฎุทุฃ
  - ูุญุงููุฉ ุฅุถุงูุฉ DELTA ููู Outbox ุญุชู ุนูุฏ ุงููุดู

---

## ๐ ููุฎุต ุงูุชุญุณููุงุช

### OutboxManager:
1. โ ุชุตููู ูุญุณูู ููุฃุฎุทุงุก (network/timeout ุฃููููุฉ ุนุงููุฉ)
2. โ Schema errors โ DLQ ูุน log ูุงุถุญ
3. โ ุชูููุฒ ูุงุถุญ ุจูู ุงูุฃุฎุทุงุก ุงููุงุจูุฉ ููุงุณุชุนุงุฏุฉ ูุงูุฏุงุฆูุฉ

### PushEngine:
1. โ Hooks ูุญุณููุฉ ูุชุบุทูุฉ ุฌููุน ุงูุญููู ุงูุญููููุฉ
2. โ ุฅุตูุงุญ ุชููุงุฆู ูุฃุณูุงุก ุงูุญููู (amount_paid vs paid_amount)
3. โ ุฅุฒุงูุฉ ุงูุญููู ุงููุญููุฉ ูุจู ุงูุฅุฑุณุงู

### Delta Operations:
1. โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ูุญุณููุฉ ูุน log ูุงุถุญ
2. โ ุฅุถุงูุฉ Outbox DELTA ุญุชู ุนูุฏ ูุดู ุงูุชุญุฏูุซ ุงููุญูู
3. โ ุงูุชุญูู ูู ูุฌูุฏ ุงูุฃุนูุฏุฉ ูุจู ุงูุงุณุชุฎุฏุงู

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ **ูู ูุง ูุฎุฑุฌ ููุณูุฑูุฑ ููุธูู ููุงุจู ููุชุดุฎูุต**
- Log ูุงุถุญ ูุฌููุน ุงูุฃุฎุทุงุก
- ุชุตููู ุฏููู ููุฃุฎุทุงุก (network vs schema)
- ูุนุงูุฌุฉ ุตุญูุญุฉ ููู ููุน ุฎุทุฃ

โ **ุจุฏูู ููุฏ ุจูุงูุงุช**
- Schema errors ุชูุญูุธ ูู DLQ (ูุงุจูุฉ ููุงุณุชุนุงุฏุฉ)
- Delta operations ุชูุถุงู ููู Outbox ุญุชู ุนูุฏ ุงููุดู ุงููุญูู

โ **ุจุฏูู retrys ูุง ููุงุฆูุฉ**
- Network/timeout errors โ retry ูุญุฏูุฏ
- Schema errors โ DLQ (ูุง retry)
- ุฃุฎุทุงุก ุฏุงุฆูุฉ โ ุญุฐู (ุจุนุฏ ุญูุธ ูู localStorage)

---

## ๐ ููุงุญุธุงุช

1. **Schema Errors**: ูุงุจูุฉ ููุงุณุชุนุงุฏุฉ ุจุนุฏ ุชุญุฏูุซ ุงูุชุทุจูู
   - ุชูุญูุธ ูู Dead Letter Queue
   - ูููู ุงุณุชุนุงุฏุชูุง ุจุนุฏ ุฅุตูุงุญ ุงููุดููุฉ

2. **Network Errors**: ุชูุนุงุฏ ุงููุญุงููุฉ ุชููุงุฆูุงู
   - Exponential backoff ูุน jitter
   - ุญุฏ ุฃูุตู ูููุญุงููุงุช: 5

3. **Delta Operations**: ูุญุงููุฉ ุฅุฑุณุงู ุญุชู ุนูุฏ ูุดู ุงูุชุญุฏูุซ ุงููุญูู
   - ูุฏ ูููู ุงูุณูุฑูุฑ ูุงุฏุฑุงู ุนูู ูุนุงูุฌุฉ ุงูุชุญุฏูุซ
   - Log ูุงุถุญ ููุชุญูู ูู ุงููุดููุฉ

---

**ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ**: 2025-01-XX
**ุงูุญุงูุฉ**: โ ููุชูู






























