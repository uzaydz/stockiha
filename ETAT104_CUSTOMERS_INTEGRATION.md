# 🔗 التكامل بين نظام العملاء وكشف 104

## 📋 **نظرة عامة:**

تم إضافة تكامل كامل بين **نظام العملاء** و **نظام كشف 104** لتسهيل إعداد الكشف الضريبي السنوي.

---

## ✅ **ما تم إنجازه:**

### **1. تحديث نوع العميل (Customer Type)**
📄 `src/types/customer.ts`

**الحقول الجديدة (اختيارية):**
- ✅ `nif` - رقم التعريف الجبائي (15 رقم)
- ✅ `rc` - رقم السجل التجاري
- ✅ `nis` - رقم التعريف الإحصائي
- ✅ `rib` - الهوية البنكية
- ✅ `address` - العنوان الكامل

### **2. تحديث نموذج إضافة العملاء**
📄 `src/components/customers/AddCustomerDialog.tsx`

**الميزات الجديدة:**
- ✅ قسم "معلومات ضريبية (اختياري)"
- ✅ حقول NIF, RC, NIS, RIB, Address
- ✅ التحقق من صحة NIF (15 رقم)
- ✅ التحقق من صحة RC (أرقام فقط)
- ✅ واجهة سهلة ومنظمة

### **3. تحديث قاعدة البيانات**
📄 `database/migrations/add_tax_fields_to_customers.sql`

**التغييرات:**
- ✅ إضافة 5 أعمدة جديدة لجدول `customers`
- ✅ فهارس على NIF و RC للبحث السريع
- ✅ تعليقات توضيحية على الأعمدة

### **4. دوال التكامل**
📄 `src/services/etat104Service.ts`

**الدوال الجديدة:**
- ✅ `importCustomersToEtat104` - استيراد العملاء تلقائياً
- ✅ `findCustomerByTaxInfo` - البحث عن عميل حسب NIF/RC

---

## 🚀 **كيفية الاستخدام:**

### **الخطوة 1: تحديث قاعدة البيانات**
```bash
# في Supabase SQL Editor
# شغّل الملف: database/migrations/add_tax_fields_to_customers.sql
```

### **الخطوة 2: إضافة عملاء بمعلومات ضريبية**

عند إضافة عميل جديد:
1. املأ الحقول الأساسية (الاسم، البريد، الهاتف)
2. **اختياري:** املأ المعلومات الضريبية:
   - NIF (15 رقم)
   - RC (أرقام فقط)
   - NIS
   - RIB
   - العنوان

### **الخطوة 3: استيراد العملاء إلى كشف 104**

```typescript
import { importCustomersToEtat104 } from '@/services/etat104Service';

// استيراد تلقائي
const result = await importCustomersToEtat104(
  declarationId,    // معرف الكشف
  organizationId,   // معرف المؤسسة
  2024              // السنة المالية
);

console.log(`تم استيراد ${result.imported} عميل`);
console.log(`تم تخطي ${result.skipped} عميل`);
console.log(`أخطاء: ${result.errors.length}`);
```

---

## 📊 **آلية الاستيراد التلقائي:**

### **ما يحدث عند الاستيراد:**

1. **جلب العملاء:**
   - يتم جلب جميع العملاء الذين لديهم NIF و RC
   - العملاء بدون معلومات ضريبية يتم تخطيهم

2. **حساب المبيعات:**
   - يتم جلب جميع طلبات العميل في السنة المحددة
   - حساب إجمالي المبيعات (HT + TVA)
   - العملاء بدون مبيعات يتم تخطيهم

3. **إضافة إلى الكشف:**
   - يتم إنشاء سجل في `etat104_clients`
   - حالة التحقق: `pending`
   - يمكن التحقق من NIF/RC لاحقاً

---

## 🎯 **حالات الاستخدام:**

### **1. إضافة عميل جديد بمعلومات ضريبية:**
```typescript
// في نموذج إضافة العميل
{
  name: "شركة مثال",
  email: "example@company.dz",
  phone: "0555123456",
  nif: "123456789012345",  // 15 رقم
  rc: "12345678",          // رقم السجل التجاري
  nis: "001",              // اختياري
  rib: "00123456789012345678901234",  // اختياري
  address: "الجزائر العاصمة"  // اختياري
}
```

### **2. استيراد تلقائي للكشف:**
```typescript
// في صفحة كشف 104
const handleImport = async () => {
  const result = await importCustomersToEtat104(
    declarationId,
    organizationId,
    2024
  );
  
  if (result.imported > 0) {
    toast.success(`تم استيراد ${result.imported} عميل بنجاح`);
  }
  
  if (result.errors.length > 0) {
    console.error('أخطاء الاستيراد:', result.errors);
  }
};
```

### **3. البحث عن عميل:**
```typescript
import { findCustomerByTaxInfo } from '@/services/etat104Service';

// البحث بـ NIF
const customer = await findCustomerByTaxInfo(
  organizationId,
  "123456789012345"  // NIF
);

// أو البحث بـ RC
const customer2 = await findCustomerByTaxInfo(
  organizationId,
  undefined,
  "12345678"  // RC
);
```

---

## 📝 **المتطلبات:**

### **للاستيراد التلقائي:**
- ✅ العميل يجب أن يكون لديه **NIF** و **RC**
- ✅ العميل يجب أن يكون لديه مبيعات في السنة المحددة
- ✅ المبيعات يجب أن تكون مسجلة في `pos_orders`

### **للتحقق:**
- ✅ NIF: 15 رقم بالضبط
- ✅ RC: أرقام فقط
- ✅ NIS: اختياري
- ✅ RIB: اختياري
- ✅ Address: اختياري

---

## 🔄 **سير العمل الكامل:**

```
1. إضافة عملاء مع معلومات ضريبية
   ↓
2. تسجيل المبيعات على مدار السنة
   ↓
3. في نهاية السنة: إنشاء كشف 104
   ↓
4. استيراد العملاء تلقائياً
   ↓
5. مراجعة البيانات والتحقق
   ↓
6. تصدير الكشف وتقديمه للـ DGI
```

---

## 🎨 **الواجهة المحدثة:**

### **نموذج إضافة العميل:**

```
┌─────────────────────────────────────┐
│ إضافة عميل جديد                     │
├─────────────────────────────────────┤
│ الاسم *                              │
│ [________________]                   │
│                                      │
│ البريد الإلكتروني *                 │
│ [________________]                   │
│                                      │
│ رقم الهاتف                          │
│ [________________]                   │
│                                      │
│ ─────────────────────────────────── │
│ معلومات ضريبية (اختياري)            │
│                                      │
│ رقم التعريف الجبائي (NIF)           │
│ [_______________] (15 رقم)          │
│                                      │
│ رقم السجل التجاري (RC)              │
│ [_______________]                    │
│                                      │
│ رقم التعريف الإحصائي (NIS)          │
│ [_______________]                    │
│                                      │
│ الهوية البنكية (RIB)                │
│ [_______________]                    │
│                                      │
│ العنوان الكامل                      │
│ [_______________]                    │
│                                      │
│ [إلغاء]  [حفظ العميل]              │
└─────────────────────────────────────┘
```

---

## ⚠️ **ملاحظات مهمة:**

### **1. الحقول الاختيارية:**
- جميع الحقول الضريبية **اختيارية**
- لكن للاستيراد التلقائي، **NIF و RC إلزاميان**

### **2. الخصوصية:**
- المعلومات الضريبية حساسة
- يتم تخزينها بشكل آمن في قاعدة البيانات
- RLS مفعّل على جدول customers

### **3. التحقق:**
- التحقق من NIF: 15 رقم فقط
- التحقق من RC: أرقام فقط
- يمكن إضافة تحقق إضافي من API الحكومي

### **4. الأداء:**
- الاستيراد التلقائي قد يستغرق وقتاً للعملاء الكثيرين
- يتم معالجة العملاء واحداً تلو الآخر
- يتم عرض تقدم العملية

---

## 🔧 **التخصيص:**

### **إضافة حقول إضافية:**

إذا أردت إضافة حقول أخرى:

1. **تحديث النوع:**
```typescript
// في customer.ts
export interface Customer {
  // ... الحقول الموجودة
  custom_field?: string;
}
```

2. **تحديث قاعدة البيانات:**
```sql
ALTER TABLE customers
ADD COLUMN custom_field VARCHAR(255);
```

3. **تحديث النموذج:**
```tsx
// في AddCustomerDialog.tsx
<Input
  id="custom_field"
  name="custom_field"
  value={formData.custom_field}
  onChange={handleChange}
/>
```

---

## 📊 **الإحصائيات:**

### **ما تم إضافته:**
- ✅ 5 حقول جديدة في Customer type
- ✅ قسم كامل في نموذج إضافة العملاء
- ✅ 2 دالة تكامل جديدة
- ✅ ملف SQL للتحديث
- ✅ فهارس للبحث السريع
- ✅ التحقق من صحة البيانات

### **الفوائد:**
- 🚀 استيراد تلقائي للعملاء
- 📊 حساب تلقائي للمبيعات
- ✅ تقليل الأخطاء اليدوية
- ⏱️ توفير الوقت
- 🔒 أمان البيانات

---

## ✅ **قائمة التحقق:**

- [ ] تشغيل ملف SQL في Supabase
- [ ] إضافة عملاء بمعلومات ضريبية
- [ ] اختبار الاستيراد التلقائي
- [ ] مراجعة البيانات المستوردة
- [ ] التحقق من NIF و RC
- [ ] تصدير الكشف

---

## 🎉 **النظام جاهز!**

الآن يمكنك:
1. ✅ إضافة عملاء بمعلومات ضريبية كاملة
2. ✅ استيراد العملاء تلقائياً إلى كشف 104
3. ✅ حساب المبيعات تلقائياً
4. ✅ توفير الوقت والجهد

**للمزيد من المعلومات:**
- راجع: `ETAT104_COMPLETE.md`
- راجع: `ETAT104_SETUP.md`
