# نظام التخزين المؤقت لـ Yalidine API

## المشكلة

تفرض واجهة برمجة التطبيقات (API) الخاصة بـ Yalidine حدودًا صارمة على معدل الاستعلامات:

- 5 طلبات في الثانية
- 50 طلبًا في الدقيقة
- 1000 طلب في الساعة
- 10000 طلب في اليوم

عند تجاوز هذه الحدود، قد يتم حظر الوصول إلى API مؤقتًا، مما يؤثر على وظائف الشحن في التطبيق.

## الحل

تم إنشاء نظام تخزين مؤقت يقوم بتخزين البيانات المستلمة من Yalidine API في قاعدة البيانات المحلية، وإدارة الاستعلامات لضمان عدم تجاوز الحدود المسموح بها.

## المكونات الرئيسية

### جداول التخزين المؤقت

1. `yalidine_api_requests` - لتتبع طلبات API وإدارة معدل الاستعلامات
2. `yalidine_wilayas` - لتخزين بيانات الولايات (بيانات شبه ثابتة)
3. `yalidine_communes` - لتخزين بيانات البلديات (بيانات شبه ثابتة)
4. `yalidine_centers` - لتخزين بيانات مراكز التوصيل (بيانات شبه ثابتة)
5. `yalidine_parcels` - لتخزين بيانات الطرود
6. `yalidine_histories` - لتخزين تواريخ حالات الطرود
7. `yalidine_fees` - لتخزين بيانات رسوم الشحن

### وظائف إدارة معدل الاستعلامات

1. `can_request_yalidine_api()` - للتحقق مما إذا كان يمكن إجراء طلب API جديد دون تجاوز الحدود
2. `log_yalidine_api_request()` - لتسجيل طلبات API

### وظائف استرجاع وتحديث البيانات

1. `update_yalidine_wilayas()` - لتحديث بيانات الولايات
2. `get_yalidine_communes()` - لاسترجاع بيانات البلديات من التخزين المؤقت أو من API إذا لزم الأمر
3. `get_yalidine_parcel()` - لاسترجاع بيانات الطرود من التخزين المؤقت أو من API إذا لزم الأمر
4. `get_yalidine_fees()` - لاسترجاع بيانات رسوم الشحن من التخزين المؤقت أو من API إذا لزم الأمر

### وظائف الصيانة والإدارة

1. `setup_yalidine_data_refresh_job()` - لإنشاء وظائف تحديث دورية للبيانات
2. `check_yalidine_cache_status()` - للتحقق من حالة التخزين المؤقت
3. `cleanup_yalidine_cache()` - لتنظيف البيانات القديمة وإدارة الذاكرة التخزينية
4. `get_yalidine_api_usage_stats()` - للحصول على إحصائيات استخدام API

## استراتيجية التحديث

1. **البيانات الثابتة** (الولايات، البلديات، المراكز):
   - تحديث مرة واحدة يوميًا في أوقات منخفضة الاستخدام
   - صلاحية البيانات تصل إلى 7 أيام

2. **بيانات الطرود**:
   - تحديث عند الطلب فقط
   - صلاحية البيانات 60 دقيقة
   - تخزين آخر حالة للطرد وتاريخ التحديث

3. **بيانات الرسوم**:
   - تحديث عند الحاجة لحساب رسوم الشحن
   - صلاحية البيانات 7 أيام

## كيفية التثبيت

1. قم بتشغيل النص البرمجي `yalidine_api_cache_system.sql` على قاعدة البيانات:
   ```bash
   psql -U [username] -d [database] -f yalidine_api_cache_system.sql
   ```

2. قم بتهيئة البيانات الأولية:
   ```sql
   SELECT update_yalidine_wilayas(TRUE);
   ```

3. إعداد وظائف التحديث الدورية (اختياري، يتطلب امتداد pg_cron):
   ```sql
   SELECT setup_yalidine_data_refresh_job();
   ```

## كيفية الاستخدام

### استرجاع بيانات البلديات لولاية معينة

```sql
SELECT * FROM get_yalidine_communes(16); -- استرجاع بلديات ولاية الجزائر
```

### استرجاع بيانات طرد

```sql
SELECT * FROM get_yalidine_parcel('yal-123456');
```

### استرجاع رسوم الشحن

```sql
SELECT * FROM get_yalidine_fees(16, 9); -- من الجزائر إلى البليدة
```

### التحقق من حالة التخزين المؤقت

```sql
SELECT * FROM check_yalidine_cache_status();
```

### تنظيف البيانات القديمة

```sql
SELECT * FROM cleanup_yalidine_cache();
```

## ملاحظات هامة

1. في بيئة الإنتاج، يجب استكمال الوظائف التي تتعامل مع Yalidine API عن طريق إضافة كود HTTP request/response المناسب.

2. يمكن تعديل فترات صلاحية البيانات حسب احتياجات التطبيق.

3. يجب تعديل وتخصيص إعدادات إدارة الذاكرة التخزينية بناءً على حجم البيانات وتردد الاستخدام.

4. النظام مصمم ليكون مرنًا وقابلًا للتوسيع لاستيعاب المزيد من وظائف Yalidine API.

5. وظائف التحديث الدورية تتطلب تثبيت وتمكين امتداد pg_cron.

## الخلاصة

يوفر هذا النظام حلاً متكاملاً لإدارة التعامل مع Yalidine API مع احترام حدود معدل الاستعلامات، وتحسين أداء التطبيق من خلال تقليل الاعتماد على الاتصال بـ API الخارجي. 