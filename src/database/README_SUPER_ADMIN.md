# تثبيت وإعداد المسؤول الرئيسي (Super Admin)

يوفر هذا الدليل خطوات تثبيت وإعداد ميزة المسؤول الرئيسي في النظام.

## المقدمة

المسؤول الرئيسي (Super Admin) هو مستخدم ذو صلاحيات خاصة يمكنه الوصول إلى جميع بيانات وإعدادات النظام عبر جميع المؤسسات. 

## متطلبات التثبيت

- وصول مباشر إلى قاعدة البيانات الخاصة بـ Supabase
- صلاحيات لتنفيذ سكريبتات SQL وإضافة أعمدة وسياسات
- وصول إلى واجهة Supabase لإدارة المستخدمين

## خطوات التثبيت

تم تقسيم عملية التثبيت إلى 3 مراحل لضمان التنفيذ الصحيح والآمن:

### 1. إضافة عمود المسؤول الرئيسي

```bash
psql -U postgres -d your_database_name -f src/database/01_add_super_admin_column.sql
```

يقوم هذا الملف بإضافة عمود `is_super_admin` إلى جدول `users`.

### 2. إنشاء سياسات الوصول للمسؤول الرئيسي

```bash
psql -U postgres -d your_database_name -f src/database/02_add_super_admin_policies.sql
```

يقوم هذا الملف بإنشاء سياسات تتيح للمسؤول الرئيسي الوصول إلى جميع البيانات في الجداول الرئيسية.

### 3. تثبيت وظيفة إنشاء المسؤول الرئيسي

```bash
psql -U postgres -d your_database_name -f src/database/03_create_super_admin_function.sql
```

يقوم هذا الملف بإنشاء وظيفة تساعد في تعيين مستخدم كمسؤول رئيسي.

## إنشاء مستخدم مسؤول رئيسي

لإنشاء مستخدم مسؤول رئيسي، يجب اتباع الخطوات التالية:

1. أولاً، قم بإنشاء مستخدم عادي في نظام المصادقة Supabase Auth
   - استخدم واجهة Supabase أو API لإنشاء المستخدم
   - تأكد من تفعيل حساب المستخدم

2. ثم قم بترقية المستخدم إلى مسؤول رئيسي باستخدام الوظيفة المثبتة:

```sql
SELECT create_super_admin('admin@example.com', 'Super Admin Name');
```

## اختبار الإعداد

بعد إكمال الخطوات السابقة، يمكنك اختبار الإعداد عن طريق:

1. تسجيل الدخول باستخدام حساب المسؤول الرئيسي
2. الانتقال إلى `/super-admin/login`
3. بعد تسجيل الدخول، يجب أن يتم توجيهك إلى لوحة تحكم المسؤول الرئيسي

## حل المشكلات الشائعة

### خطأ: العمود غير موجود

إذا واجهت خطأ: 
```
ERROR: 42703: column users.is_super_admin does not exist
```

الحل:
1. تأكد من تنفيذ الملف الأول `01_add_super_admin_column.sql` بنجاح
2. تحقق من إضافة العمود باستخدام الاستعلام:
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'users' 
AND column_name = 'is_super_admin';
```

### خطأ: لا يمكن إنشاء السياسة

إذا واجهت خطأ في إنشاء السياسات، تأكد من:
1. أن الجداول المشار إليها موجودة
2. أن RLS (Row Level Security) مفعل للجداول

## ملاحظات أمنية

- تأكد من تعيين كلمة مرور قوية لحساب المسؤول الرئيسي
- يفضل استخدام المصادقة الثنائية لحساب المسؤول الرئيسي
- قيد وصول المسؤول الرئيسي إلى عناوين IP معينة إن أمكن
- قم بمراقبة وتسجيل جميع أنشطة المسؤول الرئيسي 