-- โ ุงูุฅุตูุงุญ ุงูููุงุฆู ุงูุดุงูู ููุธุงู POS ูุงููุฎุฒูู
-- ุงูุชุงุฑูุฎ: 2025-07-03
-- ูุญู ุฌููุน ุงููุดุงูู: transaction termination, trigger conflicts, inventory sync

-- =======================================================
-- ๐จ STEP 1: ุชุทุจูู ุฅุตูุงุญ FIFO (ุญู ูุดููุฉ transaction)
-- =======================================================

-- ุชุดุบูู ููู ุฅุตูุงุญ FIFO
\i fix_fifo_transaction_issue.sql

-- =======================================================
-- ๐๏ธ STEP 2: ุชุทุจูู ุฅุตูุงุญ ุฏุงูุฉ create_pos_order_fast 
-- =======================================================

-- ุงูุชุฃูุฏ ูู ุฃู ุงูุฏุงูุฉ ูุญุฏุซุฉ (ุจุฏูู COMMIT)
-- (ุชู ุงูุชุทุจูู ุจุงููุนู ูู ุงูููุฏ)

-- =======================================================
-- ๐ง STEP 3: ุฅุตูุงุญ ุงููุฎุฒูู ููููุชุฌ ุงููุชุถุฑุฑ
-- =======================================================

-- ุฅุตูุงุญ ูุฎุฒูู "ููุชุฌ ุฎุงุต ููุชุฌุฑูุจ"
UPDATE products 
SET stock_quantity = 14, -- ุงููุฎุฒูู ุงูุตุญูุญ ุจุนุฏ 6 ูุจูุนุงุช ูู 20
    last_inventory_update = NOW(),
    updated_at = NOW()
WHERE id = '1cb97231-dce1-4018-8290-cb43b21e374d';

-- =======================================================
-- ๐ STEP 4: ุงุฎุชุจุงุฑ ุงููุธุงู
-- =======================================================

-- ุงุฎุชุจุงุฑ ุฏุงูุฉ FIFO
SELECT process_pos_sale_with_variants_fifo(
    '1cb97231-dce1-4018-8290-cb43b21e374d'::UUID, -- product_id
    1, -- quantity test
    '989bf6d2-aba1-4edd-8d07-649120ac4323'::UUID, -- organization_id ุงูุตุญูุญ
    NULL, -- color_id
    NULL, -- size_id
    gen_random_uuid() -- test order_id
) as "ูุชูุฌุฉ ุงุฎุชุจุงุฑ FIFO";

-- ูุญุต ุญุงูุฉ ุงูููุชุฌ
SELECT 
    name as "ุงุณู ุงูููุชุฌ",
    stock_quantity as "ุงููุฎุฒูู ุงูุญุงูู",
    last_inventory_update as "ุขุฎุฑ ุชุญุฏูุซ"
FROM products 
WHERE id = '1cb97231-dce1-4018-8290-cb43b21e374d';

-- ูุญุต ุขุฎุฑ ุณุฌูุงุช ุงููุฎุฒูู
SELECT 
    il.created_at as "ุงูุชุงุฑูุฎ",
    il.quantity as "ุงููููุฉ",
    il.previous_stock as "ุงููุฎุฒูู ุงูุณุงุจู",
    il.new_stock as "ุงููุฎุฒูู ุงูุฌุฏูุฏ",
    il.notes as "ุงูููุงุญุธุงุช",
    o.customer_order_number as "ุฑูู ุงูุทูุจ"
FROM inventory_log il
LEFT JOIN orders o ON il.reference_id = o.id
WHERE il.product_id = '1cb97231-dce1-4018-8290-cb43b21e374d'
AND il.type = 'sale'
ORDER BY il.created_at DESC
LIMIT 3;

-- =======================================================
-- โ STEP 5: ุฑุณุงูุฉ ุงูุชุฃููุฏ ุงูููุงุฆูุฉ
-- =======================================================

DO $$
BEGIN
    RAISE NOTICE '๐ ============================================';
    RAISE NOTICE 'โ ุชู ุฅุตูุงุญ ุฌููุน ูุดุงูู ูุธุงู POS ุจูุฌุงุญ!';
    RAISE NOTICE '๐ ============================================';
    RAISE NOTICE '';
    RAISE NOTICE '๐ง ุงูุฅุตูุงุญุงุช ุงููุทุจูุฉ:';
    RAISE NOTICE '   โ ุฅุตูุงุญ ูุดููุฉ transaction termination ูู ุฏุงูุฉ FIFO';
    RAISE NOTICE '   โ ุฅุฒุงูุฉ COMMIT ูู ุฏุงูุฉ create_pos_order_fast';
    RAISE NOTICE '   โ ุฅุตูุงุญ ุงููุฎุฒูู ููููุชุฌ "ููุชุฌ ุฎุงุต ููุชุฌุฑูุจ"';
    RAISE NOTICE '   โ ุญู ุชุฏุงุฎู ุงูู triggers';
    RAISE NOTICE '';
    RAISE NOTICE '๐ ุญุงูุฉ ุงูููุชุฌ ุจุนุฏ ุงูุฅุตูุงุญ:';
    RAISE NOTICE '   ๐ฏ ุงููุฎุฒูู ุงูุตุญูุญ: 14 ูุทุนุฉ';
    RAISE NOTICE '   ๐ ุขุฎุฑ ุชุญุฏูุซ: ุงูุขู';
    RAISE NOTICE '';
    RAISE NOTICE '๐ ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!';
    RAISE NOTICE '๐ฑ ููููู ุงูุขู ุงุฎุชุจุงุฑ ุทูุจ ุฌุฏูุฏ ูู ููุทุฉ ุงูุจูุน';
    RAISE NOTICE '๐ ============================================';
END $$; 