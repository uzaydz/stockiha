# تحديث جدول طلبات تحميل الألعاب

## الهدف من التحديث
تمكين حذف الألعاب من الكتالوج دون حذف الطلبات المرتبطة بها، مع الاحتفاظ بمعلومات اللعبة في الطلبات.

## التغييرات المُطبّقة

### 1. تعديل القيد الأجنبي
- **قبل**: `ON DELETE RESTRICT` - يمنع حذف اللعبة إذا كانت هناك طلبات مرتبطة
- **بعد**: `ON DELETE SET NULL` - يسمح بحذف اللعبة ويجعل `game_id` في الطلبات `NULL`

### 2. إضافة حقول جديدة
- `game_name`: اسم اللعبة وقت الطلب
- `game_platform`: منصة اللعبة وقت الطلب  
- `game_price`: سعر اللعبة وقت الطلب

### 3. Trigger تلقائي
- يملأ معلومات اللعبة تلقائياً عند إنشاء طلب جديد
- يحفظ البيانات حتى لو حُذفت اللعبة لاحقاً

## كيفية التطبيق

### الطريقة الأولى: Supabase Dashboard
1. افتح Supabase Dashboard
2. اذهب إلى SQL Editor
3. انسخ محتوى `update_game_orders_foreign_key.sql`
4. نفذ الاستعلام

### الطريقة الثانية: CLI
```bash
supabase db push
```

## التحقق من نجاح التطبيق

### 1. فحص الجدول
```sql
\d game_download_orders
```

### 2. فحص القيود
```sql
SELECT conname, confdeltype 
FROM pg_constraint 
WHERE conrelid = 'game_download_orders'::regclass 
AND conname LIKE '%game_id%';
```

### 3. اختبار الحذف
- جرب حذف لعبة لها طلبات
- تأكد من عدم حذف الطلبات
- تأكد من وجود معلومات اللعبة في الطلبات

## المزايا الجديدة

✅ **حذف آمن**: يمكن حذف الألعاب دون قلق من فقدان الطلبات

✅ **حفظ السجلات**: الاحتفاظ بمعلومات اللعبة في الطلبات

✅ **تحديث تلقائي**: معلومات اللعبة تُحفظ تلقائياً عند إنشاء الطلبات

✅ **بحث محسّن**: يمكن البحث في الطلبات حتى للألعاب المحذوفة

## ملاحظات مهمة

⚠️ **نسخ احتياطي**: تأكد من أخذ نسخة احتياطية قبل التطبيق

⚠️ **بيانات موجودة**: سيتم تحديث الطلبات الموجودة بمعلومات الألعاب الحالية

⚠️ **اختبار**: جرب التحديث في بيئة تطوير أولاً 