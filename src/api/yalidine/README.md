# مزامنة رسوم شحن ياليدين (Yalidine)

## المشكلة

كانت هناك مشكلة في مزامنة رسوم شحن ياليدين حيث:
- يتم جلب الرسوم من API ياليدين بنجاح
- يتم إدخال البيانات في قاعدة البيانات 
- يتم حذف البيانات تلقائياً بسبب قيد CASCADE على حقل organization_id
- نتيجة لذلك، يظهر 0 سجل في الجدول رغم إتمام المزامنة بنجاح

## الحلول المتاحة

### 1. الإصلاح السريع

ملف `migrations/quick_fix_yalidine_fees.sql` يحتوي على إصلاح سريع يقوم بـ:
- تغيير قيد المفتاح الأجنبي organization_id من CASCADE إلى RESTRICT
- إضافة الأعمدة المفقودة (is_home_available و is_stop_desk_available)
- إنشاء trigger لمزامنة أسماء الحقول المختلفة (express_home/home_fee و express_desk/stop_desk_fee)
- تحسين أداء الجدول بإضافة مؤشرات وقيود مناسبة

### 2. الإصلاح الشامل

ملف `migrations/yalidine_fees_final_fix.sql` يقدم حلاً أكثر شمولاً عن طريق:
- إنشاء جدول جديد بتصميم أفضل وقيود أكثر أماناً
- تحويل البيانات القائمة إلى الجدول الجديد
- إعادة توجيه كل العمليات من الجدول القديم إلى الجديد
- توفير آلية للتحقق من صحة البيانات قبل التبديل النهائي للجداول

## كيفية تطبيق الإصلاح

1. نفّذ الإصلاح السريع من خلال ملف `migrations/quick_fix_yalidine_fees.sql`
2. قم بمزامنة البيانات
3. استخدم الدالة `check_yalidine_fees()` للتحقق من صحة البيانات:
   ```sql
   SELECT * FROM check_yalidine_fees();
   ```
4. إذا كنت ترغب في تطبيق الإصلاح الشامل، اتبع التعليمات في ملف `src/api/yalidine/FIX_INSTRUCTIONS.md`

## بعد الإصلاح

بعد تطبيق الإصلاح، يجب أن تظهر بيانات الرسوم في قاعدة البيانات، ويجب أن تتوقف عملية الحذف التلقائي للسجلات.

---

إذا واجهت أي مشاكل أخرى، يرجى مراجعة سجلات التطبيق وحالة قاعدة البيانات للحصول على مزيد من المعلومات. 