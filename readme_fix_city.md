# حل مشكلة "null value in column 'city' of relation 'addresses' violates not-null constraint"

هذا المستند يشرح كيفية حل مشكلة قيود عدم القبول بقيم فارغة (not-null constraint) في حقل المدينة (city) عند إرسال نماذج صفحات الهبوط.

## المشكلة

عند محاولة إرسال نموذج من صفحة الهبوط، يظهر الخطأ التالي:
```
فشل الإدراج المباشر: null value in column "city" of relation "addresses" violates not-null constraint
```

السبب:
- جدول `addresses` يتطلب قيمة غير فارغة لحقل `city`
- الدالة `convert_landing_page_submission_to_order` تحاول إنشاء عنوان شحن بدون تحديد قيمة للمدينة
- البيانات المرسلة من النموذج قد لا تحتوي على حقل للمدينة

## الحل

هناك جزئين للحل:

### 1. تعديل دالة قاعدة البيانات

يجب تعديل الدالة `convert_landing_page_submission_to_order` للتأكد من أنها تستخدم قيمة للمدينة دائمًا، حتى إذا لم تكن موجودة في بيانات النموذج. الملف `fix_city_field.sql` يحتوي على هذا التعديل.

التغييرات الرئيسية:
- إضافة متغير جديد `v_customer_city` لتخزين قيمة المدينة
- استخدام وظيفة `COALESCE` للبحث عن قيمة في: `city` ثم `municipality` ثم `province` وأخيراً القيمة الافتراضية "غير محدد"
- إضافة حقل `city` بشكل صريح في استعلام الإدراج لجدول `addresses`

### 2. تحديث البيانات الموجودة

يتضمن الملف أيضًا استعلام لتحديث جميع سجلات `landing_page_submissions` الحالية بإضافة قيمة للمدينة إذا كانت فارغة.

## التطبيق

لتطبيق هذا الإصلاح:

1. تسجيل الدخول إلى Supabase Studio (أو أي واجهة لقاعدة البيانات)
2. فتح أداة SQL Editor
3. نسخ ولصق محتوى الملف `fix_city_field.sql`
4. تنفيذ الاستعلام

### التعديلات في الواجهة الأمامية

تم أيضًا إجراء التعديلات التالية في واجهة المستخدم (`LandingPageView.tsx`):

1. في دالة `handleSubmit`: تأكد من وجود قيمة للمدينة قبل إرسال البيانات
2. في دالة `tryDirectInsert`: تحقق وأضف قيمة افتراضية للمدينة إذا لم تكن موجودة
3. في دالة `tryFunctionInsert`: تأكد من وجود قيمة للمدينة قبل استدعاء وظيفة قاعدة البيانات

بعد تطبيق جميع هذه التعديلات، سيتم حل مشكلة خطأ القيود على حقل المدينة. 