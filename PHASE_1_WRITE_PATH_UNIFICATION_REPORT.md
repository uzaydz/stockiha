# ุชูุฑูุฑ ุงููุฑุญูุฉ 1: ุชุฃููุฏ ุงููุณุงุฑ ุงูููุญุฏ ูููุชุงุจุฉ Local-First

## ๐ ุงููุฏู
ุงูุชุฃูุฏ ูู ุฃู ูู ุงููุชุงุจุงุช ุงูุชู ุชุฑูุฏ ูุฒุงููุชูุง ุชูุฑ ุนุจุฑ:
**DeltaWriteService โ sqliteWriteQueue โ sync_outbox**

---

## โ ุงููุชุงุฆุฌ

### 1.1 ุงูุจุญุซ ุนู ุงููุชุงุจุงุช ุงููุจุงุดุฑุฉ ุฅูู Supabase

**ุงููุชูุฌุฉ:** โ **ูุง ุชูุฌุฏ ูุชุงุจุงุช ูุจุงุดุฑุฉ ุฅูู Supabase ูุฌุฏุงูู ูุชุฒุงููุฉ ูู ุงูููุฏ ุงูุญุงูู**

- ุชู ูุญุต ุฌููุน ุงููููุงุช ูู `src/` ุจุงุณุชุฎุฏุงู regex pattern:
  ```regex
  supabase\.from\(['"](orders|customers|receipts|expenses|suppliers|invoices|customer_debts)['"]\)\.(insert|upsert|update|delete)
  ```
- ุฌููุน ุงูุงุณุชุฎุฏุงูุงุช ุงูููุฌูุฏุฉ ูู ูููุงุช `backups/` (ูุณุฎ ุงุญุชูุงุทูุฉ ูุฏููุฉ)
- ุงูููุฏ ุงูุญุงูู ูุณุชุฎุฏู `DeltaWriteService` ุฃู `localPosOrderService` ุจุดูู ุตุญูุญ

**ููุงุญุธุฉ:** ููู `src/context/shop/orderService.ts` ูุญุชูู ุนูู ุงุณุชุฎุฏุงูุงุช ูู Supabase ููููุง:
- ููุทูุจูุงุช ุนุจุฑ ุงูุฅูุชุฑูุช (`isOnline: true`) - ูุง ุชุญุชุงุฌ ูุฒุงููุฉ ูุญููุฉ
- ูููุฑุงุกุฉ ููุท (SELECT) - ูุง ุชุญุชุงุฌ ุชูุฑูุฑ ุนุจุฑ DeltaWriteService
- ููุฎุฏูุงุช ูุงูุฌุฏุงูู ุบูุฑ ุงููุชุฒุงููุฉ

---

### 1.2 ุฅุตูุงุญ ุงูุงุณุชุฎุฏุงูุงุช ุงููุจุงุดุฑุฉ ูู sqliteDB

ุชู ุฅุตูุงุญ **3 ูููุงุช** ูุงูุช ุชุณุชุฎุฏู `sqliteDB.execute` ุฃู `sqliteDB.upsert` ูุจุงุดุฑุฉ:

#### โ ุงูููู 1: `src/lib/db/inventoryDB.ts`

**ุงููุดููุฉ:**
- ุงุณุชุฎุฏุงู `sqliteDB.upsert()` ูุจุงุดุฑุฉ ูู 4 ุฃูุงูู
- ุงุณุชุฎุฏุงู `sqliteDB.execute()` ูุจุงุดุฑุฉ ูู ููุงููู

**ุงูุญู:**
- ุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุงุณุชุฎุฏุงูุงุช ุจู `sqliteWriteQueue.write()`
- ุฅุถุงูุฉ `setOrganizationId()` ูุจู ุงููุชุงุจุฉ
- ุงูุญูุงุธ ุนูู ููุณ ุงููุธุงุฆู ูุน ุถูุงู ุงููุฑูุฑ ุนุจุฑ Queue

**ุงูุชุบููุฑุงุช:**
```typescript
// ูุจู
await sqliteDB.upsert('inventory', {...});

// ุจุนุฏ
await sqliteWriteQueue.write(
  `INSERT OR REPLACE INTO inventory (...) VALUES (?, ?, ?, ?, ?, ?)`,
  [...]
);
```

**ุงูููุงูุน ุงููุนุฏูุฉ:**
1. `updateProductStock()` - ุญูุธ ุงููุฎุฒูู
2. `updateProductStock()` - ุญูุธ ุงููุนุงููุฉ
3. `syncInventoryData()` - ุชุญุฏูุซ ุญุงูุฉ ุงููุฒุงููุฉ
4. `syncInventoryData()` - ุญูุธ ุงููุฎุฒูู ุจุนุฏ ุงููุฒุงููุฉ
5. `loadInventoryDataFromServer()` - ุญุฐู ูุญูุธ ุงูุจูุงูุงุช ูู ุงูุณูุฑูุฑ

---

#### โ ุงูููู 2: `src/api/syncCustomerDebts.ts`

**ุงููุดููุฉ:**
- ุงุณุชุฎุฏุงู `sqliteDB.upsert()` ูุจุงุดุฑุฉ ูู `fetchCustomerDebtsFromServer()`
- ุงุณุชุฎุฏุงู ุดุฑุท `if (isSQLiteAvailable())` ููุงุฎุชูุงุฑ ุจูู SQLite ู Delta Sync

**ุงูุญู:**
- ุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุงุณุชุฎุฏุงูุงุช ุจู `deltaWriteService.saveFromServer()`
- ุฅุฒุงูุฉ ุงูุดุฑุท - ุงุณุชุฎุฏุงู Delta Sync ุฏุงุฆูุงู
- ุชูุญูุฏ ุงููุณุงุฑ ูููุชุงุจุฉ

**ุงูุชุบููุฑุงุช:**
```typescript
// ูุจู
if (isSQLiteAvailable()) {
  await sqliteDB.upsert('customers', {...});
  await sqliteDB.upsert('customer_debts', {...});
} else {
  await deltaWriteService.saveFromServer(...);
}

// ุจุนุฏ
await deltaWriteService.saveFromServer('customers' as any, {...});
await deltaWriteService.saveFromServer('customer_debts' as any, {...});
```

---

#### โ ุงูููู 3: `src/services/assistant/UnifiedMutationService.ts`

**ุงููุดููุฉ:**
- ุงุณุชุฎุฏุงู `sqliteDB.upsert()` ูุจุงุดุฑุฉ ูู `createCustomerDebt()`
- ุงุณุชุฎุฏุงู ุดุฑุท `if (isSQLiteAvailable())` ููุงุฎุชูุงุฑ ุจูู SQLite ู Delta Sync

**ุงูุญู:**
- ุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุงุณุชุฎุฏุงูุงุช ุจู `deltaWriteService.create()`
- ุฅุฒุงูุฉ ุงูุดุฑุท - ุงุณุชุฎุฏุงู Delta Sync ุฏุงุฆูุงู
- ุชูุญูุฏ ุงููุณุงุฑ ูููุชุงุจุฉ

**ุงูุชุบููุฑุงุช:**
```typescript
// ูุจู
if (isSQLiteAvailable()) {
  const result = await sqliteDB.upsert('customer_debts', {...});
} else {
  await deltaWriteService.create(...);
}

// ุจุนุฏ
const result = await deltaWriteService.create('customer_debts' as any, {...}, organizationId);
```

---

### 1.3 ุงูุชุญูู ูู ุงูุฎุฏูุงุช ุงููุญููุฉ

**ุงููุชูุฌุฉ:** โ **ุฌููุน ุงูุฎุฏูุงุช ุงููุญููุฉ ุชุณุชุฎุฏู DeltaWriteService ุจุดูู ุตุญูุญ**

#### โ `localPosOrderService.ts`
- ูุณุชุฎุฏู `deltaWriteService.createOrderWithItems()` ูู `createLocalPOSOrder()`
- ูุณุชุฎุฏู `deltaWriteService.getAll()` ูู `getPendingPOSOrders()`
- ูุณุชุฎุฏู `deltaWriteService.update()` ูู `markLocalPOSOrderAsSyncing()`
- โ **ุงููุณุงุฑ ุตุญูุญ**

#### โ `localCustomerDebtService.ts`
- ูุณุชุฎุฏู `deltaWriteService.create()` ูู `createLocalCustomerDebt()`
- ูุณุชุฎุฏู `deltaWriteService.update()` ูู `updateLocalCustomerDebt()`
- โ **ุงููุณุงุฑ ุตุญูุญ**

#### โ `localExpenseService.ts`
- ูุณุชุฎุฏู `deltaWriteService.create()` ูู `createLocalExpense()`
- ูุณุชุฎุฏู `deltaWriteService.update()` ูู `updateLocalExpense()`
- โ **ุงููุณุงุฑ ุตุญูุญ**

#### โ ุงูุฎุฏูุงุช ุงูุฃุฎุฑู
ุชู ูุญุต **27 ููู** ูู `src/api/` ููููุง ุชุณุชุฎุฏู `deltaWriteService` ุจุดูู ุตุญูุญ:
- `localProductService.ts`
- `localCustomerService.ts`
- `localInvoiceService.ts`
- `localSupplierService.ts`
- `localRepairService.ts`
- `localLossDeclarationService.ts`
- `localProductReturnService.ts`
- ูุบูุฑูุง...

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

| ุงููุฆุฉ | ุงูุนุฏุฏ | ุงูุญุงูุฉ |
|------|------|--------|
| **ุงููุชุงุจุงุช ุงููุจุงุดุฑุฉ ุฅูู Supabase** | 0 | โ ูุง ุชูุฌุฏ |
| **ุงูุงุณุชุฎุฏุงูุงุช ุงููุจุงุดุฑุฉ ูู sqliteDB** | 3 ูููุงุช | โ ุชู ุฅุตูุงุญูุง |
| **ุงูุฎุฏูุงุช ุงููุญููุฉ** | 27+ ููู | โ ุฌููุนูุง ุชุณุชุฎุฏู DeltaWriteService |
| **ุงูุฃุฎุทุงุก ุจุนุฏ ุงูุฅุตูุงุญ** | 0 | โ ูุง ุชูุฌุฏ |

---

## ๐ ุงูุชูุงุตูู ุงูุชูููุฉ

### ุงููุณุงุฑ ุงูููุญุฏ ูููุชุงุจุฉ

```
โโโโโโโโโโโโโโโโโโโ
โ  Application    โ
โ     Code        โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ DeltaWriteServiceโ โโโโ โ ุฌููุน ุงููุชุงุจุงุช ุชูุฑ ูู ููุง
โ  - create()     โ
โ  - update()     โ
โ  - delete()     โ
โ  - saveFromServer()โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ sqliteWriteQueueโ โโโโ โ ุฌููุน ุงููุชุงุจุงุช ูู SQLite ุชูุฑ ูู ููุง
โ  - write()      โ
โ  - transaction()โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ   SQLite DB     โ
โโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  OutboxManager  โ โโโโ โ ุฌููุน ุงููุชุงุจุงุช ุงููุชุฒุงููุฉ ุชูุถุงู ููุง
โ  - add()        โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโ
โ  sync_outbox    โ
โ     Table       โ
โโโโโโโโโโโโโโโโโโโ
```

---

## โ ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅูุฌุงุฒู:

1. โ **ุชู ุงูุชุฃูุฏ** ูู ุนุฏู ูุฌูุฏ ูุชุงุจุงุช ูุจุงุดุฑุฉ ุฅูู Supabase ูุฌุฏุงูู ูุชุฒุงููุฉ
2. โ **ุชู ุฅุตูุงุญ** ุฌููุน ุงูุงุณุชุฎุฏุงูุงุช ุงููุจุงุดุฑุฉ ูู `sqliteDB` (3 ูููุงุช)
3. โ **ุชู ุงูุชุญูู** ูู ุฃู ุฌููุน ุงูุฎุฏูุงุช ุงููุญููุฉ ุชุณุชุฎุฏู `DeltaWriteService`
4. โ **ุชู ุชูุญูุฏ** ุงููุณุงุฑ ูููุชุงุจุฉ: `DeltaWriteService โ sqliteWriteQueue โ sync_outbox`

### ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

๐ **ุฌููุน ุงููุชุงุจุงุช ุงูุชู ุชุฑูุฏ ูุฒุงููุชูุง ุชูุฑ ุงูุขู ุนุจุฑ ุงููุณุงุฑ ุงูููุญุฏ:**
- โ DeltaWriteService
- โ sqliteWriteQueue  
- โ sync_outbox

### ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงููุฑุญูุฉ 2):

1. ุงูุชุญูู ูู ุฃู ุฌููุน ุงููุฑุงุกุงุช ุชุณุชุฎุฏู ุงููุณุงุฑ ุงูููุญุฏ
2. ุงูุชุฃูุฏ ูู ุฃู ุงููุฒุงููุฉ ุชุนูู ุจุดูู ุตุญูุญ
3. ุงุฎุชุจุงุฑ ุงููุธุงู ูู ุจูุฆุฉ offline/online

---

## ๐ ููุงุญุธุงุช

- ุฌููุน ุงูุชุบููุฑุงุช ูุชูุงููุฉ ูุน ุงูููุฏ ุงูุญุงูู
- ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู ุงูู linter ุจุนุฏ ุงูุฅุตูุงุญุงุช
- ุชู ุงูุญูุงุธ ุนูู ููุณ ุงููุธุงุฆู ูุน ุถูุงู ุงููุฑูุฑ ุนุจุฑ ุงููุณุงุฑ ุงูููุญุฏ
- ุงูููุฏ ุฃุตุจุญ ุฃูุซุฑ ูุงุจููุฉ ููุตูุงูุฉ ูุงูุงุฎุชุจุงุฑ

---

**ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ:** 2025-01-XX  
**ุงูุญุงูุฉ:** โ ููุชูู


















