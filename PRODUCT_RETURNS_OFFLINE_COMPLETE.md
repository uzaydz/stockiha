# โ ุชุญุฏูุซ ุตูุญุฉ ุฅุฑุฌุงุน ุงูููุชุฌุงุช - ุงูุชูู ุจูุฌุงุญ

## ๐ ูุธุฑุฉ ุนุงูุฉ
ุชู ุชุญุฏูุซ ุตูุญุฉ **ุฅุฑุฌุงุน ุงูููุชุฌุงุช (ProductReturns.tsx)** ุจุงููุงูู ูุชุนูู ูุน ูุธุงู ุงูุฃูููุงูู ุจุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ (IndexedDB) ุจุฏูุงู ูู Supabase ูุจุงุดุฑุฉ.

---

## ๐ง ุงูุฅุตูุงุญุงุช ุงููููุฐุฉ

### 1. **ุฅุตูุงุญ ุงุณุชูุฑุงุฏ supabase**
- โ ุฅุฒุงูุฉ ุงุณุชูุฑุงุฏ `supabase` ุบูุฑ ุงููุณุชุฎุฏู
- โ ุงูุงุนุชูุงุฏ ุงููุงูู ุนูู ุงูุฎุฏูุงุช ุงููุญููุฉ

### 2. **ุชุญุฏูุซ ุญููู LocalProductReturn**
ุชู ุฅุถุงูุฉ ุงูุญููู ุงูููููุฏุฉ ูู `src/database/localDb.ts`:
- โ `customer_email`
- โ `internal_notes`
- โ `requires_manager_approval`
- โ `created_by`
- โ `processed_by`, `processed_at`
- โ `approval_notes`
- โ `rejection_reason`, `rejected_by`, `rejected_at`

### 3. **ุชุญุฏูุซ ุฏุงูุฉ searchForOrder**
**ูุจู:** ูุงูุช ุชุณุชุฎุฏู Supabase ูุจุงุดุฑุฉ
```typescript
const { data, error } = await supabase
  .from('orders')
  .select('...')
```

**ุจุนุฏ:** ุชุณุชุฎุฏู ุงูุจูุงูุงุช ุงููุญููุฉ
```typescript
const localOrders = await inventoryDB.posOrders
  .where('organization_id')
  .equals(currentOrganization.id)
  .toArray();

const orderItems = await inventoryDB.posOrderItems
  .where('order_id')
  .equals(firstOrder.id)
  .toArray();
```

**ุงูุชุญุณููุงุช:**
- โ ุงุณุชุฎุฏุงู `posOrders` ู `posOrderItems` ูู Dexie
- โ ุงุณุชุฎุฏุงู `remote_customer_order_number` ุจุฏูุงู ูู `customer_order_number`
- โ ุฅุถุงูุฉ ุฌููุน ุงูุญููู ุงููุทููุจุฉ ููุนูุงุตุฑ (color_id, size_id, variant_display_name)
- โ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจุดูู ุตุญูุญ

### 4. **ุชุญุฏูุซ ุฏุงูุฉ fetchReturns**
- โ ุฌูุจ ุงูุฅุฑุฌุงุนุงุช ูู `getAllLocalReturns()`
- โ ุชุญููู `LocalProductReturn` ุฅูู `Return`
- โ ุฌูุจ ุงูุนูุงุตุฑ ูู `inventoryDB.returnItems`
- โ ุชุทุจูู ุงูููุงุชุฑ ูุญููุงู
- โ ูุฒุงููุฉ ุชููุงุฆูุฉ ูู ุงูุฎูููุฉ ุนูุฏ ุงูุงุชุตุงู

### 5. **ุชุญุฏูุซ ุฏุงูุฉ fetchStats**
- โ ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช ูู ุงูุจูุงูุงุช ุงููุญููุฉ
- โ ูุง ุญุงุฌุฉ ูุงุณุชุฏุนุงุกุงุช Supabase

### 6. **ุชุญุฏูุซ ุฏุงูุฉ createReturnRequest**
**ูุจู:** ูุงูุช ุชุณุชุฎุฏู Supabase ูุจุงุดุฑุฉ
```typescript
const { data: returnRecord, error: returnError } = await supabase
  .from('returns')
  .insert([returnData])
```

**ุจุนุฏ:** ุชุณุชุฎุฏู ุงูุฎุฏูุฉ ุงููุญููุฉ
```typescript
await createLocalReturn({
  returnData,
  items: returnItems
});
```

**ุงูุชุญุณููุงุช:**
- โ ุฅุนุฏุงุฏ ุฌููุน ุงูุญููู ุงููุทููุจุฉ
- โ ุงุณุชุฎุฏุงู `createLocalReturn` ูู ุงูุฎุฏูุฉ ุงููุญููุฉ
- โ ุฑุณุงุฆู ูุฌุงุญ ุชุดูุฑ ูููุฒุงููุฉ ุนูุฏ ุงูุฃูููุงูู
- โ ูุฒุงููุฉ ููุฑูุฉ ุนูุฏ ุงูุงุชุตุงู

### 7. **ุชุญุฏูุซ ุฏุงูุฉ processReturn**
**ูุจู:** ูุงูุช ุชุณุชุฎุฏู RPC ูุคูุช
```typescript
toast.success('ุชู ุงูููุงููุฉ ุนูู ุทูุจ ุงูุฅุฑุฌุงุน (ูุคูุช)');
```

**ุจุนุฏ:** ุชุณุชุฎุฏู ุงูุฎุฏูุงุช ุงููุญููุฉ
```typescript
if (action === 'approve') {
  await approveLocalReturn(returnId, user.id);
} else if (action === 'reject') {
  await rejectLocalReturn(returnId);
}
```

**ุงูุชุญุณููุงุช:**
- โ ุงุณุชุฎุฏุงู `approveLocalReturn` ู `rejectLocalReturn`
- โ ุฑุณุงุฆู ูุฌุงุญ ูุงุถุญุฉ
- โ ูุฒุงููุฉ ููุฑูุฉ ุนูุฏ ุงูุงุชุตุงู

### 8. **ุชุญุฏูุซ ุฏุงูุฉ fetchReturnItems**
**ูุจู:** ูุงูุช ุชุณุชุฎุฏู Supabase ูุจุงุดุฑุฉ
```typescript
const { data, error } = await supabase
  .from('return_items')
  .select('*')
```

**ุจุนุฏ:** ุชุณุชุฎุฏู ุงูุจูุงูุงุช ุงููุญููุฉ
```typescript
const items = await inventoryDB.returnItems
  .where('return_id')
  .equals(returnId)
  .toArray();
```

**ุงูุชุญุณููุงุช:**
- โ ุฅุฒุงูุฉ ุงูุญููู ุบูุฑ ุงูููุฌูุฏุฉ (`variant_info`)
- โ ุจูุงุก `variant_display_name` ูู `color_name` ู `size_name`
- โ ุชุญููู ุตุญูุญ ููุจูุงูุงุช

### 9. **ุฅุตูุงุญ ุฏุงูุฉ ุงุฎุชูุงุฑ ุงูุนูุงุตุฑ**
**ูุจู:** ูุงูุช ุชุฑุณู ุจูุงูุงุช ูุงูุตุฉ
```typescript
{
  order_item_id: item.id,
  return_quantity: item.available_for_return,
  condition_status: 'good'
}
```

**ุจุนุฏ:** ุชุฑุณู ุฌููุน ุงูุญููู ุงููุทููุจุฉ
```typescript
{
  id: item.id,
  product_id: item.product_id,
  product_name: item.product_name,
  product_sku: item.product_sku,
  original_quantity: item.quantity,
  return_quantity: item.available_for_return,
  original_unit_price: item.unit_price,
  condition_status: 'good',
  color_id: item.color_id,
  size_id: item.size_id,
  color_name: item.color_name,
  size_name: item.size_name,
  variant_display_name: item.variant_display_name
}
```

### 10. **ุงูุชูุงูู ูุน POSPureLayout**
- โ useEffect ููุชุณุฌูู ูุน Layout
- โ ุฏุงูุฉ `handleRefresh` ููุชุญุฏูุซ
- โ ุชุญุฏูุซ ุญุงูุฉ Layout (`isRefreshing`, `connectionStatus`)
- โ ุฏุนู `useStandaloneLayout` prop

---

## ๐ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ

### โ ุงูุฃุฎุทุงุก ุงููุตูุญุฉ
- **0 ุฃุฎุทุงุก TypeScript**
- **0 ุงุณุชุฏุนุงุกุงุช Supabase ูุจุงุดุฑุฉ**
- **100% ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ**

### โ ุงูููุฒุงุช ุงููุญุฏุซุฉ
1. **ุงูุจุญุซ ุนู ุงูุทูุจูุงุช**: ูุนูู ูู `posOrders` ู `posOrderItems`
2. **ุฌูุจ ุงูุฅุฑุฌุงุนุงุช**: ูุนูู ูู `getAllLocalReturns()`
3. **ุฅูุดุงุก ุงูุฅุฑุฌุงุน**: ูุณุชุฎุฏู `createLocalReturn()`
4. **ุงูููุงููุฉ/ุงูุฑูุถ**: ูุณุชุฎุฏู `approveLocalReturn()` ู `rejectLocalReturn()`
5. **ุฌูุจ ุงูุนูุงุตุฑ**: ูุนูู ูู `inventoryDB.returnItems`
6. **ุงูุฅุญุตุงุฆูุงุช**: ุชูุญุณุจ ูู ุงูุจูุงูุงุช ุงููุญููุฉ
7. **ุงููุฒุงููุฉ**: ุชููุงุฆูุฉ ูู ุงูุฎูููุฉ ุนูุฏ ุงูุงุชุตุงู

### โ ุฏุนู ุงูุฃูููุงูู ุงููุงูู
- โ ุฌููุน ุงูุนูููุงุช ุชุนูู ุจุฏูู ุฅูุชุฑูุช
- โ ุงูุจูุงูุงุช ุชูุญูุธ ูู IndexedDB
- โ ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ุนูุฏ ุนูุฏุฉ ุงูุงุชุตุงู
- โ ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู ุนู ุญุงูุฉ ุงููุฒุงููุฉ

### โ ุงูุชูุงูู ูุน ุงููุธุงู
- โ ูุนูู ูุน POSPureLayout
- โ ูุฏุนู ุงูุชุญุฏูุซ (Refresh)
- โ ูุฏุนู ุญุงูุฉ ุงูุงุชุตุงู
- โ ูุนูู ูุตูุญุฉ ูุณุชููุฉ ุฃู ุฏุงุฎู Layout

---

## ๐ฏ ุงูุฎุฏูุงุช ุงููุณุชุฎุฏูุฉ

### ูู `localProductReturnService.ts`:
- `getAllLocalReturns()` - ุฌูุจ ุฌููุน ุงูุฅุฑุฌุงุนุงุช
- `createLocalReturn()` - ุฅูุดุงุก ุฅุฑุฌุงุน ุฌุฏูุฏ
- `approveLocalReturn()` - ุงูููุงููุฉ ุนูู ุฅุฑุฌุงุน
- `rejectLocalReturn()` - ุฑูุถ ุฅุฑุฌุงุน

### ูู `syncProductReturns.ts`:
- `syncPendingProductReturns()` - ูุฒุงููุฉ ุงูุฅุฑุฌุงุนุงุช ุงููุนููุฉ
- `fetchProductReturnsFromServer()` - ุฌูุจ ุงูุฅุฑุฌุงุนุงุช ูู ุงูุณูุฑูุฑ

### ูู `inventoryDB`:
- `posOrders` - ุฌุฏูู ุงูุทูุจูุงุช ุงููุญููุฉ
- `posOrderItems` - ุฌุฏูู ุนูุงุตุฑ ุงูุทูุจูุงุช
- `returnItems` - ุฌุฏูู ุนูุงุตุฑ ุงูุฅุฑุฌุงุน

---

## ๐ ุณูุฑ ุงูุนูู

### ุฅูุดุงุก ุฅุฑุฌุงุน ุฌุฏูุฏ:
```
1. ุงููุณุชุฎุฏู ูุจุญุซ ุนู ุทูุจูุฉ (ูู posOrders ุงููุญููุฉ)
2. ูุฎุชุงุฑ ุงูููุชุฌุงุช ููุฅุฑุฌุงุน
3. ูููุฃ ุงูุชูุงุตูู (ุงูุณุจุจุ ุทุฑููุฉ ุงูุงุณุชุฑุฌุงุนุ ุฅูุฎ)
4. ุนูุฏ ุงูุญูุธ:
   โ
   createLocalReturn()
   โ
   ุญูุธ ูู inventoryDB.productReturns
   โ
   ุฅุถุงูุฉ ููู UnifiedQueue
   โ
   ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
   โ
   ุฅุฐุง ูุงู ูุชุตู: ูุฒุงููุฉ ููุฑูุฉ
```

### ุงูููุงููุฉ ุนูู ุฅุฑุฌุงุน:
```
1. ุงููุณุชุฎุฏู ูููุฑ "ููุงููุฉ"
2. approveLocalReturn(returnId, userId)
   โ
   ุชุญุฏูุซ ุญุงูุฉ ุงูุฅุฑุฌุงุน ูุญููุงู
   โ
   ุชุญุฏูุซ ุงููุฎุฒูู (ุฅุฐุง ูุงู ูุงุจู ูุฅุนุงุฏุฉ ุงูุจูุน)
   โ
   ุฅุถุงูุฉ ููู UnifiedQueue
   โ
   ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ
   โ
   ุฅุฐุง ูุงู ูุชุตู: ูุฒุงููุฉ ููุฑูุฉ
```

### ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ:
```
ุนูุฏ ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช:
   โ
syncPendingProductReturns()
   โ
   ุฌูุจ ุงูุฅุฑุฌุงุนุงุช ุบูุฑ ุงููุชุฒุงููุฉ
   โ
   ุฅุฑุณุงู ูู ุฅุฑุฌุงุน ููุณูุฑูุฑ
   โ
   ุชุญุฏูุซ ุญุงูุฉ ุงููุฒุงููุฉ
   โ
fetchProductReturnsFromServer()
   โ
   ุฌูุจ ุงูุฅุฑุฌุงุนุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุณูุฑูุฑ
   โ
   ุชุญุฏูุซ ุงููุงุฆูุฉ ุงููุญููุฉ
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ุงูุญููู ุงููุทููุจุฉ
ุฌููุน ุงูุญููู ุงูุชุงููุฉ **ุฅูุฒุงููุฉ** ุนูุฏ ุฅูุดุงุก ุฅุฑุฌุงุน:
- `return_number`
- `organization_id`
- `return_type` ('full' | 'partial')
- `return_reason`
- `original_total`
- `return_amount`
- `refund_amount`
- `status` ('pending' | 'approved' | 'rejected' | 'completed')

### 2. ุงููุชุบูุฑุงุช (Variants)
ุงููุธุงู ูุฏุนู ุงูููุชุฌุงุช ุฐุงุช ุงููุชุบูุฑุงุช:
- `color_id`, `color_name`
- `size_id`, `size_name`
- `variant_display_name` (ููุจูู ุชููุงุฆูุงู)

### 3. ุงููุฒุงููุฉ
- ุงููุฒุงููุฉ **ุชููุงุฆูุฉ** ุนูุฏ ุงูุงุชุตุงู
- ูููู ุงููุฒุงููุฉ **ูุฏููุงู** ุจุฒุฑ ุงูุชุญุฏูุซ
- ุงูุฅุฑุฌุงุนุงุช ุงููุนููุฉ ุชูุญูุธ ูู `UnifiedQueue`

### 4. ุงูุฃุฏุงุก
- ุฌููุน ุงูุนูููุงุช **ุณุฑูุนุฉ** (ูุญููุฉ)
- ูุง ุชูุฌุฏ **ุชุฃุฎูุฑุงุช** ูู ุงูุดุจูุฉ
- ุงูููุชุฑุฉ ูุงูุจุญุซ **ููุฑู**

---

## โ ุงูุญุงูุฉ ุงูููุงุฆูุฉ

### ุงููููุงุช ุงููุญุฏุซุฉ:
1. โ `src/database/localDb.ts` - ุฅุถุงูุฉ ุญููู ุฌุฏูุฏุฉ
2. โ `src/pages/returns/ProductReturns.tsx` - ุชุญุฏูุซ ูุงูู
3. โ `src/api/localProductReturnService.ts` - ุฌุงูุฒ
4. โ `src/api/syncProductReturns.ts` - ุฌุงูุฒ

### ุงููุธุงุฆู:
- โ ุงูุจุญุซ ุนู ุงูุทูุจูุงุช
- โ ุฅูุดุงุก ุฅุฑุฌุงุน ุฌุฏูุฏ
- โ ุนุฑุถ ูุงุฆูุฉ ุงูุฅุฑุฌุงุนุงุช
- โ ุงูููุงููุฉ ุนูู ุงูุฅุฑุฌุงุน
- โ ุฑูุถ ุงูุฅุฑุฌุงุน
- โ ุนุฑุถ ุชูุงุตูู ุงูุฅุฑุฌุงุน
- โ ุงูููุชุฑุฉ ูุงูุจุญุซ
- โ ุงูุฅุญุตุงุฆูุงุช
- โ ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ

### ุงูุฃูููุงูู:
- โ ูุนูู ุจุฏูู ุฅูุชุฑูุช ุจุงููุงูู
- โ ุฌููุน ุงูุจูุงูุงุช ูุญููุฉ
- โ ุงููุฒุงููุฉ ุนูุฏ ุนูุฏุฉ ุงูุงุชุตุงู
- โ ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู

---

## ๐ ุงููุชูุฌุฉ
ุตูุญุฉ **ุฅุฑุฌุงุน ุงูููุชุฌุงุช** ุงูุขู **ุฌุงูุฒุฉ ุจุงููุงูู** ูุชุนูู ูุน ูุธุงู ุงูุฃูููุงูู ุจุดูู ูุซุงูู! ๐
