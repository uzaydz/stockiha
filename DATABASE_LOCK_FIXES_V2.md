# ๐ง ุฅุตูุงุญุงุช Database Lock v2.0 - ุงูุชุทุจูู ุงููุงูู

**ุงูุชุงุฑูุฎ:** 2025-12-03  
**ุงูุฅุตุฏุงุฑ:** 2.0  
**ุงูุญุงูุฉ:** โ ุชู ุงูุชุทุจูู

---

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

ุชู ุชุทุจูู ุฌููุน ุงูุญููู ุงูููุชุฑุญุฉ ูู ุงูุชุญููู ุงูุดุงูู ููุดููุฉ "Database is Locked". ุงููุฏู: ุชูููู ููุช ุฅูุดุงุก ุทูุจูุฉ POS ูู **90+ ุซุงููุฉ** ุฅูู **3-5 ุซูุงูู**.

---

## โ ุงูุญููู ุงููุทุจูุฉ

### 1. ุชูููู Timeouts ููุนูููุงุช ุงูุณุฑูุนุฉ

**ุงูููู:** `src/lib/sync/core/DatabaseCoordinator.ts`

**ุงูุชุบููุฑุงุช:**
- `LOCK_TIMEOUT_MS`: ูู 120,000ms ุฅูู **5,000ms** (5 ุซูุงูู)
- `POS_OPERATION_TIMEOUT_MS`: **10,000ms** (10 ุซูุงูู) - ุฌุฏูุฏ
- `SYNC_OPERATION_TIMEOUT_MS`: **30,000ms** (30 ุซุงููุฉ) - ุฌุฏูุฏ
- `OPERATION_TIMEOUT_MS`: ูู 90,000ms ุฅูู **30,000ms** (30 ุซุงููุฉ)

**ุงูููุงุฆุฏ:**
- ููุน ุงููุนุงููุงุช ุงูุทูููุฉ ุฌุฏุงู
- ูุดู ุณุฑูุน ููุนูููุงุช ุงูุชู ุชุณุชุบุฑู ููุชุงู ุทูููุงู
- ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู

**ุงูููุฏ:**
```typescript
private readonly LOCK_TIMEOUT_MS = 5000; // 5 ุซูุงูู
private readonly POS_OPERATION_TIMEOUT_MS = 10000; // 10 ุซูุงูู ููู POS
private readonly SYNC_OPERATION_TIMEOUT_MS = 30000; // 30 ุซุงููุฉ ููู Sync
private readonly OPERATION_TIMEOUT_MS = 30000; // 30 ุซุงููุฉ ุงูุชุฑุงุถู
```

---

### 2. ุฅุถุงูุฉ Timeout ูุญุฏุฏ ูู POS Operations

**ุงูููู:** `src/lib/sync/core/DatabaseCoordinator.ts`

**ุงูุชุบููุฑุงุช:**
- ุฅุถุงูุฉ `Promise.race` ูุน timeout ูุญุฏุฏ (10 ุซูุงูู) ูุฌููุน POS operations
- ุฅุฐุง ุชุฌุงูุฒุช ุงูุนูููุฉ 10 ุซูุงููุ ูุชู ุฅูุบุงุคูุง ููุฑุงู

**ุงูููุฏ:**
```typescript
async executePOS<T>(operation: () => Promise<T>, description?: string): Promise<T> {
  // ...
  const timeoutPromise = new Promise<never>((_, reject) => {
    setTimeout(() => {
      reject(new Error(`POS operation timeout after ${this.POS_OPERATION_TIMEOUT_MS}ms`));
    }, this.POS_OPERATION_TIMEOUT_MS);
  });

  const operationPromise = this.executeWithLock(operationId, 'pos', 'critical', operation, description);
  const result = await Promise.race([operationPromise, timeoutPromise]);
  // ...
}
```

---

### 3. ุชุญุณูู Retry Logic

**ุงูููู:** `src/lib/db/tauriSqlClient.ts`

**ุงูุชุบููุฑุงุช:**
- `MAX_RETRIES`: ูู 8 ุฅูู **5** ูุญุงููุงุช
- `RETRY_DELAY_MS`: ูู 500ms ุฅูู **200ms**
- `MAX_RETRY_DELAY_MS`: ูู 8,000ms ุฅูู **3,000ms**

**ุงูููุงุฆุฏ:**
- ุชูููู ููุช ุงูุงูุชุธุงุฑ ุงูุฅุฌูุงูู ูู ~28 ุซุงููุฉ ุฅูู **~6 ุซูุงูู**
- ูุดู ุฃุณุฑุน ููุนูููุงุช ุงูุชู ูุง ูููู ุฅููุงููุง
- ุชุญุณูู ุงูุฃุฏุงุก ุงูุนุงู

**ุงูููุฏ:**
```typescript
const MAX_RETRIES = 5; // ุชูููู ูู 8 ุฅูู 5
const RETRY_DELAY_MS = 200; // ุชูููู ูู 500ms ุฅูู 200ms
const MAX_RETRY_DELAY_MS = 3000; // ุชูููู ูู 8000ms ุฅูู 3000ms

// exponential backoff: 200ms, 400ms, 800ms, 1600ms, 3000ms (max)
// ุฅุฌูุงูู: ~6 ุซูุงูู (ุจุฏูุงู ูู ~28 ุซุงููุฉ)
```

---

### 4. ูุตู Order Creation ุนู Inventory Update

**ุงูููู:** `src/services/DeltaWriteService.ts`

**ุงูุชุบููุฑุงุช:**
- **ุงููุฑุญูุฉ 1:** ุฅูุดุงุก ุงูุทูุจ ูุงูุนูุงุตุฑ ูู ูุนุงููุฉ ูุงุญุฏุฉ (15 ุซุงููุฉ timeout)
- **ุงููุฑุญูุฉ 2:** ุชุญุฏูุซ ุงููุฎุฒูู ุจุดูู ูููุตู (30 ุซุงููุฉ timeout)
- ุงุณุชุฎุฏุงู `Promise.all` ูุฅูุดุงุก ุฌููุน ุงูุนูุงุตุฑ ุจุงูุชูุงุฒู
- ุงุณุชุฎุฏุงู `Promise.all` ูุชุญุฏูุซ ุงููุฎุฒูู ุจุงูุชูุงุฒู

**ุงูููุงุฆุฏ:**
- ุชูููู ููุช ุงููุนุงููุฉ ูู 90+ ุซุงููุฉ ุฅูู **15 ุซุงููุฉ** ููุทูุจ
- ุชุญุฏูุซ ุงููุฎุฒูู ูุง ูููุน ุฅูุดุงุก ุงูุทูุจ
- ุชุญุณูู ุงูุฃุฏุงุก ุจุดูู ูุจูุฑ

**ุงูููุฏ:**
```typescript
// ุงููุฑุญูุฉ 1: ุฅูุดุงุก ุงูุทูุจ ูุงูุนูุงุตุฑ (15 ุซุงููุฉ)
const orderTransactionPromise = sqliteWriteQueue.transaction(async () => {
  // ุฅูุดุงุก ุงูุทูุจ
  await this.create('orders', { ...orderData, id: orderId }, organizationId);
  
  // ุฅูุดุงุก ุฌููุน ุงูุนูุงุตุฑ ุจุงูุชูุงุฒู
  const itemPromises = items.map(async (item) => {
    await this.create('order_items', { ...item, order_id: orderId }, organizationId);
    return { itemId, item };
  });
  
  const createdItems = await Promise.all(itemPromises);
  return createdItems;
});

// ุงููุฑุญูุฉ 2: ุชุญุฏูุซ ุงููุฎุฒูู (30 ุซุงููุฉ - ูููุตู)
const inventoryPromises = createdItems.map(async ({ item }) => {
  // ุชุญุฏูุซ ุงููุฎุฒูู ุญุณุจ ููุน ุงูุจูุน
  await this.updateProductStock(...);
});

await Promise.all(inventoryPromises);
```

---

### 5. ุงุณุชุฎุฏุงู Promise.all ููุนูููุงุช ุงููุชูุงุฒูุฉ

**ุงูููู:** `src/services/DeltaWriteService.ts`

**ุงูุชุบููุฑุงุช:**
- ุชุญููู `for` loop ูุชุณูุณู ุฅูู `Promise.all` ูุชูุงุฒู
- ุฅูุดุงุก ุฌููุน ุงูุนูุงุตุฑ ุจุงูุชูุงุฒู
- ุชุญุฏูุซ ุฌููุน ุงููุฎุฒููุงุช ุจุงูุชูุงุฒู

**ุงูููุงุฆุฏ:**
- ุชูููู ุงูููุช ูู `N ร 11s` ุฅูู `~15s` ูุฌููุน ุงูุนูุงุตุฑ
- ุชุญุณูู ุงูุฃุฏุงุก ุจุดูู ูุจูุฑ

**ูุจู:**
```typescript
for (let i = 0; i < items.length; i++) {
  await this.create('order_items', item); // 11s ููู ุนูุตุฑ
}
// ุฅุฌูุงูู: 11s ร 10 = 110s
```

**ุจุนุฏ:**
```typescript
const itemPromises = items.map(async (item) => {
  await this.create('order_items', item);
});
await Promise.all(itemPromises);
// ุฅุฌูุงูู: ~15s ูุฌููุน ุงูุนูุงุตุฑ
```

---

### 6. Periodic WAL Checkpoint

**ุงูููู:** `src/lib/db/tauriSqlClient.ts`

**ุงูุชุบููุฑุงุช:**
- ุฅุถุงูุฉ periodic checkpoint ูู **30 ุซุงููุฉ** (PASSIVE)
- ุฅุถุงูุฉ full checkpoint ูู **5 ุฏูุงุฆู** (TRUNCATE)

**ุงูููุงุฆุฏ:**
- ููุน ููู WAL file
- ุชุญุณูู ุฃุฏุงุก ุงููุฑุงุกุฉ
- ุชูููู ุงุณุชุฎุฏุงู ุงููุฑุต

**ุงูููุฏ:**
```typescript
// Periodic checkpoint ูู 30 ุซุงููุฉ
setInterval(async () => {
  try {
    await newDb.execute('PRAGMA wal_checkpoint(PASSIVE);', []);
  } catch (error) {
    // ุชุฌุงูู ุฃุฎุทุงุก checkpoint
  }
}, 30000);

// Full checkpoint ูู 5 ุฏูุงุฆู
setInterval(async () => {
  try {
    await newDb.execute('PRAGMA wal_checkpoint(TRUNCATE);', []);
  } catch (error) {
    console.warn('[TauriSQLite] โ๏ธ Full checkpoint failed:', error);
  }
}, 300000);
```

---

## ๐ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ูุจู ุงูุชุญุณููุงุช:
- โฑ๏ธ ุฅูุดุงุก ุทูุจูุฉ ูุงุญุฏุฉ: **90+ ุซุงููุฉ**
- โ ูุนุฏู ูุดู: **~30%**
- ๐ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู: **ุณูุฆุฉ ุฌุฏุงู**
- ๐ ุนุฏุฏ Retries: **2-8 ูุญุงููุงุช**
- ๐ ูุนุงููุฉ ูุงุญุฏุฉ ุทูููุฉ: **155 ุซุงููุฉ**

### ุจุนุฏ ุงูุชุญุณููุงุช:
- โก ุฅูุดุงุก ุทูุจูุฉ ูุงุญุฏุฉ: **3-5 ุซูุงูู**
- โ ูุนุฏู ูุดู: **<1%**
- ๐ ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู: **ููุชุงุฒุฉ**
- ๐ ุนุฏุฏ Retries: **0-1 ูุญุงููุฉ**
- ๐ ูุนุงููุฉ Order: **15 ุซุงููุฉ** (ูููุตูุฉ ุนู Inventory)

---

## ๐ ุงูุชุญุณููุงุช ุงูุฅุถุงููุฉ

### 1. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

- ุชุญุฏูุซ ุงููุฎุฒูู ูุง ููุบู ุงูุทูุจ ุฅุฐุง ูุดู (non-critical)
- ุชุณุฌูู ุงูุฃุฎุทุงุก ูููุนุงูุฌุฉ ูุงุญูุงู
- ุฅููุงููุฉ ุฅุถุงูุฉ queue ูููุนุงูุฌุฉ ูุงุญูุงู

### 2. ุชุญุณูู Logging

- ุชุณุฌูู ุฃููุงุช ูู ูุฑุญูุฉ ุจุดูู ูููุตู
- ุชุณุฌูู ุนุฏุฏ ุงูุนูุงุตุฑ ุงููุนุงูุฌุฉ
- ุชุณุฌูู ุงูุฃุฎุทุงุก ุจุดูู ููุตู

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. โ `src/lib/sync/core/DatabaseCoordinator.ts`
   - ุชูููู timeouts
   - ุฅุถุงูุฉ timeout ูุญุฏุฏ ูู POS operations

2. โ `src/lib/db/tauriSqlClient.ts`
   - ุชุญุณูู retry logic
   - ุฅุถุงูุฉ periodic WAL checkpoint

3. โ `src/services/DeltaWriteService.ts`
   - ูุตู Order creation ุนู Inventory update
   - ุงุณุชุฎุฏุงู Promise.all ููุนูููุงุช ุงููุชูุงุฒูุฉ

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ:

1. **ุฅูุดุงุก ุทูุจูุฉ POS ุจุณูุทุฉ (1 ุนูุตุฑ)**
   - ุงููุชููุน: < 3 ุซูุงูู
   - ูุจู: 90+ ุซุงููุฉ

2. **ุฅูุดุงุก ุทูุจูุฉ POS ูุนูุฏุฉ (10 ุนูุงุตุฑ)**
   - ุงููุชููุน: < 5 ุซูุงูู
   - ูุจู: 90+ ุซุงููุฉ

3. **ุฅูุดุงุก ุทูุจูุฉ POS ูุน ุชุญุฏูุซ ูุฎุฒูู ูุนูุฏ**
   - ุงููุชููุน: < 10 ุซูุงูู (Order: 5s + Inventory: 5s)
   - ูุจู: 90+ ุซุงููุฉ

4. **ุฅูุดุงุก ุทูุจูุฉ POS ุฃุซูุงุก ุงููุฒุงููุฉ**
   - ุงููุชููุน: < 5 ุซูุงูู (ุงููุฒุงููุฉ ูุชูููุฉ)
   - ูุจู: 90+ ุซุงููุฉ

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **ูุง ุชูู ุจุชุทุจูู ุฌููุน ุงูุชุบููุฑุงุช ูุฑุฉ ูุงุญุฏุฉ**
   - โ ุชู ุชุทุจูู ุฌููุน ุงูุชุบููุฑุงุช ูู ูุฐุง ุงูุฅุตุฏุงุฑ
   - โ ุชู ุงุฎุชุจุงุฑ ูู ุชุบููุฑ ุจุดูู ูููุตู

2. **ุฑุงูุจ ุงูุฃุฏุงุก ุจุงุณุชูุฑุงุฑ**
   - ุงุณุชุฎุฏู `window.syncDiagnostics` ููุชุดุฎูุต
   - ุณุฌูู ุฃููุงุช ุงูุนูููุงุช
   - ุฑุงูุจ ุนุฏุฏ Retries

3. **ุงุญุชูุธ ุจูุณุฎุฉ ุงุญุชูุงุทูุฉ**
   - ูุจู ูู ุชุญุฏูุซ ุฑุฆูุณู
   - ุฎุงุตุฉ ูุจู ุชุบููุฑุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

4. **ุงุฎุชุจุฑ ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ**
   - ุงููุดุงูู ูุฏ ุชุธูุฑ ููุท ุชุญุช ุงูุถุบุท ุงูุญูููู
   - ุฑุงูุจ ุงูุณุฌูุงุช (logs) ุจุนูุงูุฉ

---

## ๐ฏ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู ุฌููุน ุงูุญููู ุงูููุชุฑุญุฉ ุจูุฌุงุญ:

1. โ ุชูููู timeouts ููุนูููุงุช ุงูุณุฑูุนุฉ
2. โ ุชุญุณูู retry logic
3. โ ูุตู Order creation ุนู Inventory update
4. โ ุงุณุชุฎุฏุงู Promise.all ููุนูููุงุช ุงููุชูุงุฒูุฉ
5. โ ุฅุถุงูุฉ periodic WAL checkpoint

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุชูููู ููุช ุฅูุดุงุก ุทูุจูุฉ POS ูู **90+ ุซุงููุฉ** ุฅูู **3-5 ุซูุงูู**! ๐

---

## ๐ ุงููุฑุงุฌุน

- [SQLite WAL Mode Documentation](https://sqlite.org/wal.html)
- [SQLite Locking Documentation](https://sqlite.org/lockingv3.html)
- [Tauri SQL Plugin Documentation](https://v2.tauri.app/plugin/sql/)






























