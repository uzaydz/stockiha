# 🎯 دليل نظام جلسات العمل الكامل

## ✅ نظرة عامة

نظام متكامل لإدارة جلسات العمل اليومية لموظفي نقطة البيع مع دعم كامل للأوفلاين والأونلاين.

---

## 📋 الملفات المطلوبة

### 1. قاعدة البيانات (Supabase)
```sql
/database/pos_work_sessions_schema.sql
```

**يجب تنفيذه في Supabase SQL Editor:**
- ✅ جدول `pos_work_sessions`
- ✅ RPC Functions (4 functions)
- ✅ Triggers للتحديث التلقائي
- ✅ Indexes للأداء

### 2. الكود المحلي (IndexedDB)
```typescript
/src/database/localDb.ts
```
- ✅ جدول `workSessions` (version 4)
- ✅ نفس البنية مع حقول المزامنة

### 3. الخدمات
```typescript
/src/api/localWorkSessionService.ts       // خدمة محلية (أوفلاين/أونلاين)
/src/services/workSessionService.ts       // خدمة السيرفر (أونلاين فقط)
```

### 4. الـ Context
```typescript
/src/context/WorkSessionContext.tsx       // إدارة الحالة العامة
```

### 5. المكونات
```typescript
/src/components/pos/StartSessionDialog.tsx   // نافذة بدء الجلسة
/src/components/pos/CloseSessionDialog.tsx   // نافذة إغلاق الجلسة
/src/components/pos/POSTitleBarActions.tsx   // أزرار Title Bar
```

### 6. الصفحات
```typescript
/src/pages/POSWorkSessions.tsx            // صفحة عرض الجلسات
/src/pages/POSAdvanced.tsx                // نقطة البيع (مع التحقق من الجلسة)
```

---

## 🔄 كيف يعمل النظام؟

### 1. **بدء الجلسة**

#### أوفلاين:
```typescript
1. الموظف يدخل رأس المال الأولي
2. يتم الحفظ في IndexedDB فوراً
3. الحالة: synced=false, pendingOperation='create'
4. الموظف يمكنه البدء بالبيع فوراً
```

#### أونلاين:
```typescript
1. الموظف يدخل رأس المال الأولي
2. يتم الحفظ في IndexedDB
3. يتم استدعاء RPC: start_pos_work_session()
4. إذا نجح: تحديث ID من السيرفر + synced=true
5. إذا فشل: يبقى محلياً وسيزامن لاحقاً
```

### 2. **التحديث التلقائي عند البيع**

#### في الكود (`usePOSAdvancedState.ts`):
```typescript
// بعد نجاح البيع:
if (activeSession) {
  updateSessionLocally({
    total_sales: activeSession.total_sales + validatedTotal,
    total_orders: activeSession.total_orders + 1,
    cash_sales: activeSession.cash_sales + cashAmount,
    card_sales: activeSession.card_sales + cardAmount,
  });
}
```

#### في IndexedDB:
```typescript
1. تحديث فوري في القاعدة المحلية
2. الحالة: synced=false, pendingOperation='update'
3. العرض في Title Bar يتحدث فوراً
```

#### المزامنة:
```typescript
1. كل 30 ثانية: syncPendingWorkSessions()
2. إذا أونلاين: مزامنة التحديثات
3. السيرفر يحدث الإحصائيات
```

### 3. **إغلاق الجلسة**

#### الحسابات:
```typescript
المبلغ المتوقع = رأس المال + المبيعات النقدية
التعديل اليدوي = +/- (مع سبب إجباري)
المبلغ النهائي = المتوقع + التعديل
```

#### أوفلاين:
```typescript
1. حساب المبالغ محلياً
2. حفظ في IndexedDB
3. الحالة: status='closed', synced=false
4. سيزامن عند عودة الإنترنت
```

#### أونلاين:
```typescript
1. حساب المبالغ محلياً
2. استدعاء RPC: close_pos_work_session()
3. السيرفر يحسب ويحفظ
4. تحديث المحلي: synced=true
```

---

## 🔁 المزامنة التلقائية

### في `WorkSessionContext.tsx`:
```typescript
useEffect(() => {
  const syncInterval = setInterval(() => {
    syncPendingWorkSessions().catch(console.error);
  }, 30000); // كل 30 ثانية

  return () => clearInterval(syncInterval);
}, []);
```

### ما يتم مزامنته:
1. ✅ جلسات جديدة (create)
2. ✅ تحديثات الإحصائيات (update)
3. ✅ إغلاق الجلسات (update + closed)

---

## 📊 عرض الجلسات

### في `/dashboard/staff-management`:
```typescript
// جلب من المحلي أولاً
const sessions = await getTodayWorkSessions(organizationId, date);

// إذا أونلاين: جلب من السيرفر وتحديث المحلي
// النتيجة: دائماً تعرض أحدث البيانات
```

### البيانات المعروضة:
- ✅ اسم الموظف
- ✅ وقت البدء والانتهاء
- ✅ رأس المال الأولي والنهائي
- ✅ المبيعات (نقدي/بطاقة)
- ✅ عدد الطلبات
- ✅ الفرق (نقص/زيادة)
- ✅ الملاحظات

---

## 🎨 واجهة المستخدم

### Title Bar (POSTitleBarActions):
```
للموظف مع جلسة نشطة:
┌─────────────────────────────────────┐
│ 🟢 جلسة نشطة | 1000 دج | 5 طلبات │ [إغلاق الجلسة]
└─────────────────────────────────────┘

للموظف بدون جلسة:
┌─────────────────────────────────────┐
│ [بدء جلسة عمل] ⚡
└─────────────────────────────────────┘

للمدير:
┌─────────────────────────────────────┐
│ 🛡️ وضع المدير
└─────────────────────────────────────┘
```

### نافذة بدء الجلسة:
```
┌─────────────────────────────────────┐
│ بدء جلسة عمل جديدة                 │
├─────────────────────────────────────┤
│ رأس المال الأولي: [____] دج *      │
│ ملاحظات: [________________]        │
│                                     │
│ [إلغاء] [بدء الجلسة ✅]            │
└─────────────────────────────────────┘
```

### نافذة إغلاق الجلسة:
```
┌─────────────────────────────────────┐
│ إغلاق جلسة العمل                   │
├─────────────────────────────────────┤
│ معلومات الجلسة:                    │
│ - رأس المال: 1000 دج                │
│ - المبيعات النقدية: +500 دج        │
│ - مبيعات البطاقة: 200 دج           │
│ - عدد الطلبات: 10 طلب              │
├─────────────────────────────────────┤
│ 🟢 المبلغ المتوقع: 1500 دج         │
│    (رأس المال + المبيعات النقدية)  │
├─────────────────────────────────────┤
│ تعديل المبلغ: [____] دج             │
│ (+ للزيادة، - للنقصان)             │
│                                     │
│ سبب التعديل: [________] * (إجباري) │
├─────────────────────────────────────┤
│ 🔵 المبلغ النهائي: 1480 دج         │
│    التعديل: -20 دج 🔴              │
├─────────────────────────────────────┤
│ ملاحظات: [________________]        │
│                                     │
│ [إلغاء] [إغلاق الجلسة 🔴]          │
└─────────────────────────────────────┘
```

---

## 🧪 اختبار النظام

### 1. اختبار أوفلاين:
```bash
1. افصل الإنترنت
2. ابدأ جلسة جديدة
3. قم بعمليات بيع
4. أغلق الجلسة
5. تحقق من IndexedDB (DevTools > Application > IndexedDB)
6. أعد الاتصال بالإنترنت
7. انتظر 30 ثانية (مزامنة تلقائية)
8. تحقق من Supabase (يجب أن تظهر الجلسة)
```

### 2. اختبار أونلاين:
```bash
1. ابدأ جلسة جديدة
2. تحقق فوراً من Supabase (يجب أن تظهر)
3. قم بعمليات بيع
4. تحقق من تحديث الإحصائيات في Title Bar
5. أغلق الجلسة
6. تحقق من Supabase (يجب أن تكون مغلقة)
```

### 3. اختبار صفحة الجلسات:
```bash
1. اذهب إلى /dashboard/staff-management
2. يجب أن ترى جميع جلسات اليوم
3. تحقق من الإحصائيات
4. تحقق من الفرق (نقص/زيادة)
5. اقرأ الملاحظات
```

---

## 🐛 استكشاف الأخطاء

### الجلسة لا تظهر في Title Bar:
```typescript
// تحقق من:
1. هل WorkSessionProvider موجود في CoreInfrastructureWrapper؟
2. هل DesktopTitlebar داخل WorkSessionProvider؟
3. افتح Console وابحث عن أخطاء
```

### الجلسة تختفي عند التحديث:
```typescript
// تحقق من:
1. هل تم حفظها في IndexedDB؟
   DevTools > Application > IndexedDB > bazaarDB_v2 > workSessions
2. هل refreshActiveSession يعمل؟
   Console > ابحث عن logs
```

### المزامنة لا تعمل:
```typescript
// تحقق من:
1. هل الإنترنت متصل؟
2. هل RPC functions موجودة في Supabase؟
3. Console > ابحث عن "❌ فشل مزامنة الجلسة"
4. تحقق من syncStatus في IndexedDB
```

### التحديث التلقائي لا يعمل:
```typescript
// تحقق من:
1. هل updateSessionLocally موجود في usePOSAdvancedState؟
2. هل يتم استدعاؤه بعد submitOrder؟
3. Console > ابحث عن logs التحديث
```

---

## 📝 ملاحظات مهمة

### 1. المدير vs الموظف:
- ✅ المدير: لا يحتاج جلسة، يمكنه البيع مباشرة
- ✅ الموظف: يجب عليه بدء جلسة أولاً

### 2. التعديل اليدوي:
- ✅ إجباري: إدخال سبب التعديل
- ✅ يتم حفظ السبب في الملاحظات
- ✅ صيغة: `تعديل: +50.00 دج - السبب: مصاريف`

### 3. المزامنة:
- ✅ تلقائية كل 30 ثانية
- ✅ لا تؤثر على الأداء
- ✅ تعمل في الخلفية

### 4. الأمان:
- ✅ RPC Functions: SECURITY DEFINER
- ✅ التحقق من المستخدم في كل function
- ✅ التحقق من المؤسسة

---

## 🚀 الخلاصة

النظام جاهز بالكامل ويدعم:
- ✅ العمل أوفلاين 100%
- ✅ العمل أونلاين 100%
- ✅ المزامنة التلقائية
- ✅ التحديث الفوري
- ✅ الحسابات الدقيقة
- ✅ واجهة مستخدم سهلة
- ✅ تتبع كامل للجلسات

**كل شيء جاهز للاستخدام!** 🎉
