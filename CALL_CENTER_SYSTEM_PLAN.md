# 📞 خطة تطوير نظام مركز الاتصال (Call Center System)

## 📊 ملخص التحليل الشامل

### 🔍 تحليل قاعدة البيانات الحالية

**الجداول الرئيسية المكتشفة:**
- ✅ `online_orders` - الطلبيات الأونلاين مع حقول مهمة:
  - `call_confirmation_status_id` - حالة تأكيد المكالمة
  - `call_confirmation_notes` - ملاحظات المكالمة  
  - `call_confirmation_updated_by` - من قام بالتحديث
  - `employee_id` - الموظف المسؤول
  - `form_data` - بيانات العميل (JSON)

- ✅ `call_confirmation_statuses` - حالات تأكيد المكالمات:
  - مؤكد (أخضر) - تم تأكيد الطلب
  - تم الإتصال (أزرق) - تم الاتصال بالعميل
  - تأجيل (أصفر) - تأجيل المكالمة
  - لم يتم الرد (أحمر) - لم يرد العميل
  - ملغي (بنفسجي) - طلب ملغي

- ✅ `order_distribution_settings` - إعدادات توزيع الطلبيات
- ✅ `order_distribution_history` - تاريخ توزيع الطلبيات
- ✅ `users` - المستخدمين مع نظام صلاحيات متقدم

### 🎯 نظام التوزيع الحالي
- توزيع حسب الولايات (provinces)
- توزيع حسب المتاجر (stores)
- توزيع حسب العدد (quantity-based)
- تتبع تاريخ التوزيع والتخصيص

### 💻 تحليل الواجهات الأمامية
- ✅ `useOrdersData` hook - جلب البيانات مع تحسينات الأداء
- ✅ `OrdersTable` - جدول الطلبيات مع فلترة وبحث
- ✅ `OrderTableRow` - صف الطلب مع تفاصيل شاملة
- ✅ نظام صلاحيات متقدم للمستخدمين
- ✅ واجهة responsive مع دعم mobile

---

## 🚀 خطة التطوير - TODO List

### ✅ المرحلة الأولى: إعداد قاعدة البيانات - **مكتملة**

#### ✅ 1.1 تحليل البنية الحالية - **مكتمل**
- [x] تحليل جدول `online_orders`
- [x] تحليل جدول `call_confirmation_statuses`
- [x] تحليل جدول `order_distribution_settings`
- [x] تحليل جدول `users` والصلاحيات

#### ✅ 1.2 إنشاء الجداول الجديدة - **مكتمل**

##### جدول موظفي مركز الاتصال
- [x] إنشاء جدول `call_center_agents`
  ```sql
  CREATE TABLE call_center_agents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    assigned_regions JSONB DEFAULT '[]'::jsonb, -- الولايات المخصصة
    assigned_stores JSONB DEFAULT '[]'::jsonb,  -- المتاجر المخصصة
    max_daily_orders INTEGER DEFAULT 50,        -- الحد الأقصى للطلبيات اليومية
    is_available BOOLEAN DEFAULT true,          -- متاح للعمل
    last_activity TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    performance_metrics JSONB DEFAULT '{}'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
  );
  ```

##### جدول جلسات العمل
- [x] إنشاء جدول `call_center_sessions`
  ```sql
  CREATE TABLE call_center_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES call_center_agents(id) ON DELETE CASCADE,
    start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    end_time TIMESTAMP WITH TIME ZONE,
    orders_handled INTEGER DEFAULT 0,
    calls_made INTEGER DEFAULT 0,
    successful_calls INTEGER DEFAULT 0,
    session_notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
  );
  ```

##### جدول إحصائيات الأداء
- [x] إنشاء جدول `agent_performance_stats`
  ```sql
  CREATE TABLE agent_performance_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID NOT NULL REFERENCES call_center_agents(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    orders_assigned INTEGER DEFAULT 0,
    orders_completed INTEGER DEFAULT 0,
    calls_made INTEGER DEFAULT 0,
    successful_calls INTEGER DEFAULT 0,
    avg_call_duration INTERVAL,
    customer_satisfaction_score DECIMAL(3,2),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(agent_id, date)
  );
  ```

#### ✅ 1.3 تحديث الجداول الموجودة - **مكتمل**
- [x] إضافة حقل `assigned_agent_id` إلى جدول `online_orders`
- [x] إضافة حقل `agent_priority` إلى جدول `online_orders`
- [x] إضافة حقل `call_attempts` إلى جدول `online_orders`
- [x] إضافة حقل `last_call_attempt` إلى جدول `online_orders`
- [x] إضافة حقل `next_call_scheduled` إلى جدول `online_orders`
- [x] إضافة حقل `assignment_timestamp` إلى جدول `online_orders`

#### ✅ 1.4 إنشاء الفهارس والقيود - **مكتمل**
- [x] إنشاء فهارس للبحث السريع مع حل مشكلة IMMUTABLE
- [x] إضافة قيود التكامل المرجعي
- [x] إنشاء triggers للتحديث التلقائي
- [x] إنشاء فهارس GIN للـ JSONB fields
- [x] إنشاء فهارس مركبة للاستعلامات المعقدة

#### ✅ 1.5 إنشاء الدوال المخزنة (Stored Procedures) - **مكتمل**
- [x] دالة `assign_orders_to_agent` - تخصيص الطلبيات للموظفين
- [x] دالة `get_agent_dashboard_stats` - إحصائيات لوحة التحكم
- [x] دالة `update_agent_performance` - تحديث إحصائيات الأداء
- [x] دالة `get_available_agents` - الحصول على الموظفين المتاحين
- [x] دالة `extract_date_immutable` - دالة IMMUTABLE لاستخراج التاريخ

#### ✅ 1.6 إنشاء Views والأمان - **مكتمل**
- [x] إنشاء View `active_agents_with_stats` - الموظفين النشطين مع إحصائياتهم
- [x] إنشاء View `agent_assigned_orders` - الطلبيات المخصصة للموظفين
- [x] تفعيل Row Level Security (RLS) على جميع الجداول
- [x] إنشاء سياسات الأمان للموظفين والإداريين

---

### ✅ المرحلة الثانية: نظام المصادقة والصلاحيات - **مكتملة**

#### ✅ 2.1 تحديث الأنواع والواجهات - **مكتمل**
- [x] إضافة نوع مستخدم `call_center_agent` إلى UserRole
- [x] إنشاء ملف `callCenter.ts` مع جميع الأنواع والواجهات
- [x] إضافة صلاحيات مركز الاتصال إلى UserPermissions
- [x] تصدير أنواع مركز الاتصال من الملف الرئيسي

#### ✅ 2.2 تحديث نظام المصادقة - **مكتمل**
- [x] تحديث `AuthContext` لدعم موظفي مركز الاتصال
- [x] إنشاء دوال التحقق من صلاحيات مركز الاتصال
- [x] إنشاء دالة `checkCallCenterPermissions`
- [x] إنشاء دالة `isCallCenterAgent`
- [x] إنشاء دالة `isCallCenterSupervisor`
- [x] إنشاء دالة `getCallCenterAgentInfo`

#### ✅ 2.3 إنشاء مكونات الحماية - **مكتمل**
- [x] إنشاء `CallCenterRoute` component للحماية
- [x] إنشاء `CallCenterPermissionGuard` component
- [x] إنشاء `useCallCenterPermission` Hook
- [x] إنشاء `useCallCenterPermissions` Hook
- [x] تحديث `ProtectedRoute` لدعم مركز الاتصال

#### ✅ 2.4 تحديث نظام التوجيه (Routing) - **مكتمل**
- [x] تحديث `App.tsx` لإضافة مسارات مركز الاتصال
- [x] إنشاء مسارات محمية لموظفي مركز الاتصال (`/call-center/*`)
- [x] إنشاء مسارات محمية للمشرفين (`/call-center/management/*`)
- [x] إنشاء مسارات إدارة مركز الاتصال للأدمين (`/dashboard/call-center/*`)
- [x] إضافة redirect logic حسب نوع المستخدم في `ProtectedRoute`
- [x] إصلاح مشاكل React Router v6 مع `Outlet`

---

### ✅ المرحلة الثالثة: واجهات مركز الاتصال - **مكتملة بالكامل** 🎉

#### ✅ 3.1 القائمة الجانبية المخصصة - **مكتمل**
- [x] إنشاء `CallCenterSideMenu.tsx`
  - [x] لوحة التحكم
  - [x] الطلبيات المخصصة/المعلقة/المكتملة
  - [x] إحصائياتي
  - [x] الملف الشخصي
  - [x] قسم منفصل لأدوات المشرف
  - [x] معلومات المستخدم وحالة الاتصال
  - [x] تسجيل الخروج

#### ✅ 3.2 لوحة التحكم الرئيسية - **مكتمل**
- [x] إنشاء `CallCenterDashboard.tsx`
  - [x] إحصائيات اليوم (طلبيات، مكالمات، معدل النجاح)
  - [x] الطلبيات الأخيرة
  - [x] مؤشرات الأداء
  - [x] إجراءات سريعة
  - [x] بطاقات إحصائيات تفاعلية

#### ✅ 3.3 صفحة الطلبيات المخصصة - **مكتمل**
- [x] إنشاء `AssignedOrders.tsx`
  - [x] جدول الطلبيات المخصصة فقط
  - [x] فلترة حسب الحالة والأولوية
  - [x] بحث سريع
  - [x] إجراءات سريعة (اتصال، تحديث حالة)
  - [x] مؤشر المحاولات
  - [x] إحصائيات سريعة

#### ✅ 3.4 Layout والتوجيه - **مكتمل**
- [x] إنشاء `CallCenterLayout.tsx`
- [x] تحديث `App.tsx` مع الروابط الجديدة
- [x] دعم التوجيه المتداخل
- [x] تكامل مع نظام الحماية

#### ✅ 3.5 مكونات مخصصة لمركز الاتصال - **مكتمل**
- [x] `OrderCallPanel.tsx` - لوحة المكالمة الشاملة
  - [x] معلومات العميل والطلب
  - [x] أزرار التحكم في المكالمة
  - [x] مؤقت المكالمة
  - [x] نتائج المكالمة المختلفة
  - [x] محرر الملاحظات المدمج
- [x] `CallNotesEditor.tsx` - محرر ملاحظات متقدم
  - [x] أنواع مختلفة من الملاحظات
  - [x] قوالب جاهزة للاستخدام
  - [x] حفظ تلقائي
  - [x] إحصائيات الملاحظات
- [x] `AgentPerformanceWidget.tsx` - ويدجت الأداء التفاعلي
  - [x] إحصائيات متعددة الفترات (يوم/أسبوع/شهر)
  - [x] مؤشرات الاتجاه
  - [x] التقدم نحو الأهداف
  - [x] رسائل تحفيزية
  - [x] وضع مضغوط للعرض السريع
- [x] `QuickCallActions.tsx` - إجراءات سريعة شاملة
  - [x] أزرار ما قبل المكالمة
  - [x] أزرار أثناء المكالمة
  - [x] نتائج المكالمة المتنوعة
  - [x] جدولة معاودة الاتصال
  - [x] ملاحظات سريعة مع قوالب

---

### ✅ المرحلة الرابعة: منطق الأعمال والـ Hooks - **مكتملة بالكامل** 🎉

#### ✅ 4.1 إنشاء Custom Hooks - **مكتمل**
- [x] `useCallCenterAgent.ts` - إدارة بيانات الموظف وجلسات العمل
- [x] `useCallCenterOrders.ts` - إدارة الطلبيات والتخصيص والتصفية
- [x] `useAgentPerformance.ts` - إحصائيات الأداء متعددة الفترات
- [x] `useCallManagement.ts` - إدارة المكالمات والمؤقت وسجل المكالمات
- [x] `useCallCenterNotifications.ts` - نظام الإشعارات والتنبيهات المتقدم

#### ✅ 4.2 ميزات متقدمة في الـ Hooks - **مكتمل**
- [x] **useCallCenterAgent**: إدارة الجلسات، تحديث الحالة، إحصائيات اليوم
- [x] **useCallCenterOrders**: تصفية متقدمة، بحث، تخصيص، تحديث الحالة
- [x] **useAgentPerformance**: اتجاهات الأداء، مقارنات، أهداف شهرية
- [x] **useCallManagement**: مؤقت المكالمة، سجل المكالمات، إحصائيات
- [x] **useCallCenterNotifications**: إشعارات مباشرة، إعدادات، صوت وسطح المكتب

#### ✅ 4.3 تكامل قاعدة البيانات - **مكتمل**
- [x] ربط جميع الـ Hooks بـ Supabase
- [x] Real-time subscriptions للتحديثات المباشرة
- [x] إدارة شاملة للأخطاء والتحميل
- [x] Optimistic updates للاستجابة السريعة
- [x] تحسين الاستعلامات والأداء

---

### ✅ المرحلة الخامسة: لوحة تحكم الأدمين - **مكتملة بالكامل** 🎉

#### ✅ 5.1 إدارة موظفي مركز الاتصال - **مكتمل**
- [x] صفحة `CallCenterAgentsManagement.tsx`
  - [x] قائمة الموظفين مع البحث والتصفية المتقدمة
  - [x] إضافة موظف جديد مع نموذج تفاعلي
  - [x] تعديل بيانات الموظف (الحد الأقصى، الحالة، التوفر)
  - [x] تعطيل/تفعيل الموظف مع تأكيد
  - [x] عرض إحصائيات الأداء لكل موظف
  - [x] بطاقات إحصائيات شاملة (إجمالي، نشط، متصل، أداء)

#### ✅ 5.2 إعدادات التوزيع المتقدمة - **مكتمل**
- [x] صفحة `CallCenterDistributionSettings.tsx`
  - [x] إعدادات التوزيع التلقائي مع تبديل تفعيل/إيقاف
  - [x] الحد الأقصى للطلبيات لكل موظف يومياً
  - [x] إعادة التخصيص بعد ساعات محددة
  - [x] حد الطلبيات عالية الأولوية
  - [x] ساعات العمل (من - إلى)
  - [x] التوزيع في عطلة نهاية الأسبوع
  - [x] أوزان التوزيع (أداء 30% + عبء العمل 40% + منطقة 30%)
  - [x] قواعد التوزيع المخصصة مع أنواع متعددة
  - [x] حفظ وإعادة تعيين الإعدادات

#### ✅ 5.3 تقارير الأداء - **مكتمل**
- [x] صفحة `CallCenterReports.tsx`
  - [x] تبويبات متعددة (نظرة عامة، موظفين، مكالمات، طلبيات)
  - [x] تقرير أداء الموظفين مع جدول تفصيلي
  - [x] تقرير معدلات النجاح مع مؤشرات بصرية
  - [x] تقرير أوقات الاستجابة ومدة المكالمات
  - [x] إحصائيات المكالمات (مجابة، مفقودة، ساعات الذروة)
  - [x] فلترة حسب التاريخ والموظف
  - [x] تصدير التقارير (Excel, PDF, CSV)
  - [x] مؤشرات KPI رئيسية (6 مؤشرات)

#### ✅ 5.4 مراقبة النشاط المباشر - **مكتمل**
- [x] صفحة `CallCenterMonitoring.tsx`
  - [x] الموظفين المتصلين حالياً مع حالات متعددة
  - [x] تتبع المكالمات الجارية مع مؤقت المدة
  - [x] إحصائيات مباشرة (6 مؤشرات رئيسية)
  - [x] تنبيهات النظام مع أنواع متعددة (تحذير، خطأ، معلومات)
  - [x] تحديث تلقائي كل 30 ثانية مع إمكانية التحكم
  - [x] تفاصيل الموظف في نافذة منبثقة
  - [x] إحصائيات اليوم لكل موظف

#### ✅ 5.5 التخطيط الإداري والصفحات - **مكتمل**
- [x] تخطيط إداري موحد `CallCenterAdminLayout.tsx`
  - [x] شريط جانبي مع تنقل سهل
  - [x] إحصائيات سريعة في الشريط الجانبي
  - [x] شريط علوي مع breadcrumb navigation
  - [x] مؤشر حالة النظام
  - [x] تنبيهات مع عداد
- [x] 4 صفحات إدارية كاملة مع التخطيط:
  - [x] `AgentsManagementPage.tsx`
  - [x] `DistributionSettingsPage.tsx`
  - [x] `ReportsPage.tsx`
  - [x] `MonitoringPage.tsx`

#### ✅ 5.6 قاعدة البيانات الإدارية - **مكتمل**
- [x] جدول `order_distribution_settings` مع قيود التحقق
- [x] جدول `distribution_rules` مع أنواع متعددة
- [x] جدول `auto_assignment_log` لتتبع التوزيع
- [x] جدول `system_alerts` للتنبيهات
- [x] جدول `daily_system_stats` للإحصائيات اليومية
- [x] فهارس محسنة للأداء
- [x] بيانات افتراضية وقواعد توزيع أساسية

---

### 🔄 المرحلة السادسة: نظام التوزيع الذكي

#### 🔲 6.1 خوارزميات التوزيع
- [ ] توزيع متوازن حسب العبء
- [ ] توزيع حسب الخبرة والأداء
- [ ] توزيع حسب الموقع الجغرافي
- [ ] توزيع حسب تخصص المنتج

#### 🔲 6.2 نظام الأولويات
- [ ] أولوية حسب قيمة الطلب
- [ ] أولوية حسب نوع العميل (VIP)
- [ ] أولوية حسب وقت الطلب
- [ ] أولوية حسب محاولات الاتصال السابقة

#### 🔲 6.3 إعادة التوزيع التلقائي
- [ ] إعادة توزيع الطلبيات غير المعالجة
- [ ] إعادة توزيع عند عدم توفر الموظف
- [ ] إعادة توزيع حسب الأداء
- [ ] إشعارات إعادة التوزيع

---

### 📊 المرحلة السابعة: التحليلات والتقارير

#### 🔲 7.1 لوحة معلومات تفاعلية
- [ ] مخططات الأداء اليومي/الأسبوعي/الشهري
- [ ] مؤشرات KPI للموظفين
- [ ] مقارنة الأداء بين الموظفين
- [ ] اتجاهات معدلات النجاح

#### 🔲 7.2 تقارير مفصلة
- [ ] تقرير نشاط الموظف اليومي
- [ ] تقرير معدلات تحويل المكالمات
- [ ] تقرير أوقات الذروة
- [ ] تقرير أسباب فشل المكالمات

#### 🔲 7.3 تصدير البيانات
- [ ] تصدير إلى Excel
- [ ] تصدير إلى PDF
- [ ] تصدير إلى CSV
- [ ] جدولة التقارير التلقائية

---

### 🔔 المرحلة الثامنة: النظام التفاعلي والإشعارات

#### 🔲 8.1 الإشعارات المباشرة
- [ ] إشعارات الطلبيات الجديدة
- [ ] إشعارات تحديث الحالة
- [ ] إشعارات إعادة التخصيص
- [ ] إشعارات انتهاء المهلة الزمنية

#### 🔲 8.2 نظام الرسائل الداخلية
- [ ] رسائل بين الموظفين والمشرفين
- [ ] رسائل تنبيه النظام
- [ ] رسائل التحديثات المهمة
- [ ] أرشيف الرسائل

#### 🔲 8.3 التحديث المباشر (Real-time)
- [ ] تحديث حالة الطلبيات مباشرة
- [ ] تحديث إحصائيات الأداء
- [ ] تحديث قائمة الموظفين المتاحين
- [ ] مزامنة البيانات بين الجلسات

---

### 🧪 المرحلة التاسعة: الاختبار والتحسين

#### 🔲 9.1 اختبارات الوحدة (Unit Tests)
- [ ] اختبار hooks مركز الاتصال
- [ ] اختبار خدمات API
- [ ] اختبار مكونات الواجهة
- [ ] اختبار منطق التوزيع

#### 🔲 9.2 اختبارات التكامل
- [ ] اختبار تدفق العمل الكامل
- [ ] اختبار التوزيع والتخصيص
- [ ] اختبار الصلاحيات والأمان
- [ ] اختبار الأداء تحت الضغط

#### 🔲 9.3 تحسين الأداء
- [ ] تحسين استعلامات قاعدة البيانات
- [ ] تحسين تحميل الواجهات
- [ ] تحسين استهلاك الذاكرة
- [ ] تحسين أوقات الاستجابة

---

### 🚀 المرحلة العاشرة: النشر والتشغيل

#### 🔲 10.1 إعداد البيئة
- [ ] إعداد متغيرات البيئة
- [ ] إعداد قاعدة البيانات للإنتاج
- [ ] إعداد خدمات الإشعارات
- [ ] إعداد النسخ الاحتياطية

#### 🔲 10.2 التوثيق
- [ ] دليل المستخدم لموظفي مركز الاتصال
- [ ] دليل الأدمين لإدارة النظام
- [ ] دليل المطور للصيانة
- [ ] دليل استكشاف الأخطاء

#### 🔲 10.3 التدريب والدعم
- [ ] تدريب موظفي مركز الاتصال
- [ ] تدريب المشرفين والأدمين
- [ ] إعداد نظام الدعم الفني
- [ ] إعداد قنوات التواصل

---

## 📈 مؤشرات النجاح (KPIs)

### للموظفين:
- [ ] معدل الإجابة على المكالمات (> 80%)
- [ ] متوسط وقت المكالمة (< 5 دقائق)
- [ ] معدل تحويل الطلبيات (> 70%)
- [ ] رضا العملاء (> 4/5)

### للنظام:
- [ ] وقت استجابة الواجهة (< 2 ثانية)
- [ ] دقة توزيع الطلبيات (> 95%)
- [ ] توفر النظام (> 99.5%)
- [ ] معدل الأخطاء (< 1%)

---

## 🔧 التقنيات المستخدمة

### Frontend:
- ✅ React 18 + TypeScript
- ✅ Tailwind CSS + shadcn/ui
- ✅ React Query للبيانات
- ✅ Zustand لإدارة الحالة
- ✅ React Hook Form للنماذج

### Backend:
- ✅ Supabase (PostgreSQL)
- ✅ Row Level Security (RLS)
- ✅ Real-time subscriptions
- ✅ Edge Functions للمنطق المعقد

### إضافية:
- [ ] WebSocket للتحديث المباشر
- [ ] Push Notifications
- [ ] Service Workers للعمل دون اتصال
- [ ] PWA للتطبيق المحمول

---

## ⚠️ ملاحظات مهمة

1. **الأمان**: جميع البيانات محمية بـ RLS وصلاحيات دقيقة
2. **الأداء**: استخدام تقنيات التخزين المؤقت والتحميل التدريجي
3. **التوسع**: النظام مصمم للتوسع مع نمو الفريق
4. **التوافق**: دعم جميع المتصفحات والأجهزة
5. **الصيانة**: كود منظم وموثق للصيانة السهلة

---

## 🎯 الخطوات التالية

1. **الموافقة على الخطة** - مراجعة وتأكيد جميع المتطلبات
2. **تحديد الأولويات** - ترتيب المراحل حسب الأهمية
3. **تخصيص الموارد** - تحديد الوقت والفريق المطلوب
4. **بدء التنفيذ** - البدء بالمرحلة الأولى (قاعدة البيانات)

---

**📅 التاريخ:** $(date)  
**👨‍💻 المطور:** AI Assistant  
**📋 الحالة:** في انتظار الموافقة 