# إصلاح التحكم في الوصول للنطاقات الفرعية والمخصصة

## المشكلة
أي مؤسسة تستطيع الدخول بحسابها من أي نطاق فرعي أو مخصص خاص بمؤسسة أخرى. يجب أن يقتصر الدخول على:
- المسؤول والموظفين التابعين للمؤسسة صاحبة النطاق
- عدم السماح لمستخدمي المؤسسات الأخرى بالدخول

## الحل المطبق

### 1. تحديثات قاعدة البيانات
تم إنشاء ملف `fix_domain_access_control.sql` يحتوي على:

#### أ. دالة `get_organization_by_domain`
- تحصل على معرف المؤسسة من النطاق أو النطاق الفرعي
- تتعامل مع النطاقات بـ www وبدونها

#### ب. دالة `check_user_requires_2fa` المحدثة
- تتحقق من أن المستخدم ينتمي للمؤسسة صاحبة النطاق
- ترفض الدخول إذا كان المستخدم من مؤسسة أخرى
- تسجل محاولات الوصول غير المصرح بها
- تعطي رسائل خطأ واضحة

#### ج. دالة `verify_domain_access`
- دالة إضافية للتحقق من صلاحية الوصول للنطاق
- يمكن استخدامها في أماكن أخرى بالتطبيق

### 2. تحديثات الواجهة الأمامية
تم تحديث `LoginForm.tsx`:
- عرض رسائل الخطأ المخصصة من قاعدة البيانات
- معالجة أفضل لحالات رفض الدخول

## خطوات التطبيق

### 1. تطبيق تحديثات قاعدة البيانات
```bash
# تنفيذ ملف SQL في قاعدة البيانات
psql -U postgres -d your_database_name -f fix_domain_access_control.sql

# أو من خلال Supabase Dashboard:
# 1. افتح SQL Editor في Supabase
# 2. انسخ محتوى fix_domain_access_control.sql
# 3. نفذ الاستعلام
```

### 2. نشر التحديثات
```bash
# بناء المشروع
npm run build

# نشر التحديثات
npm run deploy
```

## كيفية عمل الحماية

### 1. عند تسجيل الدخول:
- يتم استخراج النطاق/النطاق الفرعي من URL الحالي
- يتم البحث عن المؤسسة المرتبطة بهذا النطاق
- يتم التحقق من أن المستخدم ينتمي لنفس المؤسسة
- إذا لم يطابق، يتم رفض الدخول مع رسالة خطأ واضحة

### 2. السيناريوهات المختلفة:

#### أ. نطاق فرعي (مثل: company1.ktobi.online)
- يجب أن يكون المستخدم من company1 فقط
- مستخدمو company2 سيتم رفضهم

#### ب. نطاق مخصص (مثل: company1.com)
- يجب أن يكون المستخدم من المؤسسة المرتبطة بـ company1.com
- أي مستخدم آخر سيتم رفضه

#### ج. النطاق الرئيسي (ktobi.online)
- فقط المسؤولون العامون (بدون organization_id)
- المستخدمون من المؤسسات سيتم توجيههم لنطاقاتهم

## رسائل الخطأ

### 1. "النطاق غير مسجل في النظام"
- يظهر عند محاولة الدخول من نطاق غير موجود

### 2. "غير مصرح لك بالدخول من هذا النطاق"
- يظهر عند محاولة مستخدم الدخول من نطاق مؤسسة أخرى

### 3. "يجب الدخول من نطاق مؤسستك: [subdomain].ktobi.online"
- يظهر عند محاولة الدخول من النطاق الرئيسي لمستخدم تابع لمؤسسة

## الأمان والتسجيل

### 1. تسجيل محاولات الوصول غير المصرح بها
- جميع محاولات الدخول من نطاقات خاطئة يتم تسجيلها
- مستوى الخطورة: high أو critical
- يتم حفظ: الإيميل، النطاق المحاول، معرف المؤسسة

### 2. منع الثغرات
- لا يمكن تجاوز الحماية بتعديل localStorage
- التحقق يتم من جانب الخادم في قاعدة البيانات
- حماية من محاولات التلاعب بالنطاقات

## الاختبار

### 1. اختبار الحماية:
```javascript
// سيناريو 1: مستخدم من company1 يحاول الدخول من company2.ktobi.online
// النتيجة: رفض مع رسالة "غير مصرح لك بالدخول من هذا النطاق"

// سيناريو 2: مستخدم من company1 يدخل من company1.ktobi.online  
// النتيجة: نجاح الدخول

// سيناريو 3: مسؤول عام يدخل من ktobi.online
// النتيجة: نجاح الدخول

// سيناريو 4: مستخدم عادي يحاول الدخول من ktobi.online
// النتيجة: رفض مع رسالة توجيه لنطاق مؤسسته
```

### 2. مراقبة السجلات:
```sql
-- عرض محاولات الوصول غير المصرح بها
SELECT * FROM security_logs 
WHERE activity_type IN ('unauthorized_domain_access', '2fa_check')
AND status = 'blocked'
ORDER BY created_at DESC;
```

## الصيانة

### 1. مراقبة دورية:
- مراجعة سجلات محاولات الوصول غير المصرح بها
- التحقق من أن جميع النطاقات مرتبطة بمؤسساتها

### 2. التحديثات المستقبلية:
- يمكن إضافة قائمة بيضاء للمسؤولين العامين
- يمكن إضافة إشعارات للمؤسسات عند محاولات اختراق
- يمكن إضافة حظر مؤقت بعد عدة محاولات فاشلة