# خطة تنفيذ ميزة اختيار نوع المبلغ المتبقي

## الملخص
تتيح هذه الميزة للمستخدم تحديد ما إذا كان المبلغ المتبقي عند الدفع في نظام نقاط البيع (POS) سيعتبر "دفعًا جزئيًا" (يتم تسجيله كدين على العميل) أو "باقي" عادي (أي عمليًا خصم على السعر).

## التغييرات في قاعدة البيانات
### 1. إضافة أعمدة جديدة في جدول الطلبات (orders)
- `amount_paid` (decimal): المبلغ المدفوع فعليًا
- `remaining_amount` (decimal): المبلغ المتبقي
- `consider_remaining_as_partial` (boolean): هل يعتبر المبلغ المتبقي دفعًا جزئيًا

### 2. ملف SQL لتنفيذ التغييرات
ملف `add_partial_payment_support.sql` يحتوي على:
- إضافة الأعمدة الجديدة
- إنشاء وظائف لمعالجة المدفوعات الجزئية
- تحديث وظائف التقارير والتحليلات
- تحديث السجلات القديمة لتتوافق مع البنية الجديدة

## التغييرات في واجهة المستخدم
### 1. تعديل مكون Cart.tsx
- إضافة خيار تبديل (toggle) يسمح للمستخدم بتحديد كيفية معالجة المبلغ المتبقي
- تحديث واجهة المستخدم بناءً على اختيار المستخدم
- إرسال إعدادات المدفوعات الجزئية الجديدة إلى الخادم
- تعديل رسائل التأكيد لتوضيح نوع العملية (دفع جزئي/باقي)

## التغييرات في الكود والأنواع
### 1. تعديلات في ملف src/types/index.ts
- تحديث واجهة `Order` لتضمين حقل `considerRemainingAsPartial`

### 2. تعديلات في ملف src/types/database.types.ts
- تحديث أنواع قاعدة البيانات لتتضمن الأعمدة الجديدة

### 3. تعديلات في ملف src/context/ShopContext.tsx
- تعديل وظيفة `addOrder` لحفظ معلومات المدفوعات الجزئية في الأعمدة الجديدة
- تعديل وظيفة `mapSupabaseOrderToOrder` لاستخراج البيانات من الأعمدة الجديدة

## التغييرات في التقارير والتحليلات
- تم تعديل وظيفة `calculate_order_financial_impact` لتأخذ بعين الاعتبار نوع المبلغ المتبقي
- تم تعديل وظيفة `get_sales_summary` للتعامل مع المبالغ المتبقية بشكل مختلف حسب نوعها
- تعديل حساب الإيرادات بحيث:
  - في حالة الدفع الجزئي: يتم تسجيل المبلغ المدفوع كإيراد فعلي، والمتبقي كإيراد معلق
  - في حالة الباقي العادي: يتم تسجيل المبلغ المدفوع فقط كإيراد، ولا يتم تسجيل المتبقي كإيراد معلق

## الفوائد
1. المرونة في التعامل مع المبالغ المتبقية بما يناسب احتياجات العمل
2. تقارير مالية أكثر دقة تعكس الواقع الفعلي للإيرادات والديون
3. تحسين تجربة المستخدم من خلال توفير خيارات أكثر في التعامل مع المدفوعات

## خطوات التنفيذ
1. تنفيذ التغييرات في قاعدة البيانات باستخدام ملف SQL
2. تحديث ملفات الأنواع والواجهات
3. تعديل مكون عربة التسوق
4. تحديث وظائف التقارير والتحليلات
5. اختبار الميزة الجديدة 