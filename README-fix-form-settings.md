# إصلاح مشكلة حفظ إعدادات التكامل مع شركة الشحن في النماذج

## المشكلة

تم اكتشاف عدة مشاكل تتعلق بحفظ إعدادات تكامل الشحن في النماذج:

1. وجود عدة نسخ متضاربة من وظيفة `upsert_form_settings` في قاعدة البيانات، مما يسبب خطأ عند استدعائها:
   ```
   Could not choose the best candidate function between p_shipping_integration => jsonb, p_form_id => uuid
   ```

2. إعدادات تكامل الشحن لا يتم حفظها بشكل صحيح في حقل `settings` في جدول `form_settings`، مما يؤدي إلى عدم ظهورها بعد إعادة تحميل الصفحة.

## الحل

تم إنشاء ملف SQL `fix_form_settings_function.sql` يحتوي على الخطوات التالية:

1. حذف جميع الإصدارات الحالية المتضاربة من وظيفة `upsert_form_settings`
2. إنشاء إصدار جديد من الوظيفة يدعم معلمة `p_shipping_integration` بشكل صحيح
3. تحديث حقل `settings` في السجلات الموجودة التي لا تحتوي على إعدادات
4. إضافة وظيفة مساعدة `test_shipping_integration_settings` للتحقق من حفظ الإعدادات بشكل صحيح

## كيفية تطبيق الإصلاح

1. قم بتنفيذ الملف SQL على قاعدة البيانات:
   ```bash
   psql -U [username] -d [database] -f fix_form_settings_function.sql
   ```

   أو يمكنك نسخ محتوى الملف وتنفيذه في واجهة إدارة قاعدة البيانات مثل pgAdmin أو Supabase.

2. بعد تنفيذ الإصلاح، يمكنك التحقق من صحة الإصلاح باستخدام الاستعلام التالي:
   ```sql
   SELECT id, name, settings FROM form_settings;
   ```

   يجب أن ترى الآن إعدادات التكامل مع شركة الشحن محفوظة بشكل صحيح في حقل `settings`.

3. يمكنك أيضًا اختبار وظيفة من خلال:
   ```sql
   SELECT * FROM test_shipping_integration_settings('[form_id]');
   ```
   استبدل `[form_id]` بمعرف النموذج الذي تريد اختباره.

## بعد تطبيق الإصلاح

بعد تطبيق الإصلاح، يجب أن تعمل واجهة تكامل الشحن في النماذج بشكل صحيح:
- ستتمكن من حفظ إعدادات التكامل مع شركة الشحن
- ستظهر الإعدادات بشكل صحيح بعد إعادة تحميل الصفحة
- لن تظهر أخطاء عند حفظ النموذج

## ملاحظات إضافية

- تم إضافة إشعارات RAISE NOTICE في الوظيفة الجديدة لتسهيل تتبع العمليات وتصحيح الأخطاء. يمكن إزالتها في بيئة الإنتاج.
- إذا واجهت أي مشاكل بعد تطبيق الإصلاح، يرجى التحقق من سجلات الخطأ في قاعدة البيانات. 