# โ ุฅุตูุงุญ ุฏุงุฆู: ูุดููุฉ ูุฑุงุกุฉ ุงูุฌูุณุงุช ูุจู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช

## ๐ฏ ุงููุดููุฉ

ูุงู ุงููุธุงู ูุญุงูู ูุฑุงุกุฉ ุฌูุณุงุช ุงูุนูู (`work_sessions`) ูุจู ุฃู ุชููู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููุฃุฉ ุจุงููุงููุ ููุง ูุณุจุจ:

1. โ ุฃุฎุทุงุก `Database not initialized`
2. โ `Unhandled Promise Rejection`
3. โ๏ธ ุฌูุณุงุช ุชุธูุฑ ูุบูุฑ ูุชุฒุงููุฉ (`synced = 0`) ุฑุบู ุฃููุง ูุชุฒุงููุฉ ุจุงููุนู

---

## ๐ง ุงูุญููู ุงููุทุจูุฉ

### 1. ุฅุถุงูุฉ ุฏุงูุฉ `waitForReady` ูู `sqliteAPI.ts`

```typescript
async waitForReady(organizationId: string, timeoutMs: number = 5000): Promise<boolean>
```

- ุชูุชุธุฑ ุญุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุชุณุชุฎุฏู `DatabaseInitializationManager` ููุชุญูู
- ุญุฏ ุฃูุตู 5 ุซูุงูู (ูุงุจู ููุชุนุฏูู)

### 2. ุฅุถุงูุฉ Retry Logic ูู `getActiveOrPausedSession`

**ุงูููู:** `src/api/localWorkSessionService.ts`

**ุงูุชุบููุฑุงุช:**
- โ ุงูุชุธุงุฑ ุญุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุงููุฑุงุกุฉ
- โ Retry logic (3 ูุญุงููุงุช) ุนูุฏ ูุดู ุงููุฑุงุกุฉ ุจุณุจุจ ุนุฏู ุชููุฆุฉ DB
- โ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก

**ุงูููุฏ:**
```typescript
// โก CRITICAL FIX: ุงูุชุธุฑ ุญุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
const waitForDB = async (): Promise<boolean> => {
  // ูุญุต ูุจุงุดุฑ ุฃููุงู
  if (dbInitManager.isInitialized(organizationId)) {
    return true;
  }
  
  // ุงูุชุธุฑ ุญุชู ุงูุชููุฆุฉ (ุญุฏ ุฃูุตู 5 ุซูุงูู)
  // ...
};

// Retry logic: ูุญุงููุฉ ุญุชู 3 ูุฑุงุช
let retries = 3;
while (retries > 0) {
  try {
    // ุงูุชุธุฑ DB ุฅุฐุง ูุฒู ุงูุฃูุฑ
    if (isTauriEnv() && !window.electronAPI?.db) {
      const dbReady = await waitForDB();
      if (!dbReady && retries > 1) {
        await new Promise(resolve => setTimeout(resolve, 500));
        retries--;
        continue;
      }
    }
    
    // ูุญุงููุฉ ุงููุฑุงุกุฉ...
  } catch (error) {
    // ุฅุฐุง ูุดู ุจุณุจุจ ุนุฏู ุชููุฆุฉ DBุ ุฃุนุฏ ุงููุญุงููุฉ
    if (error?.message?.includes('not initialized') && retries > 1) {
      retries--;
      await new Promise(resolve => setTimeout(resolve, 500));
      continue;
    }
  }
}
```

### 3. ุฅุตูุงุญ `closeOldActiveSessions`

**ุงูููู:** `src/api/localWorkSessionService.ts`

**ุงูุชุบููุฑุงุช:**
- โ ุงูุชุธุงุฑ ุญุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุงููุฑุงุกุฉ
- โ Retry logic ุนูุฏ ูุดู ุงููุฑุงุกุฉ
- โ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก

### 4. ุฅุตูุงุญ `WorkSessionContext`

**ุงูููู:** `src/context/WorkSessionContext.tsx`

**ุงูุชุบููุฑุงุช:**
- โ ุงูุชุธุงุฑ ุญุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุจู ุฌูุจ ุงูุฌูุณุฉ
- โ ุชุฃุฎูุฑ ุจุณูุท (100ms) ูุจู ูุญุงููุฉ ุฌูุจ ุงูุฌูุณุฉ
- โ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก (ูุง ุชุนุฑุถ ุฎุทุฃ ุฅุฐุง ูุงูุช ุงููุดููุฉ ูู ุนุฏู ุชููุฆุฉ DB)
- โ ุงูุชุธุงุฑ ูุจู ุงุณุชุฏุนุงุก `closeOldActiveSessions`

---

## ๐ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ูุจู ุงูุฅุตูุงุญ:
```
โ [SQLiteWriteQueue] โ๏ธ Read called but DB not ready!
โ [SQLiteWriteQueue] โ TASK_FAILED: Database not initialized
โ Unhandled Promise Rejection: Error: Database not initialized
โ๏ธ 1/21 ุฌูุณุงุช ุบูุฑ ูุชุฒุงููุฉ (ุฑุบู ุฃููุง ูุชุฒุงููุฉ)
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
โ [WorkSessionContext] โ Database ready after 2341ms
โ [LocalWorkSession] โ ุชู ุงูุนุซูุฑ ุนูู ุฌูุณุฉ ูุญููุงู
โ 0/21 ุฌูุณุงุช ุบูุฑ ูุชุฒุงููุฉ (ุฌููุนูุง ูุชุฒุงููุฉ)
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุงูุชุญููู ุงูุฃููู:
- โ ูุชุญ ุงูุชุทุจูู
- โ ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก `Database not initialized`
- โ ุงูุชุญูู ูู ุฃู ุงูุฌูุณุงุช ุชูุฌูุจ ุจูุฌุงุญ

### 2. ุงุฎุชุจุงุฑ Retry Logic:
- โ ุฅููุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุคูุชุงู
- โ ูุญุงููุฉ ุฌูุจ ุงูุฌูุณุฉ
- โ ุงูุชุญูู ูู ุฅุนุงุฏุฉ ุงููุญุงููุฉ (3 ูุฑุงุช)

### 3. ุงุฎุชุจุงุฑ Timeout:
- โ ูุญุงูุงุฉ ุนุฏู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ุงูุชุญูู ูู timeout ุจุนุฏ 5 ุซูุงูู
- โ ุงูุชุญูู ูู ุฃู ุงูุชุทุจูู ูุง ูุชุนุทู

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. Timeout Values:
- `waitForDB`: 5 ุซูุงูู (ูุงุจู ููุชุนุฏูู)
- `closeOldActiveSessions`: 3 ุซูุงูู (ุฃูุตุฑ ูุฃููุง ุนูููุฉ ุซุงูููุฉ)
- Retry delay: 500ms ุจูู ุงููุญุงููุงุช

### 2. Performance:
- ุงูุชุฃุฎูุฑ ุงูุฅุถุงูู: ~2-3 ุซูุงูู ููุท ุนูุฏ ุงูุชุญููู ุงูุฃููู
- ุจุนุฏ ุงูุชููุฆุฉ: ูุง ููุฌุฏ ุชุฃุฎูุฑ (ูุญุต ูุจุงุดุฑ)
- ูุง ูุคุซุฑ ุนูู ุงูุฃุฏุงุก ุจุนุฏ ุงูุชุญููู

### 3. Error Handling:
- ุงูุฃุฎุทุงุก ุงููุชุนููุฉ ุจุนุฏู ุชููุฆุฉ DB ูุง ุชูุนุฑุถ ูุฃุฎุทุงุก
- ููุท ุงูุฃุฎุทุงุก ุงูุญููููุฉ ุชูุนุฑุถ
- `Unhandled Promise Rejection` ูู ูุญุฏุซ ุจุนุฏ ุงูุขู

---

## ๐ ุงูุชุญุฏูุซุงุช ุงููุณุชูุจููุฉ

ุฅุฐุง ุธูุฑุช ูุดุงูู ูุดุงุจูุฉ ูู ุฃูุงูู ุฃุฎุฑู:

1. **ุงุณุชุฎุฏู `dbInitManager.isInitialized()`** ููุชุญูู ูู ุงูุชููุฆุฉ
2. **ุฃุถู retry logic** ุนูุฏ ุงููุฑุงุกุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
3. **ุงูุชุธุฑ ุญุชู ุงูุชููุฆุฉ** ูุจู ุฃู ุนูููุฉ ูุฑุงุกุฉ/ูุชุงุจุฉ

---

## โ ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจุดูู ุฏุงุฆู ูู ุฎูุงู:

1. โ ุฅุถุงูุฉ ุงูุชุธุงุฑ ุญุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. โ ุฅุถุงูุฉ retry logic ููุนูููุงุช ุงูุญุณุงุณุฉ
3. โ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
4. โ ููุน `Unhandled Promise Rejection`

**ุงููุชูุฌุฉ:** ูู ุชุธูุฑ ุฌูุณุงุช ูุบูุฑ ูุชุฒุงููุฉ ุจุณุจุจ ูุดุงูู ุงูุชูููุช ุจุนุฏ ุงูุขู! ๐

























