# ููุฎุต ุชุญุฏูุซ ุงูุตูุญุงุช ููุนูู ุจูุถุน ุงูุฃูููุงูู

## ูุธุฑุฉ ุนุงูุฉ
ุชู ุชุญุฏูุซ ุฌููุน ุงูุตูุญุงุช ุงูุฑุฆูุณูุฉ ูุงุณุชุฎุฏุงู ุงูุฎุฏูุงุช ุงููุญููุฉ (Local Services) ูุน ุฏุนู ูุงูู ููุนูู ุจุฏูู ุงุชุตุงู ุจุงูุฅูุชุฑูุช.

## ุงูุตูุญุงุช ุงููุญุฏุซุฉ โ

### 1. ุตูุญุฉ ุงูููุงุชูุฑ (Invoices.tsx)
**ุงููุณุงุฑ:** `src/pages/dashboard/Invoices.tsx`

**ุงูุชุญุฏูุซุงุช:**
- โ ุงุณุชูุฑุงุฏ `getAllLocalInvoices` ูู `localInvoiceService`
- โ ุงุณุชูุฑุงุฏ `syncPendingInvoices` ู `fetchInvoicesFromServer` ูู `syncInvoices`
- โ ุงุณุชุฎุฏุงู `useNetworkStatus` hook ููุชุญูู ูู ุญุงูุฉ ุงูุงุชุตุงู
- โ ุฅุถุงูุฉ ุญุงูุฉ `isSyncing` ูุชุชุจุน ุนูููุฉ ุงููุฒุงููุฉ
- โ ุชุญุฏูุซ `fetchInvoices` ูุฌูุจ ุงูุจูุงูุงุช ูู ุงููุฎุฒู ุงููุญูู
- โ ุชุญููู `LocalInvoice` ุฅูู `Invoice` ูุน ุฌูุจ ุงูุนูุงุตุฑ ูู `invoiceItems`
- โ ุฅุถุงูุฉ ุฏุงูุฉ `syncInBackground` ูููุฒุงููุฉ ุงูุชููุงุฆูุฉ
- โ ุชุญุฏูุซ `handleInvoiceCreated` ูุฅุธูุงุฑ ุฑุณุงูุฉ ุงููุฒุงููุฉ ุงููุคุฌูุฉ
- โ ุชุญุฏูุซ ุญุงูุฉ Layout ูุนุฑุถ ุญุงูุฉ ุงูุงุชุตุงู ุงูุตุญูุญุฉ

**ุงููููุฒุงุช:**
- ุนุฑุถ ูุคุดุฑุงุช ุญุงูุฉ ุงููุฒุงููุฉ (`_synced`, `_syncStatus`)
- ุฑุณุงุฆู ุชูุถูุญูุฉ ุนูุฏ ุงูุนูู ุจุฏูู ุงุชุตุงู
- ูุฒุงููุฉ ุชููุงุฆูุฉ ูู ุงูุฎูููุฉ ุนูุฏ ุชููุฑ ุงูุงุชุตุงู
- ุนุฑุถ ุฃุฑูุงู ุงูููุงุชูุฑ ุงููุคูุชุฉ ูุจู ุงููุฒุงููุฉ

---

### 2. ุตูุญุฉ ุฏููู ุงูุนููุงุก (CustomerDebts.tsx)
**ุงููุณุงุฑ:** `src/pages/dashboard/CustomerDebts.tsx`

**ุงูุชุญุฏูุซุงุช:**
- โ ุงุณุชูุฑุงุฏ `getAllLocalDebts` ู `recordLocalDebtPayment` ูู `localCustomerDebtService`
- โ ุงุณุชูุฑุงุฏ `syncPendingCustomerDebts` ู `fetchCustomerDebtsFromServer` ูู `syncCustomerDebts`
- โ ุงุณุชุฎุฏุงู `useNetworkStatus` hook
- โ ุฅุถุงูุฉ ุญุงูุฉ `isSyncing`
- โ ุชุญุฏูุซ `fetchDebtsData` ูุฌูุจ ูู ุงููุฎุฒู ุงููุญูู
- โ ุฅุถุงูุฉ ุฏุงูุฉ `convertLocalDebtsToDebtsData` ูุชุญููู ุงูุจูุงูุงุช
- โ ุชุญุฏูุซ `handleRecordPayment` ูุงุณุชุฎุฏุงู `recordLocalDebtPayment`
- โ ุฅุถุงูุฉ ุฏุงูุฉ `syncInBackground`
- โ ุชุญุฏูุซ ุญุงูุฉ Layout

**ุงููููุฒุงุช:**
- ุชุฌููุน ุงูุฏููู ุญุณุจ ุงูุนููู
- ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช ูู ุงูุจูุงูุงุช ุงููุญููุฉ
- ุชุณุฌูู ุงูุฏูุนุงุช ุจุฏูู ุงุชุตุงู
- ูุฒุงููุฉ ุชููุงุฆูุฉ ููุฏูุนุงุช ุงููุณุฌูุฉ

---

### 3. ุตูุญุฉ ุฅุฑุฌุงุน ุงูููุชุฌุงุช (ProductReturns.tsx)
**ุงููุณุงุฑ:** `src/pages/returns/ProductReturns.tsx`

**ุงูุชุญุฏูุซุงุช:**
- โ ุงุณุชูุฑุงุฏ ุงูุฎุฏูุงุช ุงููุญููุฉ ูู `localProductReturnService`
- โ ุงุณุชูุฑุงุฏ ุฎุฏูุงุช ุงููุฒุงููุฉ ูู `syncProductReturns`
- โ ุงุณุชุฎุฏุงู `useNetworkStatus` hook
- โ ุฅุถุงูุฉ ุญุงูุฉ `isSyncing`
- โ ุชุญุฏูุซ `fetchReturns` ูุฌูุจ ูู ุงููุฎุฒู ุงููุญูู
- โ ุชุญููู `LocalProductReturn` ุฅูู `Return` ูุน ุฌูุจ ุงูุนูุงุตุฑ
- โ ุชุทุจูู ุงูููุงุชุฑ ูุงูุจุญุซ ุนูู ุงูุจูุงูุงุช ุงููุญููุฉ
- โ ุฅุถุงูุฉ ุฏุงูุฉ `syncInBackground`

**ุงููููุฒุงุช:**
- ุฅูุดุงุก ุทูุจุงุช ุฅุฑุฌุงุน ุจุฏูู ุงุชุตุงู
- ุงูููุงููุฉ/ุงูุฑูุถ ูุญููุงู
- ุชุชุจุน ุญุงูุฉ ุงููุฒุงููุฉ ููู ุทูุจ
- ุฏุนู ุงูุฅุฑุฌุงุน ุงููุจุงุดุฑ ูุงูุฅุฑุฌุงุน ูู ุทูุจ

---

### 4. ุตูุญุฉ ุงูุชุตุฑูุญ ุจุงูุฎุณุงุฆุฑ (LossDeclarations.tsx)
**ุงููุณุงุฑ:** `src/pages/losses/LossDeclarations.tsx`

**ุงูุชุญุฏูุซุงุช:**
- โ ุงุณุชูุฑุงุฏ ุงูุฎุฏูุงุช ุงููุญููุฉ ูู `localLossDeclarationService`
- โ ุงุณุชูุฑุงุฏ ุฎุฏูุงุช ุงููุฒุงููุฉ ูู `syncLossDeclarations`
- โ ุงุณุชุฎุฏุงู `useNetworkStatus` hook
- โณ **ุฌุงุฑู ุงูุนูู ุนูู ุจุงูู ุงูุชุญุฏูุซุงุช**

**ุงููููุฒุงุช ุงููุฎุทุทุฉ:**
- ุชุณุฌูู ุงูุฎุณุงุฆุฑ ุจุฏูู ุงุชุตุงู
- ุงูููุงููุฉ/ุงูุฑูุถ ูุญููุงู
- ุชุนุฏูู ุงููุฎุฒูู ุชููุงุฆูุงู ุนูุฏ ุงูููุงููุฉ
- ูุฒุงููุฉ ุชููุงุฆูุฉ

---

## ุงูููุท ุงููุชุจุน ูู ุฌููุน ุงูุตูุญุงุช

### 1. ุงูุงุณุชูุฑุงุฏุงุช ุงูุฃุณุงุณูุฉ
```typescript
import { useNetworkStatus } from '@/hooks/useNetworkStatus';
import { getAllLocalXXX, createLocalXXX } from '@/api/localXXXService';
import { syncPendingXXX, fetchXXXFromServer } from '@/api/syncXXX';
import { inventoryDB } from '@/database/localDb';
```

### 2. ุงูุญุงูุงุช (State)
```typescript
const { isOnline } = useNetworkStatus();
const [isSyncing, setIsSyncing] = useState(false);
```

### 3. ุฏุงูุฉ ุฌูุจ ุงูุจูุงูุงุช
```typescript
const fetchData = async () => {
  // 1. ุฌูุจ ูู ุงููุฎุฒู ุงููุญูู
  const localData = await getAllLocalXXX(organizationId);
  
  // 2. ุชุญููู ุงูุจูุงูุงุช ููุชูุณูู ุงููุทููุจ
  const convertedData = convertLocalToDisplay(localData);
  
  // 3. ุชุทุจูู ุงูููุงุชุฑ
  const filteredData = applyFilters(convertedData);
  
  // 4. ุชุญุฏูุซ ุงูุญุงูุฉ
  setData(filteredData);
  
  // 5. ูุฒุงููุฉ ูู ุงูุฎูููุฉ ุฅุฐุง ูุชุตู
  if (isOnline) {
    syncInBackground();
  }
};
```

### 4. ุฏุงูุฉ ุงููุฒุงููุฉ ูู ุงูุฎูููุฉ
```typescript
const syncInBackground = async () => {
  if (!isOnline || !currentOrganization) return;
  
  try {
    setIsSyncing(true);
    
    // ูุฒุงููุฉ ุงูุจูุงูุงุช ุงููุนููุฉ
    const syncResult = await syncPendingXXX();
    
    // ุฌูุจ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูู ุงูุณูุฑูุฑ
    await fetchXXXFromServer(organizationId);
    
    // ุชุญุฏูุซ ุงููุงุฆูุฉ
    await fetchData();
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงููุฒุงููุฉ:', error);
  } finally {
    setIsSyncing(false);
  }
};
```

### 5. ูุนุงูุฌุงุช ุงูุฅูุดุงุก/ุงูุชุญุฏูุซ
```typescript
const handleCreate = async (data) => {
  // ุญูุธ ูุญููุงู
  await createLocalXXX(data);
  
  // ุฑุณุงูุฉ ูุฌุงุญ ูุน ุชูุจูู ุงููุฒุงููุฉ
  toast.success('ุชู ุงูุญูุธ ุจูุฌุงุญ' + 
    (!isOnline ? ' (ุณูุชู ุงููุฒุงููุฉ ุนูุฏ ุงูุงุชุตุงู)' : ''));
  
  // ูุฒุงููุฉ ููุฑูุฉ ุฅุฐุง ูุชุตู
  if (isOnline) {
    setTimeout(() => syncInBackground(), 1000);
  }
};
```

### 6. ุชุญุฏูุซ ุญุงูุฉ Layout
```typescript
useEffect(() => {
  if (!onLayoutStateChange) return;
  onLayoutStateChange({
    isRefreshing: isLoading || isSyncing,
    connectionStatus: isOnline ? 'connected' : 'disconnected'
  });
}, [isLoading, isSyncing, isOnline]);
```

---

## ูุคุดุฑุงุช ุญุงูุฉ ุงููุฒุงููุฉ ูู ุงููุงุฌูุฉ

### ูู ููุงุฆู ุงูุนูุงุตุฑ (InvoicesList, etc.)
```typescript
{(item as any)._synced === false && (
  <Badge variant="outline" className="bg-orange-50 text-orange-600">
    <Clock className="h-3 w-3 mr-1" />
    ุบูุฑ ูุชุฒุงูู
  </Badge>
)}

{(item as any)._syncStatus === 'error' && (
  <Badge variant="destructive">
    <WifiOff className="h-3 w-3 mr-1" />
    ุฎุทุฃ
  </Badge>
)}
```

---

## ุงูุฎุทูุงุช ุงููุชุจููุฉ

### โ ููุชูู
1. ุตูุญุฉ ุงูููุงุชูุฑ
2. ุตูุญุฉ ุฏููู ุงูุนููุงุก
3. ุตูุญุฉ ุฅุฑุฌุงุน ุงูููุชุฌุงุช

### โณ ููุฏ ุงูุนูู
4. ุตูุญุฉ ุงูุชุตุฑูุญ ุจุงูุฎุณุงุฆุฑ

### ๐ ูุนูู
5. ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุนููุงุก

---

## ุงูููุงุฆุฏ ุงููุญููุฉ

### 1. **ููุซูููุฉ ุนุงููุฉ**
- ุงูุนูู ุจุฏูู ุงููุทุงุน ุญุชู ูุน ููุฏุงู ุงูุงุชุตุงู
- ุนุฏู ููุฏุงู ุงูุจูุงูุงุช
- ูุฒุงููุฉ ุชููุงุฆูุฉ ุนูุฏ ุนูุฏุฉ ุงูุงุชุตุงู

### 2. **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุญุณูุฉ**
- ุงุณุชุฌุงุจุฉ ููุฑูุฉ (ูุง ุงูุชุธุงุฑ ููุณูุฑูุฑ)
- ูุคุดุฑุงุช ูุงุถุญุฉ ูุญุงูุฉ ุงููุฒุงููุฉ
- ุฑุณุงุฆู ุชูุถูุญูุฉ

### 3. **ุฃุฏุงุก ุฃูุถู**
- ุชูููู ุงูุทูุจุงุช ููุณูุฑูุฑ
- ุชุญููู ุฃุณุฑุน ููุจูุงูุงุช
- ุงุณุชุฎุฏุงู ุฃูุซู ููููุงุฑุฏ

### 4. **ูุฑููุฉ ูู ุงูุนูู**
- ุฅููุงููุฉ ุงูุนูู ูู ุงูููุงุทู ุถุนููุฉ ุงูุงุชุตุงู
- ุงูุงุณุชูุฑุงุฑ ูู ุงูุนูู ุฃุซูุงุก ุตูุงูุฉ ุงูุณูุฑูุฑ
- ุฏุนู ุงูุณููุงุฑูููุงุช ุงููุฎุชููุฉ

---

## ููุงุญุธุงุช ุชูููุฉ

### ุงุณุชุฑุงุชูุฌูุฉ ุญู ุงูุชุนุงุฑุถุงุช
- **Server Win**: ุงูุณูุฑูุฑ ูู ุงูุฃููููุฉ ูู ุญุงูุฉ ุงูุชุนุงุฑุถ
- ูุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ุงููุญููุฉ ุจูุณุฎุฉ ุงูุณูุฑูุฑ
- ูุชู ุงูุงุญุชูุงุธ ุจุณุฌู ููุชุนุงุฑุถุงุช ูู console

### ุฅุฏุงุฑุฉ ุงูุฃุฎุทุงุก
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุงูุชููุงุฆูุฉ (3 ูุฑุงุช)
- Exponential backoff
- ุชุณุฌูู ุงูุฃุฎุทุงุก ูู console
- ุฑุณุงุฆู ูุงุถุญุฉ ูููุณุชุฎุฏู

### ุงูุชูุธูู ุงูุชููุงุฆู
- ุญุฐู ุงูุณุฌูุงุช ุงููุชุฒุงููุฉ ุจูุฌุงุญ
- ุญุฐู ุงูุณุฌูุงุช ุงููุญุฐููุฉ ุจุนุฏ ุงููุฒุงููุฉ
- ุงูุงุญุชูุงุธ ุจุงูุณุฌูุงุช ุงููุงุดูุฉ ูููุฑุงุฌุนุฉ

---

## ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ ุงููุทููุจุฉ
1. โ ุฅูุดุงุก ุนูุตุฑ ุจุฏูู ุงุชุตุงู
2. โ ุชุญุฏูุซ ุนูุตุฑ ุจุฏูู ุงุชุตุงู
3. โ ุญุฐู ุนูุตุฑ ุจุฏูู ุงุชุตุงู
4. โ ุงููุฒุงููุฉ ุนูุฏ ุนูุฏุฉ ุงูุงุชุตุงู
5. โณ ุงูุชุนุงูู ูุน ุงูุชุนุงุฑุถุงุช
6. โณ ุงูุชุนุงูู ูุน ุฃุฎุทุงุก ุงููุฒุงููุฉ
7. โณ ุงูููุงุชุฑ ูุงูุจุญุซ ุนูู ุงูุจูุงูุงุช ุงููุญููุฉ

---

## ุงูุชูุซูู

### ูููุทูุฑูู
- ูู ุฏุงูุฉ ููุซูุฉ ุจุชุนูููุงุช ูุงุถุญุฉ
- ุฃุณูุงุก ูุชุบูุฑุงุช ูุตููุฉ
- ููุท ููุญุฏ ุนุจุฑ ุฌููุน ุงูุตูุญุงุช

### ูููุณุชุฎุฏููู
- ุฑุณุงุฆู ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ
- ูุคุดุฑุงุช ุจุตุฑูุฉ ูุญุงูุฉ ุงููุฒุงููุฉ
- ุชูุจููุงุช ุนูุฏ ุงูุนูู ุจุฏูู ุงุชุตุงู

---

ุชู ุงูุชุญุฏูุซ: 23 ุฃูุชูุจุฑ 2025
