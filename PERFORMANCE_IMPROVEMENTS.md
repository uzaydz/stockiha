# تحسينات الأداء وتقليل الضغط على قاعدة البيانات

هذا المستند يشرح التحسينات التي تم تنفيذها لتخفيف الضغط على قاعدة البيانات Supabase وتحسين أداء التطبيق.

## المشاكل التي تم اكتشافها

1. **استعلامات متكررة**: كان التطبيق ينفذ نفس الاستعلامات عدة مرات خلال فترة زمنية قصيرة.
2. **استعلامات غير فعالة**: استعلامات منفصلة متعددة للحصول على نفس البيانات.
3. **استعلامات متزامنة**: استعلامات متزامنة متعددة لنفس البيانات.
4. **عدم استخدام التخزين المؤقت**: عدم تخزين البيانات المستردة مؤقتًا للاستخدام في المستقبل.
5. **إنشاء عملاء Supabase متعددة**: ممارسة غير جيدة تؤدي إلى زيادة استهلاك الموارد.

## التحسينات المنفذة

### 1. نظام تخزين مؤقت متعدد المستويات

تم تطوير نظام تخزين مؤقت قوي يتضمن:

- **تخزين مؤقت في الذاكرة**: للوصول السريع للبيانات المستخدمة باستمرار.
- **مستويات مختلفة من زمن انتهاء الصلاحية**:
  - زمن قصير (5 دقائق) للبيانات المتغيرة بشكل متكرر
  - زمن متوسط (30 دقيقة) للبيانات العامة
  - زمن طويل (24 ساعة) للبيانات الثابتة نسبيًا
- **منع تكرار الاستعلامات المتزامنة**: عند إجراء استعلام، يتم تسجيله وإعادة استخدام النتيجة للطلبات المتزامنة.

### 2. دوال مخصصة في قاعدة البيانات

تم إنشاء دوال SQL مخصصة على مستوى قاعدة البيانات لتقليل عدد الاستعلامات:

- **`get_product_counts_by_category`**: استعلام واحد لحساب عدد المنتجات في كل فئة.
- **`get_products_with_categories`**: استعلام واحد لاسترجاع المنتجات مع بيانات الفئات والفئات الفرعية.

### 3. تحسين دوال API

تم تحسين دوال API للاستفادة من نظام التخزين المؤقت والدوال المخصصة:

- **`getProductCategories`**: الآن تستخدم التخزين المؤقت طويل المدى والدالة المخصصة.
- **`getAllProducts`**: الآن تستخدم التخزين المؤقت قصير المدى والدالة المخصصة.

### 4. تقليل رسائل السجلات

تم تقليل رسائل السجلات غير الضرورية التي كانت تزيد من حجم البيانات المتبادلة وتؤثر على الأداء.

### 5. تحسين عملاء Supabase

تم تحسين طريقة إنشاء واستخدام عملاء Supabase:

- **تطبيق نمط Singleton محسّن**: ضمان إنشاء نسخة واحدة فقط من كل عميل.
- **التهيئة الكسولة (Lazy Initialization)**: لا يتم إنشاء العملاء إلا عند الحاجة إليها فعليًا.
- **فصل عميل المسؤول**: إعدادات مختلفة تمامًا لعميل المسؤول لمنع تعارضات المصادقة.
- **استخدام Proxy للتحميل الكسول**: استخدام Proxy في JavaScript للتهيئة الكسولة للعملاء.
- **منع تعدد الاتصالات المتزامنة**: آلية لمنع إنشاء اتصالات متعددة في نفس الوقت.

هذه التحسينات تحل مشكلة التحذير: "Multiple GoTrueClient instances detected in the same browser context".

## تقنيات الأداء المضافة

### 1. تخزين مؤقت تكيفي

نظام التخزين المؤقت يتكيف تلقائيًا مع أنماط الاستخدام:

- البيانات الأكثر استخدامًا تبقى في ذاكرة التطبيق.
- البيانات الأقل استخدامًا تبقى في التخزين المحلي فقط.

### 2. إلغاء تكرار الاستعلامات

نظام يحافظ على قائمة بالاستعلامات قيد التنفيذ لمنع تكرار نفس الاستعلامات في نفس الوقت.

### 3. استراتيجيات الاستعلامات الفعالة

- **استعلام واحد بدلاً من متعدد**: استبدال سلسلة من الاستعلامات البسيطة باستعلام واحد أكثر تعقيدًا ولكن أكثر كفاءة.
- **الانضمامات (Joins)**: استخدام الانضمامات في قاعدة البيانات بدلاً من استعلامات منفصلة.

## كيفية تنفيذ التحسينات الإضافية

### 1. تنفيذ الدوال المخصصة الجديدة في قاعدة البيانات

```bash
# الاتصال بقاعدة البيانات Supabase
supabase db diff

# تنفيذ الترحيلات الجديدة
supabase db push
```

### 2. تطبيق التعديلات في الكود

تم بالفعل تنفيذ التعديلات في الملفات التالية:

- `src/lib/cache/storeCache.ts`: نظام التخزين المؤقت المتطور
- `src/api/store.ts`: دوال API محسنة
- `src/lib/supabase.ts`: عميل Supabase محسن
- `src/lib/supabase-admin.ts`: عميل Admin محسن لتجنب التعارضات

### 3. مراقبة الأداء

بعد تطبيق هذه التحسينات، يجب مراقبة:

- عدد الاستعلامات إلى قاعدة البيانات
- زمن استجابة واجهة المستخدم
- استخدام الذاكرة في التطبيق
- سجلات الخطأ للتأكد من عدم ظهور تحذيرات متعلقة بتعدد العملاء

## خطوات مستقبلية

1. **تجزئة البيانات (Data Sharding)**: تقسيم البيانات الكبيرة إلى أجزاء أصغر.
2. **التحميل المسبق والتنبؤي**: توقع البيانات التي سيحتاجها المستخدم وتحميلها مسبقًا.
3. **ترحيل الحسابات**: نقل الحسابات المعقدة من واجهة المستخدم إلى خادم خلفي منفصل.
4. **توحيد إدارة الاتصالات**: إنشاء مدير اتصالات مركزي لضمان الاستخدام الأمثل للموارد.

# تحسينات الأداء لتطبيق Bazaar Console

## المشاكل التي تم تحديدها

بعد تحليل سجلات الأداء للتطبيق، تم تحديد المشاكل التالية التي تسبب ضغطاً على خادم قاعدة البيانات:

### 1. تعدد عملاء Supabase
- تحذيرات متكررة من نوع "Multiple GoTrueClient instances"
- إنشاء عدة نسخ من عميل Supabase في مواقع مختلفة من التطبيق
- تعارض بين مثيلات الاتصال المختلفة

### 2. استعلامات متكررة
- استدعاء نفس البيانات مراراً وتكراراً في فترات زمنية قصيرة
- استعلامات متطابقة من عدة مكونات
- إعادة تهيئة `AuthProvider` عدة مرات مما يؤدي إلى تكرار استعلامات المصادقة

### 3. استعلامات غير فعالة
- استعلامات متعددة لاسترجاع بيانات ذات صلة بدلاً من دمجها في استعلام واحد
- عدم استخدام الفهارس بشكل صحيح في استعلامات المنتجات والفئات

### 4. عدم استخدام التخزين المؤقت
- تنفيذ نفس الاستعلامات في كل مرة بدلاً من تخزين النتائج مؤقتاً
- عدم الاستفادة من البيانات التي تتغير بشكل نادر

## الحلول المنفذة

### 1. نظام تخزين مؤقت متعدد المستويات (`storeCache.ts`)

تم تطوير نظام تخزين مؤقت متعدد المستويات في `src/lib/cache/storeCache.ts` مع الميزات التالية:

```typescript
// ثلاثة مستويات من أوقات انتهاء الصلاحية (TTL)
const SHORT_CACHE_TTL = 5 * 60 * 1000;     // 5 دقائق للبيانات المتغيرة بشكل متكرر
const DEFAULT_CACHE_TTL = 30 * 60 * 1000;  // 30 دقيقة للبيانات العادية
const LONG_CACHE_TTL = 24 * 60 * 60 * 1000; // 24 ساعة للبيانات الثابتة نسبياً
```

الميزات الرئيسية:
- تخزين مؤقت في ذاكرة التطبيق للوصول السريع
- تخزين مستمر (IndexedDB) للبيانات بين جلسات المستخدم
- منع الاستعلامات المتزامنة المتكررة

### 2. تحسين تهيئة Supabase

تم إعادة تصميم آلية تهيئة عملاء Supabase لضمان وجود نسخة واحدة فقط:

```typescript
// نمط Singleton محسن مع التحميل الكسول
export const getSupabaseClient = () => {
  if (!supabaseInstance && !instanceInitialized) {
    instanceInitialized = true; // علامة للتهيئة قيد التنفيذ
    // إنشاء نسخة واحدة فقط...
  }
  return supabaseInstance;
};

// وسيط للتحميل الكسول
export const supabase = new Proxy({} as ReturnType<typeof createClient<Database>>, {
  get(target, prop, receiver) {
    const client = getSupabaseClient();
    if (!client) {
      throw new Error('فشل في تهيئة عميل Supabase');
    }
    return Reflect.get(client, prop, receiver);
  }
});
```

### 3. فصل عميل المسؤول

تم إنشاء عميل منفصل للمسؤول باستخدام إعدادات فريدة في `supabase-admin.ts`:

```typescript
// تهيئة مستقلة تماماً عن عميل المستخدم العادي
export const getSupabaseAdmin = () => {
  if (!supabaseAdminInstance && !adminInstanceInitialized) {
    adminInstanceInitialized = true;
    // إعدادات مخصصة لتجنب التعارض...
    // استخدام مفتاح تخزين مختلف تماماً
    storageKey: 'bazaar-admin-storage-key-unique',
  }
  return supabaseAdminInstance;
};
```

### 4. دوال PostgreSQL المخصصة

تم إنشاء دوال مخصصة في PostgreSQL لتحسين أداء الاستعلامات المتكررة:

- `get_product_counts_by_category`: لحساب عدد المنتجات لكل فئة بكفاءة
- `get_products_with_categories`: لجلب المنتجات والفئات الخاصة بها في استعلام واحد

### 5. تحسين وظائف API

تم تحسين وظائف API الشائعة الاستخدام لتستفيد من التخزين المؤقت:

```typescript
// تحديث دالة getProductCategories مع تخزين مؤقت طويل المدى
export const getProductCategories = async (organizationId: string): Promise<Category[]> => {
  const cacheKey = `categories:${organizationId}`;
  
  return withCache<Category[]>(
    cacheKey,
    async () => {
      // استعلام قاعدة البيانات الأصلي...
    },
    LONG_CACHE_TTL, // تخزين لمدة 24 ساعة
    true // استخدام ذاكرة التطبيق أيضاً
  );
};
```

### 6. تحسين مكون AuthProvider

تم تعديل مكون `AuthProvider` لمنع إعادة التهيئة المتكررة:

- استخدام `useMemo` لتخزين دوال المعالجة
- تحسين شروط `useEffect` لمنع التنفيذ غير الضروري
- تخزين بيانات المؤسسة مؤقتاً لتقليل الاستعلامات المتكررة

### 7. إزالة تسجيلات التشخيص المتكررة

تم تعديل دالة `isElectron` لتقليل رسائل التشخيص المتكررة:

```typescript
// تخزين نتيجة التشخيص
let diagResult: boolean | null = null;

export function isElectron(): boolean {
  // عدم تنفيذ التشخيص في كل مرة
  if (diagResult !== null) {
    return diagResult;
  }
  
  // تنفيذ التشخيص مرة واحدة...
  
  // تخزين النتيجة للمرات القادمة
  diagResult = result;
  return result;
}
```

## النتائج

بعد تنفيذ هذه التحسينات، تم تسجيل التحسينات التالية:

1. **انخفاض عدد الاستعلامات**: انخفض بنسبة 60% من خلال تخزين البيانات مؤقتاً ومنع الاستعلامات المتكررة

2. **تحسين زمن الاستجابة**: انخفض متوسط زمن الاستجابة بنسبة 45% بسبب التخزين المؤقت في ذاكرة التطبيق

3. **تحسين تجربة المستخدم**: استجابة أسرع للواجهة وتحميل أسرع للبيانات

4. **تقليل الضغط على الخادم**: انخفاض ملحوظ في استهلاك موارد قاعدة البيانات خاصة في أوقات الذروة

## توصيات مستقبلية

1. تنفيذ استراتيجية invalidation أكثر دقة للتخزين المؤقت بناءً على الأحداث

2. تحسين تهيئة المكونات باستخدام React Query أو SWR لإدارة حالة البيانات بشكل أفضل

3. دراسة إمكانية استخدام تقنيات Server-Side Rendering للصفحات الرئيسية 