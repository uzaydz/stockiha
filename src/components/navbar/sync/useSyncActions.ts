/**
 * âš¡ Hook Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
 * @version 2.0.0
 * 
 * Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:
 * - ØªÙƒØ§Ù…Ù„ Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ PowerSync
 * - Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­Ø³Ù‘Ù†Ø©
 * - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø©
 */

import { useState, useCallback, useRef } from 'react';
import { toast } from 'sonner';
import { powerSyncService } from '@/lib/powersync/PowerSyncService';

const isDev = process.env.NODE_ENV === 'development';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”¹ Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface UseSyncActionsOptions {
  organizationId: string | undefined;
  isOnline: boolean;
  onSyncComplete?: () => void;
}

interface UseSyncActionsResult {
  isSyncing: boolean;
  isFullSyncing: boolean;
  isForceSending: boolean;
  lastSyncAt: number | null;
  lastSyncError: string | null;
  runSync: (origin?: 'auto' | 'manual') => Promise<void>;
  runFullSync: () => Promise<void>;
  forceSendPending: () => Promise<void>;
  clearPendingOutbox: () => Promise<void>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”¹ Hook
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function useSyncActions({
  organizationId,
  isOnline,
  onSyncComplete
}: UseSyncActionsOptions): UseSyncActionsResult {
  
  // âš¡ Ø§Ù„Ø­Ø§Ù„Ø§Øª
  const [isSyncing, setIsSyncing] = useState(false);
  const [isFullSyncing, setIsFullSyncing] = useState(false);
  const [isForceSending, setIsForceSending] = useState(false);
  const [lastSyncError, setLastSyncError] = useState<string | null>(null);
  const [lastSyncAt, setLastSyncAt] = useState<number | null>(() => {
    if (typeof window === 'undefined') return null;
    const saved = localStorage.getItem('navbarSync_lastSyncAt');
    return saved ? Number(saved) : null;
  });

  const syncingRef = useRef(false);

  // âš¡ ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©
  const updateLastSyncAt = useCallback((time: number) => {
    setLastSyncAt(time);
    localStorage.setItem('navbarSync_lastSyncAt', String(time));
  }, []);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ”¹ Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ø§Ø¯ÙŠØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const runSync = useCallback(async (origin: 'auto' | 'manual' = 'auto') => {
    if (!organizationId) return;

    if (!isOnline) {
      if (origin === 'manual') {
        toast.error('ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', {
          description: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©'
        });
      }
      return;
    }

    if (syncingRef.current) return;

    syncingRef.current = true;
    setIsSyncing(true);
    setLastSyncError(null);

    try {
      if (isDev) {
        console.log('[useSyncActions] âš¡ Starting PowerSync...');
      }

      // âš¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
      const isReady = await powerSyncService.waitForInitialization(5000);
      if (!isReady) {
        if (origin === 'manual') {
          toast.info('Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...', {
            description: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©'
          });
        }
        return;
      }

      // âš¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
      await powerSyncService.forceSync();

      updateLastSyncAt(Date.now());

      if (origin === 'manual') {
        toast.success('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', {
          description: 'âš¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©'
        });
      }

      onSyncComplete?.();

    } catch (error) {
      const message = error instanceof Error ? error.message : 'ÙØ´Ù„ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';

      // âš¡ ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
      if (message.includes('Not initialized') || message.includes('Database not initialized')) {
        if (isDev) {
          console.log('[useSyncActions] â³ Not initialized, will retry later');
        }
        return;
      }

      setLastSyncError(message);

      if (origin === 'manual') {
        toast.error('ØªØ¹Ø°Ø± Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', { 
          description: getErrorMessageAr(message)
        });
      }

      if (isDev) {
        console.error('[useSyncActions] Error:', error);
      }
    } finally {
      syncingRef.current = false;
      setIsSyncing(false);
    }
  }, [organizationId, isOnline, updateLastSyncAt, onSyncComplete]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ”¹ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const runFullSync = useCallback(async () => {
    if (!organizationId) {
      toast.error('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', { 
        description: 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ø¨Ø¹Ø¯' 
      });
      return;
    }

    if (!isOnline) {
      toast.error('ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', { 
        description: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£ÙˆÙ„Ø§Ù‹' 
      });
      return;
    }

    if (isFullSyncing || isSyncing) {
      toast.info('Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠØ© Ø¨Ø§Ù„ÙØ¹Ù„');
      return;
    }

    setIsFullSyncing(true);
    setLastSyncError(null);

    const loadingToast = toast.loading('Ø¬Ø§Ø±Ù Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...', {
      description: 'ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±'
    });

    try {
      // âš¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
      const isReady = await powerSyncService.waitForInitialization(10000);
      if (!isReady) {
        toast.dismiss(loadingToast);
        toast.info('Ø¬Ø§Ø±Ù ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...', { 
          description: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©' 
        });
        return;
      }

      // âš¡ Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      await powerSyncService.forceSync();

      toast.dismiss(loadingToast);
      toast.success('ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', {
        description: 'âš¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„'
      });

      updateLastSyncAt(Date.now());
      onSyncComplete?.();

    } catch (error) {
      const message = error instanceof Error ? error.message : 'ÙØ´Ù„ ÙÙŠ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';

      setLastSyncError(message);

      toast.dismiss(loadingToast);
      toast.error('ÙØ´Ù„ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©', { 
        description: getErrorMessageAr(message)
      });

      if (isDev) {
        console.error('[useSyncActions] Full sync error:', error);
      }
    } finally {
      setIsFullSyncing(false);
    }
  }, [organizationId, isOnline, isFullSyncing, isSyncing, updateLastSyncAt, onSyncComplete]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const forceSendPending = useCallback(async () => {
    if (!isOnline) {
      toast.error('ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', {
        description: 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£ÙˆÙ„Ø§Ù‹'
      });
      return;
    }

    if (isForceSending) {
      toast.info('Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¬Ø§Ø±Ù Ø¨Ø§Ù„ÙØ¹Ù„');
      return;
    }

    setIsForceSending(true);
    const loadingToast = toast.loading('Ø¬Ø§Ø±Ù Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©...', {
      description: 'ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±'
    });

    try {
      await powerSyncService.forceSync();

      toast.dismiss(loadingToast);
      toast.success('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­', {
        description: 'âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ØªÙ… Ø±ÙØ¹Ù‡Ø§'
      });

      onSyncComplete?.();
    } catch (error) {
      toast.dismiss(loadingToast);
      toast.error('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª', {
        description: error instanceof Error ? error.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'
      });
    } finally {
      setIsForceSending(false);
    }
  }, [isOnline, isForceSending, onSyncComplete]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ”¹ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const clearPendingOutbox = useCallback(async () => {
    toast.info('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', {
      description: 'PowerSync ÙŠØ¯ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹'
    });
  }, []);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ”¹ Return
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  return {
    isSyncing,
    isFullSyncing,
    isForceSending,
    lastSyncAt,
    lastSyncError,
    runSync,
    runFullSync,
    forceSendPending,
    clearPendingOutbox
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”¹ Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getErrorMessageAr(error: string): string {
  if (error.includes('PSYNC_S2002')) {
    return 'Sync Rules ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±Ø© - ÙŠØ±Ø¬Ù‰ Ù†Ø´Ø±Ù‡Ø§ Ù…Ù† PowerSync Dashboard';
  }
  if (error.includes('network') || error.includes('fetch')) {
    return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª';
  }
  if (error.includes('auth') || error.includes('token')) {
    return 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
  }
  if (error.includes('timeout')) {
    return 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ - ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
  }
  return error;
}
