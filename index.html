<!DOCTYPE html>
<html lang="ar" dir="rtl" class="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- إزالة وسوم http-equiv غير الصحيحة للضغط لتفادي سلوك غير متوقع في المتصفحات/الوكلاء -->
    
    <!-- سياسة الأمان تُدار من خلال Vite middleware بدلاً من meta element لتجنب مشاكل frame-ancestors -->

    <title>جاري التحميل...</title>
    <meta name="description" content="سطوكيها - منصة إدارة المتاجر الذكية لإنشاء متجرك الإلكتروني وإدارة المبيعات والمخزون بكل سهولة" />
    <meta name="author" content="سطوكيها" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/logo-new.webp">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/logo-new.webp">
    
    <!-- 🚀 تحميل الخطوط المحلية محسن للأداء - preload أساسي فقط -->
    <link rel="preload" as="font" href="/fonts/tajawal-regular.woff2" type="font/woff2" crossorigin="anonymous">
    
    <!-- تحميل CSS الخطوط فوراً لتجنب FOUT -->
    <link rel="stylesheet" href="/fonts/tajawal.css">
    
    <!-- تحميل CSS الرئيسي - ضروري للتطبيق -->
    <link rel="stylesheet" href="/src/index.css">
    
    <!-- تحسين إضافي: تحميل الخطوط الإضافية عند الحاجة -->
    <script nonce="{{CSP_NONCE}}">
      // Smart font loading strategy
      (function() {
        var fontsLoaded = false;
        
        // Function to load additional fonts
        function loadAdditionalFonts() {
          if (fontsLoaded) return;
          fontsLoaded = true;
          
          var additionalFonts = [
            '/fonts/tajawal-medium.woff2',
            '/fonts/tajawal-bold.woff2'
          ];
          
          additionalFonts.forEach(function(fontUrl) {
            var link = document.createElement('link');
            // استخدم prefetch بدلاً من preload لتجنّب تحذير "preloaded but not used"
            link.rel = 'prefetch';
            link.as = 'font';
            link.type = 'font/woff2';
            link.crossOrigin = 'anonymous';
            link.href = fontUrl;
            document.head.appendChild(link);
          });
        }
        
        // Load additional fonts on user interaction or after delay
        var events = ['mousedown', 'touchstart', 'keydown', 'wheel'];
        events.forEach(function(event) {
          document.addEventListener(event, loadAdditionalFonts, { once: true, passive: true });
        });
        
        // Fallback: load after 2 seconds if no interaction
        setTimeout(loadAdditionalFonts, 2000);
      })();
    </script>
    
    <!-- إضافة سكريبت للتعامل مع وضع الإضاءة -->
    <script nonce="{{CSP_NONCE}}">
      // حاول تطبيق الوضع المحفوظ قبل تحميل الصفحة لمنع وميض الشاشة
      const storedTheme = localStorage.getItem('theme') || 'light';
      const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      const initialTheme = storedTheme === 'system' ? systemTheme : storedTheme;
      document.documentElement.classList.add(initialTheme);
      document.documentElement.style.colorScheme = initialTheme;
    </script>
    
    <!-- 🚀 Resource Hints محسنة للأداء -->
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="//api.vercel.com">
    
    <!-- 🚀 Preconnect للموارد الحرجة -->
    <link rel="preconnect" href="%VITE_SUPABASE_URL%" crossorigin>
    
    <!-- إعدادات JavaScript الأساسية -->
    <script nonce="{{CSP_NONCE}}">
      // إعدادات أساسية للأداء
      window.process = window.process || { env: {} };
      window.global = window.global || window;
      
      // تحسين أداء الخطوط
      if ('fonts' in document) {
        document.fonts.ready.then(() => {
          document.documentElement.classList.add('fonts-loaded');
        });
      }
    </script>
    
    <!-- 🎯 تحسين تحميل الموارد - إزالة preload غير الضروري -->
    <!-- تم إزالة preload للملفات التي يتم تحميلها بواسطة Vite تلقائياً -->
    
    <!-- ❌ إزالة Google Fonts: نعتمد على الخطوط المحلية فقط للأداء -->
    
    <!-- 🚀 Critical CSS will be loaded via React imports -->
    
    <!-- 🚀 CRITICAL CSS INLINE (مصغّر جداً: الأساسيات واللودر فقط) -->
    <style>
      html {
        font-family: 'Tajawal', 'Arial Unicode MS', 'Tahoma', 'Arial', sans-serif;
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      body {
        margin: 0;
        padding: 0;
        direction: rtl;
        text-align: right;
        min-height: 100vh;
        background: #ffffff;
        color: #000000;
        overflow-x: hidden;
      }
      #root { min-height: 100vh; }
      .loading-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        padding: 1rem;
        border-radius: 0.5rem;
        background: #ffffff;
      }
      .loading-spinner {
        width: 32px;
        height: 32px;
        border: 2px solid #e5e7eb;
        border-top-color: #6b21a8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      * { box-sizing: border-box; }
    </style>
    
    <!-- 🚀 تحميل CSS محسن لتقليل Render Blocking (تعطيل في التطوير) -->
    <script nonce="{{CSP_NONCE}}">
      (function(){
        // لا تُحمِّل CSS الإضافي في بيئة التطوير (localhost/127.*)
        var host = location.hostname || '';
        // اعتبر subdomain.localhost بيئة تطوير أيضاً (asraycollection.localhost)
        var isDev = host === 'localhost' || host.endsWith('.localhost') || host.indexOf('127.') === 0 || host === '::1' || host === '0.0.0.0';
        if (isDev) return;

        // تحميل CSS الأساسي للتطبيق
        function loadNonCriticalCSS() {
          // تحميل CSS الرئيسي المُنتج من Vite
          var mainCSS = document.querySelector('link[rel="stylesheet"][href*="main-"]');
          if (!mainCSS) {
            // إذا لم يتم تحميل CSS الرئيسي، ابحث عنه وحمّله
            loadCSS('/assets/css/main-CbztG7-1.css');
          }
        }

        function loadCSS(href) {
          var link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = href;
          link.media = 'print';
          link.onload = function(){ this.media = 'all'; this.onload = null; };
          link.onerror = function(){ console.warn('Failed to load CSS:', href); };
          document.head.appendChild(link);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadNonCriticalCSS);
        } else {
          loadNonCriticalCSS();
        }
      })();
    </script>

    <meta property="og:title" content="سطوكيها - منصة إدارة المتاجر الذكية" />
    <meta property="og:description" content="منصة إدارة المتاجر الذكية لإنشاء متجرك الإلكتروني وإدارة المبيعات والمخزون بكل سهولة" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/images/logo-new.webp" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@stockiha" />
    <meta name="twitter:image" content="/images/logo-new.webp" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#6b21a8">
    
    <!-- مخصص لـ Vercel و SPA -->
    <meta name="vercel-deployment" content="true">
    <meta name="format-detection" content="telephone=no">
  </head>

  <body>
    <div id="root">
      <!-- PERFORMANCE OPTIMIZATION: Loading screen for better perceived performance -->
      <div class="loading-container" id="initial-loading">
        <div class="loading-spinner"></div>
      </div>
    </div>
    
    <!-- Remove loading screen when React loads -->
    <script nonce="{{CSP_NONCE}}">
      // 🚀 دالة عامة لإزالة شاشة التحميل - سيتم استدعاؤها من React
      window.removeInitialLoading = function() {
        const loadingScreen = document.getElementById('initial-loading');
        if (loadingScreen) {
          loadingScreen.style.opacity = '0';
          loadingScreen.style.transition = 'opacity 0.15s ease'; // ✅ تقليل من 0.3s إلى 0.15s
          setTimeout(() => {
            if (loadingScreen.parentNode) {
              loadingScreen.remove();
            }
          }, 150); // ✅ تقليل من 300ms إلى 150ms لتحسين الأداء
        }
      };

      // ⛑️ احتياط: إزالة شاشة التحميل تلقائياً بعد مهلة قصيرة حتى لو لم يستدعها React
      setTimeout(() => {
        try { if (typeof window.removeInitialLoading === 'function') window.removeInitialLoading(); } catch {}
      }, 2500);

      // 🚀 تحديث مبكر للعنوان/الوصف/الفافيكون بناءً على cache أو اكتشاف النطاق
      const earlyHeadUpdate = () => {
        try {
          const hostname = window.location.hostname;
          
          // فحص النطاقات العامة
          const isPublicDomain = ['ktobi.online', 'www.ktobi.online', 'stockiha.com', 'www.stockiha.com', 'stockiha.pages.dev'].includes(hostname);
          
          // لا نعدل شيئاً على الدومين العام (صفحة المنصة)
          if (isPublicDomain) return;

          // استنتاج معرف المتجر للاستخدام مع التخزين المحلي
          const baseDomains = ['.ktobi.online', '.stockiha.com'];
          const isLocalhost = hostname.includes('localhost') || hostname.startsWith('127.');
          const isBaseDomain = baseDomains.some(d => hostname.endsWith(d));
          const isCustomDomain = !isLocalhost && !isBaseDomain;

          let storeIdentifier = '';
          if (isCustomDomain) {
            storeIdentifier = hostname.startsWith('www.') ? hostname.substring(4) : hostname;
          } else if (isBaseDomain) {
            const parts = hostname.split('.');
            if (parts.length > 2 && parts[0] !== 'www') storeIdentifier = parts[0];
          } else if (isLocalhost && hostname.includes('.')) {
            const parts = hostname.split('.');
            if (parts.length > 1 && parts[0] !== 'localhost') storeIdentifier = parts[0];
          }

          // دوال مساعدة صغيرة لتحديث الفافيكون والميتا
          const setFavicon = (iconUrl, name) => {
            try {
              // إزالة أيقونات سابقة لتفادي التكرار
              document.querySelectorAll('link[rel="icon"], link[rel="shortcut icon"]').forEach(el => el.remove());
              const link = document.createElement('link');
              link.rel = 'icon';
              link.type = 'image/x-icon';
              if (iconUrl) {
                link.href = `${iconUrl}?v=${Date.now()}`;
              } else {
                const initial = (name || 'م').charAt(0);
                const svg = `
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <defs>
                      <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#22c55e;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#16a34a;stop-opacity:1" />
                      </linearGradient>
                    </defs>
                    <rect width="100" height="100" rx="20" fill="url(#grad)"/>
                    <path d="M25 35h50l-5 30H30z" fill="white" opacity="0.9"/>
                    <circle cx="35" cy="75" r="5" fill="white"/>
                    <circle cx="65" cy="75" r="5" fill="white"/>
                    <path d="M35 25l5 10h20l5-10" stroke="white" stroke-width="3" fill="none"/>
                    <text x="50" y="55" text-anchor="middle" font-family="Arial" font-size="38" font-weight="bold" fill="white">${initial}</text>
                  </svg>
                `;
                link.href = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
              }
              document.head.appendChild(link);
              // إضافة shortcut icon لدعم أوسع
              const shortcut = link.cloneNode();
              shortcut.rel = 'shortcut icon';
              document.head.appendChild(shortcut);
            } catch {}
          };

          const setMeta = (desc, title, ogImage) => {
            try {
              if (title) document.title = title;
              if (desc) {
                let m = document.querySelector('meta[name="description"]');
                if (!m) { m = document.createElement('meta'); m.setAttribute('name','description'); document.head.appendChild(m); }
                m.setAttribute('content', desc);
              }
              if (title) {
                let ogt = document.querySelector('meta[property="og:title"]');
                if (!ogt) { ogt = document.createElement('meta'); ogt.setAttribute('property','og:title'); document.head.appendChild(ogt); }
                ogt.setAttribute('content', title);
              }
              if (desc) {
                let ogd = document.querySelector('meta[property="og:description"]');
                if (!ogd) { ogd = document.createElement('meta'); ogd.setAttribute('property','og:description'); document.head.appendChild(ogd); }
                ogd.setAttribute('content', desc);
              }
              if (ogImage) {
                let ogi = document.querySelector('meta[property="og:image"]');
                if (!ogi) { ogi = document.createElement('meta'); ogi.setAttribute('property','og:image'); document.head.appendChild(ogi); }
                ogi.setAttribute('content', ogImage);
              }
            } catch {}
          };

          // 0) إن تم حقن بيانات منتج من Cloudflare Worker، استخدمها فوراً
          try {
            const pre = document.getElementById('__PRELOADED_PRODUCT__');
            if (pre && pre.textContent) {
              const json = JSON.parse(pre.textContent.trim());
              const data = json?.data || null;
              const p = data?.product || data || null;
              const pname = p?.name || null;
              const pdesc = (p?.description || '').toString().replace(/<[^>]*>/g, '').trim().slice(0, 140);
              const pimg = p?.images?.thumbnail_image || (p?.images?.additional_images && p?.images?.additional_images[0]?.url) || null;
              if (pname) {
                // لا تغيّر إن كان العنوان يحتوي الاسم بالفعل (حقن الحافة سبقنا)
                if (!document.title || !document.title.includes(pname)) {
                  setMeta(pdesc || '', pname, pimg || '');
                }
                return;
              }
            }
          } catch {}

          // 1) حاول استخدام بيانات محفوظة مسبقاً
          if (storeIdentifier) {
            const keysToTry = [
              `early_preload_${storeIdentifier}`,
              // في النطاقات المخصصة جرّب أيضاً أول جزء كـ subdomain احتياطي
              ...(isCustomDomain ? [`early_preload_${storeIdentifier.split('.')[0]}`] : [])
            ];
            for (const k of keysToTry) {
              const raw = localStorage.getItem(k) || sessionStorage.getItem(k);
              if (raw) {
                try {
                  const parsed = JSON.parse(raw);
                  const data = parsed?.data || parsed; // دعم كلا الشكلين
                  const siteName = data?.organization_settings?.site_name || data?.organization_details?.name;
                  const seoTitle = data?.seo_meta?.title || siteName;
                  const seoDesc = data?.seo_meta?.description || data?.organization_details?.description;
                  const icon = data?.organization_settings?.favicon_url || data?.organization_settings?.logo_url || data?.organization_details?.logo_url;
                  const ogImage = data?.seo_meta?.image || data?.organization_settings?.logo_url || data?.organization_details?.logo_url;
                  if (seoTitle || seoDesc || icon) {
                    setMeta(seoDesc || '', seoTitle || siteName || '', ogImage || '');
                    setFavicon(icon, siteName);
                    return; // تم التحديث بنجاح من الـ cache
                  }
                } catch {}
              }
            }
          }

          // 2) لا يوجد cache:
          // على النطاقات العامة (بدون subdomain) لا نبدّل الفافيكون الافتراضي الخاص بالمنصة
          if (!storeIdentifier) {
            // اترك روابط الفافيكون الثابتة من index.html كما هي
            // يمكن تحديث العنوان فقط إن أردت، لكن لا تلمس الأيقونة
            try {
              let rawName = hostname.startsWith('www.') ? hostname.substring(4) : hostname;
              const fallbackName = (rawName.split('.')[0] || 'متجر');
              if (!document.title || document.title === 'جاري التحميل...') {
                document.title = `سطوكيها`;
              }
            } catch {}
            return;
          }

          // نطاقات المتاجر: عنوان وفافيكون محايدان حتى يبدأ React
          let rawName = hostname.startsWith('www.') ? hostname.substring(4) : hostname;
          const fallbackName = (rawName.split('.')[0] || 'متجر');
          // لا تسبق الاسم بكلمة "متجر" لتجنب وميض العنوان
          if (!document.title || document.title === 'جاري التحميل...') {
            document.title = `${fallbackName}`;
          }
          setFavicon(null, fallbackName);
        } catch (error) {
          console.warn('خطأ في تغيير العنوان المبكر:', error);
        }
      };

      // تشغيل التحديث المبكر مباشرةً
      earlyHeadUpdate();
    </script>
    
    <!-- Main Application Entry -->
    <script type="module" src="/src/main.tsx"></script>


  </body>
</html>
